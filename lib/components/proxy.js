"use strict";
const index_1 = require("../index");
const crc = require("crc");
function genRouteFun() {
    return (session, msg, app, cb) => {
        let routes = app.get("__routes__");
        if (!routes) {
            defaultRoute(session, msg, app, cb);
            return;
        }
        let type = msg.serverType, route = routes[type] || routes["default"];
        if (route) {
            route(session, msg, app, cb);
        }
        else {
            defaultRoute(session, msg, app, cb);
        }
    };
}
function defaultRoute(session, msg, app, cb) {
    let list = app.getServersByType(msg.serverType);
    if (!list || !list.length) {
        cb(new Error("can not find server info for type:" + msg.serverType));
        return;
    }
    let uid = session ? session.uid || "" : "";
    let index = Math.abs(crc.crc32(uid.toString())) % list.length;
    index_1.utils.invokeCallback(cb, null, list[index].id);
}
module.exports = (app, opts) => {
    opts = opts || {};
    // proxy default config
    // cacheMsg is deprecated, just for compatibility here.
    opts.bufferMsg = opts.bufferMsg || opts.cacheMsg || false;
    opts.interval = opts.interval || 30;
    opts.router = genRouteFun();
    opts.context = app;
    opts.routeContext = app;
    if (app.enabled("rpcDebugLog")) {
        opts.rpcDebugLog = true;
        opts.rpcLogger = require("pomelo-logger").getLogger("rpc-debug", __filename);
    }
    return new index_1.ProxyComponent(app, opts);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcm94eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsb0NBQXVFO0FBQ3ZFLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQXNCM0I7SUFDRSxNQUFNLENBQUMsQ0FBQyxPQUFnQixFQUFFLEdBQVEsRUFBRSxHQUFnQixFQUFFLEVBQVksRUFBRSxFQUFFO1FBQ3BFLElBQUksTUFBTSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFbkMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1osWUFBWSxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQztRQUNULENBQUM7UUFFRCxJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsVUFBVSxFQUN2QixLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1YsS0FBSyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLFlBQVksQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN0QyxDQUFDO0lBQ0gsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELHNCQUNFLE9BQWdCLEVBQ2hCLEdBQVEsRUFDUixHQUFnQixFQUNoQixFQUFZO0lBRVosSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNoRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQzFCLEVBQUUsQ0FBQyxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUNyRSxNQUFNLENBQUM7SUFDVCxDQUFDO0lBRUQsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzNDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDOUQsYUFBSyxDQUFDLGNBQWMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBdkRELGlCQUFTLENBQUMsR0FBZ0IsRUFBRSxJQUFVLEVBQUUsRUFBRTtJQUN4QyxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUNsQix1QkFBdUI7SUFDdkIsdURBQXVEO0lBQ3ZELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQztJQUMxRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDO0lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxFQUFFLENBQUM7SUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7SUFDbkIsSUFBSSxDQUFDLFlBQVksR0FBRyxHQUFHLENBQUM7SUFDeEIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUNqRCxXQUFXLEVBQ1gsVUFBVSxDQUNYLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUksc0JBQWMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDdkMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwbGljYXRpb24sIFNlc3Npb24sIFByb3h5Q29tcG9uZW50LCB1dGlscyB9IGZyb20gXCIuLi9pbmRleFwiO1xuY29uc3QgY3JjID0gcmVxdWlyZShcImNyY1wiKTtcblxuZXhwb3J0ID0gKGFwcDogQXBwbGljYXRpb24sIG9wdHM/OiBhbnkpID0+IHtcbiAgb3B0cyA9IG9wdHMgfHwge307XG4gIC8vIHByb3h5IGRlZmF1bHQgY29uZmlnXG4gIC8vIGNhY2hlTXNnIGlzIGRlcHJlY2F0ZWQsIGp1c3QgZm9yIGNvbXBhdGliaWxpdHkgaGVyZS5cbiAgb3B0cy5idWZmZXJNc2cgPSBvcHRzLmJ1ZmZlck1zZyB8fCBvcHRzLmNhY2hlTXNnIHx8IGZhbHNlO1xuICBvcHRzLmludGVydmFsID0gb3B0cy5pbnRlcnZhbCB8fCAzMDtcbiAgb3B0cy5yb3V0ZXIgPSBnZW5Sb3V0ZUZ1bigpO1xuICBvcHRzLmNvbnRleHQgPSBhcHA7XG4gIG9wdHMucm91dGVDb250ZXh0ID0gYXBwO1xuICBpZiAoYXBwLmVuYWJsZWQoXCJycGNEZWJ1Z0xvZ1wiKSkge1xuICAgIG9wdHMucnBjRGVidWdMb2cgPSB0cnVlO1xuICAgIG9wdHMucnBjTG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFxuICAgICAgXCJycGMtZGVidWdcIixcbiAgICAgIF9fZmlsZW5hbWVcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBQcm94eUNvbXBvbmVudChhcHAsIG9wdHMpO1xufTtcblxuZnVuY3Rpb24gZ2VuUm91dGVGdW4oKSB7XG4gIHJldHVybiAoc2Vzc2lvbjogU2Vzc2lvbiwgbXNnOiBhbnksIGFwcDogQXBwbGljYXRpb24sIGNiOiBGdW5jdGlvbikgPT4ge1xuICAgIGxldCByb3V0ZXMgPSBhcHAuZ2V0KFwiX19yb3V0ZXNfX1wiKTtcblxuICAgIGlmICghcm91dGVzKSB7XG4gICAgICBkZWZhdWx0Um91dGUoc2Vzc2lvbiwgbXNnLCBhcHAsIGNiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgdHlwZSA9IG1zZy5zZXJ2ZXJUeXBlLFxuICAgICAgcm91dGUgPSByb3V0ZXNbdHlwZV0gfHwgcm91dGVzW1wiZGVmYXVsdFwiXTtcblxuICAgIGlmIChyb3V0ZSkge1xuICAgICAgcm91dGUoc2Vzc2lvbiwgbXNnLCBhcHAsIGNiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVmYXVsdFJvdXRlKHNlc3Npb24sIG1zZywgYXBwLCBjYik7XG4gICAgfVxuICB9O1xufVxuXG5mdW5jdGlvbiBkZWZhdWx0Um91dGUoXG4gIHNlc3Npb246IFNlc3Npb24sXG4gIG1zZzogYW55LFxuICBhcHA6IEFwcGxpY2F0aW9uLFxuICBjYjogRnVuY3Rpb25cbikge1xuICBsZXQgbGlzdCA9IGFwcC5nZXRTZXJ2ZXJzQnlUeXBlKG1zZy5zZXJ2ZXJUeXBlKTtcbiAgaWYgKCFsaXN0IHx8ICFsaXN0Lmxlbmd0aCkge1xuICAgIGNiKG5ldyBFcnJvcihcImNhbiBub3QgZmluZCBzZXJ2ZXIgaW5mbyBmb3IgdHlwZTpcIiArIG1zZy5zZXJ2ZXJUeXBlKSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IHVpZCA9IHNlc3Npb24gPyBzZXNzaW9uLnVpZCB8fCBcIlwiIDogXCJcIjtcbiAgbGV0IGluZGV4ID0gTWF0aC5hYnMoY3JjLmNyYzMyKHVpZC50b1N0cmluZygpKSkgJSBsaXN0Lmxlbmd0aDtcbiAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIG51bGwsIGxpc3RbaW5kZXhdLmlkKTtcbn1cbiJdfQ==