"use strict";
const index_1 = require("../index");
const crc = require("crc");
function genRouteFun() {
    return (session, msg, app, cb) => {
        let routes = app.get("__routes__");
        if (!routes) {
            defaultRoute(session, msg, app, cb);
            return;
        }
        let type = msg.serverType, route = routes[type] || routes["default"];
        if (route) {
            route(session, msg, app, cb);
        }
        else {
            defaultRoute(session, msg, app, cb);
        }
    };
}
function defaultRoute(session, msg, app, cb) {
    let list = app.getServersByType(msg.serverType);
    if (!list || !list.length) {
        cb(new Error("can not find server info for type:" + msg.serverType));
        return;
    }
    let uid = session ? session.uid || "" : "";
    let index = Math.abs(crc.crc32(uid.toString())) % list.length;
    index_1.utils.invokeCallback(cb, null, list[index].id);
}
module.exports = (app, opts) => {
    opts = opts || {};
    // proxy default config
    // cacheMsg is deprecated, just for compatibility here.
    opts.bufferMsg = opts.bufferMsg || opts.cacheMsg || false;
    opts.interval = opts.interval || 30;
    opts.router = genRouteFun();
    opts.context = app;
    opts.routeContext = app;
    if (app.enabled("rpcDebugLog")) {
        opts.rpcDebugLog = true;
        opts.rpcLogger = require("pomelo-logger").getLogger("rpc-debug", __filename);
    }
    return new index_1.ProxyComponent(app, opts);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwcm94eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsb0NBQXVFO0FBQ3ZFLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQXNCM0I7SUFDRSxNQUFNLENBQUMsQ0FBQyxPQUFnQixFQUFFLEdBQVEsRUFBRSxHQUFnQixFQUFFLEVBQVksRUFBRSxFQUFFO1FBQ3BFLElBQUksTUFBTSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFbkMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1osWUFBWSxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQztRQUNULENBQUM7UUFFRCxJQUFJLElBQUksR0FBRyxHQUFHLENBQUMsVUFBVSxFQUN2QixLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1YsS0FBSyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLFlBQVksQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN0QyxDQUFDO0lBQ0gsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELHNCQUNFLE9BQWdCLEVBQ2hCLEdBQVEsRUFDUixHQUFnQixFQUNoQixFQUFZO0lBRVosSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNoRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQzFCLEVBQUUsQ0FBQyxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUNyRSxNQUFNLENBQUM7SUFDVCxDQUFDO0lBRUQsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzNDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDOUQsYUFBSyxDQUFDLGNBQWMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBdkRELGlCQUFTLENBQUMsR0FBZ0IsRUFBRSxJQUFVLEVBQUUsRUFBRTtJQUN4QyxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUNsQix1QkFBdUI7SUFDdkIsdURBQXVEO0lBQ3ZELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQztJQUMxRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDO0lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxFQUFFLENBQUM7SUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7SUFDbkIsSUFBSSxDQUFDLFlBQVksR0FBRyxHQUFHLENBQUM7SUFDeEIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDeEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUNqRCxXQUFXLEVBQ1gsVUFBVSxDQUNYLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUksc0JBQWMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDdkMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwbGljYXRpb24sIFNlc3Npb24sIFByb3h5Q29tcG9uZW50LCB1dGlscyB9IGZyb20gXCIuLi9pbmRleFwiO1xyXG5jb25zdCBjcmMgPSByZXF1aXJlKFwiY3JjXCIpO1xyXG5cclxuZXhwb3J0ID0gKGFwcDogQXBwbGljYXRpb24sIG9wdHM/OiBhbnkpID0+IHtcclxuICBvcHRzID0gb3B0cyB8fCB7fTtcclxuICAvLyBwcm94eSBkZWZhdWx0IGNvbmZpZ1xyXG4gIC8vIGNhY2hlTXNnIGlzIGRlcHJlY2F0ZWQsIGp1c3QgZm9yIGNvbXBhdGliaWxpdHkgaGVyZS5cclxuICBvcHRzLmJ1ZmZlck1zZyA9IG9wdHMuYnVmZmVyTXNnIHx8IG9wdHMuY2FjaGVNc2cgfHwgZmFsc2U7XHJcbiAgb3B0cy5pbnRlcnZhbCA9IG9wdHMuaW50ZXJ2YWwgfHwgMzA7XHJcbiAgb3B0cy5yb3V0ZXIgPSBnZW5Sb3V0ZUZ1bigpO1xyXG4gIG9wdHMuY29udGV4dCA9IGFwcDtcclxuICBvcHRzLnJvdXRlQ29udGV4dCA9IGFwcDtcclxuICBpZiAoYXBwLmVuYWJsZWQoXCJycGNEZWJ1Z0xvZ1wiKSkge1xyXG4gICAgb3B0cy5ycGNEZWJ1Z0xvZyA9IHRydWU7XHJcbiAgICBvcHRzLnJwY0xvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcclxuICAgICAgXCJycGMtZGVidWdcIixcclxuICAgICAgX19maWxlbmFtZVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBuZXcgUHJveHlDb21wb25lbnQoYXBwLCBvcHRzKTtcclxufTtcclxuXHJcbmZ1bmN0aW9uIGdlblJvdXRlRnVuKCkge1xyXG4gIHJldHVybiAoc2Vzc2lvbjogU2Vzc2lvbiwgbXNnOiBhbnksIGFwcDogQXBwbGljYXRpb24sIGNiOiBGdW5jdGlvbikgPT4ge1xyXG4gICAgbGV0IHJvdXRlcyA9IGFwcC5nZXQoXCJfX3JvdXRlc19fXCIpO1xyXG5cclxuICAgIGlmICghcm91dGVzKSB7XHJcbiAgICAgIGRlZmF1bHRSb3V0ZShzZXNzaW9uLCBtc2csIGFwcCwgY2IpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHR5cGUgPSBtc2cuc2VydmVyVHlwZSxcclxuICAgICAgcm91dGUgPSByb3V0ZXNbdHlwZV0gfHwgcm91dGVzW1wiZGVmYXVsdFwiXTtcclxuXHJcbiAgICBpZiAocm91dGUpIHtcclxuICAgICAgcm91dGUoc2Vzc2lvbiwgbXNnLCBhcHAsIGNiKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGRlZmF1bHRSb3V0ZShzZXNzaW9uLCBtc2csIGFwcCwgY2IpO1xyXG4gICAgfVxyXG4gIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRlZmF1bHRSb3V0ZShcclxuICBzZXNzaW9uOiBTZXNzaW9uLFxyXG4gIG1zZzogYW55LFxyXG4gIGFwcDogQXBwbGljYXRpb24sXHJcbiAgY2I6IEZ1bmN0aW9uXHJcbikge1xyXG4gIGxldCBsaXN0ID0gYXBwLmdldFNlcnZlcnNCeVR5cGUobXNnLnNlcnZlclR5cGUpO1xyXG4gIGlmICghbGlzdCB8fCAhbGlzdC5sZW5ndGgpIHtcclxuICAgIGNiKG5ldyBFcnJvcihcImNhbiBub3QgZmluZCBzZXJ2ZXIgaW5mbyBmb3IgdHlwZTpcIiArIG1zZy5zZXJ2ZXJUeXBlKSk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBsZXQgdWlkID0gc2Vzc2lvbiA/IHNlc3Npb24udWlkIHx8IFwiXCIgOiBcIlwiO1xyXG4gIGxldCBpbmRleCA9IE1hdGguYWJzKGNyYy5jcmMzMih1aWQudG9TdHJpbmcoKSkpICUgbGlzdC5sZW5ndGg7XHJcbiAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIG51bGwsIGxpc3RbaW5kZXhdLmlkKTtcclxufVxyXG4iXX0=