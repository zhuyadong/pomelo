"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os = require("os");
const util = require("util");
const child_process_1 = require("child_process");
const Constants = require("./constants");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const pomelo_1 = require("../pomelo");
function invokeCallback(cb, ...args) {
    if (typeof cb === "function") {
        let len = arguments.length;
        if (len == 1) {
            return cb();
        }
        if (len == 2) {
            return cb(arguments[1]);
        }
        if (len == 3) {
            return cb(arguments[1], arguments[2]);
        }
        if (len == 4) {
            return cb(arguments[1], arguments[2], arguments[3]);
        }
        let args = Array(len - 1);
        for (let i = 1; i < len; i++)
            args[i - 1] = arguments[i];
        cb.apply(null, args);
    }
}
exports.invokeCallback = invokeCallback;
function size(obj) {
    let count = 0;
    for (let i in obj) {
        if (obj.hasOwnProperty(i) && typeof obj[i] !== "function") {
            count++;
        }
    }
    return count;
}
exports.size = size;
function endsWith(str, suffix) {
    if (typeof str !== "string" ||
        typeof suffix !== "string" ||
        suffix.length > str.length) {
        return false;
    }
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
}
exports.endsWith = endsWith;
function startWith(str, prefix) {
    if (typeof str !== "string" ||
        typeof prefix !== "string" ||
        prefix.length > str.length) {
        return false;
    }
    return str.indexOf(prefix) === 0;
}
exports.startWith = startWith;
function arrayDiff(array1, array2) {
    let o = {};
    for (let i = 0, len = array2.length; i < len; i++) {
        o[array2[i]] = true;
    }
    let result = [];
    for (let i = 0, len = array1.length; i < len; i++) {
        let v = array1[i];
        if (o[v])
            continue;
        result.push(v);
    }
    return result;
}
exports.arrayDiff = arrayDiff;
function format(date, format) {
    format = format || "MMddhhmm";
    let o = {
        "M+": date.getMonth() + 1,
        "d+": date.getDate(),
        "h+": date.getHours(),
        "m+": date.getMinutes(),
        "s+": date.getSeconds(),
        "q+": Math.floor((date.getMonth() + 3) / 3),
        S: date.getMilliseconds() //millisecond
    };
    if (/(y+)/.test(format)) {
        format = format.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (let k in o) {
        if (new RegExp("(" + k + ")").test(format)) {
            format = format.replace(RegExp.$1, RegExp.$1.length === 1
                ? o[k].toString()
                : ("00" + o[k]).substr(("" + o[k]).length));
        }
    }
    return format;
}
exports.format = format;
function hasChineseChar(str) {
    if (/.*[\u4e00-\u9fa5]+.*$/.test(str)) {
        return true;
    }
    else {
        return false;
    }
}
exports.hasChineseChar = hasChineseChar;
function unicodeToUtf8(str) {
    let i, len, ch;
    let utf8Str = "";
    len = str.length;
    for (i = 0; i < len; i++) {
        ch = str.charCodeAt(i);
        if (ch >= 0x0 && ch <= 0x7f) {
            utf8Str += str.charAt(i);
        }
        else if (ch >= 0x80 && ch <= 0x7ff) {
            utf8Str += String.fromCharCode(0xc0 | ((ch >> 6) & 0x1f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
        else if (ch >= 0x800 && ch <= 0xffff) {
            utf8Str += String.fromCharCode(0xe0 | ((ch >> 12) & 0xf));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 6) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
        else if (ch >= 0x10000 && ch <= 0x1fffff) {
            utf8Str += String.fromCharCode(0xf0 | ((ch >> 18) & 0x7));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 12) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 6) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
        else if (ch >= 0x200000 && ch <= 0x3ffffff) {
            utf8Str += String.fromCharCode(0xf8 | ((ch >> 24) & 0x3));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 18) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 12) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 6) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
        else if (ch >= 0x4000000 && ch <= 0x7fffffff) {
            utf8Str += String.fromCharCode(0xfc | ((ch >> 30) & 0x1));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 24) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 18) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 12) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 6) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
    }
    return utf8Str;
}
exports.unicodeToUtf8 = unicodeToUtf8;
function ping(host, cb) {
    if (!isLocal(host)) {
        let cmd = "ping -w 15 " + host;
        child_process_1.exec(cmd, function (err, stdout, stderr) {
            if (!!err) {
                cb(false);
                return;
            }
            cb(true);
        });
    }
    else {
        cb(true);
    }
}
exports.ping = ping;
function checkPort(server, cb) {
    if (!server.port && !server.clientPort) {
        invokeCallback(cb, "leisure");
        return;
    }
    let port = server.port || server.clientPort;
    let host = server.host;
    let generateCommand = function (host, port) {
        let cmd;
        let ssh_params = pomelo_1.default.app.get(Constants.RESERVED.SSH_CONFIG_PARAMS);
        if (!!ssh_params && Array.isArray(ssh_params)) {
            ssh_params = ssh_params.join(" ");
        }
        else {
            ssh_params = "";
        }
        if (!isLocal(host)) {
            cmd = util.format("ssh %s %s \"netstat -an|awk '{print $4}'|grep %s|wc -l\"", host, ssh_params, port);
        }
        else {
            cmd = util.format("netstat -an|awk '{print $4}'|grep %s|wc -l", port);
        }
        return cmd;
    };
    let cmd1 = generateCommand(host, port);
    let child = child_process_1.exec(cmd1, function (err, stdout, stderr) {
        if (err) {
            logger.error("command %s execute with error: %j", cmd1, err.stack);
            invokeCallback(cb, "error");
        }
        else if (stdout.trim() !== "0") {
            invokeCallback(cb, "busy");
        }
        else {
            port = server.clientPort;
            let cmd2 = generateCommand(host, port);
            child_process_1.exec(cmd2, function (err, stdout, stderr) {
                if (err) {
                    logger.error("command %s execute with error: %j", cmd2, err.stack);
                    invokeCallback(cb, "error");
                }
                else if (stdout.trim() !== "0") {
                    invokeCallback(cb, "busy");
                }
                else {
                    invokeCallback(cb, "leisure");
                }
            });
        }
    });
}
exports.checkPort = checkPort;
function isLocal(host) {
    let app = require("../pomelo").app;
    if (!app) {
        return (host === "127.0.0.1" ||
            host === "localhost" ||
            host === "0.0.0.0" ||
            inLocal(host));
    }
    else {
        return (host === "127.0.0.1" ||
            host === "localhost" ||
            host === "0.0.0.0" ||
            inLocal(host) ||
            host === app.master.host);
    }
}
exports.isLocal = isLocal;
function extend(origin, add) {
    if (!add || !isObject(add))
        return origin;
    let keys = Object.keys(add);
    let i = keys.length;
    while (i--) {
        origin[keys[i]] = add[keys[i]];
    }
    return origin;
}
exports.extend = extend;
function headHandler(headBuffer) {
    let len = 0;
    for (let i = 1; i < 4; i++) {
        if (i > 1) {
            len <<= 8;
        }
        len += headBuffer.readUInt8(i);
    }
    return len;
}
exports.headHandler = headHandler;
function inLocal(host) {
    for (let index in localIps) {
        if (host === localIps[index]) {
            return true;
        }
    }
    return false;
}
let localIps = (function () {
    let ifaces = os.networkInterfaces();
    let ips = [];
    let func = function (details) {
        if (details.family === "IPv4") {
            ips.push(details.address);
        }
    };
    for (let dev in ifaces) {
        ifaces[dev].forEach(func);
    }
    return ips;
})();
function isObject(arg) {
    return typeof arg === "object" && arg !== null;
}
exports.isObject = isObject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUFDOUIsaURBQXFDO0FBQ3JDLHlDQUEwQztBQUMxQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUV4RSxzQ0FBK0I7QUFFL0Isd0JBQStCLEVBQVksRUFBRSxHQUFHLElBQVc7SUFDekQsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztRQUM3QixJQUFJLEdBQUcsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO1FBQzNCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2IsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2IsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQixDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDYixNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QyxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDYixNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUVELElBQUksSUFBSSxH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QyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxLQUFLLElBQUksRUFBRSxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDdkMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzFELE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLE9BQU8sSUFBSSxFQUFFLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQztZQUMzQyxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFELE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDM0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxRQUFRLElBQUksRUFBRSxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDN0MsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzNELE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDM0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxTQUFTLElBQUksRUFBRSxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDL0MsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFD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QixHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM1QixDQUFDO0lBQ0gsQ0FBQyxDQUFDO0lBQ0YsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQztRQUN2QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFDRCxNQUFNLENBQUMsR0FBRyxDQUFDO0FBQ2IsQ0FBQyxDQUFDLEVBQUUsQ0FBQztBQUVMLGtCQUF5QixHQUFRO0lBQy9CLE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxLQUFLLElBQUksQ0FBQztBQUNqRCxDQUFDO0FBRkQsNEJBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgb3MgPSByZXF1aXJlKFwib3NcIik7XHJcbmltcG9ydCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XHJcbmltcG9ydCB7IGV4ZWMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xyXG5pbXBvcnQgQ29uc3RhbnRzID0gcmVxdWlyZShcIi4vY29uc3RhbnRzXCIpO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBTZXJ2ZXJJbmZvIH0gZnJvbSBcIi4uL2FwcGxpY2F0aW9uXCI7XHJcbmltcG9ydCBwb21lbG8gZnJvbSBcIi4uL3BvbWVsb1wiO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGludm9rZUNhbGxiYWNrKGNiOiBGdW5jdGlvbiwgLi4uYXJnczogYW55W10pIHtcclxuICBpZiAodHlwZW9mIGNiID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgIGxldCBsZW4gPSBhcmd1bWVudHMubGVuZ3RoO1xyXG4gICAgaWYgKGxlbiA9PSAxKSB7XHJcbiAgICAgIHJldHVybiBjYigpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChsZW4gPT0gMikge1xyXG4gICAgICByZXR1cm4gY2IoYXJndW1lbnRzWzFdKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAobGVuID09IDMpIHtcclxuICAgICAgcmV0dXJuIGNiKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAobGVuID09IDQpIHtcclxuICAgICAgcmV0dXJuIGNiKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10pO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBhcmdzID0gQXJyYXkobGVuIC0gMSk7XHJcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbjsgaSsrKSBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTtcclxuICAgIGNiLmFwcGx5KG51bGwsIGFyZ3MpO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNpemUob2JqOiBhbnkpOiBudW1iZXIge1xyXG4gIGxldCBjb3VudCA9IDA7XHJcbiAgZm9yIChsZXQgaSBpbiBvYmopIHtcclxuICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoaSkgJiYgdHlwZW9mIG9ialtpXSAhPT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgIGNvdW50Kys7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBjb3VudDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGVuZHNXaXRoKHN0cjogc3RyaW5nLCBzdWZmaXg6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gIGlmIChcclxuICAgIHR5cGVvZiBzdHIgIT09IFwic3RyaW5nXCIgfHxcclxuICAgIHR5cGVvZiBzdWZmaXggIT09IFwic3RyaW5nXCIgfHxcclxuICAgIHN1ZmZpeC5sZW5ndGggPiBzdHIubGVuZ3RoXHJcbiAgKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG4gIHJldHVybiBzdHIuaW5kZXhPZihzdWZmaXgsIHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzdGFydFdpdGgoc3RyOiBzdHJpbmcsIHByZWZpeDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgaWYgKFxyXG4gICAgdHlwZW9mIHN0ciAhPT0gXCJzdHJpbmdcIiB8fFxyXG4gICAgdHlwZW9mIHByZWZpeCAhPT0gXCJzdHJpbmdcIiB8fFxyXG4gICAgcHJlZml4Lmxlbmd0aCA+IHN0ci5sZW5ndGhcclxuICApIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbiAgcmV0dXJuIHN0ci5pbmRleE9mKHByZWZpeCkgPT09IDA7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhcnJheURpZmYoYXJyYXkxOiBBcnJheTxhbnk+LCBhcnJheTI6IEFycmF5PGFueT4pIHtcclxuICBsZXQgbyA9IHt9IGFzIHsgW2lkeDogc3RyaW5nXTogYm9vbGVhbiB9O1xyXG4gIGZvciAobGV0IGkgPSAwLCBsZW4gPSBhcnJheTIubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgIG9bYXJyYXkyW2ldXSA9IHRydWU7XHJcbiAgfVxyXG5cclxuICBsZXQgcmVzdWx0ID0gW107XHJcbiAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGFycmF5MS5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xyXG4gICAgbGV0IHYgPSBhcnJheTFbaV07XHJcbiAgICBpZiAob1t2XSkgY29udGludWU7XHJcbiAgICByZXN1bHQucHVzaCh2KTtcclxuICB9XHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdChkYXRlOiBEYXRlLCBmb3JtYXQ/OiBzdHJpbmcpIHtcclxuICBmb3JtYXQgPSBmb3JtYXQgfHwgXCJNTWRkaGhtbVwiO1xyXG4gIGxldCBvOiB7IFtpZHg6IHN0cmluZ106IG51bWJlciB9ID0ge1xyXG4gICAgXCJNK1wiOiBkYXRlLmdldE1vbnRoKCkgKyAxLCAvL21vbnRoXHJcbiAgICBcImQrXCI6IGRhdGUuZ2V0RGF0ZSgpLCAvL2RheVxyXG4gICAgXCJoK1wiOiBkYXRlLmdldEhvdXJzKCksIC8vaG91clxyXG4gICAgXCJtK1wiOiBkYXRlLmdldE1pbnV0ZXMoKSwgLy9taW51dGVcclxuICAgIFwicytcIjogZGF0ZS5nZXRTZWNvbmRzKCksIC8vc2Vjb25kXHJcbiAgICBcInErXCI6IE1hdGguZmxvb3IoKGRhdGUuZ2V0TW9udGgoKSArIDMpIC8gMyksIC8vcXVhcnRlclxyXG4gICAgUzogZGF0ZS5nZXRNaWxsaXNlY29uZHMoKSAvL21pbGxpc2Vjb25kXHJcbiAgfTtcclxuXHJcbiAgaWYgKC8oeSspLy50ZXN0KGZvcm1hdCkpIHtcclxuICAgIGZvcm1hdCA9IGZvcm1hdC5yZXBsYWNlKFxyXG4gICAgICBSZWdFeHAuJDEsXHJcbiAgICAgIChkYXRlLmdldEZ1bGxZZWFyKCkgKyBcIlwiKS5zdWJzdHIoNCAtIFJlZ0V4cC4kMS5sZW5ndGgpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZm9yIChsZXQgayBpbiBvKSB7XHJcbiAgICBpZiAobmV3IFJlZ0V4cChcIihcIiArIGsgKyBcIilcIikudGVzdChmb3JtYXQpKSB7XHJcbiAgICAgIGZvcm1hdCA9IGZvcm1hdC5yZXBsYWNlKFxyXG4gICAgICAgIFJlZ0V4cC4kMSxcclxuICAgICAgICBSZWdFeHAuJDEubGVuZ3RoID09PSAxXHJcbiAgICAgICAgICA/IG9ba10udG9TdHJpbmcoKVxyXG4gICAgICAgICAgOiAoXCIwMFwiICsgb1trXSkuc3Vic3RyKChcIlwiICsgb1trXSkubGVuZ3RoKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gZm9ybWF0O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaGFzQ2hpbmVzZUNoYXIoc3RyOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICBpZiAoLy4qW1xcdTRlMDAtXFx1OWZhNV0rLiokLy50ZXN0KHN0cikpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdW5pY29kZVRvVXRmOChzdHI6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgbGV0IGksIGxlbiwgY2g7XHJcbiAgbGV0IHV0ZjhTdHIgPSBcIlwiO1xyXG4gIGxlbiA9IHN0ci5sZW5ndGg7XHJcbiAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICBjaCA9IHN0ci5jaGFyQ29kZUF0KGkpO1xyXG5cclxuICAgIGlmIChjaCA+PSAweDAgJiYgY2ggPD0gMHg3Zikge1xyXG4gICAgICB1dGY4U3RyICs9IHN0ci5jaGFyQXQoaSk7XHJcbiAgICB9IGVsc2UgaWYgKGNoID49IDB4ODAgJiYgY2ggPD0gMHg3ZmYpIHtcclxuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4YzAgfCAoKGNoID4+IDYpICYgMHgxZikpO1xyXG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8IChjaCAmIDB4M2YpKTtcclxuICAgIH0gZWxzZSBpZiAoY2ggPj0gMHg4MDAgJiYgY2ggPD0gMHhmZmZmKSB7XHJcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweGUwIHwgKChjaCA+PiAxMikgJiAweGYpKTtcclxuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoKGNoID4+IDYpICYgMHgzZikpO1xyXG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8IChjaCAmIDB4M2YpKTtcclxuICAgIH0gZWxzZSBpZiAoY2ggPj0gMHgxMDAwMCAmJiBjaCA8PSAweDFmZmZmZikge1xyXG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHhmMCB8ICgoY2ggPj4gMTgpICYgMHg3KSk7XHJcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjaCA+PiAxMikgJiAweDNmKSk7XHJcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjaCA+PiA2KSAmIDB4M2YpKTtcclxuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoY2ggJiAweDNmKSk7XHJcbiAgICB9IGVsc2UgaWYgKGNoID49IDB4MjAwMDAwICYmIGNoIDw9IDB4M2ZmZmZmZikge1xyXG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHhmOCB8ICgoY2ggPj4gMjQpICYgMHgzKSk7XHJcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjaCA+PiAxOCkgJiAweDNmKSk7XHJcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjaCA+PiAxMikgJiAweDNmKSk7XHJcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjaCA+PiA2KSAmIDB4M2YpKTtcclxuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoY2ggJiAweDNmKSk7XHJcbiAgICB9IGVsc2UgaWYgKGNoID49IDB4NDAwMDAwMCAmJiBjaCA8PSAweDdmZmZmZmZmKSB7XHJcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweGZjIHwgKChjaCA+PiAzMCkgJiAweDEpKTtcclxuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoKGNoID4+IDI0KSAmIDB4M2YpKTtcclxuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoKGNoID4+IDE4KSAmIDB4M2YpKTtcclxuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoKGNoID4+IDEyKSAmIDB4M2YpKTtcclxuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoKGNoID4+IDYpICYgMHgzZikpO1xyXG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8IChjaCAmIDB4M2YpKTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHV0ZjhTdHI7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwaW5nKGhvc3Q6IHN0cmluZywgY2I6IChyZXQ6Ym9vbGVhbik9PnZvaWQpIHtcclxuICBpZiAoIWlzTG9jYWwoaG9zdCkpIHtcclxuICAgIGxldCBjbWQgPSBcInBpbmcgLXcgMTUgXCIgKyBob3N0O1xyXG4gICAgZXhlYyhjbWQsIGZ1bmN0aW9uKGVyciwgc3Rkb3V0LCBzdGRlcnIpIHtcclxuICAgICAgaWYgKCEhZXJyKSB7XHJcbiAgICAgICAgY2IoZmFsc2UpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjYih0cnVlKTtcclxuICAgIH0pO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBjYih0cnVlKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjaGVja1BvcnQoXHJcbiAgc2VydmVyOiB7IGhvc3Q6IHN0cmluZzsgcG9ydD86IG51bWJlcnxzdHJpbmc7IGNsaWVudFBvcnQ/OiBudW1iZXJ8c3RyaW5nIH0sXHJcbiAgY2I6IEZ1bmN0aW9uXHJcbikge1xyXG4gIGlmICghc2VydmVyLnBvcnQgJiYgIXNlcnZlci5jbGllbnRQb3J0KSB7XHJcbiAgICBpbnZva2VDYWxsYmFjayhjYiwgXCJsZWlzdXJlXCIpO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuICBsZXQgcG9ydCA9IHNlcnZlci5wb3J0IHx8IHNlcnZlci5jbGllbnRQb3J0O1xyXG4gIGxldCBob3N0ID0gc2VydmVyLmhvc3Q7XHJcbiAgbGV0IGdlbmVyYXRlQ29tbWFuZCA9IGZ1bmN0aW9uKGhvc3Q6IHN0cmluZywgcG9ydDogbnVtYmVyIHwgc3RyaW5nKSB7XHJcbiAgICBsZXQgY21kO1xyXG4gICAgbGV0IHNzaF9wYXJhbXMgOiBhbnkgPSBwb21lbG8uYXBwLmdldChDb25zdGFudHMuUkVTRVJWRUQuU1NIX0NPTkZJR19QQVJBTVMpO1xyXG4gICAgaWYgKCEhc3NoX3BhcmFtcyAmJiBBcnJheS5pc0FycmF5KHNzaF9wYXJhbXMpKSB7XHJcbiAgICAgIHNzaF9wYXJhbXMgPSBzc2hfcGFyYW1zLmpvaW4oXCIgXCIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc3NoX3BhcmFtcyA9IFwiXCI7XHJcbiAgICB9XHJcbiAgICBpZiAoIWlzTG9jYWwoaG9zdCkpIHtcclxuICAgICAgY21kID0gdXRpbC5mb3JtYXQoXHJcbiAgICAgICAgXCJzc2ggJXMgJXMgXFxcIm5ldHN0YXQgLWFufGF3ayAne3ByaW50ICQ0fSd8Z3JlcCAlc3x3YyAtbFxcXCJcIixcclxuICAgICAgICBob3N0LFxyXG4gICAgICAgIHNzaF9wYXJhbXMsXHJcbiAgICAgICAgcG9ydFxyXG4gICAgICApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY21kID0gdXRpbC5mb3JtYXQoXCJuZXRzdGF0IC1hbnxhd2sgJ3twcmludCAkNH0nfGdyZXAgJXN8d2MgLWxcIiwgcG9ydCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY21kO1xyXG4gIH07XHJcbiAgbGV0IGNtZDEgPSBnZW5lcmF0ZUNvbW1hbmQoaG9zdCwgcG9ydCEpO1xyXG4gIGxldCBjaGlsZCA9IGV4ZWMoY21kMSwgZnVuY3Rpb24oZXJyLCBzdGRvdXQsIHN0ZGVycikge1xyXG4gICAgaWYgKGVycikge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoXCJjb21tYW5kICVzIGV4ZWN1dGUgd2l0aCBlcnJvcjogJWpcIiwgY21kMSwgZXJyLnN0YWNrKTtcclxuICAgICAgaW52b2tlQ2FsbGJhY2soY2IsIFwiZXJyb3JcIik7XHJcbiAgICB9IGVsc2UgaWYgKHN0ZG91dC50cmltKCkgIT09IFwiMFwiKSB7XHJcbiAgICAgIGludm9rZUNhbGxiYWNrKGNiLCBcImJ1c3lcIik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwb3J0ID0gc2VydmVyLmNsaWVudFBvcnQ7XHJcbiAgICAgIGxldCBjbWQyID0gZ2VuZXJhdGVDb21tYW5kKGhvc3QsIHBvcnQhKTtcclxuICAgICAgZXhlYyhjbWQyLCBmdW5jdGlvbihlcnIsIHN0ZG91dCwgc3RkZXJyKSB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgbG9nZ2VyLmVycm9yKFwiY29tbWFuZCAlcyBleGVjdXRlIHdpdGggZXJyb3I6ICVqXCIsIGNtZDIsIGVyci5zdGFjayk7XHJcbiAgICAgICAgICBpbnZva2VDYWxsYmFjayhjYiwgXCJlcnJvclwiKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHN0ZG91dC50cmltKCkgIT09IFwiMFwiKSB7XHJcbiAgICAgICAgICBpbnZva2VDYWxsYmFjayhjYiwgXCJidXN5XCIpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpbnZva2VDYWxsYmFjayhjYiwgXCJsZWlzdXJlXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0xvY2FsKGhvc3Q6IHN0cmluZykge1xyXG4gIGxldCBhcHAgPSByZXF1aXJlKFwiLi4vcG9tZWxvXCIpLmFwcDtcclxuICBpZiAoIWFwcCkge1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgaG9zdCA9PT0gXCIxMjcuMC4wLjFcIiB8fFxyXG4gICAgICBob3N0ID09PSBcImxvY2FsaG9zdFwiIHx8XHJcbiAgICAgIGhvc3QgPT09IFwiMC4wLjAuMFwiIHx8XHJcbiAgICAgIGluTG9jYWwoaG9zdClcclxuICAgICk7XHJcbiAgfSBlbHNlIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIGhvc3QgPT09IFwiMTI3LjAuMC4xXCIgfHxcclxuICAgICAgaG9zdCA9PT0gXCJsb2NhbGhvc3RcIiB8fFxyXG4gICAgICBob3N0ID09PSBcIjAuMC4wLjBcIiB8fFxyXG4gICAgICBpbkxvY2FsKGhvc3QpIHx8XHJcbiAgICAgIGhvc3QgPT09IGFwcC5tYXN0ZXIuaG9zdFxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBleHRlbmQob3JpZ2luOiBhbnksIGFkZDogYW55KTogYW55IHtcclxuICBpZiAoIWFkZCB8fCAhaXNPYmplY3QoYWRkKSkgcmV0dXJuIG9yaWdpbjtcclxuXHJcbiAgbGV0IGtleXMgPSBPYmplY3Qua2V5cyhhZGQpO1xyXG4gIGxldCBpID0ga2V5cy5sZW5ndGg7XHJcbiAgd2hpbGUgKGktLSkge1xyXG4gICAgb3JpZ2luW2tleXNbaV1dID0gYWRkW2tleXNbaV1dO1xyXG4gIH1cclxuICByZXR1cm4gb3JpZ2luO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaGVhZEhhbmRsZXIoaGVhZEJ1ZmZlcjogQnVmZmVyKSB7XHJcbiAgbGV0IGxlbiA9IDA7XHJcbiAgZm9yIChsZXQgaSA9IDE7IGkgPCA0OyBpKyspIHtcclxuICAgIGlmIChpID4gMSkge1xyXG4gICAgICBsZW4gPDw9IDg7XHJcbiAgICB9XHJcbiAgICBsZW4gKz0gaGVhZEJ1ZmZlci5yZWFkVUludDgoaSk7XHJcbiAgfVxyXG4gIHJldHVybiBsZW47XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluTG9jYWwoaG9zdDogc3RyaW5nKSB7XHJcbiAgZm9yIChsZXQgaW5kZXggaW4gbG9jYWxJcHMpIHtcclxuICAgIGlmIChob3N0ID09PSBsb2NhbElwc1tpbmRleF0pIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxubGV0IGxvY2FsSXBzID0gKGZ1bmN0aW9uKCkge1xyXG4gIGxldCBpZmFjZXMgPSBvcy5uZXR3b3JrSW50ZXJmYWNlcygpO1xyXG4gIGxldCBpcHM6IHN0cmluZ1tdID0gW107XHJcbiAgbGV0IGZ1bmMgPSBmdW5jdGlvbihkZXRhaWxzOiBhbnkpIHtcclxuICAgIGlmIChkZXRhaWxzLmZhbWlseSA9PT0gXCJJUHY0XCIpIHtcclxuICAgICAgaXBzLnB1c2goZGV0YWlscy5hZGRyZXNzKTtcclxuICAgIH1cclxuICB9O1xyXG4gIGZvciAobGV0IGRldiBpbiBpZmFjZXMpIHtcclxuICAgIGlmYWNlc1tkZXZdLmZvckVhY2goZnVuYyk7XHJcbiAgfVxyXG4gIHJldHVybiBpcHM7XHJcbn0pKCk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNPYmplY3QoYXJnOiBhbnkpIHtcclxuICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gXCJvYmplY3RcIiAmJiBhcmcgIT09IG51bGw7XHJcbn1cclxuIl19