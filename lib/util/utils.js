"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os = require("os");
const util = require("util");
const child_process_1 = require("child_process");
const Constants = require("./constants");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const pomelo_1 = require("../pomelo");
function invokeCallback(cb, ...args) {
    if (typeof cb === "function") {
        let len = arguments.length;
        if (len == 1) {
            return cb();
        }
        if (len == 2) {
            return cb(arguments[1]);
        }
        if (len == 3) {
            return cb(arguments[1], arguments[2]);
        }
        if (len == 4) {
            return cb(arguments[1], arguments[2], arguments[3]);
        }
        let args = Array(len - 1);
        for (let i = 1; i < len; i++)
            args[i - 1] = arguments[i];
        cb.apply(null, args);
    }
}
exports.invokeCallback = invokeCallback;
function size(obj) {
    let count = 0;
    for (let i in obj) {
        if (obj.hasOwnProperty(i) && typeof obj[i] !== "function") {
            count++;
        }
    }
    return count;
}
exports.size = size;
function endsWith(str, suffix) {
    if (typeof str !== "string" ||
        typeof suffix !== "string" ||
        suffix.length > str.length) {
        return false;
    }
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
}
exports.endsWith = endsWith;
function startWith(str, prefix) {
    if (typeof str !== "string" ||
        typeof prefix !== "string" ||
        prefix.length > str.length) {
        return false;
    }
    return str.indexOf(prefix) === 0;
}
exports.startWith = startWith;
function arrayDiff(array1, array2) {
    let o = {};
    for (let i = 0, len = array2.length; i < len; i++) {
        o[array2[i]] = true;
    }
    let result = [];
    for (let i = 0, len = array1.length; i < len; i++) {
        let v = array1[i];
        if (o[v])
            continue;
        result.push(v);
    }
    return result;
}
exports.arrayDiff = arrayDiff;
function format(date, format) {
    format = format || "MMddhhmm";
    let o = {
        "M+": date.getMonth() + 1,
        "d+": date.getDate(),
        "h+": date.getHours(),
        "m+": date.getMinutes(),
        "s+": date.getSeconds(),
        "q+": Math.floor((date.getMonth() + 3) / 3),
        S: date.getMilliseconds() //millisecond
    };
    if (/(y+)/.test(format)) {
        format = format.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (let k in o) {
        if (new RegExp("(" + k + ")").test(format)) {
            format = format.replace(RegExp.$1, RegExp.$1.length === 1
                ? o[k].toString()
                : ("00" + o[k]).substr(("" + o[k]).length));
        }
    }
    return format;
}
exports.format = format;
function hasChineseChar(str) {
    if (/.*[\u4e00-\u9fa5]+.*$/.test(str)) {
        return true;
    }
    else {
        return false;
    }
}
exports.hasChineseChar = hasChineseChar;
function unicodeToUtf8(str) {
    let i, len, ch;
    let utf8Str = "";
    len = str.length;
    for (i = 0; i < len; i++) {
        ch = str.charCodeAt(i);
        if (ch >= 0x0 && ch <= 0x7f) {
            utf8Str += str.charAt(i);
        }
        else if (ch >= 0x80 && ch <= 0x7ff) {
            utf8Str += String.fromCharCode(0xc0 | ((ch >> 6) & 0x1f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
        else if (ch >= 0x800 && ch <= 0xffff) {
            utf8Str += String.fromCharCode(0xe0 | ((ch >> 12) & 0xf));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 6) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
        else if (ch >= 0x10000 && ch <= 0x1fffff) {
            utf8Str += String.fromCharCode(0xf0 | ((ch >> 18) & 0x7));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 12) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 6) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
        else if (ch >= 0x200000 && ch <= 0x3ffffff) {
            utf8Str += String.fromCharCode(0xf8 | ((ch >> 24) & 0x3));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 18) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 12) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 6) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
        else if (ch >= 0x4000000 && ch <= 0x7fffffff) {
            utf8Str += String.fromCharCode(0xfc | ((ch >> 30) & 0x1));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 24) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 18) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 12) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | ((ch >> 6) & 0x3f));
            utf8Str += String.fromCharCode(0x80 | (ch & 0x3f));
        }
    }
    return utf8Str;
}
exports.unicodeToUtf8 = unicodeToUtf8;
function ping(host, cb) {
    if (!isLocal(host)) {
        let cmd = "ping -w 15 " + host;
        child_process_1.exec(cmd, function (err, stdout, stderr) {
            if (!!err) {
                cb(false);
                return;
            }
            cb(true);
        });
    }
    else {
        cb(true);
    }
}
exports.ping = ping;
function checkPort(server, cb) {
    if (!server.port && !server.clientPort) {
        invokeCallback(cb, "leisure");
        return;
    }
    let port = server.port || server.clientPort;
    let host = server.host;
    let generateCommand = function (host, port) {
        let cmd;
        let ssh_params = pomelo_1.default.app.get(Constants.RESERVED.SSH_CONFIG_PARAMS);
        if (!!ssh_params && Array.isArray(ssh_params)) {
            ssh_params = ssh_params.join(" ");
        }
        else {
            ssh_params = "";
        }
        if (!isLocal(host)) {
            cmd = util.format("ssh %s %s \"netstat -an|awk '{print $4}'|grep %s|wc -l\"", host, ssh_params, port);
        }
        else {
            cmd = util.format("netstat -an|awk '{print $4}'|grep %s|wc -l", port);
        }
        return cmd;
    };
    let cmd1 = generateCommand(host, port);
    let child = child_process_1.exec(cmd1, function (err, stdout, stderr) {
        if (err) {
            logger.error("command %s execute with error: %j", cmd1, err.stack);
            invokeCallback(cb, "error");
        }
        else if (stdout.trim() !== "0") {
            invokeCallback(cb, "busy");
        }
        else {
            port = server.clientPort;
            let cmd2 = generateCommand(host, port);
            child_process_1.exec(cmd2, function (err, stdout, stderr) {
                if (err) {
                    logger.error("command %s execute with error: %j", cmd2, err.stack);
                    invokeCallback(cb, "error");
                }
                else if (stdout.trim() !== "0") {
                    invokeCallback(cb, "busy");
                }
                else {
                    invokeCallback(cb, "leisure");
                }
            });
        }
    });
}
exports.checkPort = checkPort;
function isLocal(host) {
    let app = require("../pomelo").app;
    if (!app) {
        return (host === "127.0.0.1" ||
            host === "localhost" ||
            host === "0.0.0.0" ||
            inLocal(host));
    }
    else {
        return (host === "127.0.0.1" ||
            host === "localhost" ||
            host === "0.0.0.0" ||
            inLocal(host) ||
            host === app.master.host);
    }
}
exports.isLocal = isLocal;
function extend(origin, add) {
    if (!add || !isObject(add))
        return origin;
    let keys = Object.keys(add);
    let i = keys.length;
    while (i--) {
        origin[keys[i]] = add[keys[i]];
    }
    return origin;
}
exports.extend = extend;
function headHandler(headBuffer) {
    let len = 0;
    for (let i = 1; i < 4; i++) {
        if (i > 1) {
            len <<= 8;
        }
        len += headBuffer.readUInt8(i);
    }
    return len;
}
exports.headHandler = headHandler;
function inLocal(host) {
    for (let index in localIps) {
        if (host === localIps[index]) {
            return true;
        }
    }
    return false;
}
let localIps = (function () {
    let ifaces = os.networkInterfaces();
    let ips = [];
    let func = function (details) {
        if (details.family === "IPv4") {
            ips.push(details.address);
        }
    };
    for (let dev in ifaces) {
        ifaces[dev].forEach(func);
    }
    return ips;
})();
function isObject(arg) {
    return typeof arg === "object" && arg !== null;
}
exports.isObject = isObject;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUFDOUIsaURBQXFDO0FBQ3JDLHlDQUEwQztBQUMxQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUV4RSxzQ0FBK0I7QUFFL0Isd0JBQStCLEVBQVksRUFBRSxHQUFHLElBQVc7SUFDekQsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztRQUM3QixJQUFJLEdBQUcsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO1FBQzNCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2IsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2IsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQixDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDYixNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QyxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDYixNQUFNLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEQsQ0FBQztRQUVELElBQUksSUFBSSxH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QyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxLQUFLLElBQUksRUFBRSxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDdkMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzFELE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLE9BQU8sSUFBSSxFQUFFLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQztZQUMzQyxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFELE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDM0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxRQUFRLElBQUksRUFBRSxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDN0MsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzNELE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDM0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxTQUFTLElBQUksRUFBRSxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDL0MsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLElBQUksTUFBTSxDQUFD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QixHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM1QixDQUFDO0lBQ0gsQ0FBQyxDQUFDO0lBQ0YsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQztRQUN2QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFDRCxNQUFNLENBQUMsR0FBRyxDQUFDO0FBQ2IsQ0FBQyxDQUFDLEVBQUUsQ0FBQztBQUVMLGtCQUF5QixHQUFRO0lBQy9CLE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUksR0FBRyxLQUFLLElBQUksQ0FBQztBQUNqRCxDQUFDO0FBRkQsNEJBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgb3MgPSByZXF1aXJlKFwib3NcIik7XG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgQ29uc3RhbnRzID0gcmVxdWlyZShcIi4vY29uc3RhbnRzXCIpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwicG9tZWxvXCIsIF9fZmlsZW5hbWUpO1xuaW1wb3J0IHsgQXBwbGljYXRpb24sIFNlcnZlckluZm8gfSBmcm9tIFwiLi4vYXBwbGljYXRpb25cIjtcbmltcG9ydCBwb21lbG8gZnJvbSBcIi4uL3BvbWVsb1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gaW52b2tlQ2FsbGJhY2soY2I6IEZ1bmN0aW9uLCAuLi5hcmdzOiBhbnlbXSkge1xuICBpZiAodHlwZW9mIGNiID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICBsZXQgbGVuID0gYXJndW1lbnRzLmxlbmd0aDtcbiAgICBpZiAobGVuID09IDEpIHtcbiAgICAgIHJldHVybiBjYigpO1xuICAgIH1cblxuICAgIGlmIChsZW4gPT0gMikge1xuICAgICAgcmV0dXJuIGNiKGFyZ3VtZW50c1sxXSk7XG4gICAgfVxuXG4gICAgaWYgKGxlbiA9PSAzKSB7XG4gICAgICByZXR1cm4gY2IoYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0pO1xuICAgIH1cblxuICAgIGlmIChsZW4gPT0gNCkge1xuICAgICAgcmV0dXJuIGNiKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10pO1xuICAgIH1cblxuICAgIGxldCBhcmdzID0gQXJyYXkobGVuIC0gMSk7XG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW47IGkrKykgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07XG4gICAgY2IuYXBwbHkobnVsbCwgYXJncyk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNpemUob2JqOiBhbnkpOiBudW1iZXIge1xuICBsZXQgY291bnQgPSAwO1xuICBmb3IgKGxldCBpIGluIG9iaikge1xuICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoaSkgJiYgdHlwZW9mIG9ialtpXSAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjb3VudCsrO1xuICAgIH1cbiAgfVxuICByZXR1cm4gY291bnQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlbmRzV2l0aChzdHI6IHN0cmluZywgc3VmZml4OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgaWYgKFxuICAgIHR5cGVvZiBzdHIgIT09IFwic3RyaW5nXCIgfHxcbiAgICB0eXBlb2Ygc3VmZml4ICE9PSBcInN0cmluZ1wiIHx8XG4gICAgc3VmZml4Lmxlbmd0aCA+IHN0ci5sZW5ndGhcbiAgKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIHJldHVybiBzdHIuaW5kZXhPZihzdWZmaXgsIHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdGFydFdpdGgoc3RyOiBzdHJpbmcsIHByZWZpeDogc3RyaW5nKTogYm9vbGVhbiB7XG4gIGlmIChcbiAgICB0eXBlb2Ygc3RyICE9PSBcInN0cmluZ1wiIHx8XG4gICAgdHlwZW9mIHByZWZpeCAhPT0gXCJzdHJpbmdcIiB8fFxuICAgIHByZWZpeC5sZW5ndGggPiBzdHIubGVuZ3RoXG4gICkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICByZXR1cm4gc3RyLmluZGV4T2YocHJlZml4KSA9PT0gMDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFycmF5RGlmZihhcnJheTE6IEFycmF5PGFueT4sIGFycmF5MjogQXJyYXk8YW55Pikge1xuICBsZXQgbyA9IHt9IGFzIHsgW2lkeDogc3RyaW5nXTogYm9vbGVhbiB9O1xuICBmb3IgKGxldCBpID0gMCwgbGVuID0gYXJyYXkyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgb1thcnJheTJbaV1dID0gdHJ1ZTtcbiAgfVxuXG4gIGxldCByZXN1bHQgPSBbXTtcbiAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGFycmF5MS5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgIGxldCB2ID0gYXJyYXkxW2ldO1xuICAgIGlmIChvW3ZdKSBjb250aW51ZTtcbiAgICByZXN1bHQucHVzaCh2KTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0KGRhdGU6IERhdGUsIGZvcm1hdD86IHN0cmluZykge1xuICBmb3JtYXQgPSBmb3JtYXQgfHwgXCJNTWRkaGhtbVwiO1xuICBsZXQgbzogeyBbaWR4OiBzdHJpbmddOiBudW1iZXIgfSA9IHtcbiAgICBcIk0rXCI6IGRhdGUuZ2V0TW9udGgoKSArIDEsIC8vbW9udGhcbiAgICBcImQrXCI6IGRhdGUuZ2V0RGF0ZSgpLCAvL2RheVxuICAgIFwiaCtcIjogZGF0ZS5nZXRIb3VycygpLCAvL2hvdXJcbiAgICBcIm0rXCI6IGRhdGUuZ2V0TWludXRlcygpLCAvL21pbnV0ZVxuICAgIFwicytcIjogZGF0ZS5nZXRTZWNvbmRzKCksIC8vc2Vjb25kXG4gICAgXCJxK1wiOiBNYXRoLmZsb29yKChkYXRlLmdldE1vbnRoKCkgKyAzKSAvIDMpLCAvL3F1YXJ0ZXJcbiAgICBTOiBkYXRlLmdldE1pbGxpc2Vjb25kcygpIC8vbWlsbGlzZWNvbmRcbiAgfTtcblxuICBpZiAoLyh5KykvLnRlc3QoZm9ybWF0KSkge1xuICAgIGZvcm1hdCA9IGZvcm1hdC5yZXBsYWNlKFxuICAgICAgUmVnRXhwLiQxLFxuICAgICAgKGRhdGUuZ2V0RnVsbFllYXIoKSArIFwiXCIpLnN1YnN0cig0IC0gUmVnRXhwLiQxLmxlbmd0aClcbiAgICApO1xuICB9XG5cbiAgZm9yIChsZXQgayBpbiBvKSB7XG4gICAgaWYgKG5ldyBSZWdFeHAoXCIoXCIgKyBrICsgXCIpXCIpLnRlc3QoZm9ybWF0KSkge1xuICAgICAgZm9ybWF0ID0gZm9ybWF0LnJlcGxhY2UoXG4gICAgICAgIFJlZ0V4cC4kMSxcbiAgICAgICAgUmVnRXhwLiQxLmxlbmd0aCA9PT0gMVxuICAgICAgICAgID8gb1trXS50b1N0cmluZygpXG4gICAgICAgICAgOiAoXCIwMFwiICsgb1trXSkuc3Vic3RyKChcIlwiICsgb1trXSkubGVuZ3RoKVxuICAgICAgKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZvcm1hdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc0NoaW5lc2VDaGFyKHN0cjogc3RyaW5nKTogYm9vbGVhbiB7XG4gIGlmICgvLipbXFx1NGUwMC1cXHU5ZmE1XSsuKiQvLnRlc3Qoc3RyKSkge1xuICAgIHJldHVybiB0cnVlO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdW5pY29kZVRvVXRmOChzdHI6IHN0cmluZyk6IHN0cmluZyB7XG4gIGxldCBpLCBsZW4sIGNoO1xuICBsZXQgdXRmOFN0ciA9IFwiXCI7XG4gIGxlbiA9IHN0ci5sZW5ndGg7XG4gIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgIGNoID0gc3RyLmNoYXJDb2RlQXQoaSk7XG5cbiAgICBpZiAoY2ggPj0gMHgwICYmIGNoIDw9IDB4N2YpIHtcbiAgICAgIHV0ZjhTdHIgKz0gc3RyLmNoYXJBdChpKTtcbiAgICB9IGVsc2UgaWYgKGNoID49IDB4ODAgJiYgY2ggPD0gMHg3ZmYpIHtcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweGMwIHwgKChjaCA+PiA2KSAmIDB4MWYpKTtcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKGNoICYgMHgzZikpO1xuICAgIH0gZWxzZSBpZiAoY2ggPj0gMHg4MDAgJiYgY2ggPD0gMHhmZmZmKSB7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHhlMCB8ICgoY2ggPj4gMTIpICYgMHhmKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8ICgoY2ggPj4gNikgJiAweDNmKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8IChjaCAmIDB4M2YpKTtcbiAgICB9IGVsc2UgaWYgKGNoID49IDB4MTAwMDAgJiYgY2ggPD0gMHgxZmZmZmYpIHtcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweGYwIHwgKChjaCA+PiAxOCkgJiAweDcpKTtcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjaCA+PiAxMikgJiAweDNmKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8ICgoY2ggPj4gNikgJiAweDNmKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8IChjaCAmIDB4M2YpKTtcbiAgICB9IGVsc2UgaWYgKGNoID49IDB4MjAwMDAwICYmIGNoIDw9IDB4M2ZmZmZmZikge1xuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ZjggfCAoKGNoID4+IDI0KSAmIDB4MykpO1xuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoKGNoID4+IDE4KSAmIDB4M2YpKTtcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjaCA+PiAxMikgJiAweDNmKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8ICgoY2ggPj4gNikgJiAweDNmKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8IChjaCAmIDB4M2YpKTtcbiAgICB9IGVsc2UgaWYgKGNoID49IDB4NDAwMDAwMCAmJiBjaCA8PSAweDdmZmZmZmZmKSB7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHhmYyB8ICgoY2ggPj4gMzApICYgMHgxKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8ICgoY2ggPj4gMjQpICYgMHgzZikpO1xuICAgICAgdXRmOFN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ODAgfCAoKGNoID4+IDE4KSAmIDB4M2YpKTtcbiAgICAgIHV0ZjhTdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweDgwIHwgKChjaCA+PiAxMikgJiAweDNmKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8ICgoY2ggPj4gNikgJiAweDNmKSk7XG4gICAgICB1dGY4U3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoMHg4MCB8IChjaCAmIDB4M2YpKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHV0ZjhTdHI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwaW5nKGhvc3Q6IHN0cmluZywgY2I6IChyZXQ6Ym9vbGVhbik9PnZvaWQpIHtcbiAgaWYgKCFpc0xvY2FsKGhvc3QpKSB7XG4gICAgbGV0IGNtZCA9IFwicGluZyAtdyAxNSBcIiArIGhvc3Q7XG4gICAgZXhlYyhjbWQsIGZ1bmN0aW9uKGVyciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgIGlmICghIWVycikge1xuICAgICAgICBjYihmYWxzZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNiKHRydWUpO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGNiKHRydWUpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGVja1BvcnQoXG4gIHNlcnZlcjogeyBob3N0OiBzdHJpbmc7IHBvcnQ/OiBudW1iZXJ8c3RyaW5nOyBjbGllbnRQb3J0PzogbnVtYmVyfHN0cmluZyB9LFxuICBjYjogRnVuY3Rpb25cbikge1xuICBpZiAoIXNlcnZlci5wb3J0ICYmICFzZXJ2ZXIuY2xpZW50UG9ydCkge1xuICAgIGludm9rZUNhbGxiYWNrKGNiLCBcImxlaXN1cmVcIik7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxldCBwb3J0ID0gc2VydmVyLnBvcnQgfHwgc2VydmVyLmNsaWVudFBvcnQ7XG4gIGxldCBob3N0ID0gc2VydmVyLmhvc3Q7XG4gIGxldCBnZW5lcmF0ZUNvbW1hbmQgPSBmdW5jdGlvbihob3N0OiBzdHJpbmcsIHBvcnQ6IG51bWJlciB8IHN0cmluZykge1xuICAgIGxldCBjbWQ7XG4gICAgbGV0IHNzaF9wYXJhbXMgOiBhbnkgPSBwb21lbG8uYXBwLmdldChDb25zdGFudHMuUkVTRVJWRUQuU1NIX0NPTkZJR19QQVJBTVMpO1xuICAgIGlmICghIXNzaF9wYXJhbXMgJiYgQXJyYXkuaXNBcnJheShzc2hfcGFyYW1zKSkge1xuICAgICAgc3NoX3BhcmFtcyA9IHNzaF9wYXJhbXMuam9pbihcIiBcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNzaF9wYXJhbXMgPSBcIlwiO1xuICAgIH1cbiAgICBpZiAoIWlzTG9jYWwoaG9zdCkpIHtcbiAgICAgIGNtZCA9IHV0aWwuZm9ybWF0KFxuICAgICAgICBcInNzaCAlcyAlcyBcXFwibmV0c3RhdCAtYW58YXdrICd7cHJpbnQgJDR9J3xncmVwICVzfHdjIC1sXFxcIlwiLFxuICAgICAgICBob3N0LFxuICAgICAgICBzc2hfcGFyYW1zLFxuICAgICAgICBwb3J0XG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjbWQgPSB1dGlsLmZvcm1hdChcIm5ldHN0YXQgLWFufGF3ayAne3ByaW50ICQ0fSd8Z3JlcCAlc3x3YyAtbFwiLCBwb3J0KTtcbiAgICB9XG4gICAgcmV0dXJuIGNtZDtcbiAgfTtcbiAgbGV0IGNtZDEgPSBnZW5lcmF0ZUNvbW1hbmQoaG9zdCwgcG9ydCEpO1xuICBsZXQgY2hpbGQgPSBleGVjKGNtZDEsIGZ1bmN0aW9uKGVyciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXCJjb21tYW5kICVzIGV4ZWN1dGUgd2l0aCBlcnJvcjogJWpcIiwgY21kMSwgZXJyLnN0YWNrKTtcbiAgICAgIGludm9rZUNhbGxiYWNrKGNiLCBcImVycm9yXCIpO1xuICAgIH0gZWxzZSBpZiAoc3Rkb3V0LnRyaW0oKSAhPT0gXCIwXCIpIHtcbiAgICAgIGludm9rZUNhbGxiYWNrKGNiLCBcImJ1c3lcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBvcnQgPSBzZXJ2ZXIuY2xpZW50UG9ydDtcbiAgICAgIGxldCBjbWQyID0gZ2VuZXJhdGVDb21tYW5kKGhvc3QsIHBvcnQhKTtcbiAgICAgIGV4ZWMoY21kMiwgZnVuY3Rpb24oZXJyLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKFwiY29tbWFuZCAlcyBleGVjdXRlIHdpdGggZXJyb3I6ICVqXCIsIGNtZDIsIGVyci5zdGFjayk7XG4gICAgICAgICAgaW52b2tlQ2FsbGJhY2soY2IsIFwiZXJyb3JcIik7XG4gICAgICAgIH0gZWxzZSBpZiAoc3Rkb3V0LnRyaW0oKSAhPT0gXCIwXCIpIHtcbiAgICAgICAgICBpbnZva2VDYWxsYmFjayhjYiwgXCJidXN5XCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGludm9rZUNhbGxiYWNrKGNiLCBcImxlaXN1cmVcIik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0xvY2FsKGhvc3Q6IHN0cmluZykge1xuICBsZXQgYXBwID0gcmVxdWlyZShcIi4uL3BvbWVsb1wiKS5hcHA7XG4gIGlmICghYXBwKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIGhvc3QgPT09IFwiMTI3LjAuMC4xXCIgfHxcbiAgICAgIGhvc3QgPT09IFwibG9jYWxob3N0XCIgfHxcbiAgICAgIGhvc3QgPT09IFwiMC4wLjAuMFwiIHx8XG4gICAgICBpbkxvY2FsKGhvc3QpXG4gICAgKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gKFxuICAgICAgaG9zdCA9PT0gXCIxMjcuMC4wLjFcIiB8fFxuICAgICAgaG9zdCA9PT0gXCJsb2NhbGhvc3RcIiB8fFxuICAgICAgaG9zdCA9PT0gXCIwLjAuMC4wXCIgfHxcbiAgICAgIGluTG9jYWwoaG9zdCkgfHxcbiAgICAgIGhvc3QgPT09IGFwcC5tYXN0ZXIuaG9zdFxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4dGVuZChvcmlnaW46IGFueSwgYWRkOiBhbnkpOiBhbnkge1xuICBpZiAoIWFkZCB8fCAhaXNPYmplY3QoYWRkKSkgcmV0dXJuIG9yaWdpbjtcblxuICBsZXQga2V5cyA9IE9iamVjdC5rZXlzKGFkZCk7XG4gIGxldCBpID0ga2V5cy5sZW5ndGg7XG4gIHdoaWxlIChpLS0pIHtcbiAgICBvcmlnaW5ba2V5c1tpXV0gPSBhZGRba2V5c1tpXV07XG4gIH1cbiAgcmV0dXJuIG9yaWdpbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhlYWRIYW5kbGVyKGhlYWRCdWZmZXI6IEJ1ZmZlcikge1xuICBsZXQgbGVuID0gMDtcbiAgZm9yIChsZXQgaSA9IDE7IGkgPCA0OyBpKyspIHtcbiAgICBpZiAoaSA+IDEpIHtcbiAgICAgIGxlbiA8PD0gODtcbiAgICB9XG4gICAgbGVuICs9IGhlYWRCdWZmZXIucmVhZFVJbnQ4KGkpO1xuICB9XG4gIHJldHVybiBsZW47XG59XG5cbmZ1bmN0aW9uIGluTG9jYWwoaG9zdDogc3RyaW5nKSB7XG4gIGZvciAobGV0IGluZGV4IGluIGxvY2FsSXBzKSB7XG4gICAgaWYgKGhvc3QgPT09IGxvY2FsSXBzW2luZGV4XSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxubGV0IGxvY2FsSXBzID0gKGZ1bmN0aW9uKCkge1xuICBsZXQgaWZhY2VzID0gb3MubmV0d29ya0ludGVyZmFjZXMoKTtcbiAgbGV0IGlwczogc3RyaW5nW10gPSBbXTtcbiAgbGV0IGZ1bmMgPSBmdW5jdGlvbihkZXRhaWxzOiBhbnkpIHtcbiAgICBpZiAoZGV0YWlscy5mYW1pbHkgPT09IFwiSVB2NFwiKSB7XG4gICAgICBpcHMucHVzaChkZXRhaWxzLmFkZHJlc3MpO1xuICAgIH1cbiAgfTtcbiAgZm9yIChsZXQgZGV2IGluIGlmYWNlcykge1xuICAgIGlmYWNlc1tkZXZdLmZvckVhY2goZnVuYyk7XG4gIH1cbiAgcmV0dXJuIGlwcztcbn0pKCk7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc09iamVjdChhcmc6IGFueSkge1xuICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gXCJvYmplY3RcIiAmJiBhcmcgIT09IG51bGw7XG59XG4iXX0=