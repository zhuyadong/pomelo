"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os = require("os");
let admin = require("pomelo-admin");
const utils = require("./utils");
const pathUtil = require("./pathUtil");
const starter = require("../master/starter");
const constants_1 = require("./constants");
let logger = require("pomelo-logger").getLogger("pomelo", __filename);
//TODO:self & consoleService types
function loadModules(self, consoleService) {
    // load app register modules
    let _modules = self.app.get(constants_1.KEYWORDS.MODULE);
    if (!_modules) {
        return;
    }
    let modules = [];
    for (let m in _modules) {
        modules.push(_modules[m]);
    }
    for (let i = 0, l = modules.length; i < l; i++) {
        let module;
        let record = modules[i];
        if (typeof record.module === "function") {
            module = record.module(record.opts, consoleService);
        }
        else {
            module = record.module;
        }
        let moduleId = record.moduleId || module.moduleId;
        if (!moduleId) {
            logger.warn("ignore an unknown module.");
            continue;
        }
        consoleService.register(moduleId, module);
        self.modules.push(module);
    }
}
exports.loadModules = loadModules;
function startModules(modules, cb) {
    // invoke the start lifecycle method of modules
    if (!modules) {
        return;
    }
    startModule(null, modules, 0, cb);
}
exports.startModules = startModules;
function registerDefaultModules(isMaster, app, closeWatcher = false) {
    if (!closeWatcher) {
        if (isMaster) {
            app.registerAdmin(require("../modules/masterwatcher"), { app: app });
        }
        else {
            app.registerAdmin(require("../modules/monitorwatcher"), { app: app });
        }
    }
    app.registerAdmin(admin.modules.watchServer, { app: app });
    app.registerAdmin(require("../modules/console"), {
        app: app,
        starter: starter
    });
    if (app.enabled("systemMonitor")) {
        if (os.platform() !== constants_1.PLATFORM.WIN) {
            app.registerAdmin(admin.modules.systemInfo);
            app.registerAdmin(admin.modules.nodeInfo);
        }
        app.registerAdmin(admin.modules.monitorLog, {
            path: pathUtil.getLogPath(app.base)
        });
        app.registerAdmin(admin.modules.scripts, {
            app: app,
            path: pathUtil.getScriptPath(app.base)
        });
        if (os.platform() !== constants_1.PLATFORM.WIN) {
            app.registerAdmin(admin.modules.profiler);
        }
    }
}
exports.registerDefaultModules = registerDefaultModules;
function startModule(err, modules, index, cb) {
    if (err || index >= modules.length) {
        utils.invokeCallback(cb, err);
        return;
    }
    let module = modules[index];
    if (module && typeof module.start === "function") {
        module.start(function (err) {
            startModule(err, modules, index + 1, cb);
        });
    }
    else {
        startModule(err, modules, index + 1, cb);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlVXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1vZHVsZVV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBMEI7QUFDMUIsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQ3BDLGlDQUFrQztBQUNsQyx1Q0FBd0M7QUFDeEMsNkNBQThDO0FBRTlDLDJDQUFpRDtBQUdqRCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUV0RSxrQ0FBa0M7QUFDbEMscUJBQTRCLElBQVMsRUFBRSxjQUFtQjtJQUN4RCw0QkFBNEI7SUFDNUIsSUFBSSxRQUFRLEdBQW1CLElBQUksQ0FBQyxHQUFJLENBQUMsR0FBRyxDQUFDLG9CQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFOUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2QsTUFBTSxDQUFDO0lBQ1QsQ0FBQztJQUVELElBQUksT0FBTyxHQUFpQixFQUFFLENBQUM7SUFDL0IsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQztRQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFRCxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQy9DLElBQUksTUFBZSxDQUFDO1FBQ3BCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixFQUFFLENBQUMsQ0FBQyxPQUFPLE1BQU0sQ0FBQyxNQUFNLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FB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LEtBQUssb0JBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ25DLEdBQUcsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1QyxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFqQ0Qsd0RBaUNDO0FBRUQscUJBQ0UsR0FBUSxFQUNSLE9BQWlCLEVBQ2pCLEtBQWEsRUFDYixFQUFhO0lBRWIsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLEtBQUssSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNuQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMvQixNQUFNLENBQUM7SUFDVCxDQUFDO0lBRUQsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzVCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxPQUFPLE1BQU0sQ0FBQyxLQUFLLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBUTtZQUM1QixXQUFXLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sV0FBVyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBvcyA9IHJlcXVpcmUoXCJvc1wiKTtcclxubGV0IGFkbWluID0gcmVxdWlyZShcInBvbWVsby1hZG1pblwiKTtcclxuaW1wb3J0IHV0aWxzID0gcmVxdWlyZShcIi4vdXRpbHNcIik7XHJcbmltcG9ydCBwYXRoVXRpbCA9IHJlcXVpcmUoXCIuL3BhdGhVdGlsXCIpO1xyXG5pbXBvcnQgc3RhcnRlciA9IHJlcXVpcmUoXCIuLi9tYXN0ZXIvc3RhcnRlclwiKTtcclxuaW1wb3J0IHsgQ29tcG9uZW50LCBNb2R1bGUsIE1vZHVsZUluZm9NYXAgfSBmcm9tICcuLi9hcHBsaWNhdGlvbic7XHJcbmltcG9ydCB7IEtFWVdPUkRTLCBQTEFURk9STSB9IGZyb20gXCIuL2NvbnN0YW50c1wiO1xyXG5pbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCIuLi9pbmRleFwiO1xyXG5pbXBvcnQgeyBNb2R1bGVJbmZvIH0gZnJvbSBcIi4uLy4uL2luZGV4XCI7XHJcbmxldCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XHJcblxyXG4vL1RPRE86c2VsZiAmIGNvbnNvbGVTZXJ2aWNlIHR5cGVzXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkTW9kdWxlcyhzZWxmOiBhbnksIGNvbnNvbGVTZXJ2aWNlOiBhbnkpIHtcclxuICAvLyBsb2FkIGFwcCByZWdpc3RlciBtb2R1bGVzXHJcbiAgbGV0IF9tb2R1bGVzIDogTW9kdWxlSW5mb01hcCA9IHNlbGYuYXBwIS5nZXQoS0VZV09SRFMuTU9EVUxFKTtcclxuXHJcbiAgaWYgKCFfbW9kdWxlcykge1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgbGV0IG1vZHVsZXMgOk1vZHVsZUluZm9bXSA9IFtdO1xyXG4gIGZvciAobGV0IG0gaW4gX21vZHVsZXMpIHtcclxuICAgIG1vZHVsZXMucHVzaChfbW9kdWxlc1ttXSk7XHJcbiAgfVxyXG5cclxuICBmb3IgKGxldCBpID0gMCwgbCA9IG1vZHVsZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICBsZXQgbW9kdWxlIDogTW9kdWxlO1xyXG4gICAgbGV0IHJlY29yZCA9IG1vZHVsZXNbaV07XHJcbiAgICBpZiAodHlwZW9mIHJlY29yZC5tb2R1bGUgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICBtb2R1bGUgPSByZWNvcmQubW9kdWxlKHJlY29yZC5vcHRzLCBjb25zb2xlU2VydmljZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBtb2R1bGUgPSByZWNvcmQubW9kdWxlO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBtb2R1bGVJZCA9IHJlY29yZC5tb2R1bGVJZCB8fCBtb2R1bGUubW9kdWxlSWQ7XHJcblxyXG4gICAgaWYgKCFtb2R1bGVJZCkge1xyXG4gICAgICBsb2dnZXIud2FybihcImlnbm9yZSBhbiB1bmtub3duIG1vZHVsZS5cIik7XHJcbiAgICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnNvbGVTZXJ2aWNlLnJlZ2lzdGVyKG1vZHVsZUlkLCBtb2R1bGUpO1xyXG4gICAgc2VsZi5tb2R1bGVzLnB1c2gobW9kdWxlKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzdGFydE1vZHVsZXMobW9kdWxlczogTW9kdWxlW10sIGNiPzogRnVuY3Rpb24pIHtcclxuICAvLyBpbnZva2UgdGhlIHN0YXJ0IGxpZmVjeWNsZSBtZXRob2Qgb2YgbW9kdWxlc1xyXG5cclxuICBpZiAoIW1vZHVsZXMpIHtcclxuICAgIHJldHVybjtcclxuICB9XHJcbiAgc3RhcnRNb2R1bGUobnVsbCwgbW9kdWxlcywgMCwgY2IpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJEZWZhdWx0TW9kdWxlcyhcclxuICBpc01hc3RlcjogYm9vbGVhbixcclxuICBhcHA6IEFwcGxpY2F0aW9uLFxyXG4gIGNsb3NlV2F0Y2hlcjogYm9vbGVhbiA9IGZhbHNlXHJcbikge1xyXG4gIGlmICghY2xvc2VXYXRjaGVyKSB7XHJcbiAgICBpZiAoaXNNYXN0ZXIpIHtcclxuICAgICAgYXBwLnJlZ2lzdGVyQWRtaW4ocmVxdWlyZShcIi4uL21vZHVsZXMvbWFzdGVyd2F0Y2hlclwiKSwgeyBhcHA6IGFwcCB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGFwcC5yZWdpc3RlckFkbWluKHJlcXVpcmUoXCIuLi9tb2R1bGVzL21vbml0b3J3YXRjaGVyXCIpLCB7IGFwcDogYXBwIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBhcHAucmVnaXN0ZXJBZG1pbihhZG1pbi5tb2R1bGVzLndhdGNoU2VydmVyLCB7IGFwcDogYXBwIH0pO1xyXG4gIGFwcC5yZWdpc3RlckFkbWluKHJlcXVpcmUoXCIuLi9tb2R1bGVzL2NvbnNvbGVcIiksIHtcclxuICAgIGFwcDogYXBwLFxyXG4gICAgc3RhcnRlcjogc3RhcnRlclxyXG4gIH0pO1xyXG4gIGlmIChhcHAuZW5hYmxlZChcInN5c3RlbU1vbml0b3JcIikpIHtcclxuICAgIGlmIChvcy5wbGF0Zm9ybSgpICE9PSBQTEFURk9STS5XSU4pIHtcclxuICAgICAgYXBwLnJlZ2lzdGVyQWRtaW4oYWRtaW4ubW9kdWxlcy5zeXN0ZW1JbmZvKTtcclxuICAgICAgYXBwLnJlZ2lzdGVyQWRtaW4oYWRtaW4ubW9kdWxlcy5ub2RlSW5mbyk7XHJcbiAgICB9XHJcbiAgICBhcHAucmVnaXN0ZXJBZG1pbihhZG1pbi5tb2R1bGVzLm1vbml0b3JMb2csIHtcclxuICAgICAgcGF0aDogcGF0aFV0aWwuZ2V0TG9nUGF0aChhcHAuYmFzZSlcclxuICAgIH0pO1xyXG4gICAgYXBwLnJlZ2lzdGVyQWRtaW4oYWRtaW4ubW9kdWxlcy5zY3JpcHRzLCB7XHJcbiAgICAgIGFwcDogYXBwLFxyXG4gICAgICBwYXRoOiBwYXRoVXRpbC5nZXRTY3JpcHRQYXRoKGFwcC5iYXNlKVxyXG4gICAgfSk7XHJcbiAgICBpZiAob3MucGxhdGZvcm0oKSAhPT0gUExBVEZPUk0uV0lOKSB7XHJcbiAgICAgIGFwcC5yZWdpc3RlckFkbWluKGFkbWluLm1vZHVsZXMucHJvZmlsZXIpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gc3RhcnRNb2R1bGUoXHJcbiAgZXJyOiBhbnksXHJcbiAgbW9kdWxlczogTW9kdWxlW10sXHJcbiAgaW5kZXg6IG51bWJlcixcclxuICBjYj86IEZ1bmN0aW9uXHJcbikge1xyXG4gIGlmIChlcnIgfHwgaW5kZXggPj0gbW9kdWxlcy5sZW5ndGgpIHtcclxuICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISwgZXJyKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIGxldCBtb2R1bGUgPSBtb2R1bGVzW2luZGV4XTtcclxuICBpZiAobW9kdWxlICYmIHR5cGVvZiBtb2R1bGUuc3RhcnQgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgbW9kdWxlLnN0YXJ0KGZ1bmN0aW9uKGVycjogYW55KSB7XHJcbiAgICAgIHN0YXJ0TW9kdWxlKGVyciwgbW9kdWxlcywgaW5kZXggKyAxLCBjYik7XHJcbiAgICB9KTtcclxuICB9IGVsc2Uge1xyXG4gICAgc3RhcnRNb2R1bGUoZXJyLCBtb2R1bGVzLCBpbmRleCArIDEsIGNiKTtcclxuICB9XHJcbn1cclxuIl19