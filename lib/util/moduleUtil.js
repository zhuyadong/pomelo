"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os = require("os");
const admin = require("pomelo-admin");
const utils = require("./utils");
const pathUtil = require("./pathUtil");
const starter = require("../master/starter");
const constants_1 = require("./constants");
let logger = require("pomelo-logger").getLogger("pomelo", __filename);
//TODO:self & consoleService types
function loadModules(self, consoleService) {
    // load app register modules
    let _modules = self.app.get(constants_1.KEYWORDS.MODULE);
    if (!_modules) {
        return;
    }
    let modules = [];
    for (let m in _modules) {
        modules.push(_modules[m]);
    }
    for (let i = 0, l = modules.length; i < l; i++) {
        let module;
        let record = modules[i];
        if (typeof record.module === "function") {
            module = record.module(record.opts, consoleService);
        }
        else {
            module = record.module;
        }
        let moduleId = record.moduleId || module.moduleId;
        if (!moduleId) {
            logger.warn("ignore an unknown module.");
            continue;
        }
        consoleService.register(moduleId, module);
        self.modules.push(module);
    }
}
exports.loadModules = loadModules;
function startModules(modules, cb) {
    // invoke the start lifecycle method of modules
    if (!modules) {
        return;
    }
    startModule(null, modules, 0, cb);
}
exports.startModules = startModules;
function registerDefaultModules(isMaster, app, closeWatcher = false) {
    if (!closeWatcher) {
        if (isMaster) {
            app.registerAdmin(require("../modules/masterwatcher"), { app: app });
        }
        else {
            app.registerAdmin(require("../modules/monitorwatcher"), { app: app });
        }
    }
    app.registerAdmin(admin.modules.watchServer, { app: app });
    app.registerAdmin(require("../modules/console"), {
        app: app,
        starter: starter
    });
    if (app.enabled("systemMonitor")) {
        if (os.platform() !== constants_1.PLATFORM.WIN) {
            app.registerAdmin(admin.modules.systemInfo);
            app.registerAdmin(admin.modules.nodeInfo);
        }
        app.registerAdmin(admin.modules.monitorLog, {
            path: pathUtil.getLogPath(app.base)
        });
        app.registerAdmin(admin.modules.scripts, {
            app: app,
            path: pathUtil.getScriptPath(app.base)
        });
        if (os.platform() !== constants_1.PLATFORM.WIN) {
            app.registerAdmin(admin.modules.profiler);
        }
    }
}
exports.registerDefaultModules = registerDefaultModules;
function startModule(err, modules, index, cb) {
    if (err || index >= modules.length) {
        utils.invokeCallback(cb, err);
        return;
    }
    let module = modules[index];
    if (module && typeof module.start === "function") {
        module.start(function (err) {
            startModule(err, modules, index + 1, cb);
        });
    }
    else {
        startModule(err, modules, index + 1, cb);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlVXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1vZHVsZVV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBMEI7QUFDMUIsc0NBQXVDO0FBQ3ZDLGlDQUFrQztBQUNsQyx1Q0FBd0M7QUFDeEMsNkNBQThDO0FBRTlDLDJDQUFpRDtBQUlqRCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUV0RSxrQ0FBa0M7QUFDbEMscUJBQTRCLElBQVMsRUFBRSxjQUE4QjtJQUNuRSw0QkFBNEI7SUFDNUIsSUFBSSxRQUFRLEdBQW1CLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLG9CQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFN0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2QsTUFBTSxDQUFDO0lBQ1QsQ0FBQztJQUVELElBQUksT0FBTyxHQUFpQixFQUFFLENBQUM7SUFDL0IsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQztRQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFRCxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQy9DLElBQUksTUFBZSxDQUFDO1FBQ3BCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixFQUFFLENBQUMsQ0FBQyxPQUFPLE1BQU0sQ0FBQyxNQUFNLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztZQUN4QyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0s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QUFDO1lBQ25DLEdBQUcsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1QyxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFqQ0Qsd0RBaUNDO0FBRUQscUJBQ0UsR0FBUSxFQUNSLE9BQWlCLEVBQ2pCLEtBQWEsRUFDYixFQUFhO0lBRWIsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLEtBQUssSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNuQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUMvQixNQUFNLENBQUM7SUFDVCxDQUFDO0lBRUQsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzVCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxPQUFPLE1BQU0sQ0FBQyxLQUFLLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVMsR0FBUTtZQUM1QixXQUFXLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sV0FBVyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBvcyA9IHJlcXVpcmUoXCJvc1wiKTtcbmltcG9ydCBhZG1pbiA9IHJlcXVpcmUoXCJwb21lbG8tYWRtaW5cIik7XG5pbXBvcnQgdXRpbHMgPSByZXF1aXJlKFwiLi91dGlsc1wiKTtcbmltcG9ydCBwYXRoVXRpbCA9IHJlcXVpcmUoXCIuL3BhdGhVdGlsXCIpO1xuaW1wb3J0IHN0YXJ0ZXIgPSByZXF1aXJlKFwiLi4vbWFzdGVyL3N0YXJ0ZXJcIik7XG5pbXBvcnQgeyBDb21wb25lbnQsIE1vZHVsZUluZm9NYXAgfSBmcm9tICcuLi9hcHBsaWNhdGlvbic7XG5pbXBvcnQgeyBLRVlXT1JEUywgUExBVEZPUk0gfSBmcm9tIFwiLi9jb25zdGFudHNcIjtcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBNb2R1bGUgfSBmcm9tIFwiLi4vaW5kZXhcIjtcbmltcG9ydCB7IE1vZHVsZUluZm8gfSBmcm9tIFwiLi4vLi4vaW5kZXhcIjtcbmltcG9ydCB7IENvbnNvbGVTZXJ2aWNlIH0gZnJvbSBcInBvbWVsby1hZG1pblwiO1xubGV0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcblxuLy9UT0RPOnNlbGYgJiBjb25zb2xlU2VydmljZSB0eXBlc1xuZXhwb3J0IGZ1bmN0aW9uIGxvYWRNb2R1bGVzKHNlbGY6IGFueSwgY29uc29sZVNlcnZpY2U6IENvbnNvbGVTZXJ2aWNlKSB7XG4gIC8vIGxvYWQgYXBwIHJlZ2lzdGVyIG1vZHVsZXNcbiAgbGV0IF9tb2R1bGVzIDogTW9kdWxlSW5mb01hcCA9IHNlbGYuYXBwLmdldChLRVlXT1JEUy5NT0RVTEUpO1xuXG4gIGlmICghX21vZHVsZXMpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQgbW9kdWxlcyA6TW9kdWxlSW5mb1tdID0gW107XG4gIGZvciAobGV0IG0gaW4gX21vZHVsZXMpIHtcbiAgICBtb2R1bGVzLnB1c2goX21vZHVsZXNbbV0pO1xuICB9XG5cbiAgZm9yIChsZXQgaSA9IDAsIGwgPSBtb2R1bGVzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgIGxldCBtb2R1bGUgOiBNb2R1bGU7XG4gICAgbGV0IHJlY29yZCA9IG1vZHVsZXNbaV07XG4gICAgaWYgKHR5cGVvZiByZWNvcmQubW9kdWxlID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIG1vZHVsZSA9IHJlY29yZC5tb2R1bGUocmVjb3JkLm9wdHMsIGNvbnNvbGVTZXJ2aWNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbW9kdWxlID0gcmVjb3JkLm1vZHVsZTtcbiAgICB9XG5cbiAgICBsZXQgbW9kdWxlSWQgPSByZWNvcmQubW9kdWxlSWQgfHwgbW9kdWxlLm1vZHVsZUlkO1xuXG4gICAgaWYgKCFtb2R1bGVJZCkge1xuICAgICAgbG9nZ2VyLndhcm4oXCJpZ25vcmUgYW4gdW5rbm93biBtb2R1bGUuXCIpO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgY29uc29sZVNlcnZpY2UucmVnaXN0ZXIobW9kdWxlSWQsIG1vZHVsZSk7XG4gICAgc2VsZi5tb2R1bGVzLnB1c2gobW9kdWxlKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RhcnRNb2R1bGVzKG1vZHVsZXM6IE1vZHVsZVtdLCBjYj86IEZ1bmN0aW9uKSB7XG4gIC8vIGludm9rZSB0aGUgc3RhcnQgbGlmZWN5Y2xlIG1ldGhvZCBvZiBtb2R1bGVzXG5cbiAgaWYgKCFtb2R1bGVzKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHN0YXJ0TW9kdWxlKG51bGwsIG1vZHVsZXMsIDAsIGNiKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlZ2lzdGVyRGVmYXVsdE1vZHVsZXMoXG4gIGlzTWFzdGVyOiBib29sZWFuLFxuICBhcHA6IEFwcGxpY2F0aW9uLFxuICBjbG9zZVdhdGNoZXI6IGJvb2xlYW4gPSBmYWxzZVxuKSB7XG4gIGlmICghY2xvc2VXYXRjaGVyKSB7XG4gICAgaWYgKGlzTWFzdGVyKSB7XG4gICAgICBhcHAucmVnaXN0ZXJBZG1pbihyZXF1aXJlKFwiLi4vbW9kdWxlcy9tYXN0ZXJ3YXRjaGVyXCIpLCB7IGFwcDogYXBwIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBhcHAucmVnaXN0ZXJBZG1pbihyZXF1aXJlKFwiLi4vbW9kdWxlcy9tb25pdG9yd2F0Y2hlclwiKSwgeyBhcHA6IGFwcCB9KTtcbiAgICB9XG4gIH1cbiAgYXBwLnJlZ2lzdGVyQWRtaW4oYWRtaW4ubW9kdWxlcy53YXRjaFNlcnZlciwgeyBhcHA6IGFwcCB9KTtcbiAgYXBwLnJlZ2lzdGVyQWRtaW4ocmVxdWlyZShcIi4uL21vZHVsZXMvY29uc29sZVwiKSwge1xuICAgIGFwcDogYXBwLFxuICAgIHN0YXJ0ZXI6IHN0YXJ0ZXJcbiAgfSk7XG4gIGlmIChhcHAuZW5hYmxlZChcInN5c3RlbU1vbml0b3JcIikpIHtcbiAgICBpZiAob3MucGxhdGZvcm0oKSAhPT0gUExBVEZPUk0uV0lOKSB7XG4gICAgICBhcHAucmVnaXN0ZXJBZG1pbihhZG1pbi5tb2R1bGVzLnN5c3RlbUluZm8pO1xuICAgICAgYXBwLnJlZ2lzdGVyQWRtaW4oYWRtaW4ubW9kdWxlcy5ub2RlSW5mbyk7XG4gICAgfVxuICAgIGFwcC5yZWdpc3RlckFkbWluKGFkbWluLm1vZHVsZXMubW9uaXRvckxvZywge1xuICAgICAgcGF0aDogcGF0aFV0aWwuZ2V0TG9nUGF0aChhcHAuYmFzZSlcbiAgICB9KTtcbiAgICBhcHAucmVnaXN0ZXJBZG1pbihhZG1pbi5tb2R1bGVzLnNjcmlwdHMsIHtcbiAgICAgIGFwcDogYXBwLFxuICAgICAgcGF0aDogcGF0aFV0aWwuZ2V0U2NyaXB0UGF0aChhcHAuYmFzZSlcbiAgICB9KTtcbiAgICBpZiAob3MucGxhdGZvcm0oKSAhPT0gUExBVEZPUk0uV0lOKSB7XG4gICAgICBhcHAucmVnaXN0ZXJBZG1pbihhZG1pbi5tb2R1bGVzLnByb2ZpbGVyKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gc3RhcnRNb2R1bGUoXG4gIGVycjogYW55LFxuICBtb2R1bGVzOiBNb2R1bGVbXSxcbiAgaW5kZXg6IG51bWJlcixcbiAgY2I/OiBGdW5jdGlvblxuKSB7XG4gIGlmIChlcnIgfHwgaW5kZXggPj0gbW9kdWxlcy5sZW5ndGgpIHtcbiAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiEsIGVycik7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IG1vZHVsZSA9IG1vZHVsZXNbaW5kZXhdO1xuICBpZiAobW9kdWxlICYmIHR5cGVvZiBtb2R1bGUuc3RhcnQgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIG1vZHVsZS5zdGFydChmdW5jdGlvbihlcnI6IGFueSkge1xuICAgICAgc3RhcnRNb2R1bGUoZXJyLCBtb2R1bGVzLCBpbmRleCArIDEsIGNiKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBzdGFydE1vZHVsZShlcnIsIG1vZHVsZXMsIGluZGV4ICsgMSwgY2IpO1xuICB9XG59XG4iXX0=