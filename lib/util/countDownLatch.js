"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class CountDownLatch {
    constructor(count, opts, cb) {
        this.count = count;
        this.cb = cb;
        if (opts.timeout) {
            this.timerId = setTimeout(() => {
                this.cb(true);
            }, opts.timeout);
        }
    }
    done() {
        if (this.count <= 0) {
            throw new Error("illegal state.");
        }
        this.count--;
        if (this.count === 0) {
            if (this.timerId) {
                clearTimeout(this.timerId);
            }
            this.cb();
        }
    }
}
exports.CountDownLatch = CountDownLatch;
function createCountDownLatch(count, opts, cb) {
    if (!count || count <= 0) {
        throw new Error("count should be positive.");
    }
    if (!cb && typeof opts === "function") {
        cb = opts;
        opts = {};
    }
    if (typeof cb !== "function") {
        throw new Error("cb should be a function.");
    }
    return new CountDownLatch(count, opts, cb);
}
exports.createCountDownLatch = createCountDownLatch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY291bnREb3duTGF0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb3VudERvd25MYXRjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBO0lBRUUsWUFDVSxLQUFhLEVBQ3JCLElBQTBCLEVBQ2xCLEVBQVk7UUFGWixVQUFLLEdBQUwsS0FBSyxDQUFRO1FBRWIsT0FBRSxHQUFGLEVBQUUsQ0FBVTtRQUVwQixFQUFFLENBQUMsQ0FBQyxJQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNsQixJQUFJLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEIsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNuQixDQUFDO0lBQ0gsQ0FBQztJQUVELElBQUk7UUFDRixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3BDLENBQUM7UUFFRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDYixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ2pCLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDN0IsQ0FBQztZQUNELElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNaLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUEzQkQsd0NBMkJDO0FBRUQsOEJBQ0UsS0FBYSxFQUNiLElBQTBCLEVBQzFCLEVBQVk7SUFFWixFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QixNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLE9BQU8sSUFBSSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDdEMsRUFBRSxHQUFHLElBQUksQ0FBQztRQUNWLElBQUksR0FBRyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztRQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFuQkQsb0RBbUJDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIENvdW50RG93bkxhdGNoIHtcclxuICBwcml2YXRlIHRpbWVySWQ6IGFueTtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgY291bnQ6IG51bWJlcixcclxuICAgIG9wdHM6IHsgdGltZW91dD86IG51bWJlciB9LFxyXG4gICAgcHJpdmF0ZSBjYjogRnVuY3Rpb25cclxuICApIHtcclxuICAgIGlmIChvcHRzIS50aW1lb3V0KSB7XHJcbiAgICAgIHRoaXMudGltZXJJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuY2IodHJ1ZSk7XHJcbiAgICAgIH0sIG9wdHMudGltZW91dCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkb25lKCkge1xyXG4gICAgaWYgKHRoaXMuY291bnQgPD0gMCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbGxlZ2FsIHN0YXRlLlwiKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmNvdW50LS07XHJcbiAgICBpZiAodGhpcy5jb3VudCA9PT0gMCkge1xyXG4gICAgICBpZiAodGhpcy50aW1lcklkKSB7XHJcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXJJZCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5jYigpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUNvdW50RG93bkxhdGNoKFxyXG4gIGNvdW50OiBudW1iZXIsXHJcbiAgb3B0czogeyB0aW1lb3V0PzogbnVtYmVyIH0sXHJcbiAgY2I6IEZ1bmN0aW9uXHJcbikge1xyXG4gIGlmICghY291bnQgfHwgY291bnQgPD0gMCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiY291bnQgc2hvdWxkIGJlIHBvc2l0aXZlLlwiKTtcclxuICB9XHJcblxyXG4gIGlmICghY2IgJiYgdHlwZW9mIG9wdHMgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgY2IgPSBvcHRzO1xyXG4gICAgb3B0cyA9IHt9O1xyXG4gIH1cclxuXHJcbiAgaWYgKHR5cGVvZiBjYiAhPT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJjYiBzaG91bGQgYmUgYSBmdW5jdGlvbi5cIik7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gbmV3IENvdW50RG93bkxhdGNoKGNvdW50LCBvcHRzLCBjYik7XHJcbn1cclxuIl19