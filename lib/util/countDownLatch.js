"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class CountDownLatch {
    constructor(count, opts, cb) {
        this.count = count;
        this.cb = cb;
        if (opts.timeout) {
            this.timerId = setTimeout(() => {
                this.cb(true);
            }, opts.timeout);
        }
    }
    done() {
        if (this.count <= 0) {
            throw new Error("illegal state.");
        }
        this.count--;
        if (this.count === 0) {
            if (this.timerId) {
                clearTimeout(this.timerId);
            }
            this.cb();
        }
    }
}
exports.CountDownLatch = CountDownLatch;
function createCountDownLatch(count, opts, cb) {
    if (!count || count <= 0) {
        throw new Error("count should be positive.");
    }
    if (!cb && typeof opts === "function") {
        cb = opts;
        opts = {};
    }
    if (typeof cb !== "function") {
        throw new Error("cb should be a function.");
    }
    return new CountDownLatch(count, opts, cb);
}
exports.createCountDownLatch = createCountDownLatch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY291bnREb3duTGF0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb3VudERvd25MYXRjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBO0lBRUUsWUFDVSxLQUFhLEVBQ3JCLElBQTBCLEVBQ2xCLEVBQVk7UUFGWixVQUFLLEdBQUwsS0FBSyxDQUFRO1FBRWIsT0FBRSxHQUFGLEVBQUUsQ0FBVTtRQUVwQixFQUFFLENBQUMsQ0FBQyxJQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNsQixJQUFJLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEIsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNuQixDQUFDO0lBQ0gsQ0FBQztJQUVELElBQUk7UUFDRixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3BDLENBQUM7UUFFRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDYixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ2pCLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDN0IsQ0FBQztZQUNELElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNaLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUEzQkQsd0NBMkJDO0FBRUQsOEJBQ0UsS0FBYSxFQUNiLElBQTBCLEVBQzFCLEVBQVk7SUFFWixFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QixNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLE9BQU8sSUFBSSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDdEMsRUFBRSxHQUFHLElBQUksQ0FBQztRQUNWLElBQUksR0FBRyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztRQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFuQkQsb0RBbUJDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIENvdW50RG93bkxhdGNoIHtcbiAgcHJpdmF0ZSB0aW1lcklkOiBhbnk7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY291bnQ6IG51bWJlcixcbiAgICBvcHRzOiB7IHRpbWVvdXQ/OiBudW1iZXIgfSxcbiAgICBwcml2YXRlIGNiOiBGdW5jdGlvblxuICApIHtcbiAgICBpZiAob3B0cyEudGltZW91dCkge1xuICAgICAgdGhpcy50aW1lcklkID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuY2IodHJ1ZSk7XG4gICAgICB9LCBvcHRzLnRpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIGRvbmUoKSB7XG4gICAgaWYgKHRoaXMuY291bnQgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaWxsZWdhbCBzdGF0ZS5cIik7XG4gICAgfVxuXG4gICAgdGhpcy5jb3VudC0tO1xuICAgIGlmICh0aGlzLmNvdW50ID09PSAwKSB7XG4gICAgICBpZiAodGhpcy50aW1lcklkKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVySWQpO1xuICAgICAgfVxuICAgICAgdGhpcy5jYigpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ291bnREb3duTGF0Y2goXG4gIGNvdW50OiBudW1iZXIsXG4gIG9wdHM6IHsgdGltZW91dD86IG51bWJlciB9LFxuICBjYjogRnVuY3Rpb25cbikge1xuICBpZiAoIWNvdW50IHx8IGNvdW50IDw9IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJjb3VudCBzaG91bGQgYmUgcG9zaXRpdmUuXCIpO1xuICB9XG5cbiAgaWYgKCFjYiAmJiB0eXBlb2Ygb3B0cyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgY2IgPSBvcHRzO1xuICAgIG9wdHMgPSB7fTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgY2IgIT09IFwiZnVuY3Rpb25cIikge1xuICAgIHRocm93IG5ldyBFcnJvcihcImNiIHNob3VsZCBiZSBhIGZ1bmN0aW9uLlwiKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgQ291bnREb3duTGF0Y2goY291bnQsIG9wdHMsIGNiKTtcbn1cbiJdfQ==