"use strict";
const events_1 = require("events");
const index_1 = require("../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const countDownLatch = require("../util/countDownLatch");
module.exports = class Watchdog extends events_1.EventEmitter {
    constructor(app, service) {
        //TODO
        super();
        this.app = app;
        this.service = service;
        this.app = app;
        this.service = service;
        this.isStarted = false;
        this.count = index_1.utils.size(app.getServersFromConfig());
        this.servers = {};
        this.listenerMap = {};
    }
    addServer(server) {
        if (!server) {
            return;
        }
        this.servers[server.id] = server;
        this.notify({ action: "addServer", server: server });
    }
    removeServer(id) {
        if (!id) {
            return;
        }
        this.unsubscribe(id);
        delete this.servers[id];
        this.notify({ action: "removeServer", id: id });
    }
    reconnectServer(server) {
        let self = this;
        if (!server) {
            return;
        }
        if (!this.servers[server.id]) {
            this.servers[server.id] = server;
        }
        //replace server in reconnect server
        this.notifyById(server.id, {
            action: "replaceServer",
            servers: self.servers
        });
        // notify other server to add server
        this.notify({ action: "addServer", server: server });
        // add server in listener
        this.subscribe(server.id);
    }
    subscribe(id) {
        this.listenerMap[id] = 1;
    }
    unsubscribe(id) {
        delete this.listenerMap[id];
    }
    query() {
        return this.servers;
    }
    record(id) {
        if (!this.isStarted && --this.count < 0) {
            let usedTime = Date.now() - this.app.startTime;
            logger.info("all servers startup in %s ms", usedTime);
            this.notify({ action: "startOver" });
            this.isStarted = true;
        }
    }
    notifyById(id, msg) {
        this.service.agent.request(id, index_1.KEYWORDS.MONITOR_WATCHER, msg, (signal) => {
            if (signal !== index_1.SIGNAL.OK) {
                logger.error("master watchdog fail to notify to monitor, id: %s, msg: %j", id, msg);
            }
            else {
                logger.debug("master watchdog notify to monitor success, id: %s, msg: %j", id, msg);
            }
        });
    }
    notify(msg) {
        let listenerMap = this.listenerMap;
        let success = true;
        let fails = [];
        let timeouts = [];
        let requests = {};
        let count = index_1.utils.size(listenerMap);
        if (count === 0) {
            logger.warn("master watchdog listenerMap is none, msg: %j", msg);
            return;
        }
        let latch = countDownLatch.createCountDownLatch(count, { timeout: index_1.TIME.TIME_WAIT_COUNTDOWN }, (isTimeout) => {
            if (!!isTimeout) {
                for (let key in requests) {
                    if (!requests[key]) {
                        timeouts.push(key);
                    }
                }
                logger.error("master watchdog request timeout message: %j, timeouts: %j, fails: %j", msg, timeouts, fails);
            }
            if (!success) {
                logger.error("master watchdog request fail message: %j, fails: %j", msg, fails);
            }
        });
        let moduleRequest = (self, id) => {
            return (() => {
                self.service.agent.request(id, index_1.KEYWORDS.MONITOR_WATCHER, msg, (signal) => {
                    if (signal !== index_1.SIGNAL.OK) {
                        fails.push(id);
                        success = false;
                    }
                    requests[id] = 1;
                    latch.done();
                });
            })();
        };
        for (let id in listenerMap) {
            requests[id] = 0;
            moduleRequest(this, id);
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2hkb2cuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ3YXRjaGRvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsbUNBQXNDO0FBQ3RDLG9DQVFrQjtBQUNsQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUN4RSx5REFBeUQ7QUFFekQsaUJBQVMsY0FBZSxTQUFRLHFCQUFZO0lBSzFDLFlBQXFCLEdBQWdCLEVBQVcsT0FBWTtRQUMxRCxNQUFNO1FBQ04sS0FBSyxFQUFFLENBQUM7UUFGVyxRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQVcsWUFBTyxHQUFQLE9BQU8sQ0FBSztRQUcxRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUcsYUFBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDO1FBRXBELElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxTQUFTLENBQUMsTUFBa0I7UUFDMUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1osTUFBTSxDQUFDO1FBQ1QsQ0FBQztRQUNELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNqQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQsWUFBWSxDQUFDLEVBQVU7UUFDckIsRUFBRSxD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QUM7UUFDSCxDQUFDLENBQ0YsQ0FBQztRQUVGLElBQUksYUFBYSxHQUFHLENBQUMsSUFBYyxFQUFFLEVBQVUsRUFBRSxFQUFFO1lBQ2pELE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRTtnQkFDWCxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQ3hCLEVBQUUsRUFDRixnQkFBUSxDQUFDLGVBQWUsRUFDeEIsR0FBRyxFQUNILENBQUMsTUFBYyxFQUFFLEVBQUU7b0JBQ2pCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxjQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQzt3QkFDekIsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFDZixPQUFPLEdBQUcsS0FBSyxDQUFDO29CQUNsQixDQUFDO29CQUNELFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2pCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDZixDQUFDLENBQ0YsQ0FBQztZQUNKLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDUCxDQUFDLENBQUM7UUFFRixHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQzNCLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakIsYUFBYSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMxQixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XHJcbmltcG9ydCB7XHJcbiAgdXRpbHMsXHJcbiAgQXBwbGljYXRpb24sXHJcbiAgU2VydmVySW5mb01hcCxcclxuICBTZXJ2ZXJJbmZvLFxyXG4gIEtFWVdPUkRTLFxyXG4gIFNJR05BTCxcclxuICBUSU1FXHJcbn0gZnJvbSBcIi4uL2luZGV4XCI7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcclxuaW1wb3J0ICogYXMgY291bnREb3duTGF0Y2ggZnJvbSBcIi4uL3V0aWwvY291bnREb3duTGF0Y2hcIjtcclxuXHJcbmV4cG9ydCA9IGNsYXNzIFdhdGNoZG9nIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcclxuICBwcml2YXRlIGlzU3RhcnRlZDogYm9vbGVhbjtcclxuICBwcml2YXRlIGNvdW50OiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBzZXJ2ZXJzOiBTZXJ2ZXJJbmZvTWFwO1xyXG4gIHByaXZhdGUgbGlzdGVuZXJNYXA6IHsgW2lkeDogc3RyaW5nXTogbnVtYmVyIH07XHJcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgcmVhZG9ubHkgc2VydmljZTogYW55KSB7XHJcbiAgICAvL1RPRE9cclxuICAgIHN1cGVyKCk7XHJcbiAgICB0aGlzLmFwcCA9IGFwcDtcclxuICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2U7XHJcbiAgICB0aGlzLmlzU3RhcnRlZCA9IGZhbHNlO1xyXG4gICAgdGhpcy5jb3VudCA9IHV0aWxzLnNpemUoYXBwLmdldFNlcnZlcnNGcm9tQ29uZmlnKCkpO1xyXG5cclxuICAgIHRoaXMuc2VydmVycyA9IHt9O1xyXG4gICAgdGhpcy5saXN0ZW5lck1hcCA9IHt9O1xyXG4gIH1cclxuXHJcbiAgYWRkU2VydmVyKHNlcnZlcjogU2VydmVySW5mbykge1xyXG4gICAgaWYgKCFzZXJ2ZXIpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZXJ2ZXJzW3NlcnZlci5pZF0gPSBzZXJ2ZXI7XHJcbiAgICB0aGlzLm5vdGlmeSh7IGFjdGlvbjogXCJhZGRTZXJ2ZXJcIiwgc2VydmVyOiBzZXJ2ZXIgfSk7XHJcbiAgfVxyXG5cclxuICByZW1vdmVTZXJ2ZXIoaWQ6IHN0cmluZykge1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnVuc3Vic2NyaWJlKGlkKTtcclxuICAgIGRlbGV0ZSB0aGlzLnNlcnZlcnNbaWRdO1xyXG4gICAgdGhpcy5ub3RpZnkoeyBhY3Rpb246IFwicmVtb3ZlU2VydmVyXCIsIGlkOiBpZCB9KTtcclxuICB9XHJcblxyXG4gIHJlY29ubmVjdFNlcnZlcihzZXJ2ZXI6IFNlcnZlckluZm8pIHtcclxuICAgIGxldCBzZWxmID0gdGhpcztcclxuICAgIGlmICghc2VydmVyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICghdGhpcy5zZXJ2ZXJzW3NlcnZlci5pZF0pIHtcclxuICAgICAgdGhpcy5zZXJ2ZXJzW3NlcnZlci5pZF0gPSBzZXJ2ZXI7XHJcbiAgICB9XHJcbiAgICAvL3JlcGxhY2Ugc2VydmVyIGluIHJlY29ubmVjdCBzZXJ2ZXJcclxuICAgIHRoaXMubm90aWZ5QnlJZChzZXJ2ZXIuaWQsIHtcclxuICAgICAgYWN0aW9uOiBcInJlcGxhY2VTZXJ2ZXJcIixcclxuICAgICAgc2VydmVyczogc2VsZi5zZXJ2ZXJzXHJcbiAgICB9KTtcclxuICAgIC8vIG5vdGlmeSBvdGhlciBzZXJ2ZXIgdG8gYWRkIHNlcnZlclxyXG4gICAgdGhpcy5ub3RpZnkoeyBhY3Rpb246IFwiYWRkU2VydmVyXCIsIHNlcnZlcjogc2VydmVyIH0pO1xyXG4gICAgLy8gYWRkIHNlcnZlciBpbiBsaXN0ZW5lclxyXG4gICAgdGhpcy5zdWJzY3JpYmUoc2VydmVyLmlkKTtcclxuICB9XHJcblxyXG4gIHN1YnNjcmliZShpZDogc3RyaW5nKSB7XHJcbiAgICB0aGlzLmxpc3RlbmVyTWFwW2lkXSA9IDE7XHJcbiAgfVxyXG5cclxuICB1bnN1YnNjcmliZShpZDogc3RyaW5nKSB7XHJcbiAgICBkZWxldGUgdGhpcy5saXN0ZW5lck1hcFtpZF07XHJcbiAgfVxyXG5cclxuICBxdWVyeSgpIHtcclxuICAgIHJldHVybiB0aGlzLnNlcnZlcnM7XHJcbiAgfVxyXG5cclxuICByZWNvcmQoaWQ6IHN0cmluZykge1xyXG4gICAgaWYgKCF0aGlzLmlzU3RhcnRlZCAmJiAtLXRoaXMuY291bnQgPCAwKSB7XHJcbiAgICAgIGxldCB1c2VkVGltZSA9IERhdGUubm93KCkgLSB0aGlzLmFwcC5zdGFydFRpbWU7XHJcbiAgICAgIGxvZ2dlci5pbmZvKFwiYWxsIHNlcnZlcnMgc3RhcnR1cCBpbiAlcyBtc1wiLCB1c2VkVGltZSk7XHJcbiAgICAgIHRoaXMubm90aWZ5KHsgYWN0aW9uOiBcInN0YXJ0T3ZlclwiIH0pO1xyXG4gICAgICB0aGlzLmlzU3RhcnRlZCA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBub3RpZnlCeUlkKGlkOiBzdHJpbmcsIG1zZzogYW55KSB7XHJcbiAgICB0aGlzLnNlcnZpY2UuYWdlbnQucmVxdWVzdChcclxuICAgICAgaWQsXHJcbiAgICAgIEtFWVdPUkRTLk1PTklUT1JfV0FUQ0hFUixcclxuICAgICAgbXNnLFxyXG4gICAgICAoc2lnbmFsOiBudW1iZXIpID0+IHtcclxuICAgICAgICBpZiAoc2lnbmFsICE9PSBTSUdOQUwuT0spIHtcclxuICAgICAgICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgICAgICAgXCJtYXN0ZXIgd2F0Y2hkb2cgZmFpbCB0byBub3RpZnkgdG8gbW9uaXRvciwgaWQ6ICVzLCBtc2c6ICVqXCIsXHJcbiAgICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgICBtc2dcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhcclxuICAgICAgICAgICAgXCJtYXN0ZXIgd2F0Y2hkb2cgbm90aWZ5IHRvIG1vbml0b3Igc3VjY2VzcywgaWQ6ICVzLCBtc2c6ICVqXCIsXHJcbiAgICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgICBtc2dcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgbm90aWZ5KG1zZzogYW55KSB7XHJcbiAgICBsZXQgbGlzdGVuZXJNYXAgPSB0aGlzLmxpc3RlbmVyTWFwO1xyXG4gICAgbGV0IHN1Y2Nlc3MgPSB0cnVlO1xyXG4gICAgbGV0IGZhaWxzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgbGV0IHRpbWVvdXRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgbGV0IHJlcXVlc3RzOiB7IFtpZHg6IHN0cmluZ106IG51bWJlciB9ID0ge307XHJcbiAgICBsZXQgY291bnQgPSB1dGlscy5zaXplKGxpc3RlbmVyTWFwKTtcclxuICAgIGlmIChjb3VudCA9PT0gMCkge1xyXG4gICAgICBsb2dnZXIud2FybihcIm1hc3RlciB3YXRjaGRvZyBsaXN0ZW5lck1hcCBpcyBub25lLCBtc2c6ICVqXCIsIG1zZyk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBsYXRjaCA9IGNvdW50RG93bkxhdGNoLmNyZWF0ZUNvdW50RG93bkxhdGNoKFxyXG4gICAgICBjb3VudCxcclxuICAgICAgeyB0aW1lb3V0OiBUSU1FLlRJTUVfV0FJVF9DT1VOVERPV04gfSxcclxuICAgICAgKGlzVGltZW91dDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgIGlmICghIWlzVGltZW91dCkge1xyXG4gICAgICAgICAgZm9yIChsZXQga2V5IGluIHJlcXVlc3RzKSB7XHJcbiAgICAgICAgICAgIGlmICghcmVxdWVzdHNba2V5XSkge1xyXG4gICAgICAgICAgICAgIHRpbWVvdXRzLnB1c2goa2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAgICAgICBcIm1hc3RlciB3YXRjaGRvZyByZXF1ZXN0IHRpbWVvdXQgbWVzc2FnZTogJWosIHRpbWVvdXRzOiAlaiwgZmFpbHM6ICVqXCIsXHJcbiAgICAgICAgICAgIG1zZyxcclxuICAgICAgICAgICAgdGltZW91dHMsXHJcbiAgICAgICAgICAgIGZhaWxzXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcclxuICAgICAgICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgICAgICAgXCJtYXN0ZXIgd2F0Y2hkb2cgcmVxdWVzdCBmYWlsIG1lc3NhZ2U6ICVqLCBmYWlsczogJWpcIixcclxuICAgICAgICAgICAgbXNnLFxyXG4gICAgICAgICAgICBmYWlsc1xyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gICAgbGV0IG1vZHVsZVJlcXVlc3QgPSAoc2VsZjogV2F0Y2hkb2csIGlkOiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuICgoKSA9PiB7XHJcbiAgICAgICAgc2VsZi5zZXJ2aWNlLmFnZW50LnJlcXVlc3QoXHJcbiAgICAgICAgICBpZCxcclxuICAgICAgICAgIEtFWVdPUkRTLk1PTklUT1JfV0FUQ0hFUixcclxuICAgICAgICAgIG1zZyxcclxuICAgICAgICAgIChzaWduYWw6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2lnbmFsICE9PSBTSUdOQUwuT0spIHtcclxuICAgICAgICAgICAgICBmYWlscy5wdXNoKGlkKTtcclxuICAgICAgICAgICAgICBzdWNjZXNzID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVxdWVzdHNbaWRdID0gMTtcclxuICAgICAgICAgICAgbGF0Y2guZG9uZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pKCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZvciAobGV0IGlkIGluIGxpc3RlbmVyTWFwKSB7XHJcbiAgICAgIHJlcXVlc3RzW2lkXSA9IDA7XHJcbiAgICAgIG1vZHVsZVJlcXVlc3QodGhpcywgaWQpO1xyXG4gICAgfVxyXG4gIH1cclxufTtcclxuIl19