"use strict";
const events_1 = require("events");
const index_1 = require("../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const countDownLatch = require("../util/countDownLatch");
module.exports = class Watchdog extends events_1.EventEmitter {
    constructor(app, service) {
        //TODO
        super();
        this.app = app;
        this.service = service;
        this.app = app;
        this.service = service;
        this.isStarted = false;
        this.count = index_1.utils.size(app.getServersFromConfig());
        this.servers = {};
        this.listenerMap = {};
    }
    addServer(server) {
        if (!server) {
            return;
        }
        this.servers[server.id] = server;
        this.notify({ action: "addServer", server: server });
    }
    removeServer(id) {
        if (!id) {
            return;
        }
        this.unsubscribe(id);
        delete this.servers[id];
        this.notify({ action: "removeServer", id: id });
    }
    reconnectServer(server) {
        let self = this;
        if (!server) {
            return;
        }
        if (!this.servers[server.id]) {
            this.servers[server.id] = server;
        }
        //replace server in reconnect server
        this.notifyById(server.id, {
            action: "replaceServer",
            servers: self.servers
        });
        // notify other server to add server
        this.notify({ action: "addServer", server: server });
        // add server in listener
        this.subscribe(server.id);
    }
    subscribe(id) {
        this.listenerMap[id] = 1;
    }
    unsubscribe(id) {
        delete this.listenerMap[id];
    }
    query() {
        return this.servers;
    }
    record(id) {
        if (!this.isStarted && --this.count < 0) {
            let usedTime = Date.now() - this.app.startTime;
            logger.info("all servers startup in %s ms", usedTime);
            this.notify({ action: "startOver" });
            this.isStarted = true;
        }
    }
    notifyById(id, msg) {
        this.service.agent.request(id, index_1.KEYWORDS.MONITOR_WATCHER, msg, (signal) => {
            if (signal !== index_1.SIGNAL.OK) {
                logger.error("master watchdog fail to notify to monitor, id: %s, msg: %j", id, msg);
            }
            else {
                logger.debug("master watchdog notify to monitor success, id: %s, msg: %j", id, msg);
            }
        });
    }
    notify(msg) {
        let listenerMap = this.listenerMap;
        let success = true;
        let fails = [];
        let timeouts = [];
        let requests = {};
        let count = index_1.utils.size(listenerMap);
        if (count === 0) {
            logger.warn("master watchdog listenerMap is none, msg: %j", msg);
            return;
        }
        let latch = countDownLatch.createCountDownLatch(count, { timeout: index_1.TIME.TIME_WAIT_COUNTDOWN }, (isTimeout) => {
            if (!!isTimeout) {
                for (let key in requests) {
                    if (!requests[key]) {
                        timeouts.push(key);
                    }
                }
                logger.error("master watchdog request timeout message: %j, timeouts: %j, fails: %j", msg, timeouts, fails);
            }
            if (!success) {
                logger.error("master watchdog request fail message: %j, fails: %j", msg, fails);
            }
        });
        let moduleRequest = (self, id) => {
            return (() => {
                self.service.agent.request(id, index_1.KEYWORDS.MONITOR_WATCHER, msg, (signal) => {
                    if (signal !== index_1.SIGNAL.OK) {
                        fails.push(id);
                        success = false;
                    }
                    requests[id] = 1;
                    latch.done();
                });
            })();
        };
        for (let id in listenerMap) {
            requests[id] = 0;
            moduleRequest(this, id);
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2hkb2cuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ3YXRjaGRvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsbUNBQXNDO0FBQ3RDLG9DQVFrQjtBQUNsQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUN4RSx5REFBeUQ7QUFFekQsaUJBQVMsY0FBZSxTQUFRLHFCQUFZO0lBSzFDLFlBQXFCLEdBQWdCLEVBQVcsT0FBWTtRQUMxRCxNQUFNO1FBQ04sS0FBSyxFQUFFLENBQUM7UUFGVyxRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQVcsWUFBTyxHQUFQLE9BQU8sQ0FBSztRQUcxRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUcsYUFBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDO1FBRXBELElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxTQUFTLENBQUMsTUFBa0I7UUFDMUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1osTUFBTSxDQUFDO1FBQ1QsQ0FBQztRQUNELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNqQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQsWUFBWSxDQUFDLEVBQVU7UUFDckIsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ1IsTUFBTSxDQUFDO1FBQ1QsQ0FBQztRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDckIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxlQUFlLENBQUMsTUFBa0I7UUFDaEMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNaLE1BQU0sQ0FBQztRQUNULENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDbkMsQ0FBQztRQUNELG9DQUFvQztRQUNwQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUU7WUFDekIsTUFBTSxFQUFFLGVBQWU7WUFDdkIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1NBQ3RCLENBQUMsQ0FBQztRQUNILG9DQUFvQztRQUNwQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUNyRCx5QkFBeUI7UUFDekIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELFNBQVMsQ0FBQyxFQUFVO1FBQ2xCLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFRCxXQUFXLENBQUMsRUFBVTtRQUNwQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELEtBQUs7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDO0lBRUQsTUFBTSxDQUFDLEVBQVU7UUFDZixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxJQUFJLENBQUMsOEJBQThCLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDdEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLENBQUM7SUFDSCxDQUFDO0lBRUQsVUFBVSxDQUFDLEVBQVUsRUFBRSxHQUFRO1FBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FDeEIsRUFBRSxFQUNGLGdCQUFRLENBQUMsZUFBZSxFQUN4QixHQUFHLEVBQ0gsQ0FBQyxNQUFjLEVBQUUsRUFBRTtZQUNqQixFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssY0FBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3pCLE1BQU0sQ0FBQyxLQUFLLENBQ1YsNERBQTRELEVBQzVELEVBQUUsRUFDRixHQUFHLENBQ0osQ0FBQztZQUNKLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixNQUFNLENBQUMsS0FBSyxDQUNWLDREQUE0RCxFQUM1RCxFQUFFLEVBQ0YsR0FBRyxDQUNKLENBQUM7WUFDSixDQUFDO1FBQ0gsQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLEdBQVE7UUFDYixJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQ25DLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztRQUNuQixJQUFJLEtBQUssR0FBYSxFQUFFLENBQUM7UUFDekIsSUFBSSxRQUFRLEdBQWEsRUFBRSxDQUFDO1FBQzVCLElBQUksUUFBUSxHQUE4QixFQUFFLENBQUM7UUFDN0MsSUFBSSxLQUFLLEdBQUcsYUFBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoQixNQUFNLENBQUMsSUFBSSxDQUFDLDhDQUE4QyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sQ0FBQztRQUNULENBQUM7UUFDRCxJQUFJLEtBQUssR0FBRyxjQUFjLENBQUMsb0JBQW9CLENBQzdDLEtBQUssRUFDTCxFQUFFLE9BQU8sRUFBRSxZQUFJLENBQUMsbUJBQW1CLEVBQUUsRUFDckMsQ0FBQyxTQUFrQixFQUFFLEVBQUU7WUFDckIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLEdBQUcsQ0FBQyxDQUFDLElBQUksR0FBRyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUM7b0JBQ3pCLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDbkIsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDckIsQ0FBQztnQkFDSCxDQUFDO2dCQUNELE1BQU0sQ0FBQyxLQUFLLENBQ1Ysc0VBQXNFLEVBQ3RFLEdBQUcsRUFDSCxRQUFRLEVBQ1IsS0FBSyxDQUNOLENBQUM7WUFDSixDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNiLE1BQU0sQ0FBQyxLQUFLLENBQ1YscURBQXFELEVBQ3JELEdBQUcsRUFDSCxLQUFLLENBQ04sQ0FBQztZQUNKLENBQUM7UUFDSCxDQUFDLENBQ0YsQ0FBQztRQUVGLElBQUksYUFBYSxHQUFHLENBQUMsSUFBYyxFQUFFLEVBQVUsRUFBRSxFQUFFO1lBQ2pELE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRTtnQkFDWCxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQ3hCLEVBQUUsRUFDRixnQkFBUSxDQUFDLGVBQWUsRUFDeEIsR0FBRyxFQUNILENBQUMsTUFBYyxFQUFFLEVBQUU7b0JBQ2pCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxjQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQzt3QkFDekIsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFDZixPQUFPLEdBQUcsS0FBSyxDQUFDO29CQUNsQixDQUFDO29CQUNELFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2pCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDZixDQUFDLENBQ0YsQ0FBQztZQUNKLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDUCxDQUFDLENBQUM7UUFFRixHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQzNCLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakIsYUFBYSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMxQixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQge1xuICB1dGlscyxcbiAgQXBwbGljYXRpb24sXG4gIFNlcnZlckluZm9NYXAsXG4gIFNlcnZlckluZm8sXG4gIEtFWVdPUkRTLFxuICBTSUdOQUwsXG4gIFRJTUVcbn0gZnJvbSBcIi4uL2luZGV4XCI7XG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XG5pbXBvcnQgKiBhcyBjb3VudERvd25MYXRjaCBmcm9tIFwiLi4vdXRpbC9jb3VudERvd25MYXRjaFwiO1xuXG5leHBvcnQgPSBjbGFzcyBXYXRjaGRvZyBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIHByaXZhdGUgaXNTdGFydGVkOiBib29sZWFuO1xuICBwcml2YXRlIGNvdW50OiBudW1iZXI7XG4gIHByaXZhdGUgc2VydmVyczogU2VydmVySW5mb01hcDtcbiAgcHJpdmF0ZSBsaXN0ZW5lck1hcDogeyBbaWR4OiBzdHJpbmddOiBudW1iZXIgfTtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgcmVhZG9ubHkgc2VydmljZTogYW55KSB7XG4gICAgLy9UT0RPXG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICB0aGlzLnNlcnZpY2UgPSBzZXJ2aWNlO1xuICAgIHRoaXMuaXNTdGFydGVkID0gZmFsc2U7XG4gICAgdGhpcy5jb3VudCA9IHV0aWxzLnNpemUoYXBwLmdldFNlcnZlcnNGcm9tQ29uZmlnKCkpO1xuXG4gICAgdGhpcy5zZXJ2ZXJzID0ge307XG4gICAgdGhpcy5saXN0ZW5lck1hcCA9IHt9O1xuICB9XG5cbiAgYWRkU2VydmVyKHNlcnZlcjogU2VydmVySW5mbykge1xuICAgIGlmICghc2VydmVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc2VydmVyc1tzZXJ2ZXIuaWRdID0gc2VydmVyO1xuICAgIHRoaXMubm90aWZ5KHsgYWN0aW9uOiBcImFkZFNlcnZlclwiLCBzZXJ2ZXI6IHNlcnZlciB9KTtcbiAgfVxuXG4gIHJlbW92ZVNlcnZlcihpZDogc3RyaW5nKSB7XG4gICAgaWYgKCFpZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnVuc3Vic2NyaWJlKGlkKTtcbiAgICBkZWxldGUgdGhpcy5zZXJ2ZXJzW2lkXTtcbiAgICB0aGlzLm5vdGlmeSh7IGFjdGlvbjogXCJyZW1vdmVTZXJ2ZXJcIiwgaWQ6IGlkIH0pO1xuICB9XG5cbiAgcmVjb25uZWN0U2VydmVyKHNlcnZlcjogU2VydmVySW5mbykge1xuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBpZiAoIXNlcnZlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuc2VydmVyc1tzZXJ2ZXIuaWRdKSB7XG4gICAgICB0aGlzLnNlcnZlcnNbc2VydmVyLmlkXSA9IHNlcnZlcjtcbiAgICB9XG4gICAgLy9yZXBsYWNlIHNlcnZlciBpbiByZWNvbm5lY3Qgc2VydmVyXG4gICAgdGhpcy5ub3RpZnlCeUlkKHNlcnZlci5pZCwge1xuICAgICAgYWN0aW9uOiBcInJlcGxhY2VTZXJ2ZXJcIixcbiAgICAgIHNlcnZlcnM6IHNlbGYuc2VydmVyc1xuICAgIH0pO1xuICAgIC8vIG5vdGlmeSBvdGhlciBzZXJ2ZXIgdG8gYWRkIHNlcnZlclxuICAgIHRoaXMubm90aWZ5KHsgYWN0aW9uOiBcImFkZFNlcnZlclwiLCBzZXJ2ZXI6IHNlcnZlciB9KTtcbiAgICAvLyBhZGQgc2VydmVyIGluIGxpc3RlbmVyXG4gICAgdGhpcy5zdWJzY3JpYmUoc2VydmVyLmlkKTtcbiAgfVxuXG4gIHN1YnNjcmliZShpZDogc3RyaW5nKSB7XG4gICAgdGhpcy5saXN0ZW5lck1hcFtpZF0gPSAxO1xuICB9XG5cbiAgdW5zdWJzY3JpYmUoaWQ6IHN0cmluZykge1xuICAgIGRlbGV0ZSB0aGlzLmxpc3RlbmVyTWFwW2lkXTtcbiAgfVxuXG4gIHF1ZXJ5KCkge1xuICAgIHJldHVybiB0aGlzLnNlcnZlcnM7XG4gIH1cblxuICByZWNvcmQoaWQ6IHN0cmluZykge1xuICAgIGlmICghdGhpcy5pc1N0YXJ0ZWQgJiYgLS10aGlzLmNvdW50IDwgMCkge1xuICAgICAgbGV0IHVzZWRUaW1lID0gRGF0ZS5ub3coKSAtIHRoaXMuYXBwLnN0YXJ0VGltZTtcbiAgICAgIGxvZ2dlci5pbmZvKFwiYWxsIHNlcnZlcnMgc3RhcnR1cCBpbiAlcyBtc1wiLCB1c2VkVGltZSk7XG4gICAgICB0aGlzLm5vdGlmeSh7IGFjdGlvbjogXCJzdGFydE92ZXJcIiB9KTtcbiAgICAgIHRoaXMuaXNTdGFydGVkID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBub3RpZnlCeUlkKGlkOiBzdHJpbmcsIG1zZzogYW55KSB7XG4gICAgdGhpcy5zZXJ2aWNlLmFnZW50LnJlcXVlc3QoXG4gICAgICBpZCxcbiAgICAgIEtFWVdPUkRTLk1PTklUT1JfV0FUQ0hFUixcbiAgICAgIG1zZyxcbiAgICAgIChzaWduYWw6IG51bWJlcikgPT4ge1xuICAgICAgICBpZiAoc2lnbmFsICE9PSBTSUdOQUwuT0spIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBcIm1hc3RlciB3YXRjaGRvZyBmYWlsIHRvIG5vdGlmeSB0byBtb25pdG9yLCBpZDogJXMsIG1zZzogJWpcIixcbiAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgbXNnXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgICBcIm1hc3RlciB3YXRjaGRvZyBub3RpZnkgdG8gbW9uaXRvciBzdWNjZXNzLCBpZDogJXMsIG1zZzogJWpcIixcbiAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgbXNnXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBub3RpZnkobXNnOiBhbnkpIHtcbiAgICBsZXQgbGlzdGVuZXJNYXAgPSB0aGlzLmxpc3RlbmVyTWFwO1xuICAgIGxldCBzdWNjZXNzID0gdHJ1ZTtcbiAgICBsZXQgZmFpbHM6IHN0cmluZ1tdID0gW107XG4gICAgbGV0IHRpbWVvdXRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGxldCByZXF1ZXN0czogeyBbaWR4OiBzdHJpbmddOiBudW1iZXIgfSA9IHt9O1xuICAgIGxldCBjb3VudCA9IHV0aWxzLnNpemUobGlzdGVuZXJNYXApO1xuICAgIGlmIChjb3VudCA9PT0gMCkge1xuICAgICAgbG9nZ2VyLndhcm4oXCJtYXN0ZXIgd2F0Y2hkb2cgbGlzdGVuZXJNYXAgaXMgbm9uZSwgbXNnOiAlalwiLCBtc2cpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgbGF0Y2ggPSBjb3VudERvd25MYXRjaC5jcmVhdGVDb3VudERvd25MYXRjaChcbiAgICAgIGNvdW50LFxuICAgICAgeyB0aW1lb3V0OiBUSU1FLlRJTUVfV0FJVF9DT1VOVERPV04gfSxcbiAgICAgIChpc1RpbWVvdXQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgaWYgKCEhaXNUaW1lb3V0KSB7XG4gICAgICAgICAgZm9yIChsZXQga2V5IGluIHJlcXVlc3RzKSB7XG4gICAgICAgICAgICBpZiAoIXJlcXVlc3RzW2tleV0pIHtcbiAgICAgICAgICAgICAgdGltZW91dHMucHVzaChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBcIm1hc3RlciB3YXRjaGRvZyByZXF1ZXN0IHRpbWVvdXQgbWVzc2FnZTogJWosIHRpbWVvdXRzOiAlaiwgZmFpbHM6ICVqXCIsXG4gICAgICAgICAgICBtc2csXG4gICAgICAgICAgICB0aW1lb3V0cyxcbiAgICAgICAgICAgIGZhaWxzXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBcIm1hc3RlciB3YXRjaGRvZyByZXF1ZXN0IGZhaWwgbWVzc2FnZTogJWosIGZhaWxzOiAlalwiLFxuICAgICAgICAgICAgbXNnLFxuICAgICAgICAgICAgZmFpbHNcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcblxuICAgIGxldCBtb2R1bGVSZXF1ZXN0ID0gKHNlbGY6IFdhdGNoZG9nLCBpZDogc3RyaW5nKSA9PiB7XG4gICAgICByZXR1cm4gKCgpID0+IHtcbiAgICAgICAgc2VsZi5zZXJ2aWNlLmFnZW50LnJlcXVlc3QoXG4gICAgICAgICAgaWQsXG4gICAgICAgICAgS0VZV09SRFMuTU9OSVRPUl9XQVRDSEVSLFxuICAgICAgICAgIG1zZyxcbiAgICAgICAgICAoc2lnbmFsOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGlmIChzaWduYWwgIT09IFNJR05BTC5PSykge1xuICAgICAgICAgICAgICBmYWlscy5wdXNoKGlkKTtcbiAgICAgICAgICAgICAgc3VjY2VzcyA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVxdWVzdHNbaWRdID0gMTtcbiAgICAgICAgICAgIGxhdGNoLmRvbmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9KSgpO1xuICAgIH07XG5cbiAgICBmb3IgKGxldCBpZCBpbiBsaXN0ZW5lck1hcCkge1xuICAgICAgcmVxdWVzdHNbaWRdID0gMDtcbiAgICAgIG1vZHVsZVJlcXVlc3QodGhpcywgaWQpO1xuICAgIH1cbiAgfVxufTtcbiJdfQ==