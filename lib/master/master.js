"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const starter = require("./starter");
const util = require("util");
const index_1 = require("../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const crashLogger = require("pomelo-logger").getLogger("crash-log", __filename);
const adminLogger = require("pomelo-logger").getLogger("admin-log", __filename);
const admin = require("pomelo-admin");
class Master {
    constructor(app, opts) {
        this.app = app;
        this.masterInfo = app.master;
        this.registered = {};
        this.modules = [];
        opts = opts || {};
        opts.port = this.masterInfo.port;
        opts.env = this.app.get(index_1.RESERVED.ENV);
        this.closeWatcher = opts.closeWatcher;
        this.masterConsole = admin.createMasterConsole(opts);
    }
    start(cb) {
        index_1.moduleUtil.registerDefaultModules(true, this.app, this.closeWatcher);
        index_1.moduleUtil.loadModules(this, this.masterConsole);
        // start master console
        this.masterConsole.start((err) => {
            if (err) {
                process.exit(0);
            }
            index_1.moduleUtil.startModules(this.modules, (err) => {
                if (err) {
                    index_1.utils.invokeCallback(cb, err);
                    return;
                }
                if (this.app.get(index_1.RESERVED.MODE) !== index_1.RESERVED.STAND_ALONE) {
                    starter.runServers(this.app);
                }
                index_1.utils.invokeCallback(cb);
            });
        });
        this.masterConsole.on("error", (err) => {
            if (!!err) {
                logger.error("masterConsole encounters with error: " + err.stack);
                return;
            }
        });
        this.masterConsole.on("reconnect", (info) => {
            this.app.addServers([info]);
        });
        // monitor servers disconnect event
        this.masterConsole.on("disconnect", (id, type, info, reason) => {
            crashLogger.info(util.format("[%s],[%s],[%s],[%s]", type, id, Date.now(), reason || "disconnect"));
            let count = 0;
            let time = 0;
            let pingTimer = null;
            let server = this.app.getServerById(id);
            let stopFlags = this.app.get(index_1.RESERVED.STOP_SERVERS) || [];
            if (!!server &&
                (server[index_1.RESERVED.AUTO_RESTART] === "true" ||
                    server[index_1.RESERVED.RESTART_FORCE] === "true") &&
                stopFlags.indexOf(id) < 0) {
                let setTimer = (time) => {
                    pingTimer = setTimeout(() => {
                        index_1.utils.ping(server.host, flag => {
                            if (flag) {
                                handle();
                            }
                            else {
                                count++;
                                if (count > 3) {
                                    time = index_1.TIME.TIME_WAIT_MAX_PING;
                                }
                                else {
                                    time = index_1.TIME.TIME_WAIT_PING * count;
                                }
                                setTimer(time);
                            }
                        });
                    }, time);
                };
                setTimer(time);
                let handle = () => {
                    clearTimeout(pingTimer);
                    index_1.utils.checkPort(server, (status) => {
                        if (status === "error") {
                            index_1.utils.invokeCallback(cb, new Error("Check port command executed with error."));
                            return;
                        }
                        else if (status === "busy") {
                            if (!!server[index_1.RESERVED.RESTART_FORCE]) {
                                starter.kill([info.pid], [server]);
                            }
                            else {
                                index_1.utils.invokeCallback(cb, new Error("Port occupied already, check your server to add."));
                                return;
                            }
                        }
                        setTimeout(() => {
                            starter.run(this.app, server);
                        }, index_1.TIME.TIME_WAIT_STOP);
                    });
                };
            }
        });
        // monitor servers register event
        this.masterConsole.on("register", (record) => {
            starter.bindCpu(record.id, record.pid, record.host);
        });
        this.masterConsole.on("admin-log", (log, error) => {
            if (error) {
                adminLogger.error(JSON.stringify(log));
            }
            else {
                adminLogger.info(JSON.stringify(log));
            }
        });
    }
    stop(cb) {
        this.masterConsole.stop();
        process.nextTick(cb);
    }
}
exports.default = Master;
exports.Master = Master;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFzdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFzdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEscUNBQXFDO0FBQ3JDLDZCQUE4QjtBQUM5QixvQ0FRa0I7QUFFbEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDeEUsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDaEYsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDaEYsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBRXRDO0lBTUUsWUFBcUIsR0FBZ0IsRUFBRSxJQUFVO1FBQTVCLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFDbkMsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBRWxCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7UUFDakMsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUN0QyxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBQ0Qs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QUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3pDLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN4QyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxDQUFDLEVBQVk7UUFDZixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzFCLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBN0lELHlCQTZJQztBQUVRLHdCQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgc3RhcnRlciBmcm9tIFwiLi9zdGFydGVyXCI7XHJcbmltcG9ydCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XHJcbmltcG9ydCB7XHJcbiAgU2VydmVySW5mbyxcclxuICBNb2R1bGUsXHJcbiAgQXBwbGljYXRpb24sXHJcbiAgUkVTRVJWRUQsXHJcbiAgbW9kdWxlVXRpbCxcclxuICB1dGlscyxcclxuICBUSU1FXHJcbn0gZnJvbSBcIi4uL2luZGV4XCI7XHJcblxyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XHJcbmNvbnN0IGNyYXNoTG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwiY3Jhc2gtbG9nXCIsIF9fZmlsZW5hbWUpO1xyXG5jb25zdCBhZG1pbkxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcImFkbWluLWxvZ1wiLCBfX2ZpbGVuYW1lKTtcclxuY29uc3QgYWRtaW4gPSByZXF1aXJlKFwicG9tZWxvLWFkbWluXCIpO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTWFzdGVyIHtcclxuICByZWFkb25seSBtYXN0ZXJJbmZvOiBTZXJ2ZXJJbmZvO1xyXG4gIHByaXZhdGUgbW9kdWxlczogTW9kdWxlW107XHJcbiAgcHJpdmF0ZSBjbG9zZVdhdGNoZXI6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBtYXN0ZXJDb25zb2xlOiBhbnk7IC8vVE9ET1xyXG4gIHByaXZhdGUgcmVnaXN0ZXJlZDogYW55OyAvL1RPRE9cclxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XHJcbiAgICB0aGlzLm1hc3RlckluZm8gPSBhcHAubWFzdGVyO1xyXG4gICAgdGhpcy5yZWdpc3RlcmVkID0ge307XHJcbiAgICB0aGlzLm1vZHVsZXMgPSBbXTtcclxuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xyXG5cclxuICAgIG9wdHMucG9ydCA9IHRoaXMubWFzdGVySW5mby5wb3J0O1xyXG4gICAgb3B0cy5lbnYgPSB0aGlzLmFwcC5nZXQoUkVTRVJWRUQuRU5WKTtcclxuICAgIHRoaXMuY2xvc2VXYXRjaGVyID0gb3B0cy5jbG9zZVdhdGNoZXI7XHJcbiAgICB0aGlzLm1hc3RlckNvbnNvbGUgPSBhZG1pbi5jcmVhdGVNYXN0ZXJDb25zb2xlKG9wdHMpO1xyXG4gIH1cclxuICBzdGFydChjYj86IEZ1bmN0aW9uKSB7XHJcbiAgICBtb2R1bGVVdGlsLnJlZ2lzdGVyRGVmYXVsdE1vZHVsZXModHJ1ZSwgdGhpcy5hcHAsIHRoaXMuY2xvc2VXYXRjaGVyKTtcclxuICAgIG1vZHVsZVV0aWwubG9hZE1vZHVsZXModGhpcywgdGhpcy5tYXN0ZXJDb25zb2xlKTtcclxuXHJcbiAgICAvLyBzdGFydCBtYXN0ZXIgY29uc29sZVxyXG4gICAgdGhpcy5tYXN0ZXJDb25zb2xlLnN0YXJ0KChlcnI6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xyXG4gICAgICB9XHJcbiAgICAgIG1vZHVsZVV0aWwuc3RhcnRNb2R1bGVzKHRoaXMubW9kdWxlcywgKGVycjogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhLCBlcnIpO1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuYXBwLmdldChSRVNFUlZFRC5NT0RFKSAhPT0gUkVTRVJWRUQuU1RBTkRfQUxPTkUpIHtcclxuICAgICAgICAgIHN0YXJ0ZXIucnVuU2VydmVycyh0aGlzLmFwcCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5tYXN0ZXJDb25zb2xlLm9uKFwiZXJyb3JcIiwgKGVycjogYW55KSA9PiB7XHJcbiAgICAgIGlmICghIWVycikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihcIm1hc3RlckNvbnNvbGUgZW5jb3VudGVycyB3aXRoIGVycm9yOiBcIiArIGVyci5zdGFjayk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLm1hc3RlckNvbnNvbGUub24oXCJyZWNvbm5lY3RcIiwgKGluZm86IFNlcnZlckluZm8pID0+IHtcclxuICAgICAgdGhpcy5hcHAuYWRkU2VydmVycyhbaW5mb10pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gbW9uaXRvciBzZXJ2ZXJzIGRpc2Nvbm5lY3QgZXZlbnRcclxuICAgIHRoaXMubWFzdGVyQ29uc29sZS5vbihcclxuICAgICAgXCJkaXNjb25uZWN0XCIsXHJcbiAgICAgIChpZDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGluZm86IFNlcnZlckluZm8sIHJlYXNvbjogYW55KSA9PiB7XHJcbiAgICAgICAgY3Jhc2hMb2dnZXIuaW5mbyhcclxuICAgICAgICAgIHV0aWwuZm9ybWF0KFxyXG4gICAgICAgICAgICBcIlslc10sWyVzXSxbJXNdLFslc11cIixcclxuICAgICAgICAgICAgdHlwZSxcclxuICAgICAgICAgICAgaWQsXHJcbiAgICAgICAgICAgIERhdGUubm93KCksXHJcbiAgICAgICAgICAgIHJlYXNvbiB8fCBcImRpc2Nvbm5lY3RcIlxyXG4gICAgICAgICAgKVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgbGV0IGNvdW50ID0gMDtcclxuICAgICAgICBsZXQgdGltZSA9IDA7XHJcbiAgICAgICAgbGV0IHBpbmdUaW1lcjogYW55ID0gbnVsbDtcclxuICAgICAgICBsZXQgc2VydmVyID0gdGhpcy5hcHAuZ2V0U2VydmVyQnlJZChpZCk7XHJcbiAgICAgICAgbGV0IHN0b3BGbGFncyA9IHRoaXMuYXBwLmdldChSRVNFUlZFRC5TVE9QX1NFUlZFUlMpIHx8IFtdO1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgICEhc2VydmVyICYmXHJcbiAgICAgICAgICAoc2VydmVyW1JFU0VSVkVELkFVVE9fUkVTVEFSVF0gPT09IFwidHJ1ZVwiIHx8XHJcbiAgICAgICAgICAgIHNlcnZlcltSRVNFUlZFRC5SRVNUQVJUX0ZPUkNFXSA9PT0gXCJ0cnVlXCIpICYmXHJcbiAgICAgICAgICBzdG9wRmxhZ3MuaW5kZXhPZihpZCkgPCAwXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICBsZXQgc2V0VGltZXIgPSAodGltZTogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIHBpbmdUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHV0aWxzLnBpbmcoc2VydmVyLmhvc3QsIGZsYWcgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZsYWcpIHtcclxuICAgICAgICAgICAgICAgICAgaGFuZGxlKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICBjb3VudCsrO1xyXG4gICAgICAgICAgICAgICAgICBpZiAoY291bnQgPiAzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGltZSA9IFRJTUUuVElNRV9XQUlUX01BWF9QSU5HO1xyXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRpbWUgPSBUSU1FLlRJTUVfV0FJVF9QSU5HICogY291bnQ7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgc2V0VGltZXIodGltZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0sIHRpbWUpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHNldFRpbWVyKHRpbWUpO1xyXG4gICAgICAgICAgbGV0IGhhbmRsZSA9ICgpID0+IHtcclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHBpbmdUaW1lcik7XHJcbiAgICAgICAgICAgIHV0aWxzLmNoZWNrUG9ydChzZXJ2ZXIsIChzdGF0dXM6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IFwiZXJyb3JcIikge1xyXG4gICAgICAgICAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soXHJcbiAgICAgICAgICAgICAgICAgIGNiISxcclxuICAgICAgICAgICAgICAgICAgbmV3IEVycm9yKFwiQ2hlY2sgcG9ydCBjb21tYW5kIGV4ZWN1dGVkIHdpdGggZXJyb3IuXCIpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSBcImJ1c3lcIikge1xyXG4gICAgICAgICAgICAgICAgaWYgKCEhc2VydmVyW1JFU0VSVkVELlJFU1RBUlRfRk9SQ0VdKSB7XHJcbiAgICAgICAgICAgICAgICAgIHN0YXJ0ZXIua2lsbChbaW5mby5waWRdLCBbc2VydmVyXSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhcclxuICAgICAgICAgICAgICAgICAgICBjYiEsXHJcbiAgICAgICAgICAgICAgICAgICAgbmV3IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgICAgICAgXCJQb3J0IG9jY3VwaWVkIGFscmVhZHksIGNoZWNrIHlvdXIgc2VydmVyIHRvIGFkZC5cIlxyXG4gICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHN0YXJ0ZXIucnVuKHRoaXMuYXBwLCBzZXJ2ZXIpO1xyXG4gICAgICAgICAgICAgIH0sIFRJTUUuVElNRV9XQUlUX1NUT1ApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIC8vIG1vbml0b3Igc2VydmVycyByZWdpc3RlciBldmVudFxyXG4gICAgdGhpcy5tYXN0ZXJDb25zb2xlLm9uKFwicmVnaXN0ZXJcIiwgKHJlY29yZDogYW55KSA9PiB7XHJcbiAgICAgIHN0YXJ0ZXIuYmluZENwdShyZWNvcmQuaWQsIHJlY29yZC5waWQsIHJlY29yZC5ob3N0KTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMubWFzdGVyQ29uc29sZS5vbihcImFkbWluLWxvZ1wiLCAobG9nOiBhbnksIGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgYWRtaW5Mb2dnZXIuZXJyb3IoSlNPTi5zdHJpbmdpZnkobG9nKSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYWRtaW5Mb2dnZXIuaW5mbyhKU09OLnN0cmluZ2lmeShsb2cpKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdG9wKGNiOiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5tYXN0ZXJDb25zb2xlLnN0b3AoKTtcclxuICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgTWFzdGVyIH07XHJcbiJdfQ==