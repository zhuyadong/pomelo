"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const starter = require("./starter");
const util = require("util");
const index_1 = require("../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const crashLogger = require("pomelo-logger").getLogger("crash-log", __filename);
const adminLogger = require("pomelo-logger").getLogger("admin-log", __filename);
const admin = require("pomelo-admin");
class Master {
    constructor(app, opts) {
        this.app = app;
        this.masterInfo = app.master;
        this.registered = {};
        this.modules = [];
        opts = opts || {};
        opts.port = this.masterInfo.port;
        opts.env = this.app.get(index_1.RESERVED.ENV);
        this.closeWatcher = opts.closeWatcher;
        this.masterConsole = admin.createMasterConsole(opts);
    }
    start(cb) {
        index_1.moduleUtil.registerDefaultModules(true, this.app, this.closeWatcher);
        index_1.moduleUtil.loadModules(this, this.masterConsole);
        // start master console
        this.masterConsole.start((err) => {
            if (err) {
                process.exit(0);
            }
            index_1.moduleUtil.startModules(this.modules, (err) => {
                if (err) {
                    index_1.utils.invokeCallback(cb, err);
                    return;
                }
                if (this.app.get(index_1.RESERVED.MODE) !== index_1.RESERVED.STAND_ALONE) {
                    starter.runServers(this.app);
                }
                index_1.utils.invokeCallback(cb);
            });
        });
        this.masterConsole.on("error", (err) => {
            if (!!err) {
                logger.error("masterConsole encounters with error: " + err.stack);
                return;
            }
        });
        this.masterConsole.on("reconnect", (info) => {
            this.app.addServers([info]);
        });
        // monitor servers disconnect event
        this.masterConsole.on("disconnect", (id, type, info, reason) => {
            crashLogger.info(util.format("[%s],[%s],[%s],[%s]", type, id, Date.now(), reason || "disconnect"));
            let count = 0;
            let time = 0;
            let pingTimer = null;
            let server = this.app.getServerById(id);
            let stopFlags = this.app.get(index_1.RESERVED.STOP_SERVERS) || [];
            if (!!server &&
                (server[index_1.RESERVED.AUTO_RESTART] === "true" ||
                    server[index_1.RESERVED.RESTART_FORCE] === "true") &&
                stopFlags.indexOf(id) < 0) {
                let setTimer = (time) => {
                    pingTimer = setTimeout(() => {
                        index_1.utils.ping(server.host, flag => {
                            if (flag) {
                                handle();
                            }
                            else {
                                count++;
                                if (count > 3) {
                                    time = index_1.TIME.TIME_WAIT_MAX_PING;
                                }
                                else {
                                    time = index_1.TIME.TIME_WAIT_PING * count;
                                }
                                setTimer(time);
                            }
                        });
                    }, time);
                };
                setTimer(time);
                let handle = () => {
                    clearTimeout(pingTimer);
                    index_1.utils.checkPort(server, (status) => {
                        if (status === "error") {
                            index_1.utils.invokeCallback(cb, new Error("Check port command executed with error."));
                            return;
                        }
                        else if (status === "busy") {
                            if (!!server[index_1.RESERVED.RESTART_FORCE]) {
                                starter.kill([info.pid], [server]);
                            }
                            else {
                                index_1.utils.invokeCallback(cb, new Error("Port occupied already, check your server to add."));
                                return;
                            }
                        }
                        setTimeout(() => {
                            starter.run(this.app, server);
                        }, index_1.TIME.TIME_WAIT_STOP);
                    });
                };
            }
        });
        // monitor servers register event
        this.masterConsole.on("register", (record) => {
            starter.bindCpu(record.id, record.pid, record.host);
        });
        this.masterConsole.on("admin-log", (log, error) => {
            if (error) {
                adminLogger.error(JSON.stringify(log));
            }
            else {
                adminLogger.info(JSON.stringify(log));
            }
        });
    }
    stop(cb) {
        this.masterConsole.stop();
        process.nextTick(cb);
    }
}
exports.default = Master;
exports.Master = Master;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFzdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFzdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEscUNBQXFDO0FBQ3JDLDZCQUE4QjtBQUM5QixvQ0FRa0I7QUFFbEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDeEUsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDaEYsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDaEYsc0NBQXVDO0FBR3ZDO0lBTUUsWUFBcUIsR0FBZ0IsRUFBRSxJQUFVO1FBQTVCLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFDbkMsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBRWxCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7UUFDakMsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUN0QyxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBQ0QsS0FBSyxDQUFDLEVBQWE7UUFDakIsa0JBQVUsQ0FBQyxz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QyxJQUFJLENBQUMsQ0FBQztnQkFDTixXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN4QyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxDQUFDLEVBQVk7UUFDZixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzFCLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBN0lELHlCQTZJQztBQUVRLHdCQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgc3RhcnRlciBmcm9tIFwiLi9zdGFydGVyXCI7XG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xuaW1wb3J0IHtcbiAgU2VydmVySW5mbyxcbiAgTW9kdWxlLFxuICBBcHBsaWNhdGlvbixcbiAgUkVTRVJWRUQsXG4gIG1vZHVsZVV0aWwsXG4gIHV0aWxzLFxuICBUSU1FXG59IGZyb20gXCIuLi9pbmRleFwiO1xuXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XG5jb25zdCBjcmFzaExvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcImNyYXNoLWxvZ1wiLCBfX2ZpbGVuYW1lKTtcbmNvbnN0IGFkbWluTG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwiYWRtaW4tbG9nXCIsIF9fZmlsZW5hbWUpO1xuaW1wb3J0IGFkbWluID0gcmVxdWlyZShcInBvbWVsby1hZG1pblwiKTtcbmltcG9ydCB7IENvbnNvbGVTZXJ2aWNlIH0gZnJvbSBcInBvbWVsby1hZG1pblwiO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNYXN0ZXIge1xuICByZWFkb25seSBtYXN0ZXJJbmZvOiBTZXJ2ZXJJbmZvO1xuICBwcml2YXRlIG1vZHVsZXM6IE1vZHVsZVtdO1xuICBwcml2YXRlIGNsb3NlV2F0Y2hlcjogYm9vbGVhbjtcbiAgcHJpdmF0ZSBtYXN0ZXJDb25zb2xlOiBDb25zb2xlU2VydmljZTtcbiAgcHJpdmF0ZSByZWdpc3RlcmVkOiBhbnk7IC8vVE9ET1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XG4gICAgdGhpcy5tYXN0ZXJJbmZvID0gYXBwLm1hc3RlcjtcbiAgICB0aGlzLnJlZ2lzdGVyZWQgPSB7fTtcbiAgICB0aGlzLm1vZHVsZXMgPSBbXTtcbiAgICBvcHRzID0gb3B0cyB8fCB7fTtcblxuICAgIG9wdHMucG9ydCA9IHRoaXMubWFzdGVySW5mby5wb3J0O1xuICAgIG9wdHMuZW52ID0gdGhpcy5hcHAuZ2V0KFJFU0VSVkVELkVOVik7XG4gICAgdGhpcy5jbG9zZVdhdGNoZXIgPSBvcHRzLmNsb3NlV2F0Y2hlcjtcbiAgICB0aGlzLm1hc3RlckNvbnNvbGUgPSBhZG1pbi5jcmVhdGVNYXN0ZXJDb25zb2xlKG9wdHMpO1xuICB9XG4gIHN0YXJ0KGNiPzogRnVuY3Rpb24pIHtcbiAgICBtb2R1bGVVdGlsLnJlZ2lzdGVyRGVmYXVsdE1vZHVsZXModHJ1ZSwgdGhpcy5hcHAsIHRoaXMuY2xvc2VXYXRjaGVyKTtcbiAgICBtb2R1bGVVdGlsLmxvYWRNb2R1bGVzKHRoaXMsIHRoaXMubWFzdGVyQ29uc29sZSk7XG5cbiAgICAvLyBzdGFydCBtYXN0ZXIgY29uc29sZVxuICAgIHRoaXMubWFzdGVyQ29uc29sZS5zdGFydCgoZXJyOiBhbnkpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgICAgfVxuICAgICAgbW9kdWxlVXRpbC5zdGFydE1vZHVsZXModGhpcy5tb2R1bGVzLCAoZXJyOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISwgZXJyKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5hcHAuZ2V0KFJFU0VSVkVELk1PREUpICE9PSBSRVNFUlZFRC5TVEFORF9BTE9ORSkge1xuICAgICAgICAgIHN0YXJ0ZXIucnVuU2VydmVycyh0aGlzLmFwcCk7XG4gICAgICAgIH1cbiAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGhpcy5tYXN0ZXJDb25zb2xlLm9uKFwiZXJyb3JcIiwgKGVycjogYW55KSA9PiB7XG4gICAgICBpZiAoISFlcnIpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFwibWFzdGVyQ29uc29sZSBlbmNvdW50ZXJzIHdpdGggZXJyb3I6IFwiICsgZXJyLnN0YWNrKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5tYXN0ZXJDb25zb2xlLm9uKFwicmVjb25uZWN0XCIsIChpbmZvOiBTZXJ2ZXJJbmZvKSA9PiB7XG4gICAgICB0aGlzLmFwcC5hZGRTZXJ2ZXJzKFtpbmZvXSk7XG4gICAgfSk7XG5cbiAgICAvLyBtb25pdG9yIHNlcnZlcnMgZGlzY29ubmVjdCBldmVudFxuICAgIHRoaXMubWFzdGVyQ29uc29sZS5vbihcbiAgICAgIFwiZGlzY29ubmVjdFwiLFxuICAgICAgKGlkOiBzdHJpbmcsIHR5cGU6IHN0cmluZywgaW5mbzogU2VydmVySW5mbywgcmVhc29uOiBhbnkpID0+IHtcbiAgICAgICAgY3Jhc2hMb2dnZXIuaW5mbyhcbiAgICAgICAgICB1dGlsLmZvcm1hdChcbiAgICAgICAgICAgIFwiWyVzXSxbJXNdLFslc10sWyVzXVwiLFxuICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgRGF0ZS5ub3coKSxcbiAgICAgICAgICAgIHJlYXNvbiB8fCBcImRpc2Nvbm5lY3RcIlxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgICAgbGV0IGNvdW50ID0gMDtcbiAgICAgICAgbGV0IHRpbWUgPSAwO1xuICAgICAgICBsZXQgcGluZ1RpbWVyOiBhbnkgPSBudWxsO1xuICAgICAgICBsZXQgc2VydmVyID0gdGhpcy5hcHAuZ2V0U2VydmVyQnlJZChpZCk7XG4gICAgICAgIGxldCBzdG9wRmxhZ3MgPSB0aGlzLmFwcC5nZXQoUkVTRVJWRUQuU1RPUF9TRVJWRVJTKSB8fCBbXTtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICEhc2VydmVyICYmXG4gICAgICAgICAgKHNlcnZlcltSRVNFUlZFRC5BVVRPX1JFU1RBUlRdID09PSBcInRydWVcIiB8fFxuICAgICAgICAgICAgc2VydmVyW1JFU0VSVkVELlJFU1RBUlRfRk9SQ0VdID09PSBcInRydWVcIikgJiZcbiAgICAgICAgICBzdG9wRmxhZ3MuaW5kZXhPZihpZCkgPCAwXG4gICAgICAgICkge1xuICAgICAgICAgIGxldCBzZXRUaW1lciA9ICh0aW1lOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIHBpbmdUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICB1dGlscy5waW5nKHNlcnZlci5ob3N0LCBmbGFnID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmxhZykge1xuICAgICAgICAgICAgICAgICAgaGFuZGxlKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIGNvdW50Kys7XG4gICAgICAgICAgICAgICAgICBpZiAoY291bnQgPiAzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRpbWUgPSBUSU1FLlRJTUVfV0FJVF9NQVhfUElORztcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRpbWUgPSBUSU1FLlRJTUVfV0FJVF9QSU5HICogY291bnQ7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBzZXRUaW1lcih0aW1lKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSwgdGltZSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICBzZXRUaW1lcih0aW1lKTtcbiAgICAgICAgICBsZXQgaGFuZGxlID0gKCkgPT4ge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHBpbmdUaW1lcik7XG4gICAgICAgICAgICB1dGlscy5jaGVja1BvcnQoc2VydmVyLCAoc3RhdHVzOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gXCJlcnJvclwiKSB7XG4gICAgICAgICAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soXG4gICAgICAgICAgICAgICAgICBjYiEsXG4gICAgICAgICAgICAgICAgICBuZXcgRXJyb3IoXCJDaGVjayBwb3J0IGNvbW1hbmQgZXhlY3V0ZWQgd2l0aCBlcnJvci5cIilcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IFwiYnVzeVwiKSB7XG4gICAgICAgICAgICAgICAgaWYgKCEhc2VydmVyW1JFU0VSVkVELlJFU1RBUlRfRk9SQ0VdKSB7XG4gICAgICAgICAgICAgICAgICBzdGFydGVyLmtpbGwoW2luZm8ucGlkXSwgW3NlcnZlcl0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhcbiAgICAgICAgICAgICAgICAgICAgY2IhLFxuICAgICAgICAgICAgICAgICAgICBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgICAgICAgXCJQb3J0IG9jY3VwaWVkIGFscmVhZHksIGNoZWNrIHlvdXIgc2VydmVyIHRvIGFkZC5cIlxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBzdGFydGVyLnJ1bih0aGlzLmFwcCwgc2VydmVyKTtcbiAgICAgICAgICAgICAgfSwgVElNRS5USU1FX1dBSVRfU1RPUCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIG1vbml0b3Igc2VydmVycyByZWdpc3RlciBldmVudFxuICAgIHRoaXMubWFzdGVyQ29uc29sZS5vbihcInJlZ2lzdGVyXCIsIChyZWNvcmQ6IGFueSkgPT4ge1xuICAgICAgc3RhcnRlci5iaW5kQ3B1KHJlY29yZC5pZCwgcmVjb3JkLnBpZCwgcmVjb3JkLmhvc3QpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5tYXN0ZXJDb25zb2xlLm9uKFwiYWRtaW4tbG9nXCIsIChsb2c6IGFueSwgZXJyb3I6IGFueSkgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGFkbWluTG9nZ2VyLmVycm9yKEpTT04uc3RyaW5naWZ5KGxvZykpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYWRtaW5Mb2dnZXIuaW5mbyhKU09OLnN0cmluZ2lmeShsb2cpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHN0b3AoY2I6IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5tYXN0ZXJDb25zb2xlLnN0b3AoKTtcbiAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcbiAgfVxufVxuXG5leHBvcnQgeyBNYXN0ZXIgfTtcbiJdfQ==