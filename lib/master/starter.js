"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const os = require("os");
const cp = require("child_process");
const index_1 = require("../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
let env = index_1.RESERVED.ENV_DEV;
let cpus = {};
function runServers(app) {
    const condition = app.startId || app.type;
    switch (condition) {
        case index_1.RESERVED.MASTER:
            break;
        case index_1.RESERVED.ALL:
            const servers = app.serversFromConfig;
            for (let serverId in servers) {
                run(app, servers[serverId]);
            }
            break;
        default:
            const server = app.getServerFromConfig(condition);
            if (!!server) {
                run(app, server);
            }
            else {
                const servers = app.get("servers")[condition];
                for (let i = 0; i < servers.length; i++) {
                    run(app, servers[i]);
                }
            }
    }
}
exports.runServers = runServers;
function run(app, server, cb) {
    env = app.get("env");
    if (index_1.utils.isLocal(server.host)) {
        let options = [];
        if (!!server.args) {
            if (typeof server.args === "string") {
                options.push(server.args.trim());
            }
            else {
                options = options.concat(server.args);
            }
        }
        let cmd = app.get(index_1.RESERVED.MAIN);
        options.push(cmd);
        options.push(util_1.format("env=%s", env));
        for (let key in server) {
            if (key === index_1.RESERVED.CPU) {
                cpus[server.id] = server[key];
            }
            options.push(util_1.format("%s=%s", key, server[key]));
        }
        localrun(process.execPath, null, options, cb);
    }
    else {
        let cmd = util_1.format('cd "%s" && "%s"', app.base, process.execPath);
        let arg = server.args;
        if (arg !== undefined) {
            cmd += arg;
        }
        cmd += util_1.format(' "%s" env=%s ', app.get(index_1.RESERVED.MAIN), env);
        for (let key in server) {
            if (key === index_1.RESERVED.CPU) {
                cpus[server.id] = server[key];
            }
            cmd += util_1.format(" %s=%s ", key, server[key]);
        }
        sshrun(cmd, server.host, cb);
    }
}
exports.run = run;
function bindCpu(sid, pid, host) {
    if (os.platform() === index_1.PLATFORM.LINUX && cpus[sid] !== undefined) {
        if (index_1.utils.isLocal(host)) {
            let options = [];
            options.push("-pc");
            options.push(cpus[sid].toString());
            options.push(pid);
            localrun(index_1.COMMAND.TASKSET, null, options);
        }
        else {
            let cmd = util_1.format('taskset -pc "%s" "%s"', cpus[sid], pid);
            sshrun(cmd, host);
        }
    }
}
exports.bindCpu = bindCpu;
function kill(pids, servers) {
    let cmd;
    for (let i = 0; i < servers.length; i++) {
        let server = servers[i];
        if (index_1.utils.isLocal(server.host)) {
            let options = [];
            if (os.platform() === index_1.PLATFORM.WIN) {
                cmd = index_1.COMMAND.TASKKILL;
                options.push("/pid");
                options.push("/f");
            }
            else {
                cmd = index_1.COMMAND.KILL;
                options.push("-9");
            }
            options.push(pids[i]);
            localrun(cmd, null, options);
        }
        else {
            if (os.platform() === index_1.PLATFORM.WIN) {
                cmd = util_1.format("taskkill /pid %s /f", pids[i]);
            }
            else {
                cmd = util_1.format("kill -9 %s", pids[i]);
            }
            sshrun(cmd, server.host);
        }
    }
}
exports.kill = kill;
function sshrun(cmd, host, cb) {
    let args = [];
    args.push(host);
    let ssh_params = index_1.pomelo.app.get(index_1.RESERVED.SSH_CONFIG_PARAMS);
    if (!!ssh_params && Array.isArray(ssh_params)) {
        args = args.concat(ssh_params);
    }
    args.push(cmd);
    logger.info("Executing " + cmd + " on " + host + ":22");
    spawnProcess(index_1.COMMAND.SSH, host, args, cb);
    return;
}
exports.sshrun = sshrun;
function localrun(cmd, host, options, cb) {
    logger.info("Executing " + cmd + " " + options + " locally");
    spawnProcess(cmd, host, options, cb);
}
exports.localrun = localrun;
function spawnProcess(command, host, options, cb) {
    let child = null;
    if (env === index_1.RESERVED.ENV_DEV) {
        child = cp.spawn(command, options);
        let prefix = command === index_1.COMMAND.SSH ? "[" + host + "] " : "";
        child.stderr.on("data", chunk => {
            let msg = chunk.toString();
            process.stderr.write(msg);
            if (!!cb) {
                cb(msg);
            }
        });
        child.stdout.on("data", chunk => {
            let msg = prefix + chunk.toString();
            process.stdout.write(msg);
        });
    }
    else {
        child = cp.spawn(command, options, { detached: true, stdio: "inherit" });
        child.unref();
    }
    child.on("exit", code => {
        if (code !== 0) {
            logger.warn("child process exit with error, error code: %s, executed command: %s", code, command);
        }
        if (typeof cb === "function") {
            cb(code === 0 ? null : code);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YXJ0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBOEI7QUFDOUIseUJBQTBCO0FBQzFCLG9DQUFxQztBQUNyQyxvQ0FRa0I7QUFFbEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFeEUsSUFBSSxHQUFHLEdBQUcsZ0JBQVEsQ0FBQyxPQUFPLENBQUM7QUFDM0IsSUFBSSxJQUFJLEdBQThCLEVBQUUsQ0FBQztBQUV6QyxvQkFBMkIsR0FBZ0I7SUFDekMsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDO0lBQzFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDbEIsS0FBSyxnQkFBUSxDQUFDLE1BQU07WUFDbEIsS0FBSyxDQUFDO1FBQ1IsS0FBSyxnQkFBUSxDQUFDLEdBQUc7WUFDZixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsaUJBQWlCLENBQUM7WUFDdEMsR0FBRyxDQUFDLENBQUMsSUFBSSxRQUFRLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDN0IsR0FBRyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUM5QixDQUFDO1lBQ0QsS0FBSyxDQUFDO1FBQ1I7WUFDRSxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsbUJBQW1CLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDbEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ2IsR0FBRyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNuQixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FB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QUFFLElBQUksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUN6RSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVELEtBQUssQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2YsTUFBTSxDQUFDLElBQUksQ0FDVCxxRUFBcUUsRUFDckUsSUFBSSxFQUNKLE9BQU8sQ0FDUixDQUFDO1FBQ0osQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDN0IsRUFBRSxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0IsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZvcm1hdCB9IGZyb20gXCJ1dGlsXCI7XG5pbXBvcnQgb3MgPSByZXF1aXJlKFwib3NcIik7XG5pbXBvcnQgY3AgPSByZXF1aXJlKFwiY2hpbGRfcHJvY2Vzc1wiKTtcbmltcG9ydCB7XG4gIFJFU0VSVkVELFxuICBBcHBsaWNhdGlvbixcbiAgU2VydmVySW5mbyxcbiAgdXRpbHMsXG4gIENPTU1BTkQsXG4gIFBMQVRGT1JNLFxuICBwb21lbG9cbn0gZnJvbSBcIi4uL2luZGV4XCI7XG5cbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcblxubGV0IGVudiA9IFJFU0VSVkVELkVOVl9ERVY7XG5sZXQgY3B1czogeyBbaWR4OiBzdHJpbmddOiBudW1iZXIgfSA9IHt9O1xuXG5leHBvcnQgZnVuY3Rpb24gcnVuU2VydmVycyhhcHA6IEFwcGxpY2F0aW9uKSB7XG4gIGNvbnN0IGNvbmRpdGlvbiA9IGFwcC5zdGFydElkIHx8IGFwcC50eXBlO1xuICBzd2l0Y2ggKGNvbmRpdGlvbikge1xuICAgIGNhc2UgUkVTRVJWRUQuTUFTVEVSOlxuICAgICAgYnJlYWs7XG4gICAgY2FzZSBSRVNFUlZFRC5BTEw6XG4gICAgICBjb25zdCBzZXJ2ZXJzID0gYXBwLnNlcnZlcnNGcm9tQ29uZmlnO1xuICAgICAgZm9yIChsZXQgc2VydmVySWQgaW4gc2VydmVycykge1xuICAgICAgICBydW4oYXBwLCBzZXJ2ZXJzW3NlcnZlcklkXSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgY29uc3Qgc2VydmVyID0gYXBwLmdldFNlcnZlckZyb21Db25maWcoY29uZGl0aW9uKTtcbiAgICAgIGlmICghIXNlcnZlcikge1xuICAgICAgICBydW4oYXBwLCBzZXJ2ZXIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgc2VydmVycyA9IGFwcC5nZXQoXCJzZXJ2ZXJzXCIpW2NvbmRpdGlvbl07XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2VydmVycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIHJ1bihhcHAsIHNlcnZlcnNbaV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJ1bihhcHA6IEFwcGxpY2F0aW9uLCBzZXJ2ZXI6IFNlcnZlckluZm8sIGNiPzogRnVuY3Rpb24pIHtcbiAgZW52ID0gYXBwLmdldChcImVudlwiKTtcbiAgaWYgKHV0aWxzLmlzTG9jYWwoc2VydmVyLmhvc3QpKSB7XG4gICAgbGV0IG9wdGlvbnM6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKCEhc2VydmVyLmFyZ3MpIHtcbiAgICAgIGlmICh0eXBlb2Ygc2VydmVyLmFyZ3MgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgb3B0aW9ucy5wdXNoKHNlcnZlci5hcmdzLnRyaW0oKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvcHRpb25zID0gb3B0aW9ucy5jb25jYXQoc2VydmVyLmFyZ3MpO1xuICAgICAgfVxuICAgIH1cbiAgICBsZXQgY21kID0gYXBwLmdldChSRVNFUlZFRC5NQUlOKTtcbiAgICBvcHRpb25zLnB1c2goY21kKTtcbiAgICBvcHRpb25zLnB1c2goZm9ybWF0KFwiZW52PSVzXCIsIGVudikpO1xuICAgIGZvciAobGV0IGtleSBpbiBzZXJ2ZXIpIHtcbiAgICAgIGlmIChrZXkgPT09IFJFU0VSVkVELkNQVSkge1xuICAgICAgICBjcHVzW3NlcnZlci5pZF0gPSBzZXJ2ZXJba2V5XTtcbiAgICAgIH1cbiAgICAgIG9wdGlvbnMucHVzaChmb3JtYXQoXCIlcz0lc1wiLCBrZXksIHNlcnZlcltrZXldKSk7XG4gICAgfVxuICAgIGxvY2FscnVuKHByb2Nlc3MuZXhlY1BhdGgsIG51bGwsIG9wdGlvbnMsIGNiKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgY21kID0gZm9ybWF0KCdjZCBcIiVzXCIgJiYgXCIlc1wiJywgYXBwLmJhc2UsIHByb2Nlc3MuZXhlY1BhdGgpO1xuICAgIGxldCBhcmcgPSBzZXJ2ZXIuYXJncztcbiAgICBpZiAoYXJnICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNtZCArPSBhcmc7XG4gICAgfVxuICAgIGNtZCArPSBmb3JtYXQoJyBcIiVzXCIgZW52PSVzICcsIGFwcC5nZXQoUkVTRVJWRUQuTUFJTiksIGVudik7XG4gICAgZm9yIChsZXQga2V5IGluIHNlcnZlcikge1xuICAgICAgaWYgKGtleSA9PT0gUkVTRVJWRUQuQ1BVKSB7XG4gICAgICAgIGNwdXNbc2VydmVyLmlkXSA9IHNlcnZlcltrZXldO1xuICAgICAgfVxuICAgICAgY21kICs9IGZvcm1hdChcIiAlcz0lcyBcIiwga2V5LCBzZXJ2ZXJba2V5XSk7XG4gICAgfVxuICAgIHNzaHJ1bihjbWQsIHNlcnZlci5ob3N0LCBjYik7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJpbmRDcHUoc2lkOiBzdHJpbmcsIHBpZDogc3RyaW5nLCBob3N0OiBzdHJpbmcpIHtcbiAgaWYgKG9zLnBsYXRmb3JtKCkgPT09IFBMQVRGT1JNLkxJTlVYICYmIGNwdXNbc2lkXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKHV0aWxzLmlzTG9jYWwoaG9zdCkpIHtcbiAgICAgIGxldCBvcHRpb25zOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgb3B0aW9ucy5wdXNoKFwiLXBjXCIpO1xuICAgICAgb3B0aW9ucy5wdXNoKGNwdXNbc2lkXS50b1N0cmluZygpKTtcbiAgICAgIG9wdGlvbnMucHVzaChwaWQpO1xuICAgICAgbG9jYWxydW4oQ09NTUFORC5UQVNLU0VULCBudWxsLCBvcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGNtZCA9IGZvcm1hdCgndGFza3NldCAtcGMgXCIlc1wiIFwiJXNcIicsIGNwdXNbc2lkXSwgcGlkKTtcbiAgICAgIHNzaHJ1bihjbWQsIGhvc3QpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24ga2lsbChwaWRzOiBzdHJpbmdbXSwgc2VydmVyczogU2VydmVySW5mb1tdKSB7XG4gIGxldCBjbWQ7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc2VydmVycy5sZW5ndGg7IGkrKykge1xuICAgIGxldCBzZXJ2ZXIgPSBzZXJ2ZXJzW2ldO1xuICAgIGlmICh1dGlscy5pc0xvY2FsKHNlcnZlci5ob3N0KSkge1xuICAgICAgbGV0IG9wdGlvbnM6IHN0cmluZ1tdID0gW107XG4gICAgICBpZiAob3MucGxhdGZvcm0oKSA9PT0gUExBVEZPUk0uV0lOKSB7XG4gICAgICAgIGNtZCA9IENPTU1BTkQuVEFTS0tJTEw7XG4gICAgICAgIG9wdGlvbnMucHVzaChcIi9waWRcIik7XG4gICAgICAgIG9wdGlvbnMucHVzaChcIi9mXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY21kID0gQ09NTUFORC5LSUxMO1xuICAgICAgICBvcHRpb25zLnB1c2goXCItOVwiKTtcbiAgICAgIH1cbiAgICAgIG9wdGlvbnMucHVzaChwaWRzW2ldKTtcbiAgICAgIGxvY2FscnVuKGNtZCwgbnVsbCwgb3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChvcy5wbGF0Zm9ybSgpID09PSBQTEFURk9STS5XSU4pIHtcbiAgICAgICAgY21kID0gZm9ybWF0KFwidGFza2tpbGwgL3BpZCAlcyAvZlwiLCBwaWRzW2ldKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNtZCA9IGZvcm1hdChcImtpbGwgLTkgJXNcIiwgcGlkc1tpXSk7XG4gICAgICB9XG4gICAgICBzc2hydW4oY21kLCBzZXJ2ZXIuaG9zdCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzc2hydW4oY21kOiBzdHJpbmcsIGhvc3Q6IHN0cmluZywgY2I/OiBGdW5jdGlvbikge1xuICBsZXQgYXJncyA9IFtdO1xuICBhcmdzLnB1c2goaG9zdCk7XG4gIGxldCBzc2hfcGFyYW1zID0gcG9tZWxvLmFwcC5nZXQoUkVTRVJWRUQuU1NIX0NPTkZJR19QQVJBTVMpO1xuICBpZiAoISFzc2hfcGFyYW1zICYmIEFycmF5LmlzQXJyYXkoc3NoX3BhcmFtcykpIHtcbiAgICBhcmdzID0gYXJncy5jb25jYXQoc3NoX3BhcmFtcyk7XG4gIH1cbiAgYXJncy5wdXNoKGNtZCk7XG5cbiAgbG9nZ2VyLmluZm8oXCJFeGVjdXRpbmcgXCIgKyBjbWQgKyBcIiBvbiBcIiArIGhvc3QgKyBcIjoyMlwiKTtcbiAgc3Bhd25Qcm9jZXNzKENPTU1BTkQuU1NILCBob3N0LCBhcmdzLCBjYik7XG4gIHJldHVybjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxvY2FscnVuKFxuICBjbWQ6IHN0cmluZyxcbiAgaG9zdDogc3RyaW5nIHwgbnVsbCxcbiAgb3B0aW9uczogc3RyaW5nW10sXG4gIGNiPzogRnVuY3Rpb25cbikge1xuICBsb2dnZXIuaW5mbyhcIkV4ZWN1dGluZyBcIiArIGNtZCArIFwiIFwiICsgb3B0aW9ucyArIFwiIGxvY2FsbHlcIik7XG4gIHNwYXduUHJvY2VzcyhjbWQsIGhvc3QsIG9wdGlvbnMsIGNiKTtcbn1cblxuZnVuY3Rpb24gc3Bhd25Qcm9jZXNzKFxuICBjb21tYW5kOiBzdHJpbmcsXG4gIGhvc3Q6IHN0cmluZyB8IG51bGwsXG4gIG9wdGlvbnM6IHN0cmluZ1tdLFxuICBjYj86IEZ1bmN0aW9uXG4pIHtcbiAgbGV0IGNoaWxkID0gbnVsbDtcblxuICBpZiAoZW52ID09PSBSRVNFUlZFRC5FTlZfREVWKSB7XG4gICAgY2hpbGQgPSBjcC5zcGF3bihjb21tYW5kLCBvcHRpb25zKTtcbiAgICBsZXQgcHJlZml4ID0gY29tbWFuZCA9PT0gQ09NTUFORC5TU0ggPyBcIltcIiArIGhvc3QgKyBcIl0gXCIgOiBcIlwiO1xuXG4gICAgY2hpbGQuc3RkZXJyLm9uKFwiZGF0YVwiLCBjaHVuayA9PiB7XG4gICAgICBsZXQgbXNnID0gY2h1bmsudG9TdHJpbmcoKTtcbiAgICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKG1zZyk7XG4gICAgICBpZiAoISFjYikge1xuICAgICAgICBjYihtc2cpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY2hpbGQuc3Rkb3V0Lm9uKFwiZGF0YVwiLCBjaHVuayA9PiB7XG4gICAgICBsZXQgbXNnID0gcHJlZml4ICsgY2h1bmsudG9TdHJpbmcoKTtcbiAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKG1zZyk7XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgY2hpbGQgPSBjcC5zcGF3bihjb21tYW5kLCBvcHRpb25zLCB7IGRldGFjaGVkOiB0cnVlLCBzdGRpbzogXCJpbmhlcml0XCIgfSk7XG4gICAgY2hpbGQudW5yZWYoKTtcbiAgfVxuXG4gIGNoaWxkLm9uKFwiZXhpdFwiLCBjb2RlID0+IHtcbiAgICBpZiAoY29kZSAhPT0gMCkge1xuICAgICAgbG9nZ2VyLndhcm4oXG4gICAgICAgIFwiY2hpbGQgcHJvY2VzcyBleGl0IHdpdGggZXJyb3IsIGVycm9yIGNvZGU6ICVzLCBleGVjdXRlZCBjb21tYW5kOiAlc1wiLFxuICAgICAgICBjb2RlLFxuICAgICAgICBjb21tYW5kXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGNiID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNiKGNvZGUgPT09IDAgPyBudWxsIDogY29kZSk7XG4gICAgfVxuICB9KTtcbn1cbiJdfQ==