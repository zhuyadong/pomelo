"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const os = require("os");
const cp = require("child_process");
const index_1 = require("../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
let env = index_1.RESERVED.ENV_DEV;
let cpus = {};
function runServers(app) {
    const condition = app.startId || app.type;
    switch (condition) {
        case index_1.RESERVED.MASTER:
            break;
        case index_1.RESERVED.ALL:
            const servers = app.serversFromConfig;
            for (let serverId in servers) {
                run(app, servers[serverId]);
            }
            break;
        default:
            const server = app.getServerFromConfig(condition);
            if (!!server) {
                run(app, server);
            }
            else {
                const servers = app.get("servers")[condition];
                for (let i = 0; i < servers.length; i++) {
                    run(app, servers[i]);
                }
            }
    }
}
exports.runServers = runServers;
function run(app, server, cb) {
    env = app.get("env");
    if (index_1.utils.isLocal(server.host)) {
        let options = [];
        if (!!server.args) {
            if (typeof server.args === "string") {
                options.push(server.args.trim());
            }
            else {
                options = options.concat(server.args);
            }
        }
        let cmd = app.get(index_1.RESERVED.MAIN);
        options.push(cmd);
        options.push(util_1.format("env=%s", env));
        for (let key in server) {
            if (key === index_1.RESERVED.CPU) {
                cpus[server.id] = server[key];
            }
            options.push(util_1.format("%s=%s", key, server[key]));
        }
        localrun(process.execPath, null, options, cb);
    }
    else {
        let cmd = util_1.format('cd "%s" && "%s"', app.base, process.execPath);
        let arg = server.args;
        if (arg !== undefined) {
            cmd += arg;
        }
        cmd += util_1.format(' "%s" env=%s ', app.get(index_1.RESERVED.MAIN), env);
        for (let key in server) {
            if (key === index_1.RESERVED.CPU) {
                cpus[server.id] = server[key];
            }
            cmd += util_1.format(" %s=%s ", key, server[key]);
        }
        sshrun(cmd, server.host, cb);
    }
}
exports.run = run;
function bindCpu(sid, pid, host) {
    if (os.platform() === index_1.PLATFORM.LINUX && cpus[sid] !== undefined) {
        if (index_1.utils.isLocal(host)) {
            let options = [];
            options.push("-pc");
            options.push(cpus[sid].toString());
            options.push(pid);
            localrun(index_1.COMMAND.TASKSET, null, options);
        }
        else {
            let cmd = util_1.format('taskset -pc "%s" "%s"', cpus[sid], pid);
            sshrun(cmd, host);
        }
    }
}
exports.bindCpu = bindCpu;
function kill(pids, servers) {
    let cmd;
    for (let i = 0; i < servers.length; i++) {
        let server = servers[i];
        if (index_1.utils.isLocal(server.host)) {
            let options = [];
            if (os.platform() === index_1.PLATFORM.WIN) {
                cmd = index_1.COMMAND.TASKKILL;
                options.push("/pid");
                options.push("/f");
            }
            else {
                cmd = index_1.COMMAND.KILL;
                options.push("-9");
            }
            options.push(pids[i]);
            localrun(cmd, null, options);
        }
        else {
            if (os.platform() === index_1.PLATFORM.WIN) {
                cmd = util_1.format("taskkill /pid %s /f", pids[i]);
            }
            else {
                cmd = util_1.format("kill -9 %s", pids[i]);
            }
            sshrun(cmd, server.host);
        }
    }
}
exports.kill = kill;
function sshrun(cmd, host, cb) {
    let args = [];
    args.push(host);
    let ssh_params = index_1.pomelo.app.get(index_1.RESERVED.SSH_CONFIG_PARAMS);
    if (!!ssh_params && Array.isArray(ssh_params)) {
        args = args.concat(ssh_params);
    }
    args.push(cmd);
    logger.info("Executing " + cmd + " on " + host + ":22");
    spawnProcess(index_1.COMMAND.SSH, host, args, cb);
    return;
}
exports.sshrun = sshrun;
function localrun(cmd, host, options, cb) {
    logger.info("Executing " + cmd + " " + options + " locally");
    spawnProcess(cmd, host, options, cb);
}
exports.localrun = localrun;
function spawnProcess(command, host, options, cb) {
    let child = null;
    if (env === index_1.RESERVED.ENV_DEV) {
        child = cp.spawn(command, options);
        let prefix = command === index_1.COMMAND.SSH ? "[" + host + "] " : "";
        child.stderr.on("data", chunk => {
            let msg = chunk.toString();
            process.stderr.write(msg);
            if (!!cb) {
                cb(msg);
            }
        });
        child.stdout.on("data", chunk => {
            let msg = prefix + chunk.toString();
            process.stdout.write(msg);
        });
    }
    else {
        child = cp.spawn(command, options, { detached: true, stdio: "inherit" });
        child.unref();
    }
    child.on("exit", code => {
        if (code !== 0) {
            logger.warn("child process exit with error, error code: %s, executed command: %s", code, command);
        }
        if (typeof cb === "function") {
            cb(code === 0 ? null : code);
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YXJ0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBOEI7QUFDOUIseUJBQTBCO0FBQzFCLG9DQUFxQztBQUNyQyxvQ0FRa0I7QUFFbEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFeEUsSUFBSSxHQUFHLEdBQUcsZ0JBQVEsQ0FBQyxPQUFPLENBQUM7QUFDM0IsSUFBSSxJQUFJLEdBQThCLEVBQUUsQ0FBQztBQUV6QyxvQkFBMkIsR0FBZ0I7SUFDekMsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDO0lBQzFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDbEIsS0FBSyxnQkFBUSxDQUFDLE1BQU07WUFDbEIsS0FBSyxDQUFDO1FBQ1IsS0FBSyxnQkFBUSxDQUFDLEdBQUc7WUFDZixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsaUJBQWlCLENBQUM7WUFDdEMsR0FBRyxDQUFDLENBQUMsSUFBSSxRQUFRLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDN0IsR0FBRyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUM5QixDQUFDO1lBQ0QsS0FBSyxDQUFDO1FBQ1I7WUFDRSxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsbUJBQW1CLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDbEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ2IsR0FBRyxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNuQixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FB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QUFFLElBQUksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUN6RSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVELEtBQUssQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2YsTUFBTSxDQUFDLElBQUksQ0FDVCxxRUFBcUUsRUFDckUsSUFBSSxFQUNKLE9BQU8sQ0FDUixDQUFDO1FBQ0osQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDN0IsRUFBRSxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0IsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZvcm1hdCB9IGZyb20gXCJ1dGlsXCI7XHJcbmltcG9ydCBvcyA9IHJlcXVpcmUoXCJvc1wiKTtcclxuaW1wb3J0IGNwID0gcmVxdWlyZShcImNoaWxkX3Byb2Nlc3NcIik7XHJcbmltcG9ydCB7XHJcbiAgUkVTRVJWRUQsXHJcbiAgQXBwbGljYXRpb24sXHJcbiAgU2VydmVySW5mbyxcclxuICB1dGlscyxcclxuICBDT01NQU5ELFxyXG4gIFBMQVRGT1JNLFxyXG4gIHBvbWVsb1xyXG59IGZyb20gXCIuLi9pbmRleFwiO1xyXG5cclxuY29uc3QgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwicG9tZWxvXCIsIF9fZmlsZW5hbWUpO1xyXG5cclxubGV0IGVudiA9IFJFU0VSVkVELkVOVl9ERVY7XHJcbmxldCBjcHVzOiB7IFtpZHg6IHN0cmluZ106IG51bWJlciB9ID0ge307XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcnVuU2VydmVycyhhcHA6IEFwcGxpY2F0aW9uKSB7XHJcbiAgY29uc3QgY29uZGl0aW9uID0gYXBwLnN0YXJ0SWQgfHwgYXBwLnR5cGU7XHJcbiAgc3dpdGNoIChjb25kaXRpb24pIHtcclxuICAgIGNhc2UgUkVTRVJWRUQuTUFTVEVSOlxyXG4gICAgICBicmVhaztcclxuICAgIGNhc2UgUkVTRVJWRUQuQUxMOlxyXG4gICAgICBjb25zdCBzZXJ2ZXJzID0gYXBwLnNlcnZlcnNGcm9tQ29uZmlnO1xyXG4gICAgICBmb3IgKGxldCBzZXJ2ZXJJZCBpbiBzZXJ2ZXJzKSB7XHJcbiAgICAgICAgcnVuKGFwcCwgc2VydmVyc1tzZXJ2ZXJJZF0pO1xyXG4gICAgICB9XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgY29uc3Qgc2VydmVyID0gYXBwLmdldFNlcnZlckZyb21Db25maWcoY29uZGl0aW9uKTtcclxuICAgICAgaWYgKCEhc2VydmVyKSB7XHJcbiAgICAgICAgcnVuKGFwcCwgc2VydmVyKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBzZXJ2ZXJzID0gYXBwLmdldChcInNlcnZlcnNcIilbY29uZGl0aW9uXTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlcnZlcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgIHJ1bihhcHAsIHNlcnZlcnNbaV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJ1bihhcHA6IEFwcGxpY2F0aW9uLCBzZXJ2ZXI6IFNlcnZlckluZm8sIGNiPzogRnVuY3Rpb24pIHtcclxuICBlbnYgPSBhcHAuZ2V0KFwiZW52XCIpO1xyXG4gIGlmICh1dGlscy5pc0xvY2FsKHNlcnZlci5ob3N0KSkge1xyXG4gICAgbGV0IG9wdGlvbnM6IHN0cmluZ1tdID0gW107XHJcbiAgICBpZiAoISFzZXJ2ZXIuYXJncykge1xyXG4gICAgICBpZiAodHlwZW9mIHNlcnZlci5hcmdzID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgb3B0aW9ucy5wdXNoKHNlcnZlci5hcmdzLnRyaW0oKSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMuY29uY2F0KHNlcnZlci5hcmdzKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgbGV0IGNtZCA9IGFwcC5nZXQoUkVTRVJWRUQuTUFJTik7XHJcbiAgICBvcHRpb25zLnB1c2goY21kKTtcclxuICAgIG9wdGlvbnMucHVzaChmb3JtYXQoXCJlbnY9JXNcIiwgZW52KSk7XHJcbiAgICBmb3IgKGxldCBrZXkgaW4gc2VydmVyKSB7XHJcbiAgICAgIGlmIChrZXkgPT09IFJFU0VSVkVELkNQVSkge1xyXG4gICAgICAgIGNwdXNbc2VydmVyLmlkXSA9IHNlcnZlcltrZXldO1xyXG4gICAgICB9XHJcbiAgICAgIG9wdGlvbnMucHVzaChmb3JtYXQoXCIlcz0lc1wiLCBrZXksIHNlcnZlcltrZXldKSk7XHJcbiAgICB9XHJcbiAgICBsb2NhbHJ1bihwcm9jZXNzLmV4ZWNQYXRoLCBudWxsLCBvcHRpb25zLCBjYik7XHJcbiAgfSBlbHNlIHtcclxuICAgIGxldCBjbWQgPSBmb3JtYXQoJ2NkIFwiJXNcIiAmJiBcIiVzXCInLCBhcHAuYmFzZSwgcHJvY2Vzcy5leGVjUGF0aCk7XHJcbiAgICBsZXQgYXJnID0gc2VydmVyLmFyZ3M7XHJcbiAgICBpZiAoYXJnICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgY21kICs9IGFyZztcclxuICAgIH1cclxuICAgIGNtZCArPSBmb3JtYXQoJyBcIiVzXCIgZW52PSVzICcsIGFwcC5nZXQoUkVTRVJWRUQuTUFJTiksIGVudik7XHJcbiAgICBmb3IgKGxldCBrZXkgaW4gc2VydmVyKSB7XHJcbiAgICAgIGlmIChrZXkgPT09IFJFU0VSVkVELkNQVSkge1xyXG4gICAgICAgIGNwdXNbc2VydmVyLmlkXSA9IHNlcnZlcltrZXldO1xyXG4gICAgICB9XHJcbiAgICAgIGNtZCArPSBmb3JtYXQoXCIgJXM9JXMgXCIsIGtleSwgc2VydmVyW2tleV0pO1xyXG4gICAgfVxyXG4gICAgc3NocnVuKGNtZCwgc2VydmVyLmhvc3QsIGNiKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBiaW5kQ3B1KHNpZDogc3RyaW5nLCBwaWQ6IHN0cmluZywgaG9zdDogc3RyaW5nKSB7XHJcbiAgaWYgKG9zLnBsYXRmb3JtKCkgPT09IFBMQVRGT1JNLkxJTlVYICYmIGNwdXNbc2lkXSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICBpZiAodXRpbHMuaXNMb2NhbChob3N0KSkge1xyXG4gICAgICBsZXQgb3B0aW9uczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgb3B0aW9ucy5wdXNoKFwiLXBjXCIpO1xyXG4gICAgICBvcHRpb25zLnB1c2goY3B1c1tzaWRdLnRvU3RyaW5nKCkpO1xyXG4gICAgICBvcHRpb25zLnB1c2gocGlkKTtcclxuICAgICAgbG9jYWxydW4oQ09NTUFORC5UQVNLU0VULCBudWxsLCBvcHRpb25zKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGxldCBjbWQgPSBmb3JtYXQoJ3Rhc2tzZXQgLXBjIFwiJXNcIiBcIiVzXCInLCBjcHVzW3NpZF0sIHBpZCk7XHJcbiAgICAgIHNzaHJ1bihjbWQsIGhvc3QpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGtpbGwocGlkczogc3RyaW5nW10sIHNlcnZlcnM6IFNlcnZlckluZm9bXSkge1xyXG4gIGxldCBjbWQ7XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZXJ2ZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICBsZXQgc2VydmVyID0gc2VydmVyc1tpXTtcclxuICAgIGlmICh1dGlscy5pc0xvY2FsKHNlcnZlci5ob3N0KSkge1xyXG4gICAgICBsZXQgb3B0aW9uczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgaWYgKG9zLnBsYXRmb3JtKCkgPT09IFBMQVRGT1JNLldJTikge1xyXG4gICAgICAgIGNtZCA9IENPTU1BTkQuVEFTS0tJTEw7XHJcbiAgICAgICAgb3B0aW9ucy5wdXNoKFwiL3BpZFwiKTtcclxuICAgICAgICBvcHRpb25zLnB1c2goXCIvZlwiKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjbWQgPSBDT01NQU5ELktJTEw7XHJcbiAgICAgICAgb3B0aW9ucy5wdXNoKFwiLTlcIik7XHJcbiAgICAgIH1cclxuICAgICAgb3B0aW9ucy5wdXNoKHBpZHNbaV0pO1xyXG4gICAgICBsb2NhbHJ1bihjbWQsIG51bGwsIG9wdGlvbnMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKG9zLnBsYXRmb3JtKCkgPT09IFBMQVRGT1JNLldJTikge1xyXG4gICAgICAgIGNtZCA9IGZvcm1hdChcInRhc2traWxsIC9waWQgJXMgL2ZcIiwgcGlkc1tpXSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY21kID0gZm9ybWF0KFwia2lsbCAtOSAlc1wiLCBwaWRzW2ldKTtcclxuICAgICAgfVxyXG4gICAgICBzc2hydW4oY21kLCBzZXJ2ZXIuaG9zdCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc3NocnVuKGNtZDogc3RyaW5nLCBob3N0OiBzdHJpbmcsIGNiPzogRnVuY3Rpb24pIHtcclxuICBsZXQgYXJncyA9IFtdO1xyXG4gIGFyZ3MucHVzaChob3N0KTtcclxuICBsZXQgc3NoX3BhcmFtcyA9IHBvbWVsby5hcHAuZ2V0KFJFU0VSVkVELlNTSF9DT05GSUdfUEFSQU1TKTtcclxuICBpZiAoISFzc2hfcGFyYW1zICYmIEFycmF5LmlzQXJyYXkoc3NoX3BhcmFtcykpIHtcclxuICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChzc2hfcGFyYW1zKTtcclxuICB9XHJcbiAgYXJncy5wdXNoKGNtZCk7XHJcblxyXG4gIGxvZ2dlci5pbmZvKFwiRXhlY3V0aW5nIFwiICsgY21kICsgXCIgb24gXCIgKyBob3N0ICsgXCI6MjJcIik7XHJcbiAgc3Bhd25Qcm9jZXNzKENPTU1BTkQuU1NILCBob3N0LCBhcmdzLCBjYik7XHJcbiAgcmV0dXJuO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbG9jYWxydW4oXHJcbiAgY21kOiBzdHJpbmcsXHJcbiAgaG9zdDogc3RyaW5nIHwgbnVsbCxcclxuICBvcHRpb25zOiBzdHJpbmdbXSxcclxuICBjYj86IEZ1bmN0aW9uXHJcbikge1xyXG4gIGxvZ2dlci5pbmZvKFwiRXhlY3V0aW5nIFwiICsgY21kICsgXCIgXCIgKyBvcHRpb25zICsgXCIgbG9jYWxseVwiKTtcclxuICBzcGF3blByb2Nlc3MoY21kLCBob3N0LCBvcHRpb25zLCBjYik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNwYXduUHJvY2VzcyhcclxuICBjb21tYW5kOiBzdHJpbmcsXHJcbiAgaG9zdDogc3RyaW5nIHwgbnVsbCxcclxuICBvcHRpb25zOiBzdHJpbmdbXSxcclxuICBjYj86IEZ1bmN0aW9uXHJcbikge1xyXG4gIGxldCBjaGlsZCA9IG51bGw7XHJcblxyXG4gIGlmIChlbnYgPT09IFJFU0VSVkVELkVOVl9ERVYpIHtcclxuICAgIGNoaWxkID0gY3Auc3Bhd24oY29tbWFuZCwgb3B0aW9ucyk7XHJcbiAgICBsZXQgcHJlZml4ID0gY29tbWFuZCA9PT0gQ09NTUFORC5TU0ggPyBcIltcIiArIGhvc3QgKyBcIl0gXCIgOiBcIlwiO1xyXG5cclxuICAgIGNoaWxkLnN0ZGVyci5vbihcImRhdGFcIiwgY2h1bmsgPT4ge1xyXG4gICAgICBsZXQgbXNnID0gY2h1bmsudG9TdHJpbmcoKTtcclxuICAgICAgcHJvY2Vzcy5zdGRlcnIud3JpdGUobXNnKTtcclxuICAgICAgaWYgKCEhY2IpIHtcclxuICAgICAgICBjYihtc2cpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBjaGlsZC5zdGRvdXQub24oXCJkYXRhXCIsIGNodW5rID0+IHtcclxuICAgICAgbGV0IG1zZyA9IHByZWZpeCArIGNodW5rLnRvU3RyaW5nKCk7XHJcbiAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKG1zZyk7XHJcbiAgICB9KTtcclxuICB9IGVsc2Uge1xyXG4gICAgY2hpbGQgPSBjcC5zcGF3bihjb21tYW5kLCBvcHRpb25zLCB7IGRldGFjaGVkOiB0cnVlLCBzdGRpbzogXCJpbmhlcml0XCIgfSk7XHJcbiAgICBjaGlsZC51bnJlZigpO1xyXG4gIH1cclxuXHJcbiAgY2hpbGQub24oXCJleGl0XCIsIGNvZGUgPT4ge1xyXG4gICAgaWYgKGNvZGUgIT09IDApIHtcclxuICAgICAgbG9nZ2VyLndhcm4oXHJcbiAgICAgICAgXCJjaGlsZCBwcm9jZXNzIGV4aXQgd2l0aCBlcnJvciwgZXJyb3IgY29kZTogJXMsIGV4ZWN1dGVkIGNvbW1hbmQ6ICVzXCIsXHJcbiAgICAgICAgY29kZSxcclxuICAgICAgICBjb21tYW5kXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIGNiID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgY2IoY29kZSA9PT0gMCA/IG51bGwgOiBjb2RlKTtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG4iXX0=