"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
let logger = require("pomelo-logger").getLogger("pomelo", __filename);
const fs = require("fs");
const path = require("path");
const pathUtil = require("../util/pathUtil");
let Loader = require("pomelo-loader");
const utils = require("../util/utils");
let schedule = require("pomelo-scheduler");
const filterService_1 = require("../common/service/filterService");
const handlerService_1 = require("../common/service/handlerService");
const index_1 = require("../index");
const constants_1 = require("../util/constants");
const util_1 = require("util");
var State;
(function (State) {
    State[State["ST_INITED"] = 0] = "ST_INITED";
    State[State["ST_STARTED"] = 1] = "ST_STARTED";
    State[State["ST_STOPED"] = 2] = "ST_STOPED"; // server stoped
})(State || (State = {}));
class Server {
    constructor(app, opts) {
        this.app = app;
        this.opts = opts || {};
        this.globalFilterService = null;
        this.filterService = null;
        this.handlerService = null;
        this.crons = [];
        this.jobs = {};
        this.state = State.ST_INITED;
        app.event.on(index_1.events.ADD_CRONS, this.addCrons.bind(this));
        app.event.on(index_1.events.REMOVE_CRONS, this.removeCrons.bind(this));
    }
    start() {
        if (this.state > State.ST_INITED) {
            return;
        }
        this.globalFilterService = initFilter(true, this.app);
        this.filterService = initFilter(false, this.app);
        this.handlerService = initHandler(this.app, this.opts);
        this.cronHandlers = loadCronHandlers(this.app);
        loadCrons(this, this.app);
        this.state = State.ST_STARTED;
    }
    afterStart() {
        scheduleCrons(this, this.crons);
    }
    stop() {
        this.state = State.ST_STOPED;
    }
    globalHandle(msg, session, cb) {
        if (this.state !== State.ST_STARTED) {
            utils.invokeCallback(cb, new Error("server not started"));
            return;
        }
        let routeRecord = parseRoute(msg.route);
        if (!routeRecord) {
            utils.invokeCallback(cb, new Error(util_1.format("meet unknown route message %j", msg.route)));
            return;
        }
        let self = this;
        let dispatch = (err, resp, opts) => {
            if (err) {
                handleError(true, self, err, msg, session, resp, opts, (err, resp, opts) => {
                    response(true, self, err, msg, session, resp, opts, cb);
                });
                return;
            }
            if (self.app.serverType !== routeRecord.serverType) {
                doForward(self.app, msg, session, routeRecord, (err, resp, opts) => {
                    response(true, self, err, msg, session, resp, opts, cb);
                });
            }
            else {
                doHandle(self, msg, session, routeRecord, (err, resp, opts) => {
                    response(true, self, err, msg, session, resp, opts, cb);
                });
            }
        };
        beforeFilter(true, self, msg, session, dispatch);
    }
    handle(msg, session, cb) {
        if (this.state !== State.ST_STARTED) {
            cb(new Error("server not started"));
            return;
        }
        let routeRecord = parseRoute(msg.route);
        doHandle(this, msg, session, routeRecord, cb);
    }
    addCrons(crons) {
        this.cronHandlers = loadCronHandlers(this.app);
        for (let i = 0, l = crons.length; i < l; i++) {
            let cron = crons[i];
            checkAndAdd(cron, this.crons, this);
        }
        scheduleCrons(this, crons);
    }
    removeCrons(crons) {
        for (let i = 0, l = crons.length; i < l; i++) {
            let cron = crons[i];
            let id = cron.id;
            if (!!this.jobs[id]) {
                schedule.cancelJob(this.jobs[id]);
            }
            else {
                logger.warn("cron is not in application: %j", cron);
            }
        }
    }
}
exports.Server = Server;
function initFilter(isGlobal, app) {
    let service = new filterService_1.FilterService();
    let befores, afters;
    if (isGlobal) {
        befores = app.get(constants_1.KEYWORDS.GLOBAL_BEFORE_FILTER);
        afters = app.get(constants_1.KEYWORDS.GLOBAL_AFTER_FILTER);
    }
    else {
        befores = app.get(constants_1.KEYWORDS.BEFORE_FILTER);
        afters = app.get(constants_1.KEYWORDS.AFTER_FILTER);
    }
    let i, l;
    if (befores) {
        for (i = 0, l = befores.length; i < l; i++) {
            service.before(befores[i]);
        }
    }
    if (afters) {
        for (i = 0, l = afters.length; i < l; i++) {
            service.after(afters[i]);
        }
    }
    return service;
}
function initHandler(app, opts) {
    return new handlerService_1.HandlerService(app, opts);
}
function loadCronHandlers(app) {
    let p = pathUtil.getCronPath(app.base, app.serverType);
    if (p) {
        return Loader.load(p, app);
    }
}
function loadCrons(server, app) {
    let env = app.get(constants_1.RESERVED.ENV);
    let p = path.join(app.base, constants_1.FILEPATH.CRON);
    if (!fs.existsSync(p)) {
        p = path.join(app.base, constants_1.FILEPATH.CONFIG_DIR, env, path.basename(constants_1.FILEPATH.CRON));
        if (!fs.existsSync(p)) {
            return;
        }
    }
    app.loadConfigBaseApp(constants_1.RESERVED.CRONS, constants_1.FILEPATH.CRON);
    let crons = app.get(constants_1.RESERVED.CRONS);
    for (let serverType in crons) {
        if (app.serverType === serverType) {
            let list = crons[serverType];
            for (let i = 0; i < list.length; i++) {
                if (!list[i].serverId) {
                    checkAndAdd(list[i], server.crons, server);
                }
                else {
                    if (app.serverId === list[i].serverId) {
                        checkAndAdd(list[i], server.crons, server);
                    }
                }
            }
        }
    }
}
function beforeFilter(isGlobal, server, msg, session, cb) {
    let fm;
    if (isGlobal) {
        fm = server.globalFilterService;
    }
    else {
        fm = server.filterService;
    }
    if (fm) {
        fm.beforeFilter(msg, session, cb);
    }
    else {
        utils.invokeCallback(cb);
    }
}
function afterFilter(isGlobal, server, err, msg, session, resp, opts, cb) {
    let fm;
    if (isGlobal) {
        fm = server.globalFilterService;
    }
    else {
        fm = server.filterService;
    }
    if (fm) {
        if (isGlobal) {
            fm.afterFilter(err, msg, session, resp, () => {
                // do nothing
            });
        }
        else {
            fm.afterFilter(err, msg, session, resp, (err) => {
                cb(err, resp, opts);
            });
        }
    }
}
function handleError(isGlobal, server, err, msg, session, resp, opts, cb) {
    let handler;
    if (isGlobal) {
        handler = server.app.get(constants_1.RESERVED.GLOBAL_ERROR_HANDLER);
    }
    else {
        handler = server.app.get(constants_1.RESERVED.ERROR_HANDLER);
    }
    if (!handler) {
        logger.debug("no default error handler to resolve unknown exception. " + err.stack);
        utils.invokeCallback(cb, err, resp, opts);
    }
    else {
        if (handler.length === 5) {
            handler(err, msg, resp, session, cb);
        }
        else {
            handler(err, msg, resp, session, opts, cb);
        }
    }
}
function response(isGlobal, server, err, msg, session, resp, opts, cb) {
    if (isGlobal) {
        cb(err, resp, opts);
        // after filter should not interfere response
        afterFilter(isGlobal, server, err, msg, session, resp, opts, cb);
    }
    else {
        afterFilter(isGlobal, server, err, msg, session, resp, opts, cb);
    }
}
function parseRoute(route) {
    if (!route) {
        return null;
    }
    let ts = route.split(".");
    if (ts.length !== 3) {
        return null;
    }
    return {
        route: route,
        serverType: ts[0],
        handler: ts[1],
        method: ts[2]
    };
}
function doForward(app, msg, session, routeRecord, cb) {
    let finished = false;
    //should route to other servers
    try {
        app.sysrpc[routeRecord.serverType].msgRemote.forwardMessage(
        // app.sysrpc[routeRecord.serverType].msgRemote.forwardMessage2(
        session, msg, 
        // msg.oldRoute || msg.route,
        // msg.body,
        // msg.aesPassword,
        // msg.compressGzip,
        session.export(), (err, resp, opts) => {
            if (err) {
                logger.error("fail to process remote message:" + err.stack);
            }
            finished = true;
            utils.invokeCallback(cb, err, resp, opts);
        });
    }
    catch (err) {
        if (!finished) {
            logger.error(`[${app.serverId}] fail to forward message:` + err.stack);
            utils.invokeCallback(cb, err);
        }
    }
}
function doHandle(server, msg, session, routeRecord, cb) {
    let originMsg = msg;
    msg = msg.body || {};
    msg.__route__ = originMsg.route;
    let self = server;
    let handle = (err, resp, opts) => {
        if (err) {
            // error from before filter
            handleError(false, self, err, msg, session, resp, opts, (err, resp, opts) => {
                response(false, self, err, msg, session, resp, opts, cb);
            });
            return;
        }
        self.handlerService.handle(routeRecord, msg, session, (err, resp, opts) => {
            if (err) {
                //error from handler
                handleError(false, self, err, msg, session, resp, opts, (err, resp, opts) => {
                    response(false, self, err, msg, session, resp, opts, cb);
                });
                return;
            }
            response(false, self, err, msg, session, resp, opts, cb);
        });
    }; //end of handle
    beforeFilter(false, server, msg, session, handle);
}
function scheduleCrons(server, crons) {
    let handlers = server.cronHandlers;
    for (let i = 0; i < crons.length; i++) {
        let cronInfo = crons[i];
        let time = cronInfo.time;
        let action = cronInfo.action;
        let jobId = cronInfo.id;
        if (!time || !action || !jobId) {
            logger.error("cron miss necessary parameters: %j", cronInfo);
            continue;
        }
        if (action.indexOf(".") < 0) {
            logger.error("cron action is error format: %j", cronInfo);
            continue;
        }
        let cron = action.split(".")[0];
        let job = action.split(".")[1];
        let handler = handlers[cron];
        if (!handler) {
            logger.error("could not find cron: %j", cronInfo);
            continue;
        }
        if (typeof handler[job] !== "function") {
            logger.error("could not find cron job: %j, %s", cronInfo, job);
            continue;
        }
        let id = schedule.scheduleJob(time, handler[job].bind(handler));
        server.jobs[jobId] = id;
    }
}
function checkAndAdd(cron, crons, server) {
    if (!containCron(cron.id, crons)) {
        server.crons.push(cron);
    }
    else {
        logger.warn("cron is duplicated: %j", cron);
    }
}
function containCron(id, crons) {
    for (let i = 0, l = crons.length; i < l; i++) {
        if (id === crons[i].id) {
            return true;
        }
    }
    return false;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDdEUseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5Qiw2Q0FBOEM7QUFDOUMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3RDLHVDQUF3QztBQUN4QyxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUUzQyxtRUFBZ0U7QUFDaEUscUVBSTBDO0FBRTFDLG9DQUFtRTtBQUNuRSxpREFBaUU7QUFFakUsK0JBQThCO0FBRTlCLElBQUssS0FJSjtBQUpELFdBQUssS0FBSztJQUNSLDJDQUFhLENBQUE7SUFDYiw2Q0FBYyxDQUFBO0lBQ2QsMkNBQWEsQ0FBQSxDQUFDLGdCQUFnQjtBQUNoQyxDQUFDLEVBSkksS0FBSyxLQUFMLEtBQUssUUFJVDtBQVdEO0lBU0UsWUFBcUIsR0FBZ0IsRUFBRSxJQUFVO1FBQTVCLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFDbkMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxtQkFBbUIsR0FBUSxJQUFJLENBQUM7UUFDckMsSUFBSSxDQUFDLGFBQWEsR0FBUSxJQUFJLENBQUM7UUFDL0IsSUFBSSxDQUFDLGNBQWMsR0FBUSxJQUFJLENBQUM7UUFDaEMsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFFN0IsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsY0FBTSxDQUFDLFNBQVMsRUFB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Q0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM3QyxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJsZXQgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwicG9tZWxvXCIsIF9fZmlsZW5hbWUpO1xyXG5pbXBvcnQgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmltcG9ydCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmltcG9ydCBwYXRoVXRpbCA9IHJlcXVpcmUoXCIuLi91dGlsL3BhdGhVdGlsXCIpO1xyXG5sZXQgTG9hZGVyID0gcmVxdWlyZShcInBvbWVsby1sb2FkZXJcIik7XHJcbmltcG9ydCB1dGlscyA9IHJlcXVpcmUoXCIuLi91dGlsL3V0aWxzXCIpO1xyXG5sZXQgc2NoZWR1bGUgPSByZXF1aXJlKFwicG9tZWxvLXNjaGVkdWxlclwiKTtcclxuXHJcbmltcG9ydCB7IEZpbHRlclNlcnZpY2UgfSBmcm9tIFwiLi4vY29tbW9uL3NlcnZpY2UvZmlsdGVyU2VydmljZVwiO1xyXG5pbXBvcnQge1xyXG4gIEhhbmRsZXJTZXJ2aWNlLFxyXG4gIEhhbmRsZXJzTWFwLFxyXG4gIEhhbmRsZXJzXHJcbn0gZnJvbSBcIi4uL2NvbW1vbi9zZXJ2aWNlL2hhbmRsZXJTZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBDb21wb25lbnQsIENyb24gfSBmcm9tIFwiLi4vYXBwbGljYXRpb25cIjtcclxuaW1wb3J0IHsgZXZlbnRzLCBGcm9udGVuZFNlc3Npb24sIEJhY2tlbmRTZXNzaW9uIH0gZnJvbSBcIi4uL2luZGV4XCI7XHJcbmltcG9ydCB7IFJFU0VSVkVELCBGSUxFUEFUSCwgS0VZV09SRFMgfSBmcm9tIFwiLi4vdXRpbC9jb25zdGFudHNcIjtcclxuaW1wb3J0IHsgU2Vzc2lvbiB9IGZyb20gXCIuLi9jb21tb24vc2VydmljZS9zZXNzaW9uU2VydmljZVwiO1xyXG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tIFwidXRpbFwiO1xyXG5cclxuZW51bSBTdGF0ZSB7XHJcbiAgU1RfSU5JVEVEID0gMCwgLy8gc2VydmVyIGluaXRlZFxyXG4gIFNUX1NUQVJURUQgPSAxLCAvLyBzZXJ2ZXIgc3RhcnRlZFxyXG4gIFNUX1NUT1BFRCA9IDIgLy8gc2VydmVyIHN0b3BlZFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFJvdXRlUmVjb3JkIHtcclxuICByb3V0ZTogc3RyaW5nO1xyXG4gIHNlcnZlclR5cGU6IHN0cmluZztcclxuICBoYW5kbGVyOiBzdHJpbmc7XHJcbiAgbWV0aG9kOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIEpvYk1hcCA9IHsgW2lkeDogc3RyaW5nXTogYW55IH07XHJcblxyXG5leHBvcnQgY2xhc3MgU2VydmVyIHtcclxuICByZWFkb25seSBjcm9uczogQ3JvbltdO1xyXG4gIHJlYWRvbmx5IGpvYnM6IEpvYk1hcDtcclxuICByZWFkb25seSBjcm9uSGFuZGxlcnM6IEhhbmRsZXJzO1xyXG4gIHJlYWRvbmx5IGdsb2JhbEZpbHRlclNlcnZpY2U6IEZpbHRlclNlcnZpY2U7XHJcbiAgcmVhZG9ubHkgZmlsdGVyU2VydmljZTogRmlsdGVyU2VydmljZTtcclxuICByZWFkb25seSBoYW5kbGVyU2VydmljZTogSGFuZGxlclNlcnZpY2U7XHJcbiAgcHJpdmF0ZSBvcHRzOiBhbnk7XHJcbiAgcHJpdmF0ZSBzdGF0ZTogU3RhdGU7XHJcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgb3B0cz86IGFueSkge1xyXG4gICAgdGhpcy5vcHRzID0gb3B0cyB8fCB7fTtcclxuICAgIHRoaXMuZ2xvYmFsRmlsdGVyU2VydmljZSA9IDxhbnk+bnVsbDtcclxuICAgIHRoaXMuZmlsdGVyU2VydmljZSA9IDxhbnk+bnVsbDtcclxuICAgIHRoaXMuaGFuZGxlclNlcnZpY2UgPSA8YW55Pm51bGw7XHJcbiAgICB0aGlzLmNyb25zID0gW107XHJcbiAgICB0aGlzLmpvYnMgPSB7fTtcclxuICAgIHRoaXMuc3RhdGUgPSBTdGF0ZS5TVF9JTklURUQ7XHJcblxyXG4gICAgYXBwLmV2ZW50Lm9uKGV2ZW50cy5BRERfQ1JPTlMsIHRoaXMuYWRkQ3JvbnMuYmluZCh0aGlzKSk7XHJcbiAgICBhcHAuZXZlbnQub24oZXZlbnRzLlJFTU9WRV9DUk9OUywgdGhpcy5yZW1vdmVDcm9ucy5iaW5kKHRoaXMpKTtcclxuICB9XHJcbiAgc3RhcnQoKSB7XHJcbiAgICBpZiAodGhpcy5zdGF0ZSA+IFN0YXRlLlNUX0lOSVRFRCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5nbG9iYWxGaWx0ZXJTZXJ2aWNlISA9IGluaXRGaWx0ZXIodHJ1ZSwgdGhpcy5hcHApO1xyXG4gICAgdGhpcy5maWx0ZXJTZXJ2aWNlISA9IGluaXRGaWx0ZXIoZmFsc2UsIHRoaXMuYXBwKTtcclxuICAgIHRoaXMuaGFuZGxlclNlcnZpY2UhID0gaW5pdEhhbmRsZXIodGhpcy5hcHAsIHRoaXMub3B0cyk7XHJcbiAgICB0aGlzLmNyb25IYW5kbGVycyEgPSBsb2FkQ3JvbkhhbmRsZXJzKHRoaXMuYXBwKTtcclxuICAgIGxvYWRDcm9ucyh0aGlzLCB0aGlzLmFwcCk7XHJcbiAgICB0aGlzLnN0YXRlID0gU3RhdGUuU1RfU1RBUlRFRDtcclxuICB9XHJcbiAgYWZ0ZXJTdGFydCgpIHtcclxuICAgIHNjaGVkdWxlQ3JvbnModGhpcywgdGhpcy5jcm9ucyk7XHJcbiAgfVxyXG4gIHN0b3AoKSB7XHJcbiAgICB0aGlzLnN0YXRlID0gU3RhdGUuU1RfU1RPUEVEO1xyXG4gIH1cclxuICBnbG9iYWxIYW5kbGUobXNnOiBhbnksIHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbiwgY2I/OiBGdW5jdGlvbikge1xyXG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IFN0YXRlLlNUX1NUQVJURUQpIHtcclxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhLCBuZXcgRXJyb3IoXCJzZXJ2ZXIgbm90IHN0YXJ0ZWRcIikpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHJvdXRlUmVjb3JkID0gcGFyc2VSb3V0ZShtc2cucm91dGUpO1xyXG4gICAgaWYgKCFyb3V0ZVJlY29yZCkge1xyXG4gICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhcclxuICAgICAgICBjYiEsXHJcbiAgICAgICAgbmV3IEVycm9yKGZvcm1hdChcIm1lZXQgdW5rbm93biByb3V0ZSBtZXNzYWdlICVqXCIsIG1zZy5yb3V0ZSkpXHJcbiAgICAgICk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2VsZiA9IHRoaXM7XHJcbiAgICBsZXQgZGlzcGF0Y2ggPSAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XHJcbiAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICBoYW5kbGVFcnJvcihcclxuICAgICAgICAgIHRydWUsXHJcbiAgICAgICAgICBzZWxmLFxyXG4gICAgICAgICAgZXJyLFxyXG4gICAgICAgICAgbXNnLFxyXG4gICAgICAgICAgc2Vzc2lvbixcclxuICAgICAgICAgIHJlc3AsXHJcbiAgICAgICAgICBvcHRzLFxyXG4gICAgICAgICAgKGVycjogYW55LCByZXNwOiBhbnksIG9wdHM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICByZXNwb25zZSh0cnVlLCBzZWxmLCBlcnIsIG1zZywgc2Vzc2lvbiwgcmVzcCwgb3B0cywgY2IhKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHNlbGYuYXBwLnNlcnZlclR5cGUgIT09IHJvdXRlUmVjb3JkIS5zZXJ2ZXJUeXBlKSB7XHJcbiAgICAgICAgZG9Gb3J3YXJkKFxyXG4gICAgICAgICAgc2VsZi5hcHAsXHJcbiAgICAgICAgICBtc2csXHJcbiAgICAgICAgICBzZXNzaW9uLFxyXG4gICAgICAgICAgcm91dGVSZWNvcmQhLFxyXG4gICAgICAgICAgKGVycjogYW55LCByZXNwOiBhbnksIG9wdHM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICByZXNwb25zZSh0cnVlLCBzZWxmLCBlcnIsIG1zZywgc2Vzc2lvbiwgcmVzcCwgb3B0cywgY2IhKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRvSGFuZGxlKFxyXG4gICAgICAgICAgc2VsZixcclxuICAgICAgICAgIG1zZyxcclxuICAgICAgICAgIHNlc3Npb24sXHJcbiAgICAgICAgICByb3V0ZVJlY29yZCEsXHJcbiAgICAgICAgICAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHJlc3BvbnNlKHRydWUsIHNlbGYsIGVyciwgbXNnLCBzZXNzaW9uLCByZXNwLCBvcHRzLCBjYiEpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBiZWZvcmVGaWx0ZXIodHJ1ZSwgc2VsZiwgbXNnLCBzZXNzaW9uLCBkaXNwYXRjaCk7XHJcbiAgfVxyXG5cclxuICBoYW5kbGUobXNnOiBhbnksIHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbiwgY2I6IEZ1bmN0aW9uKSB7XHJcbiAgICBpZiAodGhpcy5zdGF0ZSAhPT0gU3RhdGUuU1RfU1RBUlRFRCkge1xyXG4gICAgICBjYihuZXcgRXJyb3IoXCJzZXJ2ZXIgbm90IHN0YXJ0ZWRcIikpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHJvdXRlUmVjb3JkID0gcGFyc2VSb3V0ZShtc2cucm91dGUpO1xyXG4gICAgZG9IYW5kbGUodGhpcywgbXNnLCBzZXNzaW9uLCByb3V0ZVJlY29yZCEsIGNiKTtcclxuICB9XHJcblxyXG4gIGFkZENyb25zKGNyb25zOiBDcm9uW10pIHtcclxuICAgIHRoaXMuY3JvbkhhbmRsZXJzISA9IGxvYWRDcm9uSGFuZGxlcnModGhpcy5hcHApO1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBjcm9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgbGV0IGNyb24gPSBjcm9uc1tpXTtcclxuICAgICAgY2hlY2tBbmRBZGQoY3JvbiwgdGhpcy5jcm9ucywgdGhpcyk7XHJcbiAgICB9XHJcbiAgICBzY2hlZHVsZUNyb25zKHRoaXMsIGNyb25zKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUNyb25zKGNyb25zOiBDcm9uW10pIHtcclxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gY3JvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgIGxldCBjcm9uID0gY3JvbnNbaV07XHJcbiAgICAgIGxldCBpZCA9IGNyb24uaWQ7XHJcbiAgICAgIGlmICghIXRoaXMuam9ic1tpZF0pIHtcclxuICAgICAgICBzY2hlZHVsZS5jYW5jZWxKb2IodGhpcy5qb2JzW2lkXSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbG9nZ2VyLndhcm4oXCJjcm9uIGlzIG5vdCBpbiBhcHBsaWNhdGlvbjogJWpcIiwgY3Jvbik7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluaXRGaWx0ZXIoaXNHbG9iYWw6IGJvb2xlYW4sIGFwcDogQXBwbGljYXRpb24pIHtcclxuICBsZXQgc2VydmljZSA9IG5ldyBGaWx0ZXJTZXJ2aWNlKCk7XHJcbiAgbGV0IGJlZm9yZXMsIGFmdGVycztcclxuXHJcbiAgaWYgKGlzR2xvYmFsKSB7XHJcbiAgICBiZWZvcmVzID0gYXBwLmdldChLRVlXT1JEUy5HTE9CQUxfQkVGT1JFX0ZJTFRFUik7XHJcbiAgICBhZnRlcnMgPSBhcHAuZ2V0KEtFWVdPUkRTLkdMT0JBTF9BRlRFUl9GSUxURVIpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBiZWZvcmVzID0gYXBwLmdldChLRVlXT1JEUy5CRUZPUkVfRklMVEVSKTtcclxuICAgIGFmdGVycyA9IGFwcC5nZXQoS0VZV09SRFMuQUZURVJfRklMVEVSKTtcclxuICB9XHJcblxyXG4gIGxldCBpLCBsO1xyXG4gIGlmIChiZWZvcmVzKSB7XHJcbiAgICBmb3IgKGkgPSAwLCBsID0gYmVmb3Jlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgc2VydmljZS5iZWZvcmUoYmVmb3Jlc1tpXSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpZiAoYWZ0ZXJzKSB7XHJcbiAgICBmb3IgKGkgPSAwLCBsID0gYWZ0ZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICBzZXJ2aWNlLmFmdGVyKGFmdGVyc1tpXSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gc2VydmljZTtcclxufVxyXG5cclxuZnVuY3Rpb24gaW5pdEhhbmRsZXIoYXBwOiBBcHBsaWNhdGlvbiwgb3B0cz86IGFueSkge1xyXG4gIHJldHVybiBuZXcgSGFuZGxlclNlcnZpY2UoYXBwLCBvcHRzKTtcclxufVxyXG5cclxuZnVuY3Rpb24gbG9hZENyb25IYW5kbGVycyhhcHA6IEFwcGxpY2F0aW9uKSB7XHJcbiAgbGV0IHAgPSBwYXRoVXRpbC5nZXRDcm9uUGF0aChhcHAuYmFzZSwgYXBwLnNlcnZlclR5cGUpO1xyXG4gIGlmIChwKSB7XHJcbiAgICByZXR1cm4gTG9hZGVyLmxvYWQocCwgYXBwKTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRDcm9ucyhzZXJ2ZXI6IFNlcnZlciwgYXBwOiBBcHBsaWNhdGlvbikge1xyXG4gIGxldCBlbnYgPSBhcHAuZ2V0KFJFU0VSVkVELkVOVik7XHJcbiAgbGV0IHAgPSBwYXRoLmpvaW4oYXBwLmJhc2UsIEZJTEVQQVRILkNST04pO1xyXG4gIGlmICghZnMuZXhpc3RzU3luYyhwKSkge1xyXG4gICAgcCA9IHBhdGguam9pbihcclxuICAgICAgYXBwLmJhc2UsXHJcbiAgICAgIEZJTEVQQVRILkNPTkZJR19ESVIsXHJcbiAgICAgIGVudixcclxuICAgICAgcGF0aC5iYXNlbmFtZShGSUxFUEFUSC5DUk9OKVxyXG4gICAgKTtcclxuICAgIGlmICghZnMuZXhpc3RzU3luYyhwKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgfVxyXG4gIGFwcC5sb2FkQ29uZmlnQmFzZUFwcChSRVNFUlZFRC5DUk9OUywgRklMRVBBVEguQ1JPTik7XHJcbiAgbGV0IGNyb25zID0gYXBwLmdldChSRVNFUlZFRC5DUk9OUyk7XHJcbiAgZm9yIChsZXQgc2VydmVyVHlwZSBpbiBjcm9ucykge1xyXG4gICAgaWYgKGFwcC5zZXJ2ZXJUeXBlID09PSBzZXJ2ZXJUeXBlKSB7XHJcbiAgICAgIGxldCBsaXN0ID0gY3JvbnNbc2VydmVyVHlwZV07XHJcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGlmICghbGlzdFtpXS5zZXJ2ZXJJZCkge1xyXG4gICAgICAgICAgY2hlY2tBbmRBZGQobGlzdFtpXSwgc2VydmVyLmNyb25zLCBzZXJ2ZXIpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpZiAoYXBwLnNlcnZlcklkID09PSBsaXN0W2ldLnNlcnZlcklkKSB7XHJcbiAgICAgICAgICAgIGNoZWNrQW5kQWRkKGxpc3RbaV0sIHNlcnZlci5jcm9ucywgc2VydmVyKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJlZm9yZUZpbHRlcihcclxuICBpc0dsb2JhbDogYm9vbGVhbixcclxuICBzZXJ2ZXI6IFNlcnZlcixcclxuICBtc2c6IGFueSxcclxuICBzZXNzaW9uOiBGcm9udGVuZFNlc3Npb258QmFja2VuZFNlc3Npb24sXHJcbiAgY2I/OiBGdW5jdGlvblxyXG4pIHtcclxuICBsZXQgZm07XHJcbiAgaWYgKGlzR2xvYmFsKSB7XHJcbiAgICBmbSA9IHNlcnZlci5nbG9iYWxGaWx0ZXJTZXJ2aWNlO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBmbSA9IHNlcnZlci5maWx0ZXJTZXJ2aWNlO1xyXG4gIH1cclxuICBpZiAoZm0pIHtcclxuICAgIGZtLmJlZm9yZUZpbHRlcihtc2csIHNlc3Npb24sIGNiISk7XHJcbiAgfSBlbHNlIHtcclxuICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBhZnRlckZpbHRlcihcclxuICBpc0dsb2JhbDogYm9vbGVhbixcclxuICBzZXJ2ZXI6IFNlcnZlcixcclxuICBlcnI6IGFueSxcclxuICBtc2c6IGFueSxcclxuICBzZXNzaW9uOiBGcm9udGVuZFNlc3Npb258QmFja2VuZFNlc3Npb24sXHJcbiAgcmVzcDogYW55LFxyXG4gIG9wdHM6IGFueSxcclxuICBjYjogRnVuY3Rpb25cclxuKSB7XHJcbiAgbGV0IGZtO1xyXG4gIGlmIChpc0dsb2JhbCkge1xyXG4gICAgZm0gPSBzZXJ2ZXIuZ2xvYmFsRmlsdGVyU2VydmljZTtcclxuICB9IGVsc2Uge1xyXG4gICAgZm0gPSBzZXJ2ZXIuZmlsdGVyU2VydmljZTtcclxuICB9XHJcbiAgaWYgKGZtKSB7XHJcbiAgICBpZiAoaXNHbG9iYWwpIHtcclxuICAgICAgZm0uYWZ0ZXJGaWx0ZXIoZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsICgpID0+IHtcclxuICAgICAgICAvLyBkbyBub3RoaW5nXHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZm0uYWZ0ZXJGaWx0ZXIoZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICAgIGNiKGVyciwgcmVzcCwgb3B0cyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlRXJyb3IoXHJcbiAgaXNHbG9iYWw6IGJvb2xlYW4sXHJcbiAgc2VydmVyOiBTZXJ2ZXIsXHJcbiAgZXJyOiBhbnksXHJcbiAgbXNnOiBhbnksXHJcbiAgc2Vzc2lvbjogRnJvbnRlbmRTZXNzaW9ufEJhY2tlbmRTZXNzaW9uLFxyXG4gIHJlc3A6IGFueSxcclxuICBvcHRzOiBhbnksXHJcbiAgY2I6IEZ1bmN0aW9uXHJcbikge1xyXG4gIGxldCBoYW5kbGVyO1xyXG4gIGlmIChpc0dsb2JhbCkge1xyXG4gICAgaGFuZGxlciA9IHNlcnZlci5hcHAuZ2V0KFJFU0VSVkVELkdMT0JBTF9FUlJPUl9IQU5ETEVSKTtcclxuICB9IGVsc2Uge1xyXG4gICAgaGFuZGxlciA9IHNlcnZlci5hcHAuZ2V0KFJFU0VSVkVELkVSUk9SX0hBTkRMRVIpO1xyXG4gIH1cclxuICBpZiAoIWhhbmRsZXIpIHtcclxuICAgIGxvZ2dlci5kZWJ1ZyhcclxuICAgICAgXCJubyBkZWZhdWx0IGVycm9yIGhhbmRsZXIgdG8gcmVzb2x2ZSB1bmtub3duIGV4Y2VwdGlvbi4gXCIgKyBlcnIuc3RhY2tcclxuICAgICk7XHJcbiAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiwgZXJyLCByZXNwLCBvcHRzKTtcclxuICB9IGVsc2Uge1xyXG4gICAgaWYgKGhhbmRsZXIubGVuZ3RoID09PSA1KSB7XHJcbiAgICAgIGhhbmRsZXIoZXJyLCBtc2csIHJlc3AsIHNlc3Npb24sIGNiKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGhhbmRsZXIoZXJyLCBtc2csIHJlc3AsIHNlc3Npb24sIG9wdHMsIGNiKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlc3BvbnNlKFxyXG4gIGlzR2xvYmFsOiBib29sZWFuLFxyXG4gIHNlcnZlcjogU2VydmVyLFxyXG4gIGVycjogYW55LFxyXG4gIG1zZzogYW55LFxyXG4gIHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbixcclxuICByZXNwOiBhbnksXHJcbiAgb3B0czogYW55LFxyXG4gIGNiOiBGdW5jdGlvblxyXG4pIHtcclxuICBpZiAoaXNHbG9iYWwpIHtcclxuICAgIGNiKGVyciwgcmVzcCwgb3B0cyk7XHJcbiAgICAvLyBhZnRlciBmaWx0ZXIgc2hvdWxkIG5vdCBpbnRlcmZlcmUgcmVzcG9uc2VcclxuICAgIGFmdGVyRmlsdGVyKGlzR2xvYmFsLCBzZXJ2ZXIsIGVyciwgbXNnLCBzZXNzaW9uLCByZXNwLCBvcHRzLCBjYik7XHJcbiAgfSBlbHNlIHtcclxuICAgIGFmdGVyRmlsdGVyKGlzR2xvYmFsLCBzZXJ2ZXIsIGVyciwgbXNnLCBzZXNzaW9uLCByZXNwLCBvcHRzLCBjYik7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZVJvdXRlKHJvdXRlOiBzdHJpbmcpIHtcclxuICBpZiAoIXJvdXRlKSB7XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgbGV0IHRzID0gcm91dGUuc3BsaXQoXCIuXCIpO1xyXG4gIGlmICh0cy5sZW5ndGggIT09IDMpIHtcclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHJvdXRlOiByb3V0ZSxcclxuICAgIHNlcnZlclR5cGU6IHRzWzBdLFxyXG4gICAgaGFuZGxlcjogdHNbMV0sXHJcbiAgICBtZXRob2Q6IHRzWzJdXHJcbiAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gZG9Gb3J3YXJkKFxyXG4gIGFwcDogQXBwbGljYXRpb24sXHJcbiAgbXNnOiBhbnksXHJcbiAgc2Vzc2lvbjogRnJvbnRlbmRTZXNzaW9ufEJhY2tlbmRTZXNzaW9uLFxyXG4gIHJvdXRlUmVjb3JkOiBSb3V0ZVJlY29yZCxcclxuICBjYj86IEZ1bmN0aW9uXHJcbikge1xyXG4gIGxldCBmaW5pc2hlZCA9IGZhbHNlO1xyXG4gIC8vc2hvdWxkIHJvdXRlIHRvIG90aGVyIHNlcnZlcnNcclxuICB0cnkge1xyXG4gICAgYXBwLnN5c3JwY1tyb3V0ZVJlY29yZC5zZXJ2ZXJUeXBlXS5tc2dSZW1vdGUuZm9yd2FyZE1lc3NhZ2UoXHJcbiAgICAgIC8vIGFwcC5zeXNycGNbcm91dGVSZWNvcmQuc2VydmVyVHlwZV0ubXNnUmVtb3RlLmZvcndhcmRNZXNzYWdlMihcclxuICAgICAgc2Vzc2lvbixcclxuICAgICAgbXNnLFxyXG4gICAgICAvLyBtc2cub2xkUm91dGUgfHwgbXNnLnJvdXRlLFxyXG4gICAgICAvLyBtc2cuYm9keSxcclxuICAgICAgLy8gbXNnLmFlc1Bhc3N3b3JkLFxyXG4gICAgICAvLyBtc2cuY29tcHJlc3NHemlwLFxyXG4gICAgICBzZXNzaW9uLmV4cG9ydCgpLFxyXG4gICAgICAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgbG9nZ2VyLmVycm9yKFwiZmFpbCB0byBwcm9jZXNzIHJlbW90ZSBtZXNzYWdlOlwiICsgZXJyLnN0YWNrKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZmluaXNoZWQgPSB0cnVlO1xyXG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISwgZXJyLCByZXNwLCBvcHRzKTtcclxuICAgICAgfVxyXG4gICAgKTtcclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIGlmICghZmluaXNoZWQpIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKGBbJHthcHAuc2VydmVySWR9XSBmYWlsIHRvIGZvcndhcmQgbWVzc2FnZTpgICsgZXJyLnN0YWNrKTtcclxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhLCBlcnIpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZG9IYW5kbGUoXHJcbiAgc2VydmVyOiBTZXJ2ZXIsXHJcbiAgbXNnOiBhbnksXHJcbiAgc2Vzc2lvbjogRnJvbnRlbmRTZXNzaW9ufEJhY2tlbmRTZXNzaW9uLFxyXG4gIHJvdXRlUmVjb3JkOiBSb3V0ZVJlY29yZCxcclxuICBjYj86IEZ1bmN0aW9uXHJcbikge1xyXG4gIGxldCBvcmlnaW5Nc2cgPSBtc2c7XHJcbiAgbXNnID0gbXNnLmJvZHkgfHwge307XHJcbiAgbXNnLl9fcm91dGVfXyA9IG9yaWdpbk1zZy5yb3V0ZTtcclxuXHJcbiAgbGV0IHNlbGYgPSBzZXJ2ZXI7XHJcblxyXG4gIGxldCBoYW5kbGUgPSAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XHJcbiAgICBpZiAoZXJyKSB7XHJcbiAgICAgIC8vIGVycm9yIGZyb20gYmVmb3JlIGZpbHRlclxyXG4gICAgICBoYW5kbGVFcnJvcihcclxuICAgICAgICBmYWxzZSxcclxuICAgICAgICBzZWxmLFxyXG4gICAgICAgIGVycixcclxuICAgICAgICBtc2csXHJcbiAgICAgICAgc2Vzc2lvbixcclxuICAgICAgICByZXNwLFxyXG4gICAgICAgIG9wdHMsXHJcbiAgICAgICAgKGVycjogYW55LCByZXNwOiBhbnksIG9wdHM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgcmVzcG9uc2UoZmFsc2UsIHNlbGYsIGVyciwgbXNnLCBzZXNzaW9uLCByZXNwLCBvcHRzLCBjYiEpO1xyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbGYuaGFuZGxlclNlcnZpY2UuaGFuZGxlKFxyXG4gICAgICByb3V0ZVJlY29yZCxcclxuICAgICAgbXNnLFxyXG4gICAgICBzZXNzaW9uLFxyXG4gICAgICAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgLy9lcnJvciBmcm9tIGhhbmRsZXJcclxuICAgICAgICAgIGhhbmRsZUVycm9yKFxyXG4gICAgICAgICAgICBmYWxzZSxcclxuICAgICAgICAgICAgc2VsZixcclxuICAgICAgICAgICAgZXJyLFxyXG4gICAgICAgICAgICBtc2csXHJcbiAgICAgICAgICAgIHNlc3Npb24sXHJcbiAgICAgICAgICAgIHJlc3AsXHJcbiAgICAgICAgICAgIG9wdHMsXHJcbiAgICAgICAgICAgIChlcnI6IGFueSwgcmVzcDogYW55LCBvcHRzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICByZXNwb25zZShmYWxzZSwgc2VsZiwgZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIG9wdHMsIGNiISk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXNwb25zZShmYWxzZSwgc2VsZiwgZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIG9wdHMsIGNiISk7XHJcbiAgICAgIH1cclxuICAgICk7XHJcbiAgfTsgLy9lbmQgb2YgaGFuZGxlXHJcblxyXG4gIGJlZm9yZUZpbHRlcihmYWxzZSwgc2VydmVyLCBtc2csIHNlc3Npb24sIGhhbmRsZSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNjaGVkdWxlQ3JvbnMoc2VydmVyOiBTZXJ2ZXIsIGNyb25zOiBDcm9uW10pIHtcclxuICBsZXQgaGFuZGxlcnMgPSBzZXJ2ZXIuY3JvbkhhbmRsZXJzO1xyXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgY3JvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgIGxldCBjcm9uSW5mbyA9IGNyb25zW2ldO1xyXG4gICAgbGV0IHRpbWUgPSBjcm9uSW5mby50aW1lO1xyXG4gICAgbGV0IGFjdGlvbiA9IGNyb25JbmZvLmFjdGlvbjtcclxuICAgIGxldCBqb2JJZCA9IGNyb25JbmZvLmlkO1xyXG5cclxuICAgIGlmICghdGltZSB8fCAhYWN0aW9uIHx8ICFqb2JJZCkge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoXCJjcm9uIG1pc3MgbmVjZXNzYXJ5IHBhcmFtZXRlcnM6ICVqXCIsIGNyb25JbmZvKTtcclxuICAgICAgY29udGludWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGFjdGlvbi5pbmRleE9mKFwiLlwiKSA8IDApIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKFwiY3JvbiBhY3Rpb24gaXMgZXJyb3IgZm9ybWF0OiAlalwiLCBjcm9uSW5mbyk7XHJcbiAgICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBjcm9uID0gYWN0aW9uLnNwbGl0KFwiLlwiKVswXTtcclxuICAgIGxldCBqb2IgPSBhY3Rpb24uc3BsaXQoXCIuXCIpWzFdO1xyXG4gICAgbGV0IGhhbmRsZXIgPSBoYW5kbGVyc1tjcm9uXTtcclxuXHJcbiAgICBpZiAoIWhhbmRsZXIpIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKFwiY291bGQgbm90IGZpbmQgY3JvbjogJWpcIiwgY3JvbkluZm8pO1xyXG4gICAgICBjb250aW51ZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodHlwZW9mIGhhbmRsZXJbam9iXSAhPT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihcImNvdWxkIG5vdCBmaW5kIGNyb24gam9iOiAlaiwgJXNcIiwgY3JvbkluZm8sIGpvYik7XHJcbiAgICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBpZCA9IHNjaGVkdWxlLnNjaGVkdWxlSm9iKHRpbWUsIGhhbmRsZXJbam9iXS5iaW5kKGhhbmRsZXIpKTtcclxuICAgIHNlcnZlci5qb2JzW2pvYklkXSA9IGlkO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2tBbmRBZGQoY3JvbjogQ3JvbiwgY3JvbnM6IENyb25bXSwgc2VydmVyOiBTZXJ2ZXIpIHtcclxuICBpZiAoIWNvbnRhaW5Dcm9uKGNyb24uaWQsIGNyb25zKSkge1xyXG4gICAgc2VydmVyLmNyb25zLnB1c2goY3Jvbik7XHJcbiAgfSBlbHNlIHtcclxuICAgIGxvZ2dlci53YXJuKFwiY3JvbiBpcyBkdXBsaWNhdGVkOiAlalwiLCBjcm9uKTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnRhaW5Dcm9uKGlkOiBudW1iZXIsIGNyb25zOiBDcm9uW10pIHtcclxuICBmb3IgKGxldCBpID0gMCwgbCA9IGNyb25zLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgaWYgKGlkID09PSBjcm9uc1tpXS5pZCkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIGZhbHNlO1xyXG59XHJcbiJdfQ==