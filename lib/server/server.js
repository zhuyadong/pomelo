"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
let logger = require("pomelo-logger").getLogger("pomelo", __filename);
const fs = require("fs");
const path = require("path");
const pathUtil = require("../util/pathUtil");
let Loader = require("pomelo-loader");
const utils = require("../util/utils");
let schedule = require("pomelo-scheduler");
const filterService_1 = require("../common/service/filterService");
const handlerService_1 = require("../common/service/handlerService");
const index_1 = require("../index");
const constants_1 = require("../util/constants");
const util_1 = require("util");
var State;
(function (State) {
    State[State["ST_INITED"] = 0] = "ST_INITED";
    State[State["ST_STARTED"] = 1] = "ST_STARTED";
    State[State["ST_STOPED"] = 2] = "ST_STOPED"; // server stoped
})(State || (State = {}));
class Server {
    constructor(app, opts) {
        this.app = app;
        this.opts = opts || {};
        this.globalFilterService = null;
        this.filterService = null;
        this.handlerService = null;
        this.crons = [];
        this.jobs = {};
        this.state = State.ST_INITED;
        app.event.on(index_1.events.ADD_CRONS, this.addCrons.bind(this));
        app.event.on(index_1.events.REMOVE_CRONS, this.removeCrons.bind(this));
    }
    start() {
        if (this.state > State.ST_INITED) {
            return;
        }
        this.globalFilterService = initFilter(true, this.app);
        this.filterService = initFilter(false, this.app);
        this.handlerService = initHandler(this.app, this.opts);
        this.cronHandlers = loadCronHandlers(this.app);
        loadCrons(this, this.app);
        this.state = State.ST_STARTED;
    }
    afterStart() {
        scheduleCrons(this, this.crons);
    }
    stop() {
        this.state = State.ST_STOPED;
    }
    globalHandle(msg, session, cb) {
        if (this.state !== State.ST_STARTED) {
            utils.invokeCallback(cb, new Error("server not started"));
            return;
        }
        let routeRecord = parseRoute(msg.route);
        if (!routeRecord) {
            utils.invokeCallback(cb, new Error(util_1.format("meet unknown route message %j", msg.route)));
            return;
        }
        let self = this;
        let dispatch = (err, resp, opts) => {
            if (err) {
                handleError(true, self, err, msg, session, resp, opts, (err, resp, opts) => {
                    response(true, self, err, msg, session, resp, opts, cb);
                });
                return;
            }
            if (self.app.serverType !== routeRecord.serverType) {
                doForward(self.app, msg, session, routeRecord, (err, resp, opts) => {
                    response(true, self, err, msg, session, resp, opts, cb);
                });
            }
            else {
                doHandle(self, msg, session, routeRecord, (err, resp, opts) => {
                    response(true, self, err, msg, session, resp, opts, cb);
                });
            }
        };
        beforeFilter(true, self, msg, session, dispatch);
    }
    handle(msg, session, cb) {
        if (this.state !== State.ST_STARTED) {
            cb(new Error("server not started"));
            return;
        }
        let routeRecord = parseRoute(msg.route);
        doHandle(this, msg, session, routeRecord, cb);
    }
    addCrons(crons) {
        this.cronHandlers = loadCronHandlers(this.app);
        for (let i = 0, l = crons.length; i < l; i++) {
            let cron = crons[i];
            checkAndAdd(cron, this.crons, this);
        }
        scheduleCrons(this, crons);
    }
    removeCrons(crons) {
        for (let i = 0, l = crons.length; i < l; i++) {
            let cron = crons[i];
            let id = cron.id;
            if (!!this.jobs[id]) {
                schedule.cancelJob(this.jobs[id]);
            }
            else {
                logger.warn("cron is not in application: %j", cron);
            }
        }
    }
}
exports.Server = Server;
function initFilter(isGlobal, app) {
    let service = new filterService_1.FilterService();
    let befores, afters;
    if (isGlobal) {
        befores = app.get(constants_1.KEYWORDS.GLOBAL_BEFORE_FILTER);
        afters = app.get(constants_1.KEYWORDS.GLOBAL_AFTER_FILTER);
    }
    else {
        befores = app.get(constants_1.KEYWORDS.BEFORE_FILTER);
        afters = app.get(constants_1.KEYWORDS.AFTER_FILTER);
    }
    let i, l;
    if (befores) {
        for (i = 0, l = befores.length; i < l; i++) {
            service.before(befores[i]);
        }
    }
    if (afters) {
        for (i = 0, l = afters.length; i < l; i++) {
            service.after(afters[i]);
        }
    }
    return service;
}
function initHandler(app, opts) {
    return new handlerService_1.HandlerService(app, opts);
}
function loadCronHandlers(app) {
    let p = pathUtil.getCronPath(app.base, app.serverType);
    if (p) {
        return Loader.load(p, app);
    }
}
function loadCrons(server, app) {
    let env = app.get(constants_1.RESERVED.ENV);
    let p = path.join(app.base, constants_1.FILEPATH.CRON);
    if (!fs.existsSync(p)) {
        p = path.join(app.base, constants_1.FILEPATH.CONFIG_DIR, env, path.basename(constants_1.FILEPATH.CRON));
        if (!fs.existsSync(p)) {
            return;
        }
    }
    app.loadConfigBaseApp(constants_1.RESERVED.CRONS, constants_1.FILEPATH.CRON);
    let crons = app.get(constants_1.RESERVED.CRONS);
    for (let serverType in crons) {
        if (app.serverType === serverType) {
            let list = crons[serverType];
            for (let i = 0; i < list.length; i++) {
                if (!list[i].serverId) {
                    checkAndAdd(list[i], server.crons, server);
                }
                else {
                    if (app.serverId === list[i].serverId) {
                        checkAndAdd(list[i], server.crons, server);
                    }
                }
            }
        }
    }
}
function beforeFilter(isGlobal, server, msg, session, cb) {
    let fm;
    if (isGlobal) {
        fm = server.globalFilterService;
    }
    else {
        fm = server.filterService;
    }
    if (fm) {
        fm.beforeFilter(msg, session, cb);
    }
    else {
        utils.invokeCallback(cb);
    }
}
function afterFilter(isGlobal, server, err, msg, session, resp, opts, cb) {
    let fm;
    if (isGlobal) {
        fm = server.globalFilterService;
    }
    else {
        fm = server.filterService;
    }
    if (fm) {
        if (isGlobal) {
            fm.afterFilter(err, msg, session, resp, () => {
                // do nothing
            });
        }
        else {
            fm.afterFilter(err, msg, session, resp, (err) => {
                cb(err, resp, opts);
            });
        }
    }
}
function handleError(isGlobal, server, err, msg, session, resp, opts, cb) {
    let handler;
    if (isGlobal) {
        handler = server.app.get(constants_1.RESERVED.GLOBAL_ERROR_HANDLER);
    }
    else {
        handler = server.app.get(constants_1.RESERVED.ERROR_HANDLER);
    }
    if (!handler) {
        logger.debug("no default error handler to resolve unknown exception. " + err.stack);
        utils.invokeCallback(cb, err, resp, opts);
    }
    else {
        if (handler.length === 5) {
            handler(err, msg, resp, session, cb);
        }
        else {
            handler(err, msg, resp, session, opts, cb);
        }
    }
}
function response(isGlobal, server, err, msg, session, resp, opts, cb) {
    if (isGlobal) {
        cb(err, resp, opts);
        // after filter should not interfere response
        afterFilter(isGlobal, server, err, msg, session, resp, opts, cb);
    }
    else {
        afterFilter(isGlobal, server, err, msg, session, resp, opts, cb);
    }
}
function parseRoute(route) {
    if (!route) {
        return null;
    }
    let ts = route.split(".");
    if (ts.length !== 3) {
        return null;
    }
    return {
        route: route,
        serverType: ts[0],
        handler: ts[1],
        method: ts[2]
    };
}
function doForward(app, msg, session, routeRecord, cb) {
    let finished = false;
    //should route to other servers
    try {
        app.sysrpc[routeRecord.serverType].msgRemote.forwardMessage(
        // app.sysrpc[routeRecord.serverType].msgRemote.forwardMessage2(
        session, msg, 
        // msg.oldRoute || msg.route,
        // msg.body,
        // msg.aesPassword,
        // msg.compressGzip,
        session.export(), (err, resp, opts) => {
            if (err) {
                logger.error("fail to process remote message:" + err.stack);
            }
            finished = true;
            utils.invokeCallback(cb, err, resp, opts);
        });
    }
    catch (err) {
        if (!finished) {
            logger.error(`[${app.serverId}] fail to forward message:` + err.stack);
            utils.invokeCallback(cb, err);
        }
    }
}
function doHandle(server, msg, session, routeRecord, cb) {
    let originMsg = msg;
    msg = msg.body || {};
    msg.__route__ = originMsg.route;
    let self = server;
    let handle = (err, resp, opts) => {
        if (err) {
            // error from before filter
            handleError(false, self, err, msg, session, resp, opts, (err, resp, opts) => {
                response(false, self, err, msg, session, resp, opts, cb);
            });
            return;
        }
        self.handlerService.handle(routeRecord, msg, session, (err, resp, opts) => {
            if (err) {
                //error from handler
                handleError(false, self, err, msg, session, resp, opts, (err, resp, opts) => {
                    response(false, self, err, msg, session, resp, opts, cb);
                });
                return;
            }
            response(false, self, err, msg, session, resp, opts, cb);
        });
    }; //end of handle
    beforeFilter(false, server, msg, session, handle);
}
function scheduleCrons(server, crons) {
    let handlers = server.cronHandlers;
    for (let i = 0; i < crons.length; i++) {
        let cronInfo = crons[i];
        let time = cronInfo.time;
        let action = cronInfo.action;
        let jobId = cronInfo.id;
        if (!time || !action || !jobId) {
            logger.error("cron miss necessary parameters: %j", cronInfo);
            continue;
        }
        if (action.indexOf(".") < 0) {
            logger.error("cron action is error format: %j", cronInfo);
            continue;
        }
        let cron = action.split(".")[0];
        let job = action.split(".")[1];
        let handler = handlers[cron];
        if (!handler) {
            logger.error("could not find cron: %j", cronInfo);
            continue;
        }
        if (typeof handler[job] !== "function") {
            logger.error("could not find cron job: %j, %s", cronInfo, job);
            continue;
        }
        let id = schedule.scheduleJob(time, handler[job].bind(handler));
        server.jobs[jobId] = id;
    }
}
function checkAndAdd(cron, crons, server) {
    if (!containCron(cron.id, crons)) {
        server.crons.push(cron);
    }
    else {
        logger.warn("cron is duplicated: %j", cron);
    }
}
function containCron(id, crons) {
    for (let i = 0, l = crons.length; i < l; i++) {
        if (id === crons[i].id) {
            return true;
        }
    }
    return false;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDdEUseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5Qiw2Q0FBOEM7QUFDOUMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3RDLHVDQUF3QztBQUN4QyxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUUzQyxtRUFBZ0U7QUFDaEUscUVBSTBDO0FBRTFDLG9DQUFtRTtBQUNuRSxpREFBaUU7QUFFakUsK0JBQThCO0FBRTlCLElBQUssS0FJSjtBQUpELFdBQUssS0FBSztJQUNSLDJDQUFhLENBQUE7SUFDYiw2Q0FBYyxDQUFBO0lBQ2QsMkNBQWEsQ0FBQSxDQUFDLGdCQUFnQjtBQUNoQyxDQUFDLEVBSkksS0FBSyxLQUFMLEtBQUssUUFJVDtBQVdEO0lBU0UsWUFBcUIsR0FBZ0IsRUFBRSxJQUFVO1FBQTVCLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFDbkMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxtQkFBbUIsR0FBUSxJQUFJLENBQUM7UUFDckMsSUFBSSxDQUFDLGFBQWEsR0FBUSxJQUFJLENBQUM7UUFDL0IsSUFBSSxDQUFDLGNBQWMsR0FBUSxJQUFJLENBQUM7UUFDaEMsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFFN0IsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsY0FBTSxDQUFDLFNBQVMsRUFB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Q0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM3QyxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJsZXQgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwicG9tZWxvXCIsIF9fZmlsZW5hbWUpO1xuaW1wb3J0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmltcG9ydCBwYXRoVXRpbCA9IHJlcXVpcmUoXCIuLi91dGlsL3BhdGhVdGlsXCIpO1xubGV0IExvYWRlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9hZGVyXCIpO1xuaW1wb3J0IHV0aWxzID0gcmVxdWlyZShcIi4uL3V0aWwvdXRpbHNcIik7XG5sZXQgc2NoZWR1bGUgPSByZXF1aXJlKFwicG9tZWxvLXNjaGVkdWxlclwiKTtcblxuaW1wb3J0IHsgRmlsdGVyU2VydmljZSB9IGZyb20gXCIuLi9jb21tb24vc2VydmljZS9maWx0ZXJTZXJ2aWNlXCI7XG5pbXBvcnQge1xuICBIYW5kbGVyU2VydmljZSxcbiAgSGFuZGxlcnNNYXAsXG4gIEhhbmRsZXJzXG59IGZyb20gXCIuLi9jb21tb24vc2VydmljZS9oYW5kbGVyU2VydmljZVwiO1xuaW1wb3J0IHsgQXBwbGljYXRpb24sIENvbXBvbmVudCwgQ3JvbiB9IGZyb20gXCIuLi9hcHBsaWNhdGlvblwiO1xuaW1wb3J0IHsgZXZlbnRzLCBGcm9udGVuZFNlc3Npb24sIEJhY2tlbmRTZXNzaW9uIH0gZnJvbSBcIi4uL2luZGV4XCI7XG5pbXBvcnQgeyBSRVNFUlZFRCwgRklMRVBBVEgsIEtFWVdPUkRTIH0gZnJvbSBcIi4uL3V0aWwvY29uc3RhbnRzXCI7XG5pbXBvcnQgeyBTZXNzaW9uIH0gZnJvbSBcIi4uL2NvbW1vbi9zZXJ2aWNlL3Nlc3Npb25TZXJ2aWNlXCI7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tIFwidXRpbFwiO1xuXG5lbnVtIFN0YXRlIHtcbiAgU1RfSU5JVEVEID0gMCwgLy8gc2VydmVyIGluaXRlZFxuICBTVF9TVEFSVEVEID0gMSwgLy8gc2VydmVyIHN0YXJ0ZWRcbiAgU1RfU1RPUEVEID0gMiAvLyBzZXJ2ZXIgc3RvcGVkXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUm91dGVSZWNvcmQge1xuICByb3V0ZTogc3RyaW5nO1xuICBzZXJ2ZXJUeXBlOiBzdHJpbmc7XG4gIGhhbmRsZXI6IHN0cmluZztcbiAgbWV0aG9kOiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIEpvYk1hcCA9IHsgW2lkeDogc3RyaW5nXTogYW55IH07XG5cbmV4cG9ydCBjbGFzcyBTZXJ2ZXIge1xuICByZWFkb25seSBjcm9uczogQ3JvbltdO1xuICByZWFkb25seSBqb2JzOiBKb2JNYXA7XG4gIHJlYWRvbmx5IGNyb25IYW5kbGVyczogSGFuZGxlcnM7XG4gIHJlYWRvbmx5IGdsb2JhbEZpbHRlclNlcnZpY2U6IEZpbHRlclNlcnZpY2U7XG4gIHJlYWRvbmx5IGZpbHRlclNlcnZpY2U6IEZpbHRlclNlcnZpY2U7XG4gIHJlYWRvbmx5IGhhbmRsZXJTZXJ2aWNlOiBIYW5kbGVyU2VydmljZTtcbiAgcHJpdmF0ZSBvcHRzOiBhbnk7XG4gIHByaXZhdGUgc3RhdGU6IFN0YXRlO1xuICBjb25zdHJ1Y3RvcihyZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XG4gICAgdGhpcy5vcHRzID0gb3B0cyB8fCB7fTtcbiAgICB0aGlzLmdsb2JhbEZpbHRlclNlcnZpY2UgPSA8YW55Pm51bGw7XG4gICAgdGhpcy5maWx0ZXJTZXJ2aWNlID0gPGFueT5udWxsO1xuICAgIHRoaXMuaGFuZGxlclNlcnZpY2UgPSA8YW55Pm51bGw7XG4gICAgdGhpcy5jcm9ucyA9IFtdO1xuICAgIHRoaXMuam9icyA9IHt9O1xuICAgIHRoaXMuc3RhdGUgPSBTdGF0ZS5TVF9JTklURUQ7XG5cbiAgICBhcHAuZXZlbnQub24oZXZlbnRzLkFERF9DUk9OUywgdGhpcy5hZGRDcm9ucy5iaW5kKHRoaXMpKTtcbiAgICBhcHAuZXZlbnQub24oZXZlbnRzLlJFTU9WRV9DUk9OUywgdGhpcy5yZW1vdmVDcm9ucy5iaW5kKHRoaXMpKTtcbiAgfVxuICBzdGFydCgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZSA+IFN0YXRlLlNUX0lOSVRFRCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuZ2xvYmFsRmlsdGVyU2VydmljZSEgPSBpbml0RmlsdGVyKHRydWUsIHRoaXMuYXBwKTtcbiAgICB0aGlzLmZpbHRlclNlcnZpY2UhID0gaW5pdEZpbHRlcihmYWxzZSwgdGhpcy5hcHApO1xuICAgIHRoaXMuaGFuZGxlclNlcnZpY2UhID0gaW5pdEhhbmRsZXIodGhpcy5hcHAsIHRoaXMub3B0cyk7XG4gICAgdGhpcy5jcm9uSGFuZGxlcnMhID0gbG9hZENyb25IYW5kbGVycyh0aGlzLmFwcCk7XG4gICAgbG9hZENyb25zKHRoaXMsIHRoaXMuYXBwKTtcbiAgICB0aGlzLnN0YXRlID0gU3RhdGUuU1RfU1RBUlRFRDtcbiAgfVxuICBhZnRlclN0YXJ0KCkge1xuICAgIHNjaGVkdWxlQ3JvbnModGhpcywgdGhpcy5jcm9ucyk7XG4gIH1cbiAgc3RvcCgpIHtcbiAgICB0aGlzLnN0YXRlID0gU3RhdGUuU1RfU1RPUEVEO1xuICB9XG4gIGdsb2JhbEhhbmRsZShtc2c6IGFueSwgc2Vzc2lvbjogRnJvbnRlbmRTZXNzaW9ufEJhY2tlbmRTZXNzaW9uLCBjYj86IEZ1bmN0aW9uKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IFN0YXRlLlNUX1NUQVJURUQpIHtcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISwgbmV3IEVycm9yKFwic2VydmVyIG5vdCBzdGFydGVkXCIpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgcm91dGVSZWNvcmQgPSBwYXJzZVJvdXRlKG1zZy5yb3V0ZSk7XG4gICAgaWYgKCFyb3V0ZVJlY29yZCkge1xuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soXG4gICAgICAgIGNiISxcbiAgICAgICAgbmV3IEVycm9yKGZvcm1hdChcIm1lZXQgdW5rbm93biByb3V0ZSBtZXNzYWdlICVqXCIsIG1zZy5yb3V0ZSkpXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBsZXQgZGlzcGF0Y2ggPSAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGhhbmRsZUVycm9yKFxuICAgICAgICAgIHRydWUsXG4gICAgICAgICAgc2VsZixcbiAgICAgICAgICBlcnIsXG4gICAgICAgICAgbXNnLFxuICAgICAgICAgIHNlc3Npb24sXG4gICAgICAgICAgcmVzcCxcbiAgICAgICAgICBvcHRzLFxuICAgICAgICAgIChlcnI6IGFueSwgcmVzcDogYW55LCBvcHRzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIHJlc3BvbnNlKHRydWUsIHNlbGYsIGVyciwgbXNnLCBzZXNzaW9uLCByZXNwLCBvcHRzLCBjYiEpO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAoc2VsZi5hcHAuc2VydmVyVHlwZSAhPT0gcm91dGVSZWNvcmQhLnNlcnZlclR5cGUpIHtcbiAgICAgICAgZG9Gb3J3YXJkKFxuICAgICAgICAgIHNlbGYuYXBwLFxuICAgICAgICAgIG1zZyxcbiAgICAgICAgICBzZXNzaW9uLFxuICAgICAgICAgIHJvdXRlUmVjb3JkISxcbiAgICAgICAgICAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XG4gICAgICAgICAgICByZXNwb25zZSh0cnVlLCBzZWxmLCBlcnIsIG1zZywgc2Vzc2lvbiwgcmVzcCwgb3B0cywgY2IhKTtcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb0hhbmRsZShcbiAgICAgICAgICBzZWxmLFxuICAgICAgICAgIG1zZyxcbiAgICAgICAgICBzZXNzaW9uLFxuICAgICAgICAgIHJvdXRlUmVjb3JkISxcbiAgICAgICAgICAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XG4gICAgICAgICAgICByZXNwb25zZSh0cnVlLCBzZWxmLCBlcnIsIG1zZywgc2Vzc2lvbiwgcmVzcCwgb3B0cywgY2IhKTtcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfTtcbiAgICBiZWZvcmVGaWx0ZXIodHJ1ZSwgc2VsZiwgbXNnLCBzZXNzaW9uLCBkaXNwYXRjaCk7XG4gIH1cblxuICBoYW5kbGUobXNnOiBhbnksIHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbiwgY2I6IEZ1bmN0aW9uKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IFN0YXRlLlNUX1NUQVJURUQpIHtcbiAgICAgIGNiKG5ldyBFcnJvcihcInNlcnZlciBub3Qgc3RhcnRlZFwiKSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IHJvdXRlUmVjb3JkID0gcGFyc2VSb3V0ZShtc2cucm91dGUpO1xuICAgIGRvSGFuZGxlKHRoaXMsIG1zZywgc2Vzc2lvbiwgcm91dGVSZWNvcmQhLCBjYik7XG4gIH1cblxuICBhZGRDcm9ucyhjcm9uczogQ3JvbltdKSB7XG4gICAgdGhpcy5jcm9uSGFuZGxlcnMhID0gbG9hZENyb25IYW5kbGVycyh0aGlzLmFwcCk7XG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBjcm9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgIGxldCBjcm9uID0gY3JvbnNbaV07XG4gICAgICBjaGVja0FuZEFkZChjcm9uLCB0aGlzLmNyb25zLCB0aGlzKTtcbiAgICB9XG4gICAgc2NoZWR1bGVDcm9ucyh0aGlzLCBjcm9ucyk7XG4gIH1cblxuICByZW1vdmVDcm9ucyhjcm9uczogQ3JvbltdKSB7XG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBjcm9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgIGxldCBjcm9uID0gY3JvbnNbaV07XG4gICAgICBsZXQgaWQgPSBjcm9uLmlkO1xuICAgICAgaWYgKCEhdGhpcy5qb2JzW2lkXSkge1xuICAgICAgICBzY2hlZHVsZS5jYW5jZWxKb2IodGhpcy5qb2JzW2lkXSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIud2FybihcImNyb24gaXMgbm90IGluIGFwcGxpY2F0aW9uOiAlalwiLCBjcm9uKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5pdEZpbHRlcihpc0dsb2JhbDogYm9vbGVhbiwgYXBwOiBBcHBsaWNhdGlvbikge1xuICBsZXQgc2VydmljZSA9IG5ldyBGaWx0ZXJTZXJ2aWNlKCk7XG4gIGxldCBiZWZvcmVzLCBhZnRlcnM7XG5cbiAgaWYgKGlzR2xvYmFsKSB7XG4gICAgYmVmb3JlcyA9IGFwcC5nZXQoS0VZV09SRFMuR0xPQkFMX0JFRk9SRV9GSUxURVIpO1xuICAgIGFmdGVycyA9IGFwcC5nZXQoS0VZV09SRFMuR0xPQkFMX0FGVEVSX0ZJTFRFUik7XG4gIH0gZWxzZSB7XG4gICAgYmVmb3JlcyA9IGFwcC5nZXQoS0VZV09SRFMuQkVGT1JFX0ZJTFRFUik7XG4gICAgYWZ0ZXJzID0gYXBwLmdldChLRVlXT1JEUy5BRlRFUl9GSUxURVIpO1xuICB9XG5cbiAgbGV0IGksIGw7XG4gIGlmIChiZWZvcmVzKSB7XG4gICAgZm9yIChpID0gMCwgbCA9IGJlZm9yZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICBzZXJ2aWNlLmJlZm9yZShiZWZvcmVzW2ldKTtcbiAgICB9XG4gIH1cblxuICBpZiAoYWZ0ZXJzKSB7XG4gICAgZm9yIChpID0gMCwgbCA9IGFmdGVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgIHNlcnZpY2UuYWZ0ZXIoYWZ0ZXJzW2ldKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gc2VydmljZTtcbn1cblxuZnVuY3Rpb24gaW5pdEhhbmRsZXIoYXBwOiBBcHBsaWNhdGlvbiwgb3B0cz86IGFueSkge1xuICByZXR1cm4gbmV3IEhhbmRsZXJTZXJ2aWNlKGFwcCwgb3B0cyk7XG59XG5cbmZ1bmN0aW9uIGxvYWRDcm9uSGFuZGxlcnMoYXBwOiBBcHBsaWNhdGlvbikge1xuICBsZXQgcCA9IHBhdGhVdGlsLmdldENyb25QYXRoKGFwcC5iYXNlLCBhcHAuc2VydmVyVHlwZSk7XG4gIGlmIChwKSB7XG4gICAgcmV0dXJuIExvYWRlci5sb2FkKHAsIGFwcCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbG9hZENyb25zKHNlcnZlcjogU2VydmVyLCBhcHA6IEFwcGxpY2F0aW9uKSB7XG4gIGxldCBlbnYgPSBhcHAuZ2V0KFJFU0VSVkVELkVOVik7XG4gIGxldCBwID0gcGF0aC5qb2luKGFwcC5iYXNlLCBGSUxFUEFUSC5DUk9OKTtcbiAgaWYgKCFmcy5leGlzdHNTeW5jKHApKSB7XG4gICAgcCA9IHBhdGguam9pbihcbiAgICAgIGFwcC5iYXNlLFxuICAgICAgRklMRVBBVEguQ09ORklHX0RJUixcbiAgICAgIGVudixcbiAgICAgIHBhdGguYmFzZW5hbWUoRklMRVBBVEguQ1JPTilcbiAgICApO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhwKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuICBhcHAubG9hZENvbmZpZ0Jhc2VBcHAoUkVTRVJWRUQuQ1JPTlMsIEZJTEVQQVRILkNST04pO1xuICBsZXQgY3JvbnMgPSBhcHAuZ2V0KFJFU0VSVkVELkNST05TKTtcbiAgZm9yIChsZXQgc2VydmVyVHlwZSBpbiBjcm9ucykge1xuICAgIGlmIChhcHAuc2VydmVyVHlwZSA9PT0gc2VydmVyVHlwZSkge1xuICAgICAgbGV0IGxpc3QgPSBjcm9uc1tzZXJ2ZXJUeXBlXTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoIWxpc3RbaV0uc2VydmVySWQpIHtcbiAgICAgICAgICBjaGVja0FuZEFkZChsaXN0W2ldLCBzZXJ2ZXIuY3JvbnMsIHNlcnZlcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGFwcC5zZXJ2ZXJJZCA9PT0gbGlzdFtpXS5zZXJ2ZXJJZCkge1xuICAgICAgICAgICAgY2hlY2tBbmRBZGQobGlzdFtpXSwgc2VydmVyLmNyb25zLCBzZXJ2ZXIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBiZWZvcmVGaWx0ZXIoXG4gIGlzR2xvYmFsOiBib29sZWFuLFxuICBzZXJ2ZXI6IFNlcnZlcixcbiAgbXNnOiBhbnksXG4gIHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbixcbiAgY2I/OiBGdW5jdGlvblxuKSB7XG4gIGxldCBmbTtcbiAgaWYgKGlzR2xvYmFsKSB7XG4gICAgZm0gPSBzZXJ2ZXIuZ2xvYmFsRmlsdGVyU2VydmljZTtcbiAgfSBlbHNlIHtcbiAgICBmbSA9IHNlcnZlci5maWx0ZXJTZXJ2aWNlO1xuICB9XG4gIGlmIChmbSkge1xuICAgIGZtLmJlZm9yZUZpbHRlcihtc2csIHNlc3Npb24sIGNiISk7XG4gIH0gZWxzZSB7XG4gICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZnRlckZpbHRlcihcbiAgaXNHbG9iYWw6IGJvb2xlYW4sXG4gIHNlcnZlcjogU2VydmVyLFxuICBlcnI6IGFueSxcbiAgbXNnOiBhbnksXG4gIHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbixcbiAgcmVzcDogYW55LFxuICBvcHRzOiBhbnksXG4gIGNiOiBGdW5jdGlvblxuKSB7XG4gIGxldCBmbTtcbiAgaWYgKGlzR2xvYmFsKSB7XG4gICAgZm0gPSBzZXJ2ZXIuZ2xvYmFsRmlsdGVyU2VydmljZTtcbiAgfSBlbHNlIHtcbiAgICBmbSA9IHNlcnZlci5maWx0ZXJTZXJ2aWNlO1xuICB9XG4gIGlmIChmbSkge1xuICAgIGlmIChpc0dsb2JhbCkge1xuICAgICAgZm0uYWZ0ZXJGaWx0ZXIoZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsICgpID0+IHtcbiAgICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZtLmFmdGVyRmlsdGVyKGVyciwgbXNnLCBzZXNzaW9uLCByZXNwLCAoZXJyOiBhbnkpID0+IHtcbiAgICAgICAgY2IoZXJyLCByZXNwLCBvcHRzKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihcbiAgaXNHbG9iYWw6IGJvb2xlYW4sXG4gIHNlcnZlcjogU2VydmVyLFxuICBlcnI6IGFueSxcbiAgbXNnOiBhbnksXG4gIHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbixcbiAgcmVzcDogYW55LFxuICBvcHRzOiBhbnksXG4gIGNiOiBGdW5jdGlvblxuKSB7XG4gIGxldCBoYW5kbGVyO1xuICBpZiAoaXNHbG9iYWwpIHtcbiAgICBoYW5kbGVyID0gc2VydmVyLmFwcC5nZXQoUkVTRVJWRUQuR0xPQkFMX0VSUk9SX0hBTkRMRVIpO1xuICB9IGVsc2Uge1xuICAgIGhhbmRsZXIgPSBzZXJ2ZXIuYXBwLmdldChSRVNFUlZFRC5FUlJPUl9IQU5ETEVSKTtcbiAgfVxuICBpZiAoIWhhbmRsZXIpIHtcbiAgICBsb2dnZXIuZGVidWcoXG4gICAgICBcIm5vIGRlZmF1bHQgZXJyb3IgaGFuZGxlciB0byByZXNvbHZlIHVua25vd24gZXhjZXB0aW9uLiBcIiArIGVyci5zdGFja1xuICAgICk7XG4gICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIGVyciwgcmVzcCwgb3B0cyk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKGhhbmRsZXIubGVuZ3RoID09PSA1KSB7XG4gICAgICBoYW5kbGVyKGVyciwgbXNnLCByZXNwLCBzZXNzaW9uLCBjYik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhhbmRsZXIoZXJyLCBtc2csIHJlc3AsIHNlc3Npb24sIG9wdHMsIGNiKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVzcG9uc2UoXG4gIGlzR2xvYmFsOiBib29sZWFuLFxuICBzZXJ2ZXI6IFNlcnZlcixcbiAgZXJyOiBhbnksXG4gIG1zZzogYW55LFxuICBzZXNzaW9uOiBGcm9udGVuZFNlc3Npb258QmFja2VuZFNlc3Npb24sXG4gIHJlc3A6IGFueSxcbiAgb3B0czogYW55LFxuICBjYjogRnVuY3Rpb25cbikge1xuICBpZiAoaXNHbG9iYWwpIHtcbiAgICBjYihlcnIsIHJlc3AsIG9wdHMpO1xuICAgIC8vIGFmdGVyIGZpbHRlciBzaG91bGQgbm90IGludGVyZmVyZSByZXNwb25zZVxuICAgIGFmdGVyRmlsdGVyKGlzR2xvYmFsLCBzZXJ2ZXIsIGVyciwgbXNnLCBzZXNzaW9uLCByZXNwLCBvcHRzLCBjYik7XG4gIH0gZWxzZSB7XG4gICAgYWZ0ZXJGaWx0ZXIoaXNHbG9iYWwsIHNlcnZlciwgZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIG9wdHMsIGNiKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZVJvdXRlKHJvdXRlOiBzdHJpbmcpIHtcbiAgaWYgKCFyb3V0ZSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGxldCB0cyA9IHJvdXRlLnNwbGl0KFwiLlwiKTtcbiAgaWYgKHRzLmxlbmd0aCAhPT0gMykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICByb3V0ZTogcm91dGUsXG4gICAgc2VydmVyVHlwZTogdHNbMF0sXG4gICAgaGFuZGxlcjogdHNbMV0sXG4gICAgbWV0aG9kOiB0c1syXVxuICB9O1xufVxuXG5mdW5jdGlvbiBkb0ZvcndhcmQoXG4gIGFwcDogQXBwbGljYXRpb24sXG4gIG1zZzogYW55LFxuICBzZXNzaW9uOiBGcm9udGVuZFNlc3Npb258QmFja2VuZFNlc3Npb24sXG4gIHJvdXRlUmVjb3JkOiBSb3V0ZVJlY29yZCxcbiAgY2I/OiBGdW5jdGlvblxuKSB7XG4gIGxldCBmaW5pc2hlZCA9IGZhbHNlO1xuICAvL3Nob3VsZCByb3V0ZSB0byBvdGhlciBzZXJ2ZXJzXG4gIHRyeSB7XG4gICAgYXBwLnN5c3JwY1tyb3V0ZVJlY29yZC5zZXJ2ZXJUeXBlXS5tc2dSZW1vdGUuZm9yd2FyZE1lc3NhZ2UoXG4gICAgICAvLyBhcHAuc3lzcnBjW3JvdXRlUmVjb3JkLnNlcnZlclR5cGVdLm1zZ1JlbW90ZS5mb3J3YXJkTWVzc2FnZTIoXG4gICAgICBzZXNzaW9uLFxuICAgICAgbXNnLFxuICAgICAgLy8gbXNnLm9sZFJvdXRlIHx8IG1zZy5yb3V0ZSxcbiAgICAgIC8vIG1zZy5ib2R5LFxuICAgICAgLy8gbXNnLmFlc1Bhc3N3b3JkLFxuICAgICAgLy8gbXNnLmNvbXByZXNzR3ppcCxcbiAgICAgIHNlc3Npb24uZXhwb3J0KCksXG4gICAgICAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJmYWlsIHRvIHByb2Nlc3MgcmVtb3RlIG1lc3NhZ2U6XCIgKyBlcnIuc3RhY2spO1xuICAgICAgICB9XG4gICAgICAgIGZpbmlzaGVkID0gdHJ1ZTtcbiAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhLCBlcnIsIHJlc3AsIG9wdHMpO1xuICAgICAgfVxuICAgICk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICghZmluaXNoZWQpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihgWyR7YXBwLnNlcnZlcklkfV0gZmFpbCB0byBmb3J3YXJkIG1lc3NhZ2U6YCArIGVyci5zdGFjayk7XG4gICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiEsIGVycik7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGRvSGFuZGxlKFxuICBzZXJ2ZXI6IFNlcnZlcixcbiAgbXNnOiBhbnksXG4gIHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbixcbiAgcm91dGVSZWNvcmQ6IFJvdXRlUmVjb3JkLFxuICBjYj86IEZ1bmN0aW9uXG4pIHtcbiAgbGV0IG9yaWdpbk1zZyA9IG1zZztcbiAgbXNnID0gbXNnLmJvZHkgfHwge307XG4gIG1zZy5fX3JvdXRlX18gPSBvcmlnaW5Nc2cucm91dGU7XG5cbiAgbGV0IHNlbGYgPSBzZXJ2ZXI7XG5cbiAgbGV0IGhhbmRsZSA9IChlcnI6IGFueSwgcmVzcDogYW55LCBvcHRzOiBhbnkpID0+IHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICAvLyBlcnJvciBmcm9tIGJlZm9yZSBmaWx0ZXJcbiAgICAgIGhhbmRsZUVycm9yKFxuICAgICAgICBmYWxzZSxcbiAgICAgICAgc2VsZixcbiAgICAgICAgZXJyLFxuICAgICAgICBtc2csXG4gICAgICAgIHNlc3Npb24sXG4gICAgICAgIHJlc3AsXG4gICAgICAgIG9wdHMsXG4gICAgICAgIChlcnI6IGFueSwgcmVzcDogYW55LCBvcHRzOiBhbnkpID0+IHtcbiAgICAgICAgICByZXNwb25zZShmYWxzZSwgc2VsZiwgZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIG9wdHMsIGNiISk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgc2VsZi5oYW5kbGVyU2VydmljZS5oYW5kbGUoXG4gICAgICByb3V0ZVJlY29yZCxcbiAgICAgIG1zZyxcbiAgICAgIHNlc3Npb24sXG4gICAgICAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAvL2Vycm9yIGZyb20gaGFuZGxlclxuICAgICAgICAgIGhhbmRsZUVycm9yKFxuICAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICBzZWxmLFxuICAgICAgICAgICAgZXJyLFxuICAgICAgICAgICAgbXNnLFxuICAgICAgICAgICAgc2Vzc2lvbixcbiAgICAgICAgICAgIHJlc3AsXG4gICAgICAgICAgICBvcHRzLFxuICAgICAgICAgICAgKGVycjogYW55LCByZXNwOiBhbnksIG9wdHM6IGFueSkgPT4ge1xuICAgICAgICAgICAgICByZXNwb25zZShmYWxzZSwgc2VsZiwgZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIG9wdHMsIGNiISk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICByZXNwb25zZShmYWxzZSwgc2VsZiwgZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIG9wdHMsIGNiISk7XG4gICAgICB9XG4gICAgKTtcbiAgfTsgLy9lbmQgb2YgaGFuZGxlXG5cbiAgYmVmb3JlRmlsdGVyKGZhbHNlLCBzZXJ2ZXIsIG1zZywgc2Vzc2lvbiwgaGFuZGxlKTtcbn1cblxuZnVuY3Rpb24gc2NoZWR1bGVDcm9ucyhzZXJ2ZXI6IFNlcnZlciwgY3JvbnM6IENyb25bXSkge1xuICBsZXQgaGFuZGxlcnMgPSBzZXJ2ZXIuY3JvbkhhbmRsZXJzO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGNyb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IGNyb25JbmZvID0gY3JvbnNbaV07XG4gICAgbGV0IHRpbWUgPSBjcm9uSW5mby50aW1lO1xuICAgIGxldCBhY3Rpb24gPSBjcm9uSW5mby5hY3Rpb247XG4gICAgbGV0IGpvYklkID0gY3JvbkluZm8uaWQ7XG5cbiAgICBpZiAoIXRpbWUgfHwgIWFjdGlvbiB8fCAham9iSWQpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcImNyb24gbWlzcyBuZWNlc3NhcnkgcGFyYW1ldGVyczogJWpcIiwgY3JvbkluZm8pO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKGFjdGlvbi5pbmRleE9mKFwiLlwiKSA8IDApIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcImNyb24gYWN0aW9uIGlzIGVycm9yIGZvcm1hdDogJWpcIiwgY3JvbkluZm8pO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgbGV0IGNyb24gPSBhY3Rpb24uc3BsaXQoXCIuXCIpWzBdO1xuICAgIGxldCBqb2IgPSBhY3Rpb24uc3BsaXQoXCIuXCIpWzFdO1xuICAgIGxldCBoYW5kbGVyID0gaGFuZGxlcnNbY3Jvbl07XG5cbiAgICBpZiAoIWhhbmRsZXIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcImNvdWxkIG5vdCBmaW5kIGNyb246ICVqXCIsIGNyb25JbmZvKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgaGFuZGxlcltqb2JdICE9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcImNvdWxkIG5vdCBmaW5kIGNyb24gam9iOiAlaiwgJXNcIiwgY3JvbkluZm8sIGpvYik7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBsZXQgaWQgPSBzY2hlZHVsZS5zY2hlZHVsZUpvYih0aW1lLCBoYW5kbGVyW2pvYl0uYmluZChoYW5kbGVyKSk7XG4gICAgc2VydmVyLmpvYnNbam9iSWRdID0gaWQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2hlY2tBbmRBZGQoY3JvbjogQ3JvbiwgY3JvbnM6IENyb25bXSwgc2VydmVyOiBTZXJ2ZXIpIHtcbiAgaWYgKCFjb250YWluQ3Jvbihjcm9uLmlkLCBjcm9ucykpIHtcbiAgICBzZXJ2ZXIuY3JvbnMucHVzaChjcm9uKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIud2FybihcImNyb24gaXMgZHVwbGljYXRlZDogJWpcIiwgY3Jvbik7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29udGFpbkNyb24oaWQ6IG51bWJlciwgY3JvbnM6IENyb25bXSkge1xuICBmb3IgKGxldCBpID0gMCwgbCA9IGNyb25zLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgIGlmIChpZCA9PT0gY3JvbnNbaV0uaWQpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG4iXX0=