"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const stream_1 = require("stream");
const net_1 = require("net");
const protocol = require("pomelo-protocol");
const Package = protocol.Package;
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
var State;
(function (State) {
    State[State["ST_HEAD"] = 1] = "ST_HEAD";
    State[State["ST_BODY"] = 2] = "ST_BODY";
    State[State["ST_CLOSED"] = 3] = "ST_CLOSED"; // closed
})(State || (State = {}));
class TcpSocket extends stream_1.Stream {
    constructor(socket, opts) {
        super();
        if (!(this instanceof net_1.Socket)) {
            return new TcpSocket(socket, opts);
        }
        if (!socket || !opts) {
            throw new Error("invalid socket or opts");
        }
        if (!opts.headSize || typeof opts.headHandler !== "function") {
            throw new Error("invalid opts.headSize or opts.headHandler");
        }
        // stream style interfaces.
        // TODO: need to port to stream2 after node 0.9
        stream_1.Stream.call(this);
        this.readable = true;
        this.writeable = true;
        this._socket = socket;
        this.headSize = opts.headSize;
        this.closeMethod = opts.closeMethod;
        this.headBuffer = new Buffer(opts.headSize);
        this.headHandler = opts.headHandler;
        this.headOffset = 0;
        this.packageOffset = 0;
        this.packageSize = 0;
        this.packageBuffer = null;
        // bind event form the origin socket
        this._socket.on("data", ondata.bind(null, this));
        this._socket.on("end", onend.bind(null, this));
        this._socket.on("error", this.emit.bind(this, "error"));
        this._socket.on("close", this.emit.bind(this, "close"));
        this.state = State.ST_HEAD;
    }
    send(msg, encode, cb) {
        return this._socket.write(msg, encode, cb);
    }
    close() {
        if (!!this.closeMethod && this.closeMethod === "end") {
            this._socket.end();
        }
        else {
            try {
                this._socket.destroy();
            }
            catch (e) {
                logger.error("socket close with destroy error: %j", e.stack);
            }
        }
    }
}
exports.default = TcpSocket;
exports.TcpSocket = TcpSocket;
function ondata(socket, chunk) {
    if (socket.state === State.ST_CLOSED) {
        throw new Error("socket has closed");
    }
    if (typeof chunk !== "string" && !Buffer.isBuffer(chunk)) {
        throw new Error("invalid data");
    }
    if (typeof chunk === "string") {
        chunk = new Buffer(chunk, "utf8");
    }
    let offset = 0, end = chunk.length;
    while (offset < end) {
        if (socket.state === State.ST_HEAD) {
            offset = readHead(socket, chunk, offset);
        }
        if (socket.state === State.ST_BODY) {
            offset = readBody(socket, chunk, offset);
        }
    }
    return true;
}
function onend(socket, chunk) {
    if (chunk) {
        socket._socket.write(chunk);
    }
    socket.state = State.ST_CLOSED;
    reset(socket);
    socket.emit("end");
}
function readHead(socket, data, offset) {
    let hlen = socket.headSize - socket.headOffset;
    let dlen = data.length - offset;
    let len = Math.min(hlen, dlen);
    let dend = offset + len;
    data.copy(socket.headBuffer, socket.headOffset, offset, dend);
    socket.headOffset += len;
    if (socket.headOffset === socket.headSize) {
        // if head segment finished
        let size = socket.headHandler(socket.headBuffer);
        if (size < 0) {
            throw new Error("invalid body size: " + size);
        }
        // check if header contains a valid type
        if (checkTypeData(socket.headBuffer[0])) {
            socket.packageSize = size + socket.headSize;
            socket.packageBuffer = new Buffer(socket.packageSize);
            socket.headBuffer.copy(socket.packageBuffer, 0, 0, socket.headSize);
            socket.packageOffset = socket.headSize;
            socket.state = State.ST_BODY;
        }
        else {
            dend = data.length;
            logger.error("close the connection with invalid head message, the remote ip is %s && port is %s && message is %j", socket._socket.remoteAddress, socket._socket.remotePort, data);
            socket.close();
        }
    }
    return dend;
}
function readBody(socket, data, offset) {
    let blen = socket.packageSize - socket.packageOffset;
    let dlen = data.length - offset;
    let len = Math.min(blen, dlen);
    let dend = offset + len;
    data.copy(socket.packageBuffer, socket.packageOffset, offset, dend);
    socket.packageOffset += len;
    if (socket.packageOffset === socket.packageSize) {
        // if all the package finished
        let buffer = socket.packageBuffer;
        socket.emit("message", buffer);
        reset(socket);
    }
    return dend;
}
function reset(socket) {
    socket.headOffset = 0;
    socket.packageOffset = 0;
    socket.packageSize = 0;
    socket.packageBuffer = null;
    socket.state = State.ST_HEAD;
}
function checkTypeData(data) {
    return (data === Package.TYPE_HANDSHAKE ||
        data === Package.TYPE_HANDSHAKE_ACK ||
        data === Package.TYPE_HEARTBEAT ||
        data === Package.TYPE_DATA ||
        data === Package.TYPE_KICK);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGNwc29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGNwc29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsbUNBQWdDO0FBQ2hDLDZCQUFvRDtBQUVwRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUM1QyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDO0FBQ2pDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRXhFLElBQUssS0FJSjtBQUpELFdBQUssS0FBSztJQUNSLHVDQUFXLENBQUE7SUFDWCx1Q0FBVyxDQUFBO0lBQ1gsMkNBQWEsQ0FBQSxDQUFDLFNBQVM7QUFDekIsQ0FBQyxFQUpJLEtBQUssS0FBTCxLQUFLLFFBSVQ7QUFRRCxlQUErQixTQUFRLGVBQU07SUFZM0MsWUFBWSxNQUFjLEVBQUUsSUFBbUI7UUFDN0MsS0FBSyxFQUFFLENBQUM7UUFDUixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxZQUFZLFlBQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM5QixNQUFNLENBQUMsSUFBSSxTQUFTLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQzVDLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksT0FBTyxJQUFJLENBQUMsV0FBVyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDN0QsTUFBTSxJQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCwyQkFBMkI7UUFDM0IsK0NBQStDO1FBQy9DLGVBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFFdEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzlCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUNwQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFFcEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUM7UUFDcEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsR0FBUSxJQUFJLENBQUM7UUFFL0Isb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFeEQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO0lBQzdCLENBQUM7SUFDRCxJQUFJLENBQUMsR0FBVyxFQUFFLE1BQWUsRUFBRSxFQUFhO1FBQzlDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLO1FBQ0gsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdBQVcsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDckIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDO2dCQUNILElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDekIsQ0FBQztZQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ1gsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDL0QsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFsRUQsNEJBa0VDO0FBb0hRLDhCQUFTO0FBbEhsQixnQkFBZ0IsTUFBaUIsRUFBRSxLQUFzQjtJQUN2RCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekQsTUFBTSxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxLQUFLLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztRQUM5QixLQUFLLEdBQUcsSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxJQUFJLE1BQU0sR0FBRyxDQUFDLEVBQ1osR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7SUFFckIsT0FBTyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDcEIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDM0MsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDbkMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzNDLENBQUM7SUFDSCxDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUksQ0FBQztBQUNkLENBQUM7QUFFRCxlQUFlLE1BQWlCLEVBQUUsS0FBVTtJQUMxQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ1YsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFNLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQztJQUNoQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDZCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3JCLENBQUM7QUFFRCxrQkFBa0IsTUFBaUIsRUFBRSxJQUFTLEVBQUUsTUFBYztJQUM1RCxJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7SUFDL0MsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDaEMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDL0IsSUFBSSxJQUFJLEdBQUcsTUFBTSxHQUFHLEdBQUcsQ0FBQztJQUV4QixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDOUQsTUFBTSxDQUFDLFVBQVcsSUFBSSxHQUFHLENBQUM7SUFFMUIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsS0FBSyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUMxQywyQkFBMkI7UUFDM0IsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDakQsRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDYixNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQyxDQUFDO1FBQ2hELENBQUM7UUFDRCx3Q0FBd0M7UUFDeEMsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEMsTUFBTSxDQUFDLFdBQVksR0FBRyxJQUFJLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztZQUM3QyxNQUFNLENBQUMsYUFBYyxHQUFHLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN2RCxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BFLE1BQU0sQ0FBQyxhQUFjLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztZQUN4QyxNQUFNLENBQUMsS0FBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDaEMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDbkIsTUFBTSxDQUFDLEtBQUssQ0FDVixvR0FBb0csRUFDcEcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQzVCLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUN6QixJQUFJLENBQ0wsQ0FBQztZQUNGLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNqQixDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQsa0JBQWtCLE1BQWlCLEVBQUUsSUFBUyxFQUFFLE1BQWM7SUFDNUQsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDO0lBQ3JELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQ2hDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQy9CLElBQUksSUFBSSxHQUFHLE1BQU0sR0FBRyxHQUFHLENBQUM7SUFFeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxhQUFhLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBRXBFLE1BQU0sQ0FBQyxhQUFjLElBQUksR0FBRyxDQUFDO0lBRTdCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEtBQUssTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7UUFDaEQsOEJBQThCO1FBQzlCLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUM7UUFDbEMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDL0IsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hCLENBQUM7SUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELGVBQWUsTUFBaUI7SUFDOUIsTUFBTSxDQUFDLFVBQVcsR0FBRyxDQUFDLENBQUM7SUFDdkIsTUFBTSxDQUFDLGFBQWMsR0FBRyxDQUFDLENBQUM7SUFDMUIsTUFBTSxDQUFDLFdBQVksR0FBRyxDQUFDLENBQUM7SUFDeEIsTUFBTSxDQUFDLGFBQWMsR0FBUSxJQUFJLENBQUM7SUFDbEMsTUFBTSxDQUFDLEtBQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO0FBQ2hDLENBQUM7QUFFRCx1QkFBdUIsSUFBUztJQUM5QixNQUFNLENBQUMsQ0FDTCxJQUFJLEtBQUssT0FBTyxDQUFDLGNBQWM7UUFDL0IsSUFBSSxLQUFLLE9BQU8sQ0FBQyxrQkFBa0I7UUFDbkMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxjQUFjO1FBQy9CLElBQUksS0FBSyxPQUFPLENBQUMsU0FBUztRQUMxQixJQUFJLEtBQUssT0FBTyxDQUFDLFNBQVMsQ0FDM0IsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xuaW1wb3J0IHsgU3RyZWFtIH0gZnJvbSBcInN0cmVhbVwiO1xuaW1wb3J0IHsgU29ja2V0LCBTb2NrZXRDb25zdHJ1Y3Rvck9wdHMgfSBmcm9tIFwibmV0XCI7XG5pbXBvcnQgeyBoZWFkSGFuZGxlciB9IGZyb20gXCIuLi8uLi91dGlsL3V0aWxzXCI7XG5jb25zdCBwcm90b2NvbCA9IHJlcXVpcmUoXCJwb21lbG8tcHJvdG9jb2xcIik7XG5jb25zdCBQYWNrYWdlID0gcHJvdG9jb2wuUGFja2FnZTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcblxuZW51bSBTdGF0ZSB7XG4gIFNUX0hFQUQgPSAxLCAvLyB3YWl0IGZvciBoZWFkXG4gIFNUX0JPRFkgPSAyLCAvLyB3YWl0IGZvciBib2R5XG4gIFNUX0NMT1NFRCA9IDMgLy8gY2xvc2VkXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGNwU29ja2V0T3B0cyB7XG4gIGhlYWRTaXplOiBudW1iZXI7XG4gIGhlYWRIYW5kbGVyOiAoYnVmOiBCdWZmZXIpID0+IG51bWJlcjtcbiAgY2xvc2VNZXRob2Q6IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVGNwU29ja2V0IGV4dGVuZHMgU3RyZWFtIHtcbiAgcHJpdmF0ZSB3cml0ZWFibGU6IGJvb2xlYW47XG4gIHJlYWRvbmx5IF9zb2NrZXQ6IFNvY2tldDtcbiAgcmVhZG9ubHkgaGVhZFNpemU6IG51bWJlcjtcbiAgcmVhZG9ubHkgY2xvc2VNZXRob2Q6IHN0cmluZztcbiAgcmVhZG9ubHkgaGVhZEJ1ZmZlcjogQnVmZmVyO1xuICByZWFkb25seSBoZWFkSGFuZGxlcjogKGJ1ZjogQnVmZmVyKSA9PiBudW1iZXI7XG4gIHJlYWRvbmx5IGhlYWRPZmZzZXQ6IG51bWJlcjtcbiAgcmVhZG9ubHkgcGFja2FnZU9mZnNldDogbnVtYmVyO1xuICByZWFkb25seSBwYWNrYWdlU2l6ZTogbnVtYmVyO1xuICByZWFkb25seSBwYWNrYWdlQnVmZmVyOiBCdWZmZXI7XG4gIHJlYWRvbmx5IHN0YXRlOiBTdGF0ZTtcbiAgY29uc3RydWN0b3Ioc29ja2V0OiBTb2NrZXQsIG9wdHM6IFRjcFNvY2tldE9wdHMpIHtcbiAgICBzdXBlcigpO1xuICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBTb2NrZXQpKSB7XG4gICAgICByZXR1cm4gbmV3IFRjcFNvY2tldChzb2NrZXQsIG9wdHMpO1xuICAgIH1cblxuICAgIGlmICghc29ja2V0IHx8ICFvcHRzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnZhbGlkIHNvY2tldCBvciBvcHRzXCIpO1xuICAgIH1cblxuICAgIGlmICghb3B0cy5oZWFkU2l6ZSB8fCB0eXBlb2Ygb3B0cy5oZWFkSGFuZGxlciAhPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnZhbGlkIG9wdHMuaGVhZFNpemUgb3Igb3B0cy5oZWFkSGFuZGxlclwiKTtcbiAgICB9XG5cbiAgICAvLyBzdHJlYW0gc3R5bGUgaW50ZXJmYWNlcy5cbiAgICAvLyBUT0RPOiBuZWVkIHRvIHBvcnQgdG8gc3RyZWFtMiBhZnRlciBub2RlIDAuOVxuICAgIFN0cmVhbS5jYWxsKHRoaXMpO1xuICAgIHRoaXMucmVhZGFibGUgPSB0cnVlO1xuICAgIHRoaXMud3JpdGVhYmxlID0gdHJ1ZTtcblxuICAgIHRoaXMuX3NvY2tldCA9IHNvY2tldDtcbiAgICB0aGlzLmhlYWRTaXplID0gb3B0cy5oZWFkU2l6ZTtcbiAgICB0aGlzLmNsb3NlTWV0aG9kID0gb3B0cy5jbG9zZU1ldGhvZDtcbiAgICB0aGlzLmhlYWRCdWZmZXIgPSBuZXcgQnVmZmVyKG9wdHMuaGVhZFNpemUpO1xuICAgIHRoaXMuaGVhZEhhbmRsZXIgPSBvcHRzLmhlYWRIYW5kbGVyO1xuXG4gICAgdGhpcy5oZWFkT2Zmc2V0ID0gMDtcbiAgICB0aGlzLnBhY2thZ2VPZmZzZXQgPSAwO1xuICAgIHRoaXMucGFja2FnZVNpemUgPSAwO1xuICAgIHRoaXMucGFja2FnZUJ1ZmZlciA9IDxhbnk+bnVsbDtcblxuICAgIC8vIGJpbmQgZXZlbnQgZm9ybSB0aGUgb3JpZ2luIHNvY2tldFxuICAgIHRoaXMuX3NvY2tldC5vbihcImRhdGFcIiwgb25kYXRhLmJpbmQobnVsbCwgdGhpcykpO1xuICAgIHRoaXMuX3NvY2tldC5vbihcImVuZFwiLCBvbmVuZC5iaW5kKG51bGwsIHRoaXMpKTtcbiAgICB0aGlzLl9zb2NrZXQub24oXCJlcnJvclwiLCB0aGlzLmVtaXQuYmluZCh0aGlzLCBcImVycm9yXCIpKTtcbiAgICB0aGlzLl9zb2NrZXQub24oXCJjbG9zZVwiLCB0aGlzLmVtaXQuYmluZCh0aGlzLCBcImNsb3NlXCIpKTtcblxuICAgIHRoaXMuc3RhdGUgPSBTdGF0ZS5TVF9IRUFEO1xuICB9XG4gIHNlbmQobXNnOiBzdHJpbmcsIGVuY29kZT86IHN0cmluZywgY2I/OiBGdW5jdGlvbikge1xuICAgIHJldHVybiB0aGlzLl9zb2NrZXQud3JpdGUobXNnLCBlbmNvZGUsIGNiKTtcbiAgfVxuXG4gIGNsb3NlKCkge1xuICAgIGlmICghIXRoaXMuY2xvc2VNZXRob2QgJiYgdGhpcy5jbG9zZU1ldGhvZCA9PT0gXCJlbmRcIikge1xuICAgICAgdGhpcy5fc29ja2V0LmVuZCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLl9zb2NrZXQuZGVzdHJveSgpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoXCJzb2NrZXQgY2xvc2Ugd2l0aCBkZXN0cm95IGVycm9yOiAlalwiLCBlLnN0YWNrKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gb25kYXRhKHNvY2tldDogVGNwU29ja2V0LCBjaHVuazogc3RyaW5nIHwgQnVmZmVyKSB7XG4gIGlmIChzb2NrZXQuc3RhdGUgPT09IFN0YXRlLlNUX0NMT1NFRCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcInNvY2tldCBoYXMgY2xvc2VkXCIpO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBjaHVuayAhPT0gXCJzdHJpbmdcIiAmJiAhQnVmZmVyLmlzQnVmZmVyKGNodW5rKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcImludmFsaWQgZGF0YVwiKTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgY2h1bmsgPT09IFwic3RyaW5nXCIpIHtcbiAgICBjaHVuayA9IG5ldyBCdWZmZXIoY2h1bmssIFwidXRmOFwiKTtcbiAgfVxuXG4gIGxldCBvZmZzZXQgPSAwLFxuICAgIGVuZCA9IGNodW5rLmxlbmd0aDtcblxuICB3aGlsZSAob2Zmc2V0IDwgZW5kKSB7XG4gICAgaWYgKHNvY2tldC5zdGF0ZSA9PT0gU3RhdGUuU1RfSEVBRCkge1xuICAgICAgb2Zmc2V0ID0gcmVhZEhlYWQoc29ja2V0LCBjaHVuaywgb2Zmc2V0KTtcbiAgICB9XG5cbiAgICBpZiAoc29ja2V0LnN0YXRlID09PSBTdGF0ZS5TVF9CT0RZKSB7XG4gICAgICBvZmZzZXQgPSByZWFkQm9keShzb2NrZXQsIGNodW5rLCBvZmZzZXQpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBvbmVuZChzb2NrZXQ6IFRjcFNvY2tldCwgY2h1bms6IGFueSkge1xuICBpZiAoY2h1bmspIHtcbiAgICBzb2NrZXQuX3NvY2tldC53cml0ZShjaHVuayk7XG4gIH1cblxuICBzb2NrZXQuc3RhdGUhID0gU3RhdGUuU1RfQ0xPU0VEO1xuICByZXNldChzb2NrZXQpO1xuICBzb2NrZXQuZW1pdChcImVuZFwiKTtcbn1cblxuZnVuY3Rpb24gcmVhZEhlYWQoc29ja2V0OiBUY3BTb2NrZXQsIGRhdGE6IGFueSwgb2Zmc2V0OiBudW1iZXIpIHtcbiAgbGV0IGhsZW4gPSBzb2NrZXQuaGVhZFNpemUgLSBzb2NrZXQuaGVhZE9mZnNldDtcbiAgbGV0IGRsZW4gPSBkYXRhLmxlbmd0aCAtIG9mZnNldDtcbiAgbGV0IGxlbiA9IE1hdGgubWluKGhsZW4sIGRsZW4pO1xuICBsZXQgZGVuZCA9IG9mZnNldCArIGxlbjtcblxuICBkYXRhLmNvcHkoc29ja2V0LmhlYWRCdWZmZXIsIHNvY2tldC5oZWFkT2Zmc2V0LCBvZmZzZXQsIGRlbmQpO1xuICBzb2NrZXQuaGVhZE9mZnNldCEgKz0gbGVuO1xuXG4gIGlmIChzb2NrZXQuaGVhZE9mZnNldCA9PT0gc29ja2V0LmhlYWRTaXplKSB7XG4gICAgLy8gaWYgaGVhZCBzZWdtZW50IGZpbmlzaGVkXG4gICAgbGV0IHNpemUgPSBzb2NrZXQuaGVhZEhhbmRsZXIoc29ja2V0LmhlYWRCdWZmZXIpO1xuICAgIGlmIChzaXplIDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiaW52YWxpZCBib2R5IHNpemU6IFwiICsgc2l6ZSk7XG4gICAgfVxuICAgIC8vIGNoZWNrIGlmIGhlYWRlciBjb250YWlucyBhIHZhbGlkIHR5cGVcbiAgICBpZiAoY2hlY2tUeXBlRGF0YShzb2NrZXQuaGVhZEJ1ZmZlclswXSkpIHtcbiAgICAgIHNvY2tldC5wYWNrYWdlU2l6ZSEgPSBzaXplICsgc29ja2V0LmhlYWRTaXplO1xuICAgICAgc29ja2V0LnBhY2thZ2VCdWZmZXIhID0gbmV3IEJ1ZmZlcihzb2NrZXQucGFja2FnZVNpemUpO1xuICAgICAgc29ja2V0LmhlYWRCdWZmZXIuY29weShzb2NrZXQucGFja2FnZUJ1ZmZlciwgMCwgMCwgc29ja2V0LmhlYWRTaXplKTtcbiAgICAgIHNvY2tldC5wYWNrYWdlT2Zmc2V0ISA9IHNvY2tldC5oZWFkU2l6ZTtcbiAgICAgIHNvY2tldC5zdGF0ZSEgPSBTdGF0ZS5TVF9CT0RZO1xuICAgIH0gZWxzZSB7XG4gICAgICBkZW5kID0gZGF0YS5sZW5ndGg7XG4gICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgIFwiY2xvc2UgdGhlIGNvbm5lY3Rpb24gd2l0aCBpbnZhbGlkIGhlYWQgbWVzc2FnZSwgdGhlIHJlbW90ZSBpcCBpcyAlcyAmJiBwb3J0IGlzICVzICYmIG1lc3NhZ2UgaXMgJWpcIixcbiAgICAgICAgc29ja2V0Ll9zb2NrZXQucmVtb3RlQWRkcmVzcyxcbiAgICAgICAgc29ja2V0Ll9zb2NrZXQucmVtb3RlUG9ydCxcbiAgICAgICAgZGF0YVxuICAgICAgKTtcbiAgICAgIHNvY2tldC5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkZW5kO1xufVxuXG5mdW5jdGlvbiByZWFkQm9keShzb2NrZXQ6IFRjcFNvY2tldCwgZGF0YTogYW55LCBvZmZzZXQ6IG51bWJlcikge1xuICBsZXQgYmxlbiA9IHNvY2tldC5wYWNrYWdlU2l6ZSAtIHNvY2tldC5wYWNrYWdlT2Zmc2V0O1xuICBsZXQgZGxlbiA9IGRhdGEubGVuZ3RoIC0gb2Zmc2V0O1xuICBsZXQgbGVuID0gTWF0aC5taW4oYmxlbiwgZGxlbik7XG4gIGxldCBkZW5kID0gb2Zmc2V0ICsgbGVuO1xuXG4gIGRhdGEuY29weShzb2NrZXQucGFja2FnZUJ1ZmZlciwgc29ja2V0LnBhY2thZ2VPZmZzZXQsIG9mZnNldCwgZGVuZCk7XG5cbiAgc29ja2V0LnBhY2thZ2VPZmZzZXQhICs9IGxlbjtcblxuICBpZiAoc29ja2V0LnBhY2thZ2VPZmZzZXQgPT09IHNvY2tldC5wYWNrYWdlU2l6ZSkge1xuICAgIC8vIGlmIGFsbCB0aGUgcGFja2FnZSBmaW5pc2hlZFxuICAgIGxldCBidWZmZXIgPSBzb2NrZXQucGFja2FnZUJ1ZmZlcjtcbiAgICBzb2NrZXQuZW1pdChcIm1lc3NhZ2VcIiwgYnVmZmVyKTtcbiAgICByZXNldChzb2NrZXQpO1xuICB9XG5cbiAgcmV0dXJuIGRlbmQ7XG59XG5cbmZ1bmN0aW9uIHJlc2V0KHNvY2tldDogVGNwU29ja2V0KSB7XG4gIHNvY2tldC5oZWFkT2Zmc2V0ISA9IDA7XG4gIHNvY2tldC5wYWNrYWdlT2Zmc2V0ISA9IDA7XG4gIHNvY2tldC5wYWNrYWdlU2l6ZSEgPSAwO1xuICBzb2NrZXQucGFja2FnZUJ1ZmZlciEgPSA8YW55Pm51bGw7XG4gIHNvY2tldC5zdGF0ZSEgPSBTdGF0ZS5TVF9IRUFEO1xufVxuXG5mdW5jdGlvbiBjaGVja1R5cGVEYXRhKGRhdGE6IGFueSkge1xuICByZXR1cm4gKFxuICAgIGRhdGEgPT09IFBhY2thZ2UuVFlQRV9IQU5EU0hBS0UgfHxcbiAgICBkYXRhID09PSBQYWNrYWdlLlRZUEVfSEFORFNIQUtFX0FDSyB8fFxuICAgIGRhdGEgPT09IFBhY2thZ2UuVFlQRV9IRUFSVEJFQVQgfHxcbiAgICBkYXRhID09PSBQYWNrYWdlLlRZUEVfREFUQSB8fFxuICAgIGRhdGEgPT09IFBhY2thZ2UuVFlQRV9LSUNLXG4gICk7XG59XG5cbmV4cG9ydCB7IFRjcFNvY2tldCB9O1xuIl19