"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const stream_1 = require("stream");
const net_1 = require("net");
const protocol = require("pomelo-protocol");
const Package = protocol.Package;
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
var State;
(function (State) {
    State[State["ST_HEAD"] = 1] = "ST_HEAD";
    State[State["ST_BODY"] = 2] = "ST_BODY";
    State[State["ST_CLOSED"] = 3] = "ST_CLOSED"; // closed
})(State || (State = {}));
class TcpSocket extends stream_1.Stream {
    constructor(socket, opts) {
        super();
        if (!(this instanceof net_1.Socket)) {
            return new TcpSocket(socket, opts);
        }
        if (!socket || !opts) {
            throw new Error("invalid socket or opts");
        }
        if (!opts.headSize || typeof opts.headHandler !== "function") {
            throw new Error("invalid opts.headSize or opts.headHandler");
        }
        // stream style interfaces.
        // TODO: need to port to stream2 after node 0.9
        stream_1.Stream.call(this);
        this.readable = true;
        this.writeable = true;
        this._socket = socket;
        this.headSize = opts.headSize;
        this.closeMethod = opts.closeMethod;
        this.headBuffer = new Buffer(opts.headSize);
        this.headHandler = opts.headHandler;
        this.headOffset = 0;
        this.packageOffset = 0;
        this.packageSize = 0;
        this.packageBuffer = null;
        // bind event form the origin socket
        this._socket.on("data", ondata.bind(null, this));
        this._socket.on("end", onend.bind(null, this));
        this._socket.on("error", this.emit.bind(this, "error"));
        this._socket.on("close", this.emit.bind(this, "close"));
        this.state = State.ST_HEAD;
    }
    send(msg, encode, cb) {
        return this._socket.write(msg, encode, cb);
    }
    close() {
        if (!!this.closeMethod && this.closeMethod === "end") {
            this._socket.end();
        }
        else {
            try {
                this._socket.destroy();
            }
            catch (e) {
                logger.error("socket close with destroy error: %j", e.stack);
            }
        }
    }
}
exports.default = TcpSocket;
exports.TcpSocket = TcpSocket;
function ondata(socket, chunk) {
    if (socket.state === State.ST_CLOSED) {
        throw new Error("socket has closed");
    }
    if (typeof chunk !== "string" && !Buffer.isBuffer(chunk)) {
        throw new Error("invalid data");
    }
    if (typeof chunk === "string") {
        chunk = new Buffer(chunk, "utf8");
    }
    let offset = 0, end = chunk.length;
    while (offset < end) {
        if (socket.state === State.ST_HEAD) {
            offset = readHead(socket, chunk, offset);
        }
        if (socket.state === State.ST_BODY) {
            offset = readBody(socket, chunk, offset);
        }
    }
    return true;
}
function onend(socket, chunk) {
    if (chunk) {
        socket._socket.write(chunk);
    }
    socket.state = State.ST_CLOSED;
    reset(socket);
    socket.emit("end");
}
function readHead(socket, data, offset) {
    let hlen = socket.headSize - socket.headOffset;
    let dlen = data.length - offset;
    let len = Math.min(hlen, dlen);
    let dend = offset + len;
    data.copy(socket.headBuffer, socket.headOffset, offset, dend);
    socket.headOffset += len;
    if (socket.headOffset === socket.headSize) {
        // if head segment finished
        let size = socket.headHandler(socket.headBuffer);
        if (size < 0) {
            throw new Error("invalid body size: " + size);
        }
        // check if header contains a valid type
        if (checkTypeData(socket.headBuffer[0])) {
            socket.packageSize = size + socket.headSize;
            socket.packageBuffer = new Buffer(socket.packageSize);
            socket.headBuffer.copy(socket.packageBuffer, 0, 0, socket.headSize);
            socket.packageOffset = socket.headSize;
            socket.state = State.ST_BODY;
        }
        else {
            dend = data.length;
            logger.error("close the connection with invalid head message, the remote ip is %s && port is %s && message is %j", socket._socket.remoteAddress, socket._socket.remotePort, data);
            socket.close();
        }
    }
    return dend;
}
function readBody(socket, data, offset) {
    let blen = socket.packageSize - socket.packageOffset;
    let dlen = data.length - offset;
    let len = Math.min(blen, dlen);
    let dend = offset + len;
    data.copy(socket.packageBuffer, socket.packageOffset, offset, dend);
    socket.packageOffset += len;
    if (socket.packageOffset === socket.packageSize) {
        // if all the package finished
        let buffer = socket.packageBuffer;
        socket.emit("message", buffer);
        reset(socket);
    }
    return dend;
}
function reset(socket) {
    socket.headOffset = 0;
    socket.packageOffset = 0;
    socket.packageSize = 0;
    socket.packageBuffer = null;
    socket.state = State.ST_HEAD;
}
function checkTypeData(data) {
    return (data === Package.TYPE_HANDSHAKE ||
        data === Package.TYPE_HANDSHAKE_ACK ||
        data === Package.TYPE_HEARTBEAT ||
        data === Package.TYPE_DATA ||
        data === Package.TYPE_KICK);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGNwc29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGNwc29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsbUNBQWdDO0FBQ2hDLDZCQUFvRDtBQUVwRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUM1QyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDO0FBQ2pDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRXhFLElBQUssS0FJSjtBQUpELFdBQUssS0FBSztJQUNSLHVDQUFXLENBQUE7SUFDWCx1Q0FBVyxDQUFBO0lBQ1gsMkNBQWEsQ0FBQSxDQUFDLFNBQVM7QUFDekIsQ0FBQyxFQUpJLEtBQUssS0FBTCxLQUFLLFFBSVQ7QUFRRCxlQUErQixTQUFRLGVBQU07SUFZM0MsWUFBWSxNQUFjLEVBQUUsSUFBbUI7UUFDN0MsS0FBSyxFQUFFLENBQUM7UUFDUixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxZQUFZLFlBQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM5QixNQUFNLENBQUMsSUFBSSxTQUFTLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQzVDLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksT0FBTyxJQUFJLENBQUMsV0FBVyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDN0QsTUFBTSxJQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCwyQkFBMkI7UUFDM0Is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QUM7UUFDL0IsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hCLENBQUM7SUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELGVBQWUsTUFBaUI7SUFDOUIsTUFBTSxDQUFDLFVBQVcsR0FBRyxDQUFDLENBQUM7SUFDdkIsTUFBTSxDQUFDLGFBQWMsR0FBRyxDQUFDLENBQUM7SUFDMUIsTUFBTSxDQUFDLFdBQVksR0FBRyxDQUFDLENBQUM7SUFDeEIsTUFBTSxDQUFDLGFBQWMsR0FBUSxJQUFJLENBQUM7SUFDbEMsTUFBTSxDQUFDLEtBQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO0FBQ2hDLENBQUM7QUFFRCx1QkFBdUIsSUFBUztJQUM5QixNQUFNLENBQUMsQ0FDTCxJQUFJLEtBQUssT0FBTyxDQUFDLGNBQWM7UUFDL0IsSUFBSSxLQUFLLE9BQU8sQ0FBQyxrQkFBa0I7UUFDbkMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxjQUFjO1FBQy9CLElBQUksS0FBSyxPQUFPLENBQUMsU0FBUztRQUMxQixJQUFJLEtBQUssT0FBTyxDQUFDLFNBQVMsQ0FDM0IsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG5pbXBvcnQgeyBTdHJlYW0gfSBmcm9tIFwic3RyZWFtXCI7XHJcbmltcG9ydCB7IFNvY2tldCwgU29ja2V0Q29uc3RydWN0b3JPcHRzIH0gZnJvbSBcIm5ldFwiO1xyXG5pbXBvcnQgeyBoZWFkSGFuZGxlciB9IGZyb20gXCIuLi8uLi91dGlsL3V0aWxzXCI7XHJcbmNvbnN0IHByb3RvY29sID0gcmVxdWlyZShcInBvbWVsby1wcm90b2NvbFwiKTtcclxuY29uc3QgUGFja2FnZSA9IHByb3RvY29sLlBhY2thZ2U7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcclxuXHJcbmVudW0gU3RhdGUge1xyXG4gIFNUX0hFQUQgPSAxLCAvLyB3YWl0IGZvciBoZWFkXHJcbiAgU1RfQk9EWSA9IDIsIC8vIHdhaXQgZm9yIGJvZHlcclxuICBTVF9DTE9TRUQgPSAzIC8vIGNsb3NlZFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFRjcFNvY2tldE9wdHMge1xyXG4gIGhlYWRTaXplOiBudW1iZXI7XHJcbiAgaGVhZEhhbmRsZXI6IChidWY6IEJ1ZmZlcikgPT4gbnVtYmVyO1xyXG4gIGNsb3NlTWV0aG9kOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRjcFNvY2tldCBleHRlbmRzIFN0cmVhbSB7XHJcbiAgcHJpdmF0ZSB3cml0ZWFibGU6IGJvb2xlYW47XHJcbiAgcmVhZG9ubHkgX3NvY2tldDogU29ja2V0O1xyXG4gIHJlYWRvbmx5IGhlYWRTaXplOiBudW1iZXI7XHJcbiAgcmVhZG9ubHkgY2xvc2VNZXRob2Q6IHN0cmluZztcclxuICByZWFkb25seSBoZWFkQnVmZmVyOiBCdWZmZXI7XHJcbiAgcmVhZG9ubHkgaGVhZEhhbmRsZXI6IChidWY6IEJ1ZmZlcikgPT4gbnVtYmVyO1xyXG4gIHJlYWRvbmx5IGhlYWRPZmZzZXQ6IG51bWJlcjtcclxuICByZWFkb25seSBwYWNrYWdlT2Zmc2V0OiBudW1iZXI7XHJcbiAgcmVhZG9ubHkgcGFja2FnZVNpemU6IG51bWJlcjtcclxuICByZWFkb25seSBwYWNrYWdlQnVmZmVyOiBCdWZmZXI7XHJcbiAgcmVhZG9ubHkgc3RhdGU6IFN0YXRlO1xyXG4gIGNvbnN0cnVjdG9yKHNvY2tldDogU29ja2V0LCBvcHRzOiBUY3BTb2NrZXRPcHRzKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFNvY2tldCkpIHtcclxuICAgICAgcmV0dXJuIG5ldyBUY3BTb2NrZXQoc29ja2V0LCBvcHRzKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXNvY2tldCB8fCAhb3B0cykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnZhbGlkIHNvY2tldCBvciBvcHRzXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghb3B0cy5oZWFkU2l6ZSB8fCB0eXBlb2Ygb3B0cy5oZWFkSGFuZGxlciAhPT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImludmFsaWQgb3B0cy5oZWFkU2l6ZSBvciBvcHRzLmhlYWRIYW5kbGVyXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHN0cmVhbSBzdHlsZSBpbnRlcmZhY2VzLlxyXG4gICAgLy8gVE9ETzogbmVlZCB0byBwb3J0IHRvIHN0cmVhbTIgYWZ0ZXIgbm9kZSAwLjlcclxuICAgIFN0cmVhbS5jYWxsKHRoaXMpO1xyXG4gICAgdGhpcy5yZWFkYWJsZSA9IHRydWU7XHJcbiAgICB0aGlzLndyaXRlYWJsZSA9IHRydWU7XHJcblxyXG4gICAgdGhpcy5fc29ja2V0ID0gc29ja2V0O1xyXG4gICAgdGhpcy5oZWFkU2l6ZSA9IG9wdHMuaGVhZFNpemU7XHJcbiAgICB0aGlzLmNsb3NlTWV0aG9kID0gb3B0cy5jbG9zZU1ldGhvZDtcclxuICAgIHRoaXMuaGVhZEJ1ZmZlciA9IG5ldyBCdWZmZXIob3B0cy5oZWFkU2l6ZSk7XHJcbiAgICB0aGlzLmhlYWRIYW5kbGVyID0gb3B0cy5oZWFkSGFuZGxlcjtcclxuXHJcbiAgICB0aGlzLmhlYWRPZmZzZXQgPSAwO1xyXG4gICAgdGhpcy5wYWNrYWdlT2Zmc2V0ID0gMDtcclxuICAgIHRoaXMucGFja2FnZVNpemUgPSAwO1xyXG4gICAgdGhpcy5wYWNrYWdlQnVmZmVyID0gPGFueT5udWxsO1xyXG5cclxuICAgIC8vIGJpbmQgZXZlbnQgZm9ybSB0aGUgb3JpZ2luIHNvY2tldFxyXG4gICAgdGhpcy5fc29ja2V0Lm9uKFwiZGF0YVwiLCBvbmRhdGEuYmluZChudWxsLCB0aGlzKSk7XHJcbiAgICB0aGlzLl9zb2NrZXQub24oXCJlbmRcIiwgb25lbmQuYmluZChudWxsLCB0aGlzKSk7XHJcbiAgICB0aGlzLl9zb2NrZXQub24oXCJlcnJvclwiLCB0aGlzLmVtaXQuYmluZCh0aGlzLCBcImVycm9yXCIpKTtcclxuICAgIHRoaXMuX3NvY2tldC5vbihcImNsb3NlXCIsIHRoaXMuZW1pdC5iaW5kKHRoaXMsIFwiY2xvc2VcIikpO1xyXG5cclxuICAgIHRoaXMuc3RhdGUgPSBTdGF0ZS5TVF9IRUFEO1xyXG4gIH1cclxuICBzZW5kKG1zZzogc3RyaW5nLCBlbmNvZGU/OiBzdHJpbmcsIGNiPzogRnVuY3Rpb24pIHtcclxuICAgIHJldHVybiB0aGlzLl9zb2NrZXQud3JpdGUobXNnLCBlbmNvZGUsIGNiKTtcclxuICB9XHJcblxyXG4gIGNsb3NlKCkge1xyXG4gICAgaWYgKCEhdGhpcy5jbG9zZU1ldGhvZCAmJiB0aGlzLmNsb3NlTWV0aG9kID09PSBcImVuZFwiKSB7XHJcbiAgICAgIHRoaXMuX3NvY2tldC5lbmQoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgdGhpcy5fc29ja2V0LmRlc3Ryb3koKTtcclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihcInNvY2tldCBjbG9zZSB3aXRoIGRlc3Ryb3kgZXJyb3I6ICVqXCIsIGUuc3RhY2spO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBvbmRhdGEoc29ja2V0OiBUY3BTb2NrZXQsIGNodW5rOiBzdHJpbmcgfCBCdWZmZXIpIHtcclxuICBpZiAoc29ja2V0LnN0YXRlID09PSBTdGF0ZS5TVF9DTE9TRUQpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihcInNvY2tldCBoYXMgY2xvc2VkXCIpO1xyXG4gIH1cclxuXHJcbiAgaWYgKHR5cGVvZiBjaHVuayAhPT0gXCJzdHJpbmdcIiAmJiAhQnVmZmVyLmlzQnVmZmVyKGNodW5rKSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiaW52YWxpZCBkYXRhXCIpO1xyXG4gIH1cclxuXHJcbiAgaWYgKHR5cGVvZiBjaHVuayA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgY2h1bmsgPSBuZXcgQnVmZmVyKGNodW5rLCBcInV0ZjhcIik7XHJcbiAgfVxyXG5cclxuICBsZXQgb2Zmc2V0ID0gMCxcclxuICAgIGVuZCA9IGNodW5rLmxlbmd0aDtcclxuXHJcbiAgd2hpbGUgKG9mZnNldCA8IGVuZCkge1xyXG4gICAgaWYgKHNvY2tldC5zdGF0ZSA9PT0gU3RhdGUuU1RfSEVBRCkge1xyXG4gICAgICBvZmZzZXQgPSByZWFkSGVhZChzb2NrZXQsIGNodW5rLCBvZmZzZXQpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChzb2NrZXQuc3RhdGUgPT09IFN0YXRlLlNUX0JPRFkpIHtcclxuICAgICAgb2Zmc2V0ID0gcmVhZEJvZHkoc29ja2V0LCBjaHVuaywgb2Zmc2V0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBvbmVuZChzb2NrZXQ6IFRjcFNvY2tldCwgY2h1bms6IGFueSkge1xyXG4gIGlmIChjaHVuaykge1xyXG4gICAgc29ja2V0Ll9zb2NrZXQud3JpdGUoY2h1bmspO1xyXG4gIH1cclxuXHJcbiAgc29ja2V0LnN0YXRlISA9IFN0YXRlLlNUX0NMT1NFRDtcclxuICByZXNldChzb2NrZXQpO1xyXG4gIHNvY2tldC5lbWl0KFwiZW5kXCIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZWFkSGVhZChzb2NrZXQ6IFRjcFNvY2tldCwgZGF0YTogYW55LCBvZmZzZXQ6IG51bWJlcikge1xyXG4gIGxldCBobGVuID0gc29ja2V0LmhlYWRTaXplIC0gc29ja2V0LmhlYWRPZmZzZXQ7XHJcbiAgbGV0IGRsZW4gPSBkYXRhLmxlbmd0aCAtIG9mZnNldDtcclxuICBsZXQgbGVuID0gTWF0aC5taW4oaGxlbiwgZGxlbik7XHJcbiAgbGV0IGRlbmQgPSBvZmZzZXQgKyBsZW47XHJcblxyXG4gIGRhdGEuY29weShzb2NrZXQuaGVhZEJ1ZmZlciwgc29ja2V0LmhlYWRPZmZzZXQsIG9mZnNldCwgZGVuZCk7XHJcbiAgc29ja2V0LmhlYWRPZmZzZXQhICs9IGxlbjtcclxuXHJcbiAgaWYgKHNvY2tldC5oZWFkT2Zmc2V0ID09PSBzb2NrZXQuaGVhZFNpemUpIHtcclxuICAgIC8vIGlmIGhlYWQgc2VnbWVudCBmaW5pc2hlZFxyXG4gICAgbGV0IHNpemUgPSBzb2NrZXQuaGVhZEhhbmRsZXIoc29ja2V0LmhlYWRCdWZmZXIpO1xyXG4gICAgaWYgKHNpemUgPCAwKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImludmFsaWQgYm9keSBzaXplOiBcIiArIHNpemUpO1xyXG4gICAgfVxyXG4gICAgLy8gY2hlY2sgaWYgaGVhZGVyIGNvbnRhaW5zIGEgdmFsaWQgdHlwZVxyXG4gICAgaWYgKGNoZWNrVHlwZURhdGEoc29ja2V0LmhlYWRCdWZmZXJbMF0pKSB7XHJcbiAgICAgIHNvY2tldC5wYWNrYWdlU2l6ZSEgPSBzaXplICsgc29ja2V0LmhlYWRTaXplO1xyXG4gICAgICBzb2NrZXQucGFja2FnZUJ1ZmZlciEgPSBuZXcgQnVmZmVyKHNvY2tldC5wYWNrYWdlU2l6ZSk7XHJcbiAgICAgIHNvY2tldC5oZWFkQnVmZmVyLmNvcHkoc29ja2V0LnBhY2thZ2VCdWZmZXIsIDAsIDAsIHNvY2tldC5oZWFkU2l6ZSk7XHJcbiAgICAgIHNvY2tldC5wYWNrYWdlT2Zmc2V0ISA9IHNvY2tldC5oZWFkU2l6ZTtcclxuICAgICAgc29ja2V0LnN0YXRlISA9IFN0YXRlLlNUX0JPRFk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBkZW5kID0gZGF0YS5sZW5ndGg7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihcclxuICAgICAgICBcImNsb3NlIHRoZSBjb25uZWN0aW9uIHdpdGggaW52YWxpZCBoZWFkIG1lc3NhZ2UsIHRoZSByZW1vdGUgaXAgaXMgJXMgJiYgcG9ydCBpcyAlcyAmJiBtZXNzYWdlIGlzICVqXCIsXHJcbiAgICAgICAgc29ja2V0Ll9zb2NrZXQucmVtb3RlQWRkcmVzcyxcclxuICAgICAgICBzb2NrZXQuX3NvY2tldC5yZW1vdGVQb3J0LFxyXG4gICAgICAgIGRhdGFcclxuICAgICAgKTtcclxuICAgICAgc29ja2V0LmNsb3NlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gZGVuZDtcclxufVxyXG5cclxuZnVuY3Rpb24gcmVhZEJvZHkoc29ja2V0OiBUY3BTb2NrZXQsIGRhdGE6IGFueSwgb2Zmc2V0OiBudW1iZXIpIHtcclxuICBsZXQgYmxlbiA9IHNvY2tldC5wYWNrYWdlU2l6ZSAtIHNvY2tldC5wYWNrYWdlT2Zmc2V0O1xyXG4gIGxldCBkbGVuID0gZGF0YS5sZW5ndGggLSBvZmZzZXQ7XHJcbiAgbGV0IGxlbiA9IE1hdGgubWluKGJsZW4sIGRsZW4pO1xyXG4gIGxldCBkZW5kID0gb2Zmc2V0ICsgbGVuO1xyXG5cclxuICBkYXRhLmNvcHkoc29ja2V0LnBhY2thZ2VCdWZmZXIsIHNvY2tldC5wYWNrYWdlT2Zmc2V0LCBvZmZzZXQsIGRlbmQpO1xyXG5cclxuICBzb2NrZXQucGFja2FnZU9mZnNldCEgKz0gbGVuO1xyXG5cclxuICBpZiAoc29ja2V0LnBhY2thZ2VPZmZzZXQgPT09IHNvY2tldC5wYWNrYWdlU2l6ZSkge1xyXG4gICAgLy8gaWYgYWxsIHRoZSBwYWNrYWdlIGZpbmlzaGVkXHJcbiAgICBsZXQgYnVmZmVyID0gc29ja2V0LnBhY2thZ2VCdWZmZXI7XHJcbiAgICBzb2NrZXQuZW1pdChcIm1lc3NhZ2VcIiwgYnVmZmVyKTtcclxuICAgIHJlc2V0KHNvY2tldCk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gZGVuZDtcclxufVxyXG5cclxuZnVuY3Rpb24gcmVzZXQoc29ja2V0OiBUY3BTb2NrZXQpIHtcclxuICBzb2NrZXQuaGVhZE9mZnNldCEgPSAwO1xyXG4gIHNvY2tldC5wYWNrYWdlT2Zmc2V0ISA9IDA7XHJcbiAgc29ja2V0LnBhY2thZ2VTaXplISA9IDA7XHJcbiAgc29ja2V0LnBhY2thZ2VCdWZmZXIhID0gPGFueT5udWxsO1xyXG4gIHNvY2tldC5zdGF0ZSEgPSBTdGF0ZS5TVF9IRUFEO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjaGVja1R5cGVEYXRhKGRhdGE6IGFueSkge1xyXG4gIHJldHVybiAoXHJcbiAgICBkYXRhID09PSBQYWNrYWdlLlRZUEVfSEFORFNIQUtFIHx8XHJcbiAgICBkYXRhID09PSBQYWNrYWdlLlRZUEVfSEFORFNIQUtFX0FDSyB8fFxyXG4gICAgZGF0YSA9PT0gUGFja2FnZS5UWVBFX0hFQVJUQkVBVCB8fFxyXG4gICAgZGF0YSA9PT0gUGFja2FnZS5UWVBFX0RBVEEgfHxcclxuICAgIGRhdGEgPT09IFBhY2thZ2UuVFlQRV9LSUNLXHJcbiAgKTtcclxufVxyXG5cclxuZXhwb3J0IHsgVGNwU29ja2V0IH07XHJcbiJdfQ==