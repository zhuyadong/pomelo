"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const wsprocessor_1 = require("./wsprocessor");
const tcpprocessor_1 = require("./tcpprocessor");
const events_1 = require("events");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const HTTP_METHODS = ["GET", "POST", "DELETE", "PUT", "HEAD"];
var State;
(function (State) {
    State[State["ST_STARTED"] = 1] = "ST_STARTED";
    State[State["ST_CLOSED"] = 2] = "ST_CLOSED";
})(State || (State = {}));
const DEFAULT_TIMEOUT = 90;
class Switcher extends events_1.EventEmitter {
    constructor(server, opts) {
        super();
        this.server = server;
        this.server = server;
        this.wsprocessor = new wsprocessor_1.default();
        this.tcpprocessor = new tcpprocessor_1.default(opts.closeMethod);
        this.id = 1;
        this.timeout = (opts.timeout || DEFAULT_TIMEOUT) * 1000;
        this.setNoDelay = opts.setNoDelay;
        if (!opts.ssl) {
            this.server.on("connection", this.newSocket.bind(this));
        }
        else {
            this.server.on("secureConnection", this.newSocket.bind(this));
            this.server.on("clientError", (e, tlsSo) => {
                logger.warn("an ssl error occured before handshake established: ", e);
                tlsSo.destroy();
            });
        }
        this.wsprocessor.on("connection", this.emit.bind(this, "connection"));
        this.tcpprocessor.on("connection", this.emit.bind(this, "connection"));
        this.state = State.ST_STARTED;
    }
    newSocket(socket) {
        if (this.state !== State.ST_STARTED) {
            return;
        }
        socket.setTimeout(this.timeout, () => {
            logger.warn("connection is timeout without communication, the remote ip is %s && port is %s", socket.remoteAddress, socket.remotePort);
            socket.destroy();
        });
        socket.once("data", data => {
            // FIXME: handle incomplete HTTP method
            if (isHttp(data)) {
                processHttp(this, this.wsprocessor, socket, data);
            }
            else {
                if (!!this.setNoDelay) {
                    socket.setNoDelay(true);
                }
                processTcp(this, this.tcpprocessor, socket, data);
            }
        });
    }
    close() {
        if (this.state !== State.ST_STARTED) {
            return;
        }
        this.state = State.ST_CLOSED;
        this.wsprocessor.close();
        this.tcpprocessor.close();
    }
}
exports.default = Switcher;
exports.Switcher = Switcher;
function isHttp(data) {
    let head = data.toString("utf8", 0, 4);
    for (let i = 0, l = HTTP_METHODS.length; i < l; i++) {
        if (head.indexOf(HTTP_METHODS[i]) === 0) {
            return true;
        }
    }
    return false;
}
function processHttp(switcher, processor, socket, data) {
    processor.add(socket, data);
}
function processTcp(switcher, processor, socket, data) {
    processor.add(socket, data);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3dpdGNoZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzd2l0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtDQUF3QztBQUN4QyxpREFBMEM7QUFDMUMsbUNBQXNDO0FBRXRDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRXhFLE1BQU0sWUFBWSxHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBRTlELElBQUssS0FHSjtBQUhELFdBQUssS0FBSztJQUNSLDZDQUFjLENBQUE7SUFDZCwyQ0FBYSxDQUFBO0FBQ2YsQ0FBQyxFQUhJLEtBQUssS0FBTCxLQUFLLFFBR1Q7QUFFRCxNQUFNLGVBQWUsR0FBRyxFQUFFLENBQUM7QUFFM0IsY0FBOEIsU0FBUSxxQkFBWTtJQU9oRCxZQUFvQixNQUFjLEVBQUUsSUFBUztRQUMzQyxLQUFLLEVBQUUsQ0FBQztRQURVLFdBQU0sR0FBTixNQUFNLENBQVE7UUFHaEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLHFCQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksc0JBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDWixJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDeEQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBRWxDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDZCxJQUFJLENB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QUV2QyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3BELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVELHFCQUNFLFFBQWtCLEVBQ2xCLFNBQXNCLEVBQ3RCLE1BQWMsRUFDZCxJQUFTO0lBRVQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDOUIsQ0FBQztBQUVELG9CQUNFLFFBQWtCLEVBQ2xCLFNBQXVCLEVBQ3ZCLE1BQWMsRUFDZCxJQUFTO0lBRVQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDOUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XHJcbmltcG9ydCBXU1Byb2Nlc3NvciBmcm9tIFwiLi93c3Byb2Nlc3NvclwiO1xyXG5pbXBvcnQgVENQUHJvY2Vzc29yIGZyb20gXCIuL3RjcHByb2Nlc3NvclwiO1xyXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XHJcbmltcG9ydCB7IFNlcnZlciwgU29ja2V0IH0gZnJvbSBcIm5ldFwiO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XHJcblxyXG5jb25zdCBIVFRQX01FVEhPRFMgPSBbXCJHRVRcIiwgXCJQT1NUXCIsIFwiREVMRVRFXCIsIFwiUFVUXCIsIFwiSEVBRFwiXTtcclxuXHJcbmVudW0gU3RhdGUge1xyXG4gIFNUX1NUQVJURUQgPSAxLFxyXG4gIFNUX0NMT1NFRCA9IDJcclxufVxyXG5cclxuY29uc3QgREVGQVVMVF9USU1FT1VUID0gOTA7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTd2l0Y2hlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgcHJpdmF0ZSB3c3Byb2Nlc3NvcjogV1NQcm9jZXNzb3I7XHJcbiAgcHJpdmF0ZSB0Y3Bwcm9jZXNzb3I6IFRDUFByb2Nlc3NvcjtcclxuICBwcml2YXRlIGlkOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSB0aW1lb3V0OiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBzZXROb0RlbGF5OiBib29sZWFuO1xyXG4gIHByaXZhdGUgc3RhdGU6IFN0YXRlO1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc2VydmVyOiBTZXJ2ZXIsIG9wdHM6IGFueSkge1xyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICB0aGlzLnNlcnZlciA9IHNlcnZlcjtcclxuICAgIHRoaXMud3Nwcm9jZXNzb3IgPSBuZXcgV1NQcm9jZXNzb3IoKTtcclxuICAgIHRoaXMudGNwcHJvY2Vzc29yID0gbmV3IFRDUFByb2Nlc3NvcihvcHRzLmNsb3NlTWV0aG9kKTtcclxuICAgIHRoaXMuaWQgPSAxO1xyXG4gICAgdGhpcy50aW1lb3V0ID0gKG9wdHMudGltZW91dCB8fCBERUZBVUxUX1RJTUVPVVQpICogMTAwMDtcclxuICAgIHRoaXMuc2V0Tm9EZWxheSA9IG9wdHMuc2V0Tm9EZWxheTtcclxuXHJcbiAgICBpZiAoIW9wdHMuc3NsKSB7XHJcbiAgICAgIHRoaXMuc2VydmVyLm9uKFwiY29ubmVjdGlvblwiLCB0aGlzLm5ld1NvY2tldC5iaW5kKHRoaXMpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuc2VydmVyLm9uKFwic2VjdXJlQ29ubmVjdGlvblwiLCB0aGlzLm5ld1NvY2tldC5iaW5kKHRoaXMpKTtcclxuICAgICAgdGhpcy5zZXJ2ZXIub24oXCJjbGllbnRFcnJvclwiLCAoZSwgdGxzU28pID0+IHtcclxuICAgICAgICBsb2dnZXIud2FybihcImFuIHNzbCBlcnJvciBvY2N1cmVkIGJlZm9yZSBoYW5kc2hha2UgZXN0YWJsaXNoZWQ6IFwiLCBlKTtcclxuICAgICAgICB0bHNTby5kZXN0cm95KCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMud3Nwcm9jZXNzb3Iub24oXCJjb25uZWN0aW9uXCIsIHRoaXMuZW1pdC5iaW5kKHRoaXMsIFwiY29ubmVjdGlvblwiKSk7XHJcbiAgICB0aGlzLnRjcHByb2Nlc3Nvci5vbihcImNvbm5lY3Rpb25cIiwgdGhpcy5lbWl0LmJpbmQodGhpcywgXCJjb25uZWN0aW9uXCIpKTtcclxuXHJcbiAgICB0aGlzLnN0YXRlID0gU3RhdGUuU1RfU1RBUlRFRDtcclxuICB9XHJcbiAgbmV3U29ja2V0KHNvY2tldDogU29ja2V0KSB7XHJcbiAgICBpZiAodGhpcy5zdGF0ZSAhPT0gU3RhdGUuU1RfU1RBUlRFRCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgc29ja2V0LnNldFRpbWVvdXQodGhpcy50aW1lb3V0LCAoKSA9PiB7XHJcbiAgICAgIGxvZ2dlci53YXJuKFxyXG4gICAgICAgIFwiY29ubmVjdGlvbiBpcyB0aW1lb3V0IHdpdGhvdXQgY29tbXVuaWNhdGlvbiwgdGhlIHJlbW90ZSBpcCBpcyAlcyAmJiBwb3J0IGlzICVzXCIsXHJcbiAgICAgICAgc29ja2V0LnJlbW90ZUFkZHJlc3MsXHJcbiAgICAgICAgc29ja2V0LnJlbW90ZVBvcnRcclxuICAgICAgKTtcclxuICAgICAgc29ja2V0LmRlc3Ryb3koKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHNvY2tldC5vbmNlKFwiZGF0YVwiLCBkYXRhID0+IHtcclxuICAgICAgLy8gRklYTUU6IGhhbmRsZSBpbmNvbXBsZXRlIEhUVFAgbWV0aG9kXHJcbiAgICAgIGlmIChpc0h0dHAoZGF0YSkpIHtcclxuICAgICAgICBwcm9jZXNzSHR0cCh0aGlzLCB0aGlzLndzcHJvY2Vzc29yLCBzb2NrZXQsIGRhdGEpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlmICghIXRoaXMuc2V0Tm9EZWxheSkge1xyXG4gICAgICAgICAgc29ja2V0LnNldE5vRGVsYXkodHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHByb2Nlc3NUY3AodGhpcywgdGhpcy50Y3Bwcm9jZXNzb3IsIHNvY2tldCwgZGF0YSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgY2xvc2UoKSB7XHJcbiAgICBpZiAodGhpcy5zdGF0ZSAhPT0gU3RhdGUuU1RfU1RBUlRFRCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zdGF0ZSA9IFN0YXRlLlNUX0NMT1NFRDtcclxuICAgIHRoaXMud3Nwcm9jZXNzb3IuY2xvc2UoKTtcclxuICAgIHRoaXMudGNwcHJvY2Vzc29yLmNsb3NlKCk7XHJcbiAgfVxyXG59XHJcbmZ1bmN0aW9uIGlzSHR0cChkYXRhOiBhbnkpIHtcclxuICBsZXQgaGVhZCA9IGRhdGEudG9TdHJpbmcoXCJ1dGY4XCIsIDAsIDQpO1xyXG5cclxuICBmb3IgKGxldCBpID0gMCwgbCA9IEhUVFBfTUVUSE9EUy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgIGlmIChoZWFkLmluZGV4T2YoSFRUUF9NRVRIT0RTW2ldKSA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuZnVuY3Rpb24gcHJvY2Vzc0h0dHAoXHJcbiAgc3dpdGNoZXI6IFN3aXRjaGVyLFxyXG4gIHByb2Nlc3NvcjogV1NQcm9jZXNzb3IsXHJcbiAgc29ja2V0OiBTb2NrZXQsXHJcbiAgZGF0YTogYW55XHJcbikge1xyXG4gIHByb2Nlc3Nvci5hZGQoc29ja2V0LCBkYXRhKTtcclxufVxyXG5cclxuZnVuY3Rpb24gcHJvY2Vzc1RjcChcclxuICBzd2l0Y2hlcjogU3dpdGNoZXIsXHJcbiAgcHJvY2Vzc29yOiBUQ1BQcm9jZXNzb3IsXHJcbiAgc29ja2V0OiBTb2NrZXQsXHJcbiAgZGF0YTogYW55XHJcbikge1xyXG4gIHByb2Nlc3Nvci5hZGQoc29ja2V0LCBkYXRhKTtcclxufVxyXG5cclxuZXhwb3J0IHsgU3dpdGNoZXIgfTtcclxuIl19