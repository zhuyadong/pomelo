"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const wsprocessor_1 = require("./wsprocessor");
const tcpprocessor_1 = require("./tcpprocessor");
const events_1 = require("events");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const HTTP_METHODS = ["GET", "POST", "DELETE", "PUT", "HEAD"];
var State;
(function (State) {
    State[State["ST_STARTED"] = 1] = "ST_STARTED";
    State[State["ST_CLOSED"] = 2] = "ST_CLOSED";
})(State || (State = {}));
const DEFAULT_TIMEOUT = 90;
class Switcher extends events_1.EventEmitter {
    constructor(server, opts) {
        super();
        this.server = server;
        this.server = server;
        this.wsprocessor = new wsprocessor_1.default();
        this.tcpprocessor = new tcpprocessor_1.default(opts.closeMethod);
        this.id = 1;
        this.timeout = (opts.timeout || DEFAULT_TIMEOUT) * 1000;
        this.setNoDelay = opts.setNoDelay;
        if (!opts.ssl) {
            this.server.on("connection", this.newSocket.bind(this));
        }
        else {
            this.server.on("secureConnection", this.newSocket.bind(this));
            this.server.on("clientError", (e, tlsSo) => {
                logger.warn("an ssl error occured before handshake established: ", e);
                tlsSo.destroy();
            });
        }
        this.wsprocessor.on("connection", this.emit.bind(this, "connection"));
        this.tcpprocessor.on("connection", this.emit.bind(this, "connection"));
        this.state = State.ST_STARTED;
    }
    newSocket(socket) {
        if (this.state !== State.ST_STARTED) {
            return;
        }
        socket.setTimeout(this.timeout, () => {
            logger.warn("connection is timeout without communication, the remote ip is %s && port is %s", socket.remoteAddress, socket.remotePort);
            socket.destroy();
        });
        socket.once("data", data => {
            // FIXME: handle incomplete HTTP method
            if (isHttp(data)) {
                processHttp(this, this.wsprocessor, socket, data);
            }
            else {
                if (!!this.setNoDelay) {
                    socket.setNoDelay(true);
                }
                processTcp(this, this.tcpprocessor, socket, data);
            }
        });
    }
    close() {
        if (this.state !== State.ST_STARTED) {
            return;
        }
        this.state = State.ST_CLOSED;
        this.wsprocessor.close();
        this.tcpprocessor.close();
    }
}
exports.default = Switcher;
exports.Switcher = Switcher;
function isHttp(data) {
    let head = data.toString("utf8", 0, 4);
    for (let i = 0, l = HTTP_METHODS.length; i < l; i++) {
        if (head.indexOf(HTTP_METHODS[i]) === 0) {
            return true;
        }
    }
    return false;
}
function processHttp(switcher, processor, socket, data) {
    processor.add(socket, data);
}
function processTcp(switcher, processor, socket, data) {
    processor.add(socket, data);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3dpdGNoZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzd2l0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtDQUF3QztBQUN4QyxpREFBMEM7QUFDMUMsbUNBQXNDO0FBRXRDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRXhFLE1BQU0sWUFBWSxHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBRTlELElBQUssS0FHSjtBQUhELFdBQUssS0FBSztJQUNSLDZDQUFjLENBQUE7SUFDZCwyQ0FBYSxDQUFBO0FBQ2YsQ0FBQyxFQUhJLEtBQUssS0FBTCxLQUFLLFFBR1Q7QUFFRCxNQUFNLGVBQWUsR0FBRyxFQUFFLENBQUM7QUFFM0IsY0FBOEIsU0FBUSxxQkFBWTtJQU9oRCxZQUFvQixNQUFjLEVBQUUsSUFBUztRQUMzQyxLQUFLLEVBQUUsQ0FBQztRQURVLFdBQU0sR0FBTixNQUFNLENBQVE7UUFHaEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLHFCQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksc0JBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDWixJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDeEQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBRWxDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDZCxJQUFJLENB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QUV2QyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3BELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVELHFCQUNFLFFBQWtCLEVBQ2xCLFNBQXNCLEVBQ3RCLE1BQWMsRUFDZCxJQUFTO0lBRVQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDOUIsQ0FBQztBQUVELG9CQUNFLFFBQWtCLEVBQ2xCLFNBQXVCLEVBQ3ZCLE1BQWMsRUFDZCxJQUFTO0lBRVQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDOUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5pbXBvcnQgV1NQcm9jZXNzb3IgZnJvbSBcIi4vd3Nwcm9jZXNzb3JcIjtcbmltcG9ydCBUQ1BQcm9jZXNzb3IgZnJvbSBcIi4vdGNwcHJvY2Vzc29yXCI7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQgeyBTZXJ2ZXIsIFNvY2tldCB9IGZyb20gXCJuZXRcIjtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcblxuY29uc3QgSFRUUF9NRVRIT0RTID0gW1wiR0VUXCIsIFwiUE9TVFwiLCBcIkRFTEVURVwiLCBcIlBVVFwiLCBcIkhFQURcIl07XG5cbmVudW0gU3RhdGUge1xuICBTVF9TVEFSVEVEID0gMSxcbiAgU1RfQ0xPU0VEID0gMlxufVxuXG5jb25zdCBERUZBVUxUX1RJTUVPVVQgPSA5MDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3dpdGNoZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBwcml2YXRlIHdzcHJvY2Vzc29yOiBXU1Byb2Nlc3NvcjtcbiAgcHJpdmF0ZSB0Y3Bwcm9jZXNzb3I6IFRDUFByb2Nlc3NvcjtcbiAgcHJpdmF0ZSBpZDogbnVtYmVyO1xuICBwcml2YXRlIHRpbWVvdXQ6IG51bWJlcjtcbiAgcHJpdmF0ZSBzZXROb0RlbGF5OiBib29sZWFuO1xuICBwcml2YXRlIHN0YXRlOiBTdGF0ZTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzZXJ2ZXI6IFNlcnZlciwgb3B0czogYW55KSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuc2VydmVyID0gc2VydmVyO1xuICAgIHRoaXMud3Nwcm9jZXNzb3IgPSBuZXcgV1NQcm9jZXNzb3IoKTtcbiAgICB0aGlzLnRjcHByb2Nlc3NvciA9IG5ldyBUQ1BQcm9jZXNzb3Iob3B0cy5jbG9zZU1ldGhvZCk7XG4gICAgdGhpcy5pZCA9IDE7XG4gICAgdGhpcy50aW1lb3V0ID0gKG9wdHMudGltZW91dCB8fCBERUZBVUxUX1RJTUVPVVQpICogMTAwMDtcbiAgICB0aGlzLnNldE5vRGVsYXkgPSBvcHRzLnNldE5vRGVsYXk7XG5cbiAgICBpZiAoIW9wdHMuc3NsKSB7XG4gICAgICB0aGlzLnNlcnZlci5vbihcImNvbm5lY3Rpb25cIiwgdGhpcy5uZXdTb2NrZXQuYmluZCh0aGlzKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2VydmVyLm9uKFwic2VjdXJlQ29ubmVjdGlvblwiLCB0aGlzLm5ld1NvY2tldC5iaW5kKHRoaXMpKTtcbiAgICAgIHRoaXMuc2VydmVyLm9uKFwiY2xpZW50RXJyb3JcIiwgKGUsIHRsc1NvKSA9PiB7XG4gICAgICAgIGxvZ2dlci53YXJuKFwiYW4gc3NsIGVycm9yIG9jY3VyZWQgYmVmb3JlIGhhbmRzaGFrZSBlc3RhYmxpc2hlZDogXCIsIGUpO1xuICAgICAgICB0bHNTby5kZXN0cm95KCk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLndzcHJvY2Vzc29yLm9uKFwiY29ubmVjdGlvblwiLCB0aGlzLmVtaXQuYmluZCh0aGlzLCBcImNvbm5lY3Rpb25cIikpO1xuICAgIHRoaXMudGNwcHJvY2Vzc29yLm9uKFwiY29ubmVjdGlvblwiLCB0aGlzLmVtaXQuYmluZCh0aGlzLCBcImNvbm5lY3Rpb25cIikpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IFN0YXRlLlNUX1NUQVJURUQ7XG4gIH1cbiAgbmV3U29ja2V0KHNvY2tldDogU29ja2V0KSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IFN0YXRlLlNUX1NUQVJURUQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBzb2NrZXQuc2V0VGltZW91dCh0aGlzLnRpbWVvdXQsICgpID0+IHtcbiAgICAgIGxvZ2dlci53YXJuKFxuICAgICAgICBcImNvbm5lY3Rpb24gaXMgdGltZW91dCB3aXRob3V0IGNvbW11bmljYXRpb24sIHRoZSByZW1vdGUgaXAgaXMgJXMgJiYgcG9ydCBpcyAlc1wiLFxuICAgICAgICBzb2NrZXQucmVtb3RlQWRkcmVzcyxcbiAgICAgICAgc29ja2V0LnJlbW90ZVBvcnRcbiAgICAgICk7XG4gICAgICBzb2NrZXQuZGVzdHJveSgpO1xuICAgIH0pO1xuXG4gICAgc29ja2V0Lm9uY2UoXCJkYXRhXCIsIGRhdGEgPT4ge1xuICAgICAgLy8gRklYTUU6IGhhbmRsZSBpbmNvbXBsZXRlIEhUVFAgbWV0aG9kXG4gICAgICBpZiAoaXNIdHRwKGRhdGEpKSB7XG4gICAgICAgIHByb2Nlc3NIdHRwKHRoaXMsIHRoaXMud3Nwcm9jZXNzb3IsIHNvY2tldCwgZGF0YSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoISF0aGlzLnNldE5vRGVsYXkpIHtcbiAgICAgICAgICBzb2NrZXQuc2V0Tm9EZWxheSh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICBwcm9jZXNzVGNwKHRoaXMsIHRoaXMudGNwcHJvY2Vzc29yLCBzb2NrZXQsIGRhdGEpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgY2xvc2UoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IFN0YXRlLlNUX1NUQVJURUQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnN0YXRlID0gU3RhdGUuU1RfQ0xPU0VEO1xuICAgIHRoaXMud3Nwcm9jZXNzb3IuY2xvc2UoKTtcbiAgICB0aGlzLnRjcHByb2Nlc3Nvci5jbG9zZSgpO1xuICB9XG59XG5mdW5jdGlvbiBpc0h0dHAoZGF0YTogYW55KSB7XG4gIGxldCBoZWFkID0gZGF0YS50b1N0cmluZyhcInV0ZjhcIiwgMCwgNCk7XG5cbiAgZm9yIChsZXQgaSA9IDAsIGwgPSBIVFRQX01FVEhPRFMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgaWYgKGhlYWQuaW5kZXhPZihIVFRQX01FVEhPRFNbaV0pID09PSAwKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3NIdHRwKFxuICBzd2l0Y2hlcjogU3dpdGNoZXIsXG4gIHByb2Nlc3NvcjogV1NQcm9jZXNzb3IsXG4gIHNvY2tldDogU29ja2V0LFxuICBkYXRhOiBhbnlcbikge1xuICBwcm9jZXNzb3IuYWRkKHNvY2tldCwgZGF0YSk7XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3NUY3AoXG4gIHN3aXRjaGVyOiBTd2l0Y2hlcixcbiAgcHJvY2Vzc29yOiBUQ1BQcm9jZXNzb3IsXG4gIHNvY2tldDogU29ja2V0LFxuICBkYXRhOiBhbnlcbikge1xuICBwcm9jZXNzb3IuYWRkKHNvY2tldCwgZGF0YSk7XG59XG5cbmV4cG9ydCB7IFN3aXRjaGVyIH07XG4iXX0=