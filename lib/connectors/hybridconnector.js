"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const net = require("net");
const tls = require("tls");
const hybridsocket_1 = require("./hybridsocket");
const switcher_1 = require("./hybrid/switcher");
const events_1 = require("events");
const Handshake = require("./commands/handshake");
const Heartbeat = require("./commands/heartbeat");
const Kick = require("./commands/kick");
const coder = require("./common/coder");
let curId = 1;
class HybridConnector extends events_1.EventEmitter {
    constructor(port, host, opts) {
        super();
        this.port = port;
        this.host = host;
        this.opts = opts;
        this.encode = coder.encode;
        this.decode = coder.decode;
        if (!(this instanceof HybridConnector)) {
            return new HybridConnector(port, host, opts);
        }
        this.opts = opts || {};
        this.port = port;
        this.host = host;
        this.useDict = opts.useDict;
        this.useProtobuf = opts.useProtobuf;
        this.handshake = new Handshake(opts);
        this.heartbeat = new Heartbeat(opts);
        this.distinctHost = opts.distinctHost;
        this.ssl = opts.ssl;
        this.switcher = null;
    }
    start(cb) {
        let pomelo = require("../pomelo");
        let app = pomelo.default.app;
        //let app = require("../pomelo").default.app as Application;
        let gensocket = (socket) => {
            let hybridsocket = new hybridsocket_1.default(curId++, socket);
            hybridsocket.on("handshake", this.handshake.handle.bind(this.handshake, hybridsocket));
            hybridsocket.on("heartbeat", this.heartbeat.handle.bind(this.heartbeat, hybridsocket));
            hybridsocket.on("disconnect", this.heartbeat.clear.bind(this.heartbeat, hybridsocket.id));
            hybridsocket.on("closing", Kick.handle.bind(null, hybridsocket));
            this.emit("connection", hybridsocket);
        };
        this.connector = app.components.__connector__.connector;
        this.dictionary = app.components.__dictionary__;
        this.protobuf = app.components.__protobuf__;
        this.decodeIO_protobuf = app.components.__decodeIO__protobuf__;
        if (!this.ssl) {
            this.listeningServer = net.createServer();
        }
        else {
            this.listeningServer = tls.createServer(this.ssl);
        }
        this.switcher = new switcher_1.default(this.listeningServer, this.opts);
        this.switcher.on("connection", (socket) => {
            gensocket(socket);
        });
        if (!!this.distinctHost) {
            this.listeningServer.listen(this.port, this.host);
        }
        else {
            this.listeningServer.listen(this.port);
        }
        process.nextTick(cb);
    }
    stop(force, cb) {
        this.switcher.close();
        this.listeningServer.close();
        process.nextTick(cb);
    }
}
HybridConnector.encode = coder.encode;
HybridConnector.decode = coder.decode;
exports.default = HybridConnector;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHlicmlkY29ubmVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaHlicmlkY29ubmVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkJBQTRCO0FBQzVCLDJCQUE0QjtBQUU1QixpREFBMEM7QUFDMUMsZ0RBQXlDO0FBQ3pDLG1DQUFzQztBQVF0QyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNsRCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNsRCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUN4QyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUV4QyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFFZCxxQkFBcUMsU0FBUSxxQkFBWTtJQWlCdkQsWUFBb0IsSUFBWSxFQUFVLElBQVksRUFBVSxJQUFVO1FBQ3hFLEtBQUssRUFBRSxDQUFDO1FBRFUsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFVLFNBQUksR0FBSixJQUFJLENBQVE7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFNO1FBZDFFLFdBQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ3RCLFdBQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBZXBCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFlBQVksZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxJQUFJLGVBQWUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQy9DLENBQUM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFB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QUMsQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QyxDQUFDO1FBRUQsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQsSUFBSSxDQUFDLEtBQWMsRUFBRSxFQUFZO1FBQy9CLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUU3QixPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7O0FBdkZNLHNCQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztBQUN0QixzQkFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7QUFGL0Isa0NBeUZDO0FBQUEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXQgPSByZXF1aXJlKFwibmV0XCIpO1xyXG5pbXBvcnQgdGxzID0gcmVxdWlyZShcInRsc1wiKTtcclxuaW1wb3J0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxuaW1wb3J0IEh5YnJpZFNvY2tldCBmcm9tIFwiLi9oeWJyaWRzb2NrZXRcIjtcclxuaW1wb3J0IFN3aXRjaGVyIGZyb20gXCIuL2h5YnJpZC9zd2l0Y2hlclwiO1xyXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XHJcbmltcG9ydCB7XHJcbiAgQ29ubmVjdG9yLFxyXG4gIERpY3Rpb25hcnlDb21wb25lbnQsXHJcbiAgUHJvdG9idWZDb21wb25lbnQsXHJcbiAgQXBwbGljYXRpb25cclxufSBmcm9tIFwiLi4vaW5kZXhcIjtcclxuXHJcbmNvbnN0IEhhbmRzaGFrZSA9IHJlcXVpcmUoXCIuL2NvbW1hbmRzL2hhbmRzaGFrZVwiKTtcclxuY29uc3QgSGVhcnRiZWF0ID0gcmVxdWlyZShcIi4vY29tbWFuZHMvaGVhcnRiZWF0XCIpO1xyXG5jb25zdCBLaWNrID0gcmVxdWlyZShcIi4vY29tbWFuZHMva2lja1wiKTtcclxuY29uc3QgY29kZXIgPSByZXF1aXJlKFwiLi9jb21tb24vY29kZXJcIik7XHJcblxyXG5sZXQgY3VySWQgPSAxO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSHlicmlkQ29ubmVjdG9yIGV4dGVuZHMgRXZlbnRFbWl0dGVyIGltcGxlbWVudHMgQ29ubmVjdG9yIHtcclxuICBzdGF0aWMgZW5jb2RlID0gY29kZXIuZW5jb2RlO1xyXG4gIHN0YXRpYyBkZWNvZGUgPSBjb2Rlci5kZWNvZGU7XHJcbiAgZW5jb2RlID0gY29kZXIuZW5jb2RlO1xyXG4gIGRlY29kZSA9IGNvZGVyLmRlY29kZTtcclxuICBwcml2YXRlIHVzZURpY3Q6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSB1c2VQcm90b2J1ZjogYm9vbGVhbjtcclxuICBwcml2YXRlIGhhbmRzaGFrZTogYW55OyAvL1RPRE9cclxuICBwcml2YXRlIGhlYXJ0YmVhdDogYW55OyAvL1RPRE9cclxuICBwcml2YXRlIGRpc3RpbmN0SG9zdDogYm9vbGVhbjtcclxuICBwcml2YXRlIHNzbDogYW55OyAvL1RPRE9cclxuICBwcml2YXRlIHN3aXRjaGVyOiBhbnk7IC8vVE9ET1xyXG4gIHByaXZhdGUgY29ubmVjdG9yOiBDb25uZWN0b3I7XHJcbiAgcHJpdmF0ZSBkaWN0aW9uYXJ5OiBEaWN0aW9uYXJ5Q29tcG9uZW50O1xyXG4gIHByaXZhdGUgcHJvdG9idWY6IFByb3RvYnVmQ29tcG9uZW50O1xyXG4gIHByaXZhdGUgZGVjb2RlSU9fcHJvdG9idWY6IGFueTsgLy9UT0RPXHJcbiAgcHJpdmF0ZSBsaXN0ZW5pbmdTZXJ2ZXI6IG5ldC5TZXJ2ZXI7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwb3J0OiBudW1iZXIsIHByaXZhdGUgaG9zdDogc3RyaW5nLCBwcml2YXRlIG9wdHM/OiBhbnkpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgSHlicmlkQ29ubmVjdG9yKSkge1xyXG4gICAgICByZXR1cm4gbmV3IEh5YnJpZENvbm5lY3Rvcihwb3J0LCBob3N0LCBvcHRzKTtcclxuICAgIH1cclxuICAgIHRoaXMub3B0cyA9IG9wdHMgfHwge307XHJcbiAgICB0aGlzLnBvcnQgPSBwb3J0O1xyXG4gICAgdGhpcy5ob3N0ID0gaG9zdDtcclxuICAgIHRoaXMudXNlRGljdCA9IG9wdHMudXNlRGljdDtcclxuICAgIHRoaXMudXNlUHJvdG9idWYgPSBvcHRzLnVzZVByb3RvYnVmO1xyXG4gICAgdGhpcy5oYW5kc2hha2UgPSBuZXcgSGFuZHNoYWtlKG9wdHMpO1xyXG4gICAgdGhpcy5oZWFydGJlYXQgPSBuZXcgSGVhcnRiZWF0KG9wdHMpO1xyXG4gICAgdGhpcy5kaXN0aW5jdEhvc3QgPSBvcHRzLmRpc3RpbmN0SG9zdDtcclxuICAgIHRoaXMuc3NsID0gb3B0cy5zc2w7XHJcblxyXG4gICAgdGhpcy5zd2l0Y2hlciA9IG51bGw7XHJcbiAgfVxyXG5cclxuICBzdGFydChjYjogRnVuY3Rpb24pIHtcclxuICAgIGxldCBwb21lbG8gPSByZXF1aXJlKFwiLi4vcG9tZWxvXCIpO1xyXG4gICAgbGV0IGFwcCA9IHBvbWVsby5kZWZhdWx0LmFwcCBhcyBBcHBsaWNhdGlvbjtcclxuICAgIC8vbGV0IGFwcCA9IHJlcXVpcmUoXCIuLi9wb21lbG9cIikuZGVmYXVsdC5hcHAgYXMgQXBwbGljYXRpb247XHJcblxyXG4gICAgbGV0IGdlbnNvY2tldCA9IChzb2NrZXQ6IGFueSkgPT4ge1xyXG4gICAgICBsZXQgaHlicmlkc29ja2V0ID0gbmV3IEh5YnJpZFNvY2tldChjdXJJZCsrLCBzb2NrZXQpO1xyXG4gICAgICBoeWJyaWRzb2NrZXQub24oXHJcbiAgICAgICAgXCJoYW5kc2hha2VcIixcclxuICAgICAgICB0aGlzLmhhbmRzaGFrZS5oYW5kbGUuYmluZCh0aGlzLmhhbmRzaGFrZSwgaHlicmlkc29ja2V0KVxyXG4gICAgICApO1xyXG4gICAgICBoeWJyaWRzb2NrZXQub24oXHJcbiAgICAgICAgXCJoZWFydGJlYXRcIixcclxuICAgICAgICB0aGlzLmhlYXJ0YmVhdC5oYW5kbGUuYmluZCh0aGlzLmhlYXJ0YmVhdCwgaHlicmlkc29ja2V0KVxyXG4gICAgICApO1xyXG4gICAgICBoeWJyaWRzb2NrZXQub24oXHJcbiAgICAgICAgXCJkaXNjb25uZWN0XCIsXHJcbiAgICAgICAgdGhpcy5oZWFydGJlYXQuY2xlYXIuYmluZCh0aGlzLmhlYXJ0YmVhdCwgaHlicmlkc29ja2V0LmlkKVxyXG4gICAgICApO1xyXG4gICAgICBoeWJyaWRzb2NrZXQub24oXCJjbG9zaW5nXCIsIEtpY2suaGFuZGxlLmJpbmQobnVsbCwgaHlicmlkc29ja2V0KSk7XHJcbiAgICAgIHRoaXMuZW1pdChcImNvbm5lY3Rpb25cIiwgaHlicmlkc29ja2V0KTtcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5jb25uZWN0b3IgPSBhcHAuY29tcG9uZW50cy5fX2Nvbm5lY3Rvcl9fLmNvbm5lY3RvcjtcclxuICAgIHRoaXMuZGljdGlvbmFyeSA9IGFwcC5jb21wb25lbnRzLl9fZGljdGlvbmFyeV9fO1xyXG4gICAgdGhpcy5wcm90b2J1ZiA9IGFwcC5jb21wb25lbnRzLl9fcHJvdG9idWZfXztcclxuICAgIHRoaXMuZGVjb2RlSU9fcHJvdG9idWYgPSBhcHAuY29tcG9uZW50cy5fX2RlY29kZUlPX19wcm90b2J1Zl9fO1xyXG5cclxuICAgIGlmICghdGhpcy5zc2wpIHtcclxuICAgICAgdGhpcy5saXN0ZW5pbmdTZXJ2ZXIgPSBuZXQuY3JlYXRlU2VydmVyKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmxpc3RlbmluZ1NlcnZlciA9IHRscy5jcmVhdGVTZXJ2ZXIodGhpcy5zc2wpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zd2l0Y2hlciA9IG5ldyBTd2l0Y2hlcih0aGlzLmxpc3RlbmluZ1NlcnZlciwgdGhpcy5vcHRzKTtcclxuXHJcbiAgICB0aGlzLnN3aXRjaGVyLm9uKFwiY29ubmVjdGlvblwiLCAoc29ja2V0OiBhbnkpID0+IHtcclxuICAgICAgZ2Vuc29ja2V0KHNvY2tldCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoISF0aGlzLmRpc3RpbmN0SG9zdCkge1xyXG4gICAgICB0aGlzLmxpc3RlbmluZ1NlcnZlci5saXN0ZW4odGhpcy5wb3J0LCB0aGlzLmhvc3QpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5saXN0ZW5pbmdTZXJ2ZXIubGlzdGVuKHRoaXMucG9ydCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvY2Vzcy5uZXh0VGljayhjYik7XHJcbiAgfVxyXG5cclxuICBzdG9wKGZvcmNlOiBib29sZWFuLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuc3dpdGNoZXIuY2xvc2UoKTtcclxuICAgIHRoaXMubGlzdGVuaW5nU2VydmVyLmNsb3NlKCk7XHJcblxyXG4gICAgcHJvY2Vzcy5uZXh0VGljayhjYik7XHJcbiAgfVxyXG59O1xyXG4iXX0=