"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const net = require("net");
const tls = require("tls");
const hybridsocket_1 = require("./hybridsocket");
const switcher_1 = require("./hybrid/switcher");
const events_1 = require("events");
const Handshake = require("./commands/handshake");
const Heartbeat = require("./commands/heartbeat");
const Kick = require("./commands/kick");
const coder = require("./common/coder");
let curId = 1;
class HybridConnector extends events_1.EventEmitter {
    constructor(port, host, opts) {
        super();
        this.port = port;
        this.host = host;
        this.opts = opts;
        this.encode = coder.encode;
        this.decode = coder.decode;
        if (!(this instanceof HybridConnector)) {
            return new HybridConnector(port, host, opts);
        }
        this.opts = opts || {};
        this.port = port;
        this.host = host;
        this.useDict = opts.useDict;
        this.useProtobuf = opts.useProtobuf;
        this.handshake = new Handshake(opts);
        this.heartbeat = new Heartbeat(opts);
        this.distinctHost = opts.distinctHost;
        this.ssl = opts.ssl;
        this.switcher = null;
    }
    start(cb) {
        let pomelo = require("../pomelo");
        let app = pomelo.default.app;
        //let app = require("../pomelo").default.app as Application;
        let gensocket = (socket) => {
            let hybridsocket = new hybridsocket_1.default(curId++, socket);
            hybridsocket.on("handshake", this.handshake.handle.bind(this.handshake, hybridsocket));
            hybridsocket.on("heartbeat", this.heartbeat.handle.bind(this.heartbeat, hybridsocket));
            hybridsocket.on("disconnect", this.heartbeat.clear.bind(this.heartbeat, hybridsocket.id));
            hybridsocket.on("closing", Kick.handle.bind(null, hybridsocket));
            this.emit("connection", hybridsocket);
        };
        this.connector = app.components.__connector__.connector;
        this.dictionary = app.components.__dictionary__;
        this.protobuf = app.components.__protobuf__;
        this.decodeIO_protobuf = app.components.__decodeIO__protobuf__;
        if (!this.ssl) {
            this.listeningServer = net.createServer();
        }
        else {
            this.listeningServer = tls.createServer(this.ssl);
        }
        this.switcher = new switcher_1.default(this.listeningServer, this.opts);
        this.switcher.on("connection", (socket) => {
            gensocket(socket);
        });
        if (!!this.distinctHost) {
            this.listeningServer.listen(this.port, this.host);
        }
        else {
            this.listeningServer.listen(this.port);
        }
        process.nextTick(cb);
    }
    stop(force, cb) {
        this.switcher.close();
        this.listeningServer.close();
        process.nextTick(cb);
    }
}
HybridConnector.encode = coder.encode;
HybridConnector.decode = coder.decode;
exports.default = HybridConnector;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHlicmlkY29ubmVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaHlicmlkY29ubmVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkJBQTRCO0FBQzVCLDJCQUE0QjtBQUU1QixpREFBMEM7QUFDMUMsZ0RBQXlDO0FBQ3pDLG1DQUFzQztBQVF0QyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNsRCxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNsRCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUN4QyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUV4QyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFFZCxxQkFBcUMsU0FBUSxxQkFBWTtJQWlCdkQsWUFBb0IsSUFBWSxFQUFVLElBQVksRUFBVSxJQUFVO1FBQ3hFLEtBQUssRUFBRSxDQUFDO1FBRFUsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUFVLFNBQUksR0FBSixJQUFJLENBQVE7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFNO1FBZDFFLFdBQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ3RCLFdBQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBZXBCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFlBQVksZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxJQUFJLGVBQWUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQy9DLENBQUM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFB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QUMsQ0FBQyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QyxDQUFDO1FBRUQsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQsSUFBSSxDQUFDLEtBQWMsRUFBRSxFQUFZO1FBQy9CLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUU3QixPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7O0FBdkZNLHNCQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztBQUN0QixzQkFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7QUFGL0Isa0NBeUZDO0FBQUEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXQgPSByZXF1aXJlKFwibmV0XCIpO1xuaW1wb3J0IHRscyA9IHJlcXVpcmUoXCJ0bHNcIik7XG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xuaW1wb3J0IEh5YnJpZFNvY2tldCBmcm9tIFwiLi9oeWJyaWRzb2NrZXRcIjtcbmltcG9ydCBTd2l0Y2hlciBmcm9tIFwiLi9oeWJyaWQvc3dpdGNoZXJcIjtcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcbmltcG9ydCB7XG4gIENvbm5lY3RvcixcbiAgRGljdGlvbmFyeUNvbXBvbmVudCxcbiAgUHJvdG9idWZDb21wb25lbnQsXG4gIEFwcGxpY2F0aW9uXG59IGZyb20gXCIuLi9pbmRleFwiO1xuXG5jb25zdCBIYW5kc2hha2UgPSByZXF1aXJlKFwiLi9jb21tYW5kcy9oYW5kc2hha2VcIik7XG5jb25zdCBIZWFydGJlYXQgPSByZXF1aXJlKFwiLi9jb21tYW5kcy9oZWFydGJlYXRcIik7XG5jb25zdCBLaWNrID0gcmVxdWlyZShcIi4vY29tbWFuZHMva2lja1wiKTtcbmNvbnN0IGNvZGVyID0gcmVxdWlyZShcIi4vY29tbW9uL2NvZGVyXCIpO1xuXG5sZXQgY3VySWQgPSAxO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBIeWJyaWRDb25uZWN0b3IgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgaW1wbGVtZW50cyBDb25uZWN0b3Ige1xuICBzdGF0aWMgZW5jb2RlID0gY29kZXIuZW5jb2RlO1xuICBzdGF0aWMgZGVjb2RlID0gY29kZXIuZGVjb2RlO1xuICBlbmNvZGUgPSBjb2Rlci5lbmNvZGU7XG4gIGRlY29kZSA9IGNvZGVyLmRlY29kZTtcbiAgcHJpdmF0ZSB1c2VEaWN0OiBib29sZWFuO1xuICBwcml2YXRlIHVzZVByb3RvYnVmOiBib29sZWFuO1xuICBwcml2YXRlIGhhbmRzaGFrZTogYW55OyAvL1RPRE9cbiAgcHJpdmF0ZSBoZWFydGJlYXQ6IGFueTsgLy9UT0RPXG4gIHByaXZhdGUgZGlzdGluY3RIb3N0OiBib29sZWFuO1xuICBwcml2YXRlIHNzbDogYW55OyAvL1RPRE9cbiAgcHJpdmF0ZSBzd2l0Y2hlcjogYW55OyAvL1RPRE9cbiAgcHJpdmF0ZSBjb25uZWN0b3I6IENvbm5lY3RvcjtcbiAgcHJpdmF0ZSBkaWN0aW9uYXJ5OiBEaWN0aW9uYXJ5Q29tcG9uZW50O1xuICBwcml2YXRlIHByb3RvYnVmOiBQcm90b2J1ZkNvbXBvbmVudDtcbiAgcHJpdmF0ZSBkZWNvZGVJT19wcm90b2J1ZjogYW55OyAvL1RPRE9cbiAgcHJpdmF0ZSBsaXN0ZW5pbmdTZXJ2ZXI6IG5ldC5TZXJ2ZXI7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcG9ydDogbnVtYmVyLCBwcml2YXRlIGhvc3Q6IHN0cmluZywgcHJpdmF0ZSBvcHRzPzogYW55KSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgSHlicmlkQ29ubmVjdG9yKSkge1xuICAgICAgcmV0dXJuIG5ldyBIeWJyaWRDb25uZWN0b3IocG9ydCwgaG9zdCwgb3B0cyk7XG4gICAgfVxuICAgIHRoaXMub3B0cyA9IG9wdHMgfHwge307XG4gICAgdGhpcy5wb3J0ID0gcG9ydDtcbiAgICB0aGlzLmhvc3QgPSBob3N0O1xuICAgIHRoaXMudXNlRGljdCA9IG9wdHMudXNlRGljdDtcbiAgICB0aGlzLnVzZVByb3RvYnVmID0gb3B0cy51c2VQcm90b2J1ZjtcbiAgICB0aGlzLmhhbmRzaGFrZSA9IG5ldyBIYW5kc2hha2Uob3B0cyk7XG4gICAgdGhpcy5oZWFydGJlYXQgPSBuZXcgSGVhcnRiZWF0KG9wdHMpO1xuICAgIHRoaXMuZGlzdGluY3RIb3N0ID0gb3B0cy5kaXN0aW5jdEhvc3Q7XG4gICAgdGhpcy5zc2wgPSBvcHRzLnNzbDtcblxuICAgIHRoaXMuc3dpdGNoZXIgPSBudWxsO1xuICB9XG5cbiAgc3RhcnQoY2I6IEZ1bmN0aW9uKSB7XG4gICAgbGV0IHBvbWVsbyA9IHJlcXVpcmUoXCIuLi9wb21lbG9cIik7XG4gICAgbGV0IGFwcCA9IHBvbWVsby5kZWZhdWx0LmFwcCBhcyBBcHBsaWNhdGlvbjtcbiAgICAvL2xldCBhcHAgPSByZXF1aXJlKFwiLi4vcG9tZWxvXCIpLmRlZmF1bHQuYXBwIGFzIEFwcGxpY2F0aW9uO1xuXG4gICAgbGV0IGdlbnNvY2tldCA9IChzb2NrZXQ6IGFueSkgPT4ge1xuICAgICAgbGV0IGh5YnJpZHNvY2tldCA9IG5ldyBIeWJyaWRTb2NrZXQoY3VySWQrKywgc29ja2V0KTtcbiAgICAgIGh5YnJpZHNvY2tldC5vbihcbiAgICAgICAgXCJoYW5kc2hha2VcIixcbiAgICAgICAgdGhpcy5oYW5kc2hha2UuaGFuZGxlLmJpbmQodGhpcy5oYW5kc2hha2UsIGh5YnJpZHNvY2tldClcbiAgICAgICk7XG4gICAgICBoeWJyaWRzb2NrZXQub24oXG4gICAgICAgIFwiaGVhcnRiZWF0XCIsXG4gICAgICAgIHRoaXMuaGVhcnRiZWF0LmhhbmRsZS5iaW5kKHRoaXMuaGVhcnRiZWF0LCBoeWJyaWRzb2NrZXQpXG4gICAgICApO1xuICAgICAgaHlicmlkc29ja2V0Lm9uKFxuICAgICAgICBcImRpc2Nvbm5lY3RcIixcbiAgICAgICAgdGhpcy5oZWFydGJlYXQuY2xlYXIuYmluZCh0aGlzLmhlYXJ0YmVhdCwgaHlicmlkc29ja2V0LmlkKVxuICAgICAgKTtcbiAgICAgIGh5YnJpZHNvY2tldC5vbihcImNsb3NpbmdcIiwgS2ljay5oYW5kbGUuYmluZChudWxsLCBoeWJyaWRzb2NrZXQpKTtcbiAgICAgIHRoaXMuZW1pdChcImNvbm5lY3Rpb25cIiwgaHlicmlkc29ja2V0KTtcbiAgICB9O1xuXG4gICAgdGhpcy5jb25uZWN0b3IgPSBhcHAuY29tcG9uZW50cy5fX2Nvbm5lY3Rvcl9fLmNvbm5lY3RvcjtcbiAgICB0aGlzLmRpY3Rpb25hcnkgPSBhcHAuY29tcG9uZW50cy5fX2RpY3Rpb25hcnlfXztcbiAgICB0aGlzLnByb3RvYnVmID0gYXBwLmNvbXBvbmVudHMuX19wcm90b2J1Zl9fO1xuICAgIHRoaXMuZGVjb2RlSU9fcHJvdG9idWYgPSBhcHAuY29tcG9uZW50cy5fX2RlY29kZUlPX19wcm90b2J1Zl9fO1xuXG4gICAgaWYgKCF0aGlzLnNzbCkge1xuICAgICAgdGhpcy5saXN0ZW5pbmdTZXJ2ZXIgPSBuZXQuY3JlYXRlU2VydmVyKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubGlzdGVuaW5nU2VydmVyID0gdGxzLmNyZWF0ZVNlcnZlcih0aGlzLnNzbCk7XG4gICAgfVxuICAgIHRoaXMuc3dpdGNoZXIgPSBuZXcgU3dpdGNoZXIodGhpcy5saXN0ZW5pbmdTZXJ2ZXIsIHRoaXMub3B0cyk7XG5cbiAgICB0aGlzLnN3aXRjaGVyLm9uKFwiY29ubmVjdGlvblwiLCAoc29ja2V0OiBhbnkpID0+IHtcbiAgICAgIGdlbnNvY2tldChzb2NrZXQpO1xuICAgIH0pO1xuXG4gICAgaWYgKCEhdGhpcy5kaXN0aW5jdEhvc3QpIHtcbiAgICAgIHRoaXMubGlzdGVuaW5nU2VydmVyLmxpc3Rlbih0aGlzLnBvcnQsIHRoaXMuaG9zdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubGlzdGVuaW5nU2VydmVyLmxpc3Rlbih0aGlzLnBvcnQpO1xuICAgIH1cblxuICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xuICB9XG5cbiAgc3RvcChmb3JjZTogYm9vbGVhbiwgY2I6IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5zd2l0Y2hlci5jbG9zZSgpO1xuICAgIHRoaXMubGlzdGVuaW5nU2VydmVyLmNsb3NlKCk7XG5cbiAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcbiAgfVxufTtcbiJdfQ==