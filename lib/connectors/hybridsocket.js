"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = require("events");
const handler = require("./common/handler");
const protocol = require("pomelo-protocol");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const Package = protocol.Package;
var State;
(function (State) {
    State[State["ST_INITED"] = 0] = "ST_INITED";
    State[State["ST_WAIT_ACK"] = 1] = "ST_WAIT_ACK";
    State[State["ST_WORKING"] = 2] = "ST_WORKING";
    State[State["ST_CLOSED"] = 3] = "ST_CLOSED";
})(State || (State = {}));
class HybridSocket extends events_1.EventEmitter {
    constructor(id, socket) {
        super();
        this.id = id;
        this.socket = socket;
        if (!socket._socket) {
            this.remoteAddress = {
                ip: socket.address().address,
                port: socket.address().port
            };
        }
        else {
            this.remoteAddress = {
                ip: socket._socket.remoteAddress,
                port: socket._socket.remotePort
            };
        }
        let self = this;
        socket.once("close", this.emit.bind(this, "disconnect"));
        socket.on("error", this.emit.bind(this, "error"));
        socket.on("message", (msg) => {
            if (msg) {
                msg = Package.decode(msg);
                handler(self, msg);
            }
        });
        this.state = State.ST_INITED;
        // TODO: any other events?
    }
    sendRaw(msg) {
        if (this.state !== State.ST_WORKING) {
            return;
        }
        let self = this;
        this.socket.send(msg, { binary: true }, (err) => {
            if (!!err) {
                logger.error("websocket send binary data failed: %j", err.stack);
                return;
            }
        });
    }
    send(msg) {
        if (msg instanceof String) {
            msg = new Buffer(msg);
        }
        else if (!(msg instanceof Buffer)) {
            msg = new Buffer(JSON.stringify(msg));
        }
        this.sendRaw(Package.encode(Package.TYPE_DATA, msg));
    }
    sendBatch(msgs) {
        let rs = [];
        for (let i = 0; i < msgs.length; i++) {
            let src = Package.encode(Package.TYPE_DATA, msgs[i]);
            rs.push(src);
        }
        this.sendRaw(Buffer.concat(rs));
    }
    sendForce(msg) {
        if (this.state === State.ST_CLOSED) {
            return;
        }
        this.socket.send(msg, { binary: true });
    }
    handshakeResponse(resp) {
        if (this.state !== State.ST_INITED) {
            return;
        }
        this.socket.send(resp, { binary: true });
        this.state = State.ST_WAIT_ACK;
    }
    disconnect() {
        if (this.state === State.ST_CLOSED) {
            return;
        }
        this.state = State.ST_CLOSED;
        this.socket.emit("close");
        this.socket.close();
    }
}
exports.default = HybridSocket;
exports.HybridSocket = HybridSocket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHlicmlkc29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaHlicmlkc29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsbUNBQXNDO0FBR3RDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ3hFLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUM7QUFFakMsSUFBSyxLQUtKO0FBTEQsV0FBSyxLQUFLO0lBQ1IsMkNBQWEsQ0FBQTtJQUNiLCtDQUFlLENBQUE7SUFDZiw2Q0FBYyxDQUFBO0lBQ2QsMkNBQWEsQ0FBQTtBQUNmLENBQUMsRUFMSSxLQUFLLEtBQUwsS0FBSyxRQUtUO0FBRUQsa0JBQWtDLFNBQVEscUJBQVk7SUFHcEQsWUFBcUIsRUFBVSxFQUFXLE1BQVc7UUFDbkQsS0FBSyxFQUFFLENBQUM7UUFEVyxPQUFFLEdBQUYsRUFBRSxDQUFRO1FBQVcsV0FBTSxHQUFOLE1BQU0sQ0FBSztRQUVuRCxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLElBQUksQ0FBQyxhQUFhLEdBQUc7Z0JBQ25CLEVBQUUsRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTztnQkFDNUIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJO2FBQzVCLENBQUM7UUFDSixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsYUFBYSxHQUFHO2dCQUNuQixFQUFFLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhO2dCQUNoQyxJQUFJLEVBQUUsTUFBTSxDQUFD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QUNuQyxNQUFNLENBQUM7UUFDVCxDQUFDO1FBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELGlCQUFpQixDQUFDLElBQVM7UUFDekIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLENBQUM7UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxVQUFVO1FBQ1IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLENBQUM7UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQzdCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBM0ZELCtCQTJGQztBQUVPLG9DQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcbmltcG9ydCB7IFNvY2tldCB9IGZyb20gXCJuZXRcIjtcbmltcG9ydCB7IFJlbW90ZUFkZHJlc3MgfSBmcm9tIFwiLi4vcG9tZWxvXCI7XG5jb25zdCBoYW5kbGVyID0gcmVxdWlyZShcIi4vY29tbW9uL2hhbmRsZXJcIik7XG5jb25zdCBwcm90b2NvbCA9IHJlcXVpcmUoXCJwb21lbG8tcHJvdG9jb2xcIik7XG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XG5jb25zdCBQYWNrYWdlID0gcHJvdG9jb2wuUGFja2FnZTtcblxuZW51bSBTdGF0ZSB7XG4gIFNUX0lOSVRFRCA9IDAsXG4gIFNUX1dBSVRfQUNLID0gMSxcbiAgU1RfV09SS0lORyA9IDIsXG4gIFNUX0NMT1NFRCA9IDNcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSHlicmlkU29ja2V0IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgcHJpdmF0ZSByZW1vdGVBZGRyZXNzOiBSZW1vdGVBZGRyZXNzO1xuICBwcml2YXRlIHN0YXRlOiBTdGF0ZTtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgaWQ6IG51bWJlciwgcmVhZG9ubHkgc29ja2V0OiBhbnkpIHtcbiAgICBzdXBlcigpO1xuICAgIGlmICghc29ja2V0Ll9zb2NrZXQpIHtcbiAgICAgIHRoaXMucmVtb3RlQWRkcmVzcyA9IHtcbiAgICAgICAgaXA6IHNvY2tldC5hZGRyZXNzKCkuYWRkcmVzcyxcbiAgICAgICAgcG9ydDogc29ja2V0LmFkZHJlc3MoKS5wb3J0XG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbW90ZUFkZHJlc3MgPSB7XG4gICAgICAgIGlwOiBzb2NrZXQuX3NvY2tldC5yZW1vdGVBZGRyZXNzLFxuICAgICAgICBwb3J0OiBzb2NrZXQuX3NvY2tldC5yZW1vdGVQb3J0XG4gICAgICB9O1xuICAgIH1cblxuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIHNvY2tldC5vbmNlKFwiY2xvc2VcIiwgdGhpcy5lbWl0LmJpbmQodGhpcywgXCJkaXNjb25uZWN0XCIpKTtcbiAgICBzb2NrZXQub24oXCJlcnJvclwiLCB0aGlzLmVtaXQuYmluZCh0aGlzLCBcImVycm9yXCIpKTtcblxuICAgIHNvY2tldC5vbihcIm1lc3NhZ2VcIiwgKG1zZzogYW55KSA9PiB7XG4gICAgICBpZiAobXNnKSB7XG4gICAgICAgIG1zZyA9IFBhY2thZ2UuZGVjb2RlKG1zZyk7XG4gICAgICAgIGhhbmRsZXIoc2VsZiwgbXNnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuc3RhdGUgPSBTdGF0ZS5TVF9JTklURUQ7XG5cbiAgICAvLyBUT0RPOiBhbnkgb3RoZXIgZXZlbnRzP1xuICB9XG5cbiAgc2VuZFJhdyhtc2c6IGFueSkge1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBTdGF0ZS5TVF9XT1JLSU5HKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgIHRoaXMuc29ja2V0LnNlbmQobXNnLCB7IGJpbmFyeTogdHJ1ZSB9LCAoZXJyOiBhbnkpID0+IHtcbiAgICAgIGlmICghIWVycikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoXCJ3ZWJzb2NrZXQgc2VuZCBiaW5hcnkgZGF0YSBmYWlsZWQ6ICVqXCIsIGVyci5zdGFjayk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHNlbmQobXNnOiBzdHJpbmcgfCBCdWZmZXIpIHtcbiAgICBpZiAobXNnIGluc3RhbmNlb2YgU3RyaW5nKSB7XG4gICAgICBtc2cgPSBuZXcgQnVmZmVyKG1zZyk7XG4gICAgfSBlbHNlIGlmICghKG1zZyBpbnN0YW5jZW9mIEJ1ZmZlcikpIHtcbiAgICAgIG1zZyA9IG5ldyBCdWZmZXIoSlNPTi5zdHJpbmdpZnkobXNnKSk7XG4gICAgfVxuICAgIHRoaXMuc2VuZFJhdyhQYWNrYWdlLmVuY29kZShQYWNrYWdlLlRZUEVfREFUQSwgbXNnKSk7XG4gIH1cblxuICBzZW5kQmF0Y2gobXNnczogYW55W10pIHtcbiAgICBsZXQgcnMgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1zZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBzcmMgPSBQYWNrYWdlLmVuY29kZShQYWNrYWdlLlRZUEVfREFUQSwgbXNnc1tpXSk7XG4gICAgICBycy5wdXNoKHNyYyk7XG4gICAgfVxuICAgIHRoaXMuc2VuZFJhdyhCdWZmZXIuY29uY2F0KHJzKSk7XG4gIH1cblxuICBzZW5kRm9yY2UobXNnOiBhbnkpIHtcbiAgICBpZiAodGhpcy5zdGF0ZSA9PT0gU3RhdGUuU1RfQ0xPU0VEKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc29ja2V0LnNlbmQobXNnLCB7IGJpbmFyeTogdHJ1ZSB9KTtcbiAgfVxuXG4gIGhhbmRzaGFrZVJlc3BvbnNlKHJlc3A6IGFueSkge1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBTdGF0ZS5TVF9JTklURUQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnNvY2tldC5zZW5kKHJlc3AsIHsgYmluYXJ5OiB0cnVlIH0pO1xuICAgIHRoaXMuc3RhdGUgPSBTdGF0ZS5TVF9XQUlUX0FDSztcbiAgfVxuXG4gIGRpc2Nvbm5lY3QoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgPT09IFN0YXRlLlNUX0NMT1NFRCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuc3RhdGUgPSBTdGF0ZS5TVF9DTE9TRUQ7XG4gICAgdGhpcy5zb2NrZXQuZW1pdChcImNsb3NlXCIpO1xuICAgIHRoaXMuc29ja2V0LmNsb3NlKCk7XG4gIH1cbn1cblxuZXhwb3J0IHtIeWJyaWRTb2NrZXR9Il19