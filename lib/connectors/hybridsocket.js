"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = require("events");
const handler = require("./common/handler");
const protocol = require("pomelo-protocol");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const Package = protocol.Package;
var State;
(function (State) {
    State[State["ST_INITED"] = 0] = "ST_INITED";
    State[State["ST_WAIT_ACK"] = 1] = "ST_WAIT_ACK";
    State[State["ST_WORKING"] = 2] = "ST_WORKING";
    State[State["ST_CLOSED"] = 3] = "ST_CLOSED";
})(State || (State = {}));
class HybridSocket extends events_1.EventEmitter {
    constructor(id, socket) {
        super();
        this.id = id;
        this.socket = socket;
        if (!socket._socket) {
            this.remoteAddress = {
                ip: socket.address().address,
                port: socket.address().port
            };
        }
        else {
            this.remoteAddress = {
                ip: socket._socket.remoteAddress,
                port: socket._socket.remotePort
            };
        }
        let self = this;
        socket.once("close", this.emit.bind(this, "disconnect"));
        socket.on("error", this.emit.bind(this, "error"));
        socket.on("message", (msg) => {
            if (msg) {
                msg = Package.decode(msg);
                handler(self, msg);
            }
        });
        this.state = State.ST_INITED;
        // TODO: any other events?
    }
    sendRaw(msg) {
        if (this.state !== State.ST_WORKING) {
            return;
        }
        let self = this;
        this.socket.send(msg, { binary: true }, (err) => {
            if (!!err) {
                logger.error("websocket send binary data failed: %j", err.stack);
                return;
            }
        });
    }
    send(msg) {
        if (msg instanceof String) {
            msg = new Buffer(msg);
        }
        else if (!(msg instanceof Buffer)) {
            msg = new Buffer(JSON.stringify(msg));
        }
        this.sendRaw(Package.encode(Package.TYPE_DATA, msg));
    }
    sendBatch(msgs) {
        let rs = [];
        for (let i = 0; i < msgs.length; i++) {
            let src = Package.encode(Package.TYPE_DATA, msgs[i]);
            rs.push(src);
        }
        this.sendRaw(Buffer.concat(rs));
    }
    sendForce(msg) {
        if (this.state === State.ST_CLOSED) {
            return;
        }
        this.socket.send(msg, { binary: true });
    }
    handshakeResponse(resp) {
        if (this.state !== State.ST_INITED) {
            return;
        }
        this.socket.send(resp, { binary: true });
        this.state = State.ST_WAIT_ACK;
    }
    disconnect() {
        if (this.state === State.ST_CLOSED) {
            return;
        }
        this.state = State.ST_CLOSED;
        this.socket.emit("close");
        this.socket.close();
    }
}
exports.default = HybridSocket;
exports.HybridSocket = HybridSocket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHlicmlkc29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaHlicmlkc29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsbUNBQXNDO0FBR3RDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ3hFLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUM7QUFFakMsSUFBSyxLQUtKO0FBTEQsV0FBSyxLQUFLO0lBQ1IsMkNBQWEsQ0FBQTtJQUNiLCtDQUFlLENBQUE7SUFDZiw2Q0FBYyxDQUFBO0lBQ2QsMkNBQWEsQ0FBQTtBQUNmLENBQUMsRUFMSSxLQUFLLEtBQUwsS0FBSyxRQUtUO0FBRUQsa0JBQWtDLFNBQVEscUJBQVk7SUFHcEQsWUFBcUIsRUFBVSxFQUFXLE1BQVc7UUFDbkQsS0FBSyxFQUFFLENBQUM7UUFEVyxPQUFFLEdBQUYsRUFBRSxDQUFRO1FBQVcsV0FBTSxHQUFOLE1BQU0sQ0FBSztRQUVuRCxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLElBQUksQ0FBQyxhQUFhLEdBQUc7Z0JBQ25CLEVBQUUsRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTztnQkFDNUIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJO2FBQzVCLENBQUM7UUFDSixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsYUFBYSxHQUFHO2dCQUNuQixFQUFFLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhO2dCQUNoQyxJQUFJLEVBQUUsTUFBTSxDQUFD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QUNuQyxNQUFNLENBQUM7UUFDVCxDQUFDO1FBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELGlCQUFpQixDQUFDLElBQVM7UUFDekIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLENBQUM7UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxVQUFVO1FBQ1IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLENBQUM7UUFDVCxDQUFDO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQzdCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBM0ZELCtCQTJGQztBQUVPLG9DQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50c1wiO1xyXG5pbXBvcnQgeyBTb2NrZXQgfSBmcm9tIFwibmV0XCI7XHJcbmltcG9ydCB7IFJlbW90ZUFkZHJlc3MgfSBmcm9tIFwiLi4vcG9tZWxvXCI7XHJcbmNvbnN0IGhhbmRsZXIgPSByZXF1aXJlKFwiLi9jb21tb24vaGFuZGxlclwiKTtcclxuY29uc3QgcHJvdG9jb2wgPSByZXF1aXJlKFwicG9tZWxvLXByb3RvY29sXCIpO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XHJcbmNvbnN0IFBhY2thZ2UgPSBwcm90b2NvbC5QYWNrYWdlO1xyXG5cclxuZW51bSBTdGF0ZSB7XHJcbiAgU1RfSU5JVEVEID0gMCxcclxuICBTVF9XQUlUX0FDSyA9IDEsXHJcbiAgU1RfV09SS0lORyA9IDIsXHJcbiAgU1RfQ0xPU0VEID0gM1xyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBIeWJyaWRTb2NrZXQgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xyXG4gIHByaXZhdGUgcmVtb3RlQWRkcmVzczogUmVtb3RlQWRkcmVzcztcclxuICBwcml2YXRlIHN0YXRlOiBTdGF0ZTtcclxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBpZDogbnVtYmVyLCByZWFkb25seSBzb2NrZXQ6IGFueSkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIGlmICghc29ja2V0Ll9zb2NrZXQpIHtcclxuICAgICAgdGhpcy5yZW1vdGVBZGRyZXNzID0ge1xyXG4gICAgICAgIGlwOiBzb2NrZXQuYWRkcmVzcygpLmFkZHJlc3MsXHJcbiAgICAgICAgcG9ydDogc29ja2V0LmFkZHJlc3MoKS5wb3J0XHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnJlbW90ZUFkZHJlc3MgPSB7XHJcbiAgICAgICAgaXA6IHNvY2tldC5fc29ja2V0LnJlbW90ZUFkZHJlc3MsXHJcbiAgICAgICAgcG9ydDogc29ja2V0Ll9zb2NrZXQucmVtb3RlUG9ydFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBzZWxmID0gdGhpcztcclxuXHJcbiAgICBzb2NrZXQub25jZShcImNsb3NlXCIsIHRoaXMuZW1pdC5iaW5kKHRoaXMsIFwiZGlzY29ubmVjdFwiKSk7XHJcbiAgICBzb2NrZXQub24oXCJlcnJvclwiLCB0aGlzLmVtaXQuYmluZCh0aGlzLCBcImVycm9yXCIpKTtcclxuXHJcbiAgICBzb2NrZXQub24oXCJtZXNzYWdlXCIsIChtc2c6IGFueSkgPT4ge1xyXG4gICAgICBpZiAobXNnKSB7XHJcbiAgICAgICAgbXNnID0gUGFja2FnZS5kZWNvZGUobXNnKTtcclxuICAgICAgICBoYW5kbGVyKHNlbGYsIG1zZyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuc3RhdGUgPSBTdGF0ZS5TVF9JTklURUQ7XHJcblxyXG4gICAgLy8gVE9ETzogYW55IG90aGVyIGV2ZW50cz9cclxuICB9XHJcblxyXG4gIHNlbmRSYXcobXNnOiBhbnkpIHtcclxuICAgIGlmICh0aGlzLnN0YXRlICE9PSBTdGF0ZS5TVF9XT1JLSU5HKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBzZWxmID0gdGhpcztcclxuXHJcbiAgICB0aGlzLnNvY2tldC5zZW5kKG1zZywgeyBiaW5hcnk6IHRydWUgfSwgKGVycjogYW55KSA9PiB7XHJcbiAgICAgIGlmICghIWVycikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihcIndlYnNvY2tldCBzZW5kIGJpbmFyeSBkYXRhIGZhaWxlZDogJWpcIiwgZXJyLnN0YWNrKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2VuZChtc2c6IHN0cmluZyB8IEJ1ZmZlcikge1xyXG4gICAgaWYgKG1zZyBpbnN0YW5jZW9mIFN0cmluZykge1xyXG4gICAgICBtc2cgPSBuZXcgQnVmZmVyKG1zZyk7XHJcbiAgICB9IGVsc2UgaWYgKCEobXNnIGluc3RhbmNlb2YgQnVmZmVyKSkge1xyXG4gICAgICBtc2cgPSBuZXcgQnVmZmVyKEpTT04uc3RyaW5naWZ5KG1zZykpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZW5kUmF3KFBhY2thZ2UuZW5jb2RlKFBhY2thZ2UuVFlQRV9EQVRBLCBtc2cpKTtcclxuICB9XHJcblxyXG4gIHNlbmRCYXRjaChtc2dzOiBhbnlbXSkge1xyXG4gICAgbGV0IHJzID0gW107XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1zZ3MubGVuZ3RoOyBpKyspIHtcclxuICAgICAgbGV0IHNyYyA9IFBhY2thZ2UuZW5jb2RlKFBhY2thZ2UuVFlQRV9EQVRBLCBtc2dzW2ldKTtcclxuICAgICAgcnMucHVzaChzcmMpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZW5kUmF3KEJ1ZmZlci5jb25jYXQocnMpKTtcclxuICB9XHJcblxyXG4gIHNlbmRGb3JjZShtc2c6IGFueSkge1xyXG4gICAgaWYgKHRoaXMuc3RhdGUgPT09IFN0YXRlLlNUX0NMT1NFRCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnNvY2tldC5zZW5kKG1zZywgeyBiaW5hcnk6IHRydWUgfSk7XHJcbiAgfVxyXG5cclxuICBoYW5kc2hha2VSZXNwb25zZShyZXNwOiBhbnkpIHtcclxuICAgIGlmICh0aGlzLnN0YXRlICE9PSBTdGF0ZS5TVF9JTklURUQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuc29ja2V0LnNlbmQocmVzcCwgeyBiaW5hcnk6IHRydWUgfSk7XHJcbiAgICB0aGlzLnN0YXRlID0gU3RhdGUuU1RfV0FJVF9BQ0s7XHJcbiAgfVxyXG5cclxuICBkaXNjb25uZWN0KCkge1xyXG4gICAgaWYgKHRoaXMuc3RhdGUgPT09IFN0YXRlLlNUX0NMT1NFRCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zdGF0ZSA9IFN0YXRlLlNUX0NMT1NFRDtcclxuICAgIHRoaXMuc29ja2V0LmVtaXQoXCJjbG9zZVwiKTtcclxuICAgIHRoaXMuc29ja2V0LmNsb3NlKCk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQge0h5YnJpZFNvY2tldH0iXX0=