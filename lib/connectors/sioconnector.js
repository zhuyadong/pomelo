"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = require("events");
const siosocket_1 = require("./siosocket");
const httpServer = require("http").createServer();
const PKG_ID_BYTES = 4;
const PKG_ROUTE_LENGTH_BYTES = 1;
const PKG_HEAD_BYTES = PKG_ID_BYTES + PKG_ROUTE_LENGTH_BYTES;
let curId = 1;
class SioConnector extends events_1.EventEmitter {
    constructor(port, host, opts) {
        super();
        this.port = port;
        this.host = host;
        this.opts = opts;
        if (!(this instanceof SioConnector)) {
            return new SioConnector(port, host, opts);
        }
        this.port = port;
        this.host = host;
        this.opts = opts;
        this.heartbeats = opts.heartbeats || true;
        this.closeTimeout = opts.closeTimeout || 60;
        this.heartbeatTimeout = opts.heartbeatTimeout || 60;
        this.heartbeatInterval = opts.heartbeatInterval || 25;
    }
    start(cb) {
        // issue https://github.com/NetEase/pomelo-cn/issues/174
        let opts = {};
        if (!!this.opts) {
            opts = this.opts;
        }
        else {
            opts = {
                transports: ["websocket", "polling-xhr", "polling-jsonp", "polling"]
            };
        }
        let sio = require("socket.io")(httpServer, opts);
        let port = this.port;
        httpServer.listen(port, () => {
            console.log("sio Server listening at port %d", port);
        });
        sio.set("resource", "/socket.io");
        sio.set("transports", this.opts.transports);
        sio.set("heartbeat timeout", this.heartbeatTimeout);
        sio.set("heartbeat interval", this.heartbeatInterval);
        sio.on("connection", (socket) => {
            let siosocket = new siosocket_1.default(curId++, socket);
            this.emit("connection", siosocket);
            siosocket.on("closing", (reason) => {
                siosocket.send({ route: "onKick", reason: reason });
            });
        });
        process.nextTick(cb);
    }
    stop(force, cb) {
        this.wsocket.server.close();
        process.nextTick(cb);
    }
    encode(reqId, route, msg) {
        return SioConnector.encode(reqId, route, msg);
    }
    static encode(reqId, route, msg) {
        if (reqId) {
            return composeResponse(reqId, route, msg);
        }
        else {
            return composePush(route, msg);
        }
    }
    decode(msg) {
        return SioConnector.decode(msg);
    }
    static decode(msg) {
        let index = 0;
        let id = parseIntField(msg, index, PKG_ID_BYTES);
        index += PKG_ID_BYTES;
        let routeLen = parseIntField(msg, index, PKG_ROUTE_LENGTH_BYTES);
        let route = msg.substr(PKG_HEAD_BYTES, routeLen);
        let body = msg.substr(PKG_HEAD_BYTES + routeLen);
        return {
            id: id,
            route: route,
            body: JSON.parse(body)
        };
    }
}
exports.default = SioConnector;
function composeResponse(msgId, route, msgBody) {
    return {
        id: msgId,
        body: msgBody
    };
}
function composePush(route, msgBody) {
    return JSON.stringify({ route: route, body: msgBody });
}
function parseIntField(str, offset, len) {
    let res = 0;
    for (let i = 0; i < len; i++) {
        if (i > 0) {
            res <<= 8;
        }
        res |= str.charCodeAt(offset + i) & 0xff;
    }
    return res;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lvY29ubmVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2lvY29ubmVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsbUNBQXNDO0FBQ3RDLDJDQUFvQztBQUNwQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxFQUFFLENBQUM7QUFFbEQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxDQUFDO0FBQ2pDLE1BQU0sY0FBYyxHQUFHLFlBQVksR0FBRyxzQkFBc0IsQ0FBQztBQUU3RCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFVZCxrQkFBa0MsU0FBUSxxQkFBWTtJQU1wRCxZQUNXLElBQVksRUFDWixJQUFZLEVBQ1osSUFBc0I7UUFFL0IsS0FBSyxFQUFFLENBQUM7UUFKQyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osU0FBSSxHQUFKLElBQUksQ0FBUTtRQUNaLFNBQUksR0FBSixJQUFJLENBQWtCO1FBRy9CLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFlBQVksWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxJQUFJLFlBQVksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVDLENBQUM7UUFFRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO1FBQzFDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7UUFDNUMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsSUFB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RyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM3QixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNWLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDWixDQUFDO1FBQ0QsR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUMzQyxDQUFDO0lBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleHRlbmQgfSBmcm9tIFwiLi4vdXRpbC91dGlsc1wiO1xyXG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XHJcbmltcG9ydCBTaW9Tb2NrZXQgZnJvbSBcIi4vc2lvc29ja2V0XCI7XHJcbmNvbnN0IGh0dHBTZXJ2ZXIgPSByZXF1aXJlKFwiaHR0cFwiKS5jcmVhdGVTZXJ2ZXIoKTtcclxuXHJcbmNvbnN0IFBLR19JRF9CWVRFUyA9IDQ7XHJcbmNvbnN0IFBLR19ST1VURV9MRU5HVEhfQllURVMgPSAxO1xyXG5jb25zdCBQS0dfSEVBRF9CWVRFUyA9IFBLR19JRF9CWVRFUyArIFBLR19ST1VURV9MRU5HVEhfQllURVM7XHJcblxyXG5sZXQgY3VySWQgPSAxO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTaW9Db25uZWN0b3JPcHRzIHtcclxuICB0cmFuc3BvcnRzOiBzdHJpbmdbXTtcclxuICBoZWFydGJlYXRzOiBib29sZWFuO1xyXG4gIGNsb3NlVGltZW91dDogbnVtYmVyO1xyXG4gIGhlYXJ0YmVhdFRpbWVvdXQ6IG51bWJlcjtcclxuICBoZWFydGJlYXRJbnRlcnZhbDogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTaW9Db25uZWN0b3IgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xyXG4gIHJlYWRvbmx5IGhlYXJ0YmVhdHM6IGJvb2xlYW47XHJcbiAgcmVhZG9ubHkgY2xvc2VUaW1lb3V0OiBudW1iZXI7XHJcbiAgcmVhZG9ubHkgaGVhcnRiZWF0VGltZW91dDogbnVtYmVyO1xyXG4gIHJlYWRvbmx5IGhlYXJ0YmVhdEludGVydmFsOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSB3c29ja2V0OmFueTtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHJlYWRvbmx5IHBvcnQ6IG51bWJlcixcclxuICAgIHJlYWRvbmx5IGhvc3Q6IHN0cmluZyxcclxuICAgIHJlYWRvbmx5IG9wdHM6IFNpb0Nvbm5lY3Rvck9wdHNcclxuICApIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU2lvQ29ubmVjdG9yKSkge1xyXG4gICAgICByZXR1cm4gbmV3IFNpb0Nvbm5lY3Rvcihwb3J0LCBob3N0LCBvcHRzKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnBvcnQgPSBwb3J0O1xyXG4gICAgdGhpcy5ob3N0ID0gaG9zdDtcclxuICAgIHRoaXMub3B0cyA9IG9wdHM7XHJcbiAgICB0aGlzLmhlYXJ0YmVhdHMgPSBvcHRzLmhlYXJ0YmVhdHMgfHwgdHJ1ZTtcclxuICAgIHRoaXMuY2xvc2VUaW1lb3V0ID0gb3B0cy5jbG9zZVRpbWVvdXQgfHwgNjA7XHJcbiAgICB0aGlzLmhlYXJ0YmVhdFRpbWVvdXQgPSBvcHRzLmhlYXJ0YmVhdFRpbWVvdXQgfHwgNjA7XHJcbiAgICB0aGlzLmhlYXJ0YmVhdEludGVydmFsID0gb3B0cy5oZWFydGJlYXRJbnRlcnZhbCB8fCAyNTtcclxuICB9XHJcbiAgc3RhcnQoY2I6RnVuY3Rpb24pIHtcclxuICAgIC8vIGlzc3VlIGh0dHBzOi8vZ2l0aHViLmNvbS9OZXRFYXNlL3BvbWVsby1jbi9pc3N1ZXMvMTc0XHJcbiAgICBsZXQgb3B0cyA9IHt9O1xyXG4gICAgaWYgKCEhdGhpcy5vcHRzKSB7XHJcbiAgICAgIG9wdHMgPSB0aGlzLm9wdHM7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBvcHRzID0ge1xyXG4gICAgICAgIHRyYW5zcG9ydHM6IFtcIndlYnNvY2tldFwiLCBcInBvbGxpbmcteGhyXCIsIFwicG9sbGluZy1qc29ucFwiLCBcInBvbGxpbmdcIl1cclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2lvID0gcmVxdWlyZShcInNvY2tldC5pb1wiKShodHRwU2VydmVyLCBvcHRzKTtcclxuXHJcbiAgICBsZXQgcG9ydCA9IHRoaXMucG9ydDtcclxuICAgIGh0dHBTZXJ2ZXIubGlzdGVuKHBvcnQsICgpPT4ge1xyXG4gICAgICBjb25zb2xlLmxvZyhcInNpbyBTZXJ2ZXIgbGlzdGVuaW5nIGF0IHBvcnQgJWRcIiwgcG9ydCk7XHJcbiAgICB9KTtcclxuICAgIHNpby5zZXQoXCJyZXNvdXJjZVwiLCBcIi9zb2NrZXQuaW9cIik7XHJcbiAgICBzaW8uc2V0KFwidHJhbnNwb3J0c1wiLCB0aGlzLm9wdHMudHJhbnNwb3J0cyk7XHJcbiAgICBzaW8uc2V0KFwiaGVhcnRiZWF0IHRpbWVvdXRcIiwgdGhpcy5oZWFydGJlYXRUaW1lb3V0KTtcclxuICAgIHNpby5zZXQoXCJoZWFydGJlYXQgaW50ZXJ2YWxcIiwgdGhpcy5oZWFydGJlYXRJbnRlcnZhbCk7XHJcblxyXG4gICAgc2lvLm9uKFwiY29ubmVjdGlvblwiLCAoc29ja2V0OmFueSkgPT4ge1xyXG4gICAgICBsZXQgc2lvc29ja2V0ID0gbmV3IFNpb1NvY2tldChjdXJJZCsrLCBzb2NrZXQpO1xyXG4gICAgICB0aGlzLmVtaXQoXCJjb25uZWN0aW9uXCIsIHNpb3NvY2tldCk7XHJcbiAgICAgIHNpb3NvY2tldC5vbihcImNsb3NpbmdcIiwgKHJlYXNvbik9PiB7XHJcbiAgICAgICAgc2lvc29ja2V0LnNlbmQoeyByb3V0ZTogXCJvbktpY2tcIiwgcmVhc29uOiByZWFzb24gfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcHJvY2Vzcy5uZXh0VGljayhjYik7XHJcbiAgfVxyXG5cclxuICBzdG9wKGZvcmNlOiBib29sZWFuLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMud3NvY2tldC5zZXJ2ZXIuY2xvc2UoKTtcclxuICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xyXG4gIH1cclxuXHJcbiAgZW5jb2RlKHJlcUlkOiBudW1iZXIsIHJvdXRlOiBzdHJpbmcsIG1zZzogYW55KSB7XHJcbiAgICByZXR1cm4gU2lvQ29ubmVjdG9yLmVuY29kZShyZXFJZCwgcm91dGUsIG1zZyk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZW5jb2RlKHJlcUlkOiBudW1iZXIsIHJvdXRlOiBzdHJpbmcsIG1zZzogYW55KSB7XHJcbiAgICBpZiAocmVxSWQpIHtcclxuICAgICAgcmV0dXJuIGNvbXBvc2VSZXNwb25zZShyZXFJZCwgcm91dGUsIG1zZyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gY29tcG9zZVB1c2gocm91dGUsIG1zZyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZWNvZGUobXNnOiBhbnkpIHtcclxuICAgIHJldHVybiBTaW9Db25uZWN0b3IuZGVjb2RlKG1zZyk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZGVjb2RlKG1zZzogYW55KSB7XHJcbiAgICBsZXQgaW5kZXggPSAwO1xyXG5cclxuICAgIGxldCBpZCA9IHBhcnNlSW50RmllbGQobXNnLCBpbmRleCwgUEtHX0lEX0JZVEVTKTtcclxuICAgIGluZGV4ICs9IFBLR19JRF9CWVRFUztcclxuXHJcbiAgICBsZXQgcm91dGVMZW4gPSBwYXJzZUludEZpZWxkKG1zZywgaW5kZXgsIFBLR19ST1VURV9MRU5HVEhfQllURVMpO1xyXG5cclxuICAgIGxldCByb3V0ZSA9IG1zZy5zdWJzdHIoUEtHX0hFQURfQllURVMsIHJvdXRlTGVuKTtcclxuICAgIGxldCBib2R5ID0gbXNnLnN1YnN0cihQS0dfSEVBRF9CWVRFUyArIHJvdXRlTGVuKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBpZDogaWQsXHJcbiAgICAgIHJvdXRlOiByb3V0ZSxcclxuICAgICAgYm9keTogSlNPTi5wYXJzZShib2R5KVxyXG4gICAgfTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbXBvc2VSZXNwb25zZShtc2dJZDogbnVtYmVyLCByb3V0ZTogc3RyaW5nLCBtc2dCb2R5OiBhbnkpIHtcclxuICByZXR1cm4ge1xyXG4gICAgaWQ6IG1zZ0lkLFxyXG4gICAgYm9keTogbXNnQm9keVxyXG4gIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbXBvc2VQdXNoKHJvdXRlOiBzdHJpbmcsIG1zZ0JvZHk6IGFueSkge1xyXG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh7IHJvdXRlOiByb3V0ZSwgYm9keTogbXNnQm9keSB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VJbnRGaWVsZChzdHI6IHN0cmluZywgb2Zmc2V0OiBudW1iZXIsIGxlbjogbnVtYmVyKSB7XHJcbiAgbGV0IHJlcyA9IDA7XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xyXG4gICAgaWYgKGkgPiAwKSB7XHJcbiAgICAgIHJlcyA8PD0gODtcclxuICAgIH1cclxuICAgIHJlcyB8PSBzdHIuY2hhckNvZGVBdChvZmZzZXQgKyBpKSAmIDB4ZmY7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcmVzO1xyXG59XHJcbiJdfQ==