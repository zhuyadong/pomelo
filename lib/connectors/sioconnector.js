"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = require("events");
const siosocket_1 = require("./siosocket");
const httpServer = require("http").createServer();
const PKG_ID_BYTES = 4;
const PKG_ROUTE_LENGTH_BYTES = 1;
const PKG_HEAD_BYTES = PKG_ID_BYTES + PKG_ROUTE_LENGTH_BYTES;
let curId = 1;
class SioConnector extends events_1.EventEmitter {
    constructor(port, host, opts) {
        super();
        this.port = port;
        this.host = host;
        this.opts = opts;
        if (!(this instanceof SioConnector)) {
            return new SioConnector(port, host, opts);
        }
        this.port = port;
        this.host = host;
        this.opts = opts;
        this.heartbeats = opts.heartbeats || true;
        this.closeTimeout = opts.closeTimeout || 60;
        this.heartbeatTimeout = opts.heartbeatTimeout || 60;
        this.heartbeatInterval = opts.heartbeatInterval || 25;
    }
    start(cb) {
        // issue https://github.com/NetEase/pomelo-cn/issues/174
        let opts = {};
        if (!!this.opts) {
            opts = this.opts;
        }
        else {
            opts = {
                transports: ["websocket", "polling-xhr", "polling-jsonp", "polling"]
            };
        }
        let sio = require("socket.io")(httpServer, opts);
        let port = this.port;
        httpServer.listen(port, () => {
            console.log("sio Server listening at port %d", port);
        });
        sio.set("resource", "/socket.io");
        sio.set("transports", this.opts.transports);
        sio.set("heartbeat timeout", this.heartbeatTimeout);
        sio.set("heartbeat interval", this.heartbeatInterval);
        sio.on("connection", (socket) => {
            let siosocket = new siosocket_1.default(curId++, socket);
            this.emit("connection", siosocket);
            siosocket.on("closing", (reason) => {
                siosocket.send({ route: "onKick", reason: reason });
            });
        });
        process.nextTick(cb);
    }
    stop(force, cb) {
        this.wsocket.server.close();
        process.nextTick(cb);
    }
    encode(reqId, route, msg) {
        return SioConnector.encode(reqId, route, msg);
    }
    static encode(reqId, route, msg) {
        if (reqId) {
            return composeResponse(reqId, route, msg);
        }
        else {
            return composePush(route, msg);
        }
    }
    decode(msg) {
        return SioConnector.decode(msg);
    }
    static decode(msg) {
        let index = 0;
        let id = parseIntField(msg, index, PKG_ID_BYTES);
        index += PKG_ID_BYTES;
        let routeLen = parseIntField(msg, index, PKG_ROUTE_LENGTH_BYTES);
        let route = msg.substr(PKG_HEAD_BYTES, routeLen);
        let body = msg.substr(PKG_HEAD_BYTES + routeLen);
        return {
            id: id,
            route: route,
            body: JSON.parse(body)
        };
    }
}
exports.default = SioConnector;
function composeResponse(msgId, route, msgBody) {
    return {
        id: msgId,
        body: msgBody
    };
}
function composePush(route, msgBody) {
    return JSON.stringify({ route: route, body: msgBody });
}
function parseIntField(str, offset, len) {
    let res = 0;
    for (let i = 0; i < len; i++) {
        if (i > 0) {
            res <<= 8;
        }
        res |= str.charCodeAt(offset + i) & 0xff;
    }
    return res;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lvY29ubmVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2lvY29ubmVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsbUNBQXNDO0FBQ3RDLDJDQUFvQztBQUNwQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxFQUFFLENBQUM7QUFFbEQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxDQUFDO0FBQ2pDLE1BQU0sY0FBYyxHQUFHLFlBQVksR0FBRyxzQkFBc0IsQ0FBQztBQUU3RCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFVZCxrQkFBa0MsU0FBUSxxQkFBWTtJQU1wRCxZQUNXLElBQVksRUFDWixJQUFZLEVBQ1osSUFBc0I7UUFFL0IsS0FBSyxFQUFFLENBQUM7UUFKQyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osU0FBSSxHQUFKLElBQUksQ0FBUTtRQUNaLFNBQUksR0FBSixJQUFJLENBQWtCO1FBRy9CLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLFlBQVksWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxJQUFJLFlBQVksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVDLENBQUM7UUFFRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO1FBQzFDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7UUFDNUMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsSUFB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RyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM3QixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNWLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDWixDQUFDO1FBQ0QsR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUMzQyxDQUFDO0lBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleHRlbmQgfSBmcm9tIFwiLi4vdXRpbC91dGlsc1wiO1xuaW1wb3J0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcbmltcG9ydCBTaW9Tb2NrZXQgZnJvbSBcIi4vc2lvc29ja2V0XCI7XG5jb25zdCBodHRwU2VydmVyID0gcmVxdWlyZShcImh0dHBcIikuY3JlYXRlU2VydmVyKCk7XG5cbmNvbnN0IFBLR19JRF9CWVRFUyA9IDQ7XG5jb25zdCBQS0dfUk9VVEVfTEVOR1RIX0JZVEVTID0gMTtcbmNvbnN0IFBLR19IRUFEX0JZVEVTID0gUEtHX0lEX0JZVEVTICsgUEtHX1JPVVRFX0xFTkdUSF9CWVRFUztcblxubGV0IGN1cklkID0gMTtcblxuZXhwb3J0IGludGVyZmFjZSBTaW9Db25uZWN0b3JPcHRzIHtcbiAgdHJhbnNwb3J0czogc3RyaW5nW107XG4gIGhlYXJ0YmVhdHM6IGJvb2xlYW47XG4gIGNsb3NlVGltZW91dDogbnVtYmVyO1xuICBoZWFydGJlYXRUaW1lb3V0OiBudW1iZXI7XG4gIGhlYXJ0YmVhdEludGVydmFsOiBudW1iZXI7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNpb0Nvbm5lY3RvciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIHJlYWRvbmx5IGhlYXJ0YmVhdHM6IGJvb2xlYW47XG4gIHJlYWRvbmx5IGNsb3NlVGltZW91dDogbnVtYmVyO1xuICByZWFkb25seSBoZWFydGJlYXRUaW1lb3V0OiBudW1iZXI7XG4gIHJlYWRvbmx5IGhlYXJ0YmVhdEludGVydmFsOiBudW1iZXI7XG4gIHByaXZhdGUgd3NvY2tldDphbnk7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHJlYWRvbmx5IHBvcnQ6IG51bWJlcixcbiAgICByZWFkb25seSBob3N0OiBzdHJpbmcsXG4gICAgcmVhZG9ubHkgb3B0czogU2lvQ29ubmVjdG9yT3B0c1xuICApIHtcbiAgICBzdXBlcigpO1xuICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBTaW9Db25uZWN0b3IpKSB7XG4gICAgICByZXR1cm4gbmV3IFNpb0Nvbm5lY3Rvcihwb3J0LCBob3N0LCBvcHRzKTtcbiAgICB9XG5cbiAgICB0aGlzLnBvcnQgPSBwb3J0O1xuICAgIHRoaXMuaG9zdCA9IGhvc3Q7XG4gICAgdGhpcy5vcHRzID0gb3B0cztcbiAgICB0aGlzLmhlYXJ0YmVhdHMgPSBvcHRzLmhlYXJ0YmVhdHMgfHwgdHJ1ZTtcbiAgICB0aGlzLmNsb3NlVGltZW91dCA9IG9wdHMuY2xvc2VUaW1lb3V0IHx8IDYwO1xuICAgIHRoaXMuaGVhcnRiZWF0VGltZW91dCA9IG9wdHMuaGVhcnRiZWF0VGltZW91dCB8fCA2MDtcbiAgICB0aGlzLmhlYXJ0YmVhdEludGVydmFsID0gb3B0cy5oZWFydGJlYXRJbnRlcnZhbCB8fCAyNTtcbiAgfVxuICBzdGFydChjYjpGdW5jdGlvbikge1xuICAgIC8vIGlzc3VlIGh0dHBzOi8vZ2l0aHViLmNvbS9OZXRFYXNlL3BvbWVsby1jbi9pc3N1ZXMvMTc0XG4gICAgbGV0IG9wdHMgPSB7fTtcbiAgICBpZiAoISF0aGlzLm9wdHMpIHtcbiAgICAgIG9wdHMgPSB0aGlzLm9wdHM7XG4gICAgfSBlbHNlIHtcbiAgICAgIG9wdHMgPSB7XG4gICAgICAgIHRyYW5zcG9ydHM6IFtcIndlYnNvY2tldFwiLCBcInBvbGxpbmcteGhyXCIsIFwicG9sbGluZy1qc29ucFwiLCBcInBvbGxpbmdcIl1cbiAgICAgIH07XG4gICAgfVxuXG4gICAgbGV0IHNpbyA9IHJlcXVpcmUoXCJzb2NrZXQuaW9cIikoaHR0cFNlcnZlciwgb3B0cyk7XG5cbiAgICBsZXQgcG9ydCA9IHRoaXMucG9ydDtcbiAgICBodHRwU2VydmVyLmxpc3Rlbihwb3J0LCAoKT0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFwic2lvIFNlcnZlciBsaXN0ZW5pbmcgYXQgcG9ydCAlZFwiLCBwb3J0KTtcbiAgICB9KTtcbiAgICBzaW8uc2V0KFwicmVzb3VyY2VcIiwgXCIvc29ja2V0LmlvXCIpO1xuICAgIHNpby5zZXQoXCJ0cmFuc3BvcnRzXCIsIHRoaXMub3B0cy50cmFuc3BvcnRzKTtcbiAgICBzaW8uc2V0KFwiaGVhcnRiZWF0IHRpbWVvdXRcIiwgdGhpcy5oZWFydGJlYXRUaW1lb3V0KTtcbiAgICBzaW8uc2V0KFwiaGVhcnRiZWF0IGludGVydmFsXCIsIHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWwpO1xuXG4gICAgc2lvLm9uKFwiY29ubmVjdGlvblwiLCAoc29ja2V0OmFueSkgPT4ge1xuICAgICAgbGV0IHNpb3NvY2tldCA9IG5ldyBTaW9Tb2NrZXQoY3VySWQrKywgc29ja2V0KTtcbiAgICAgIHRoaXMuZW1pdChcImNvbm5lY3Rpb25cIiwgc2lvc29ja2V0KTtcbiAgICAgIHNpb3NvY2tldC5vbihcImNsb3NpbmdcIiwgKHJlYXNvbik9PiB7XG4gICAgICAgIHNpb3NvY2tldC5zZW5kKHsgcm91dGU6IFwib25LaWNrXCIsIHJlYXNvbjogcmVhc29uIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcbiAgfVxuXG4gIHN0b3AoZm9yY2U6IGJvb2xlYW4sIGNiOiBGdW5jdGlvbikge1xuICAgIHRoaXMud3NvY2tldC5zZXJ2ZXIuY2xvc2UoKTtcbiAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcbiAgfVxuXG4gIGVuY29kZShyZXFJZDogbnVtYmVyLCByb3V0ZTogc3RyaW5nLCBtc2c6IGFueSkge1xuICAgIHJldHVybiBTaW9Db25uZWN0b3IuZW5jb2RlKHJlcUlkLCByb3V0ZSwgbXNnKTtcbiAgfVxuXG4gIHN0YXRpYyBlbmNvZGUocmVxSWQ6IG51bWJlciwgcm91dGU6IHN0cmluZywgbXNnOiBhbnkpIHtcbiAgICBpZiAocmVxSWQpIHtcbiAgICAgIHJldHVybiBjb21wb3NlUmVzcG9uc2UocmVxSWQsIHJvdXRlLCBtc2cpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gY29tcG9zZVB1c2gocm91dGUsIG1zZyk7XG4gICAgfVxuICB9XG5cbiAgZGVjb2RlKG1zZzogYW55KSB7XG4gICAgcmV0dXJuIFNpb0Nvbm5lY3Rvci5kZWNvZGUobXNnKTtcbiAgfVxuXG4gIHN0YXRpYyBkZWNvZGUobXNnOiBhbnkpIHtcbiAgICBsZXQgaW5kZXggPSAwO1xuXG4gICAgbGV0IGlkID0gcGFyc2VJbnRGaWVsZChtc2csIGluZGV4LCBQS0dfSURfQllURVMpO1xuICAgIGluZGV4ICs9IFBLR19JRF9CWVRFUztcblxuICAgIGxldCByb3V0ZUxlbiA9IHBhcnNlSW50RmllbGQobXNnLCBpbmRleCwgUEtHX1JPVVRFX0xFTkdUSF9CWVRFUyk7XG5cbiAgICBsZXQgcm91dGUgPSBtc2cuc3Vic3RyKFBLR19IRUFEX0JZVEVTLCByb3V0ZUxlbik7XG4gICAgbGV0IGJvZHkgPSBtc2cuc3Vic3RyKFBLR19IRUFEX0JZVEVTICsgcm91dGVMZW4pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiBpZCxcbiAgICAgIHJvdXRlOiByb3V0ZSxcbiAgICAgIGJvZHk6IEpTT04ucGFyc2UoYm9keSlcbiAgICB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXBvc2VSZXNwb25zZShtc2dJZDogbnVtYmVyLCByb3V0ZTogc3RyaW5nLCBtc2dCb2R5OiBhbnkpIHtcbiAgcmV0dXJuIHtcbiAgICBpZDogbXNnSWQsXG4gICAgYm9keTogbXNnQm9keVxuICB9O1xufVxuXG5mdW5jdGlvbiBjb21wb3NlUHVzaChyb3V0ZTogc3RyaW5nLCBtc2dCb2R5OiBhbnkpIHtcbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHsgcm91dGU6IHJvdXRlLCBib2R5OiBtc2dCb2R5IH0pO1xufVxuXG5mdW5jdGlvbiBwYXJzZUludEZpZWxkKHN0cjogc3RyaW5nLCBvZmZzZXQ6IG51bWJlciwgbGVuOiBudW1iZXIpIHtcbiAgbGV0IHJlcyA9IDA7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcbiAgICBpZiAoaSA+IDApIHtcbiAgICAgIHJlcyA8PD0gODtcbiAgICB9XG4gICAgcmVzIHw9IHN0ci5jaGFyQ29kZUF0KG9mZnNldCArIGkpICYgMHhmZjtcbiAgfVxuXG4gIHJldHVybiByZXM7XG59XG4iXX0=