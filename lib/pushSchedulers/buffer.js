"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils = require("../util/utils");
const DEFAULT_FLUSH_INTERVAL = 20;
exports.default = (app, opts) => {
    return new BufferPushScheduler(app, opts);
};
class BufferPushScheduler {
    constructor(app, opts) {
        this.app = app;
        this.flushInterval = opts.flushInterval || DEFAULT_FLUSH_INTERVAL;
        this.sessions = {}; // sid -> msg queue
        this.tid = null;
    }
    start(cb) {
        this.tid = setInterval(() => this.flush(), this.flushInterval);
        process.nextTick(function () {
            utils.invokeCallback(cb);
        });
    }
    stop(force, cb) {
        if (this.tid) {
            clearInterval(this.tid);
            this.tid = null;
        }
        process.nextTick(function () {
            utils.invokeCallback(cb);
        });
    }
    schedule(reqId, route, msg, recvs, opts, cb) {
        opts = opts || {};
        if (opts.type === "broadcast") {
            this.doBroadcast(msg, opts.userOptions);
        }
        else {
            this.doBatchPush(msg, recvs);
        }
        process.nextTick(() => {
            utils.invokeCallback(cb);
        });
    }
    doBroadcast(msg, opts) {
        let channelService = this.app.get("channelService");
        let sessionService = this.app.get("sessionService");
        if (opts.binded) {
            sessionService.forEachBindedSession((session) => {
                if (channelService.broadcastFilter &&
                    !channelService.broadcastFilter(session, msg, opts.filterParam)) {
                    return;
                }
                this.enqueue(session, msg);
            });
        }
        else {
            sessionService.forEachSession((session) => {
                if (channelService.broadcastFilter &&
                    !channelService.broadcastFilter(session, msg, opts.filterParam)) {
                    return;
                }
                this.enqueue(session, msg);
            });
        }
    }
    doBatchPush(msg, recvs) {
        let sessionService = this.app.get("sessionService");
        let session;
        for (let i = 0, l = recvs.length; i < l; i++) {
            session = sessionService.get(recvs[i]);
            if (session) {
                this.enqueue(session, msg);
            }
        }
    }
    enqueue(session, msg) {
        let queue = this.sessions[session.id];
        if (!queue) {
            queue = this.sessions[session.id] = [];
            session.once("closed", () => this.onClose(session));
        }
        queue.push(msg);
    }
    onClose(session) {
        delete this.sessions[session.id];
    }
    flush() {
        let sessionService = this.app.get("sessionService");
        let queue, session;
        for (let sid in this.sessions) {
            session = sessionService.get(sid);
            if (!session) {
                continue;
            }
            queue = this.sessions[sid];
            if (!queue || queue.length === 0) {
                continue;
            }
            session.sendBatch(queue);
            this.sessions[sid] = [];
        }
    }
}
exports.BufferPushScheduler = BufferPushScheduler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVmZmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYnVmZmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsdUNBQXdDO0FBRXhDLE1BQU0sc0JBQXNCLEdBQUcsRUFBRSxDQUFDO0FBRWxDLGtCQUFlLENBQUMsR0FBZ0IsRUFBRSxJQUFVLEVBQUUsRUFBRTtJQUM5QyxNQUFNLENBQUMsSUFBSSxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDNUMsQ0FBQyxDQUFDO0FBRUY7SUFJRSxZQUFxQixHQUFnQixFQUFFLElBQVU7UUFBNUIsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUNuQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLElBQUksc0JBQXNCLENBQUM7UUFDbEUsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUMsQ0FBQyxtQkFBbUI7UUFDdkMsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUM7SUFDbEIsQ0FBQztJQUNELEtBQUssQ0FBQyxFQUFhO1FBQ2pCLElBQUksQ0FBQyxHQUFHLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDL0QsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUNmLEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRyxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxDQUFDLEtBQWMsRUFBRSxFQUFhO1FBQ2hDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2IsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN4QixJQUFJLENBQUMsR0FBRyxHQUFRLElBQUksQ0FBQztRQUN2QixDQUFDO1FBQ0QsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUNmLEtBQUssQ0FBQyxjQUFj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LENBQUM7UUFDMUIsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXRIRCxrREFzSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCIuLi9cIjtcclxuaW1wb3J0IHV0aWxzID0gcmVxdWlyZShcIi4uL3V0aWwvdXRpbHNcIik7XHJcbmltcG9ydCB7IFNlc3Npb24gfSBmcm9tIFwiLi4vY29tbW9uL3NlcnZpY2Uvc2Vzc2lvblNlcnZpY2VcIjtcclxuY29uc3QgREVGQVVMVF9GTFVTSF9JTlRFUlZBTCA9IDIwO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgKGFwcDogQXBwbGljYXRpb24sIG9wdHM/OiBhbnkpID0+IHtcclxuICByZXR1cm4gbmV3IEJ1ZmZlclB1c2hTY2hlZHVsZXIoYXBwLCBvcHRzKTtcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBCdWZmZXJQdXNoU2NoZWR1bGVyIHtcclxuICBwcml2YXRlIGZsdXNoSW50ZXJ2YWw6IG51bWJlcjtcclxuICBwcml2YXRlIHNlc3Npb25zOiB7IFtpZHg6IG51bWJlcl06IGFueSB9O1xyXG4gIHByaXZhdGUgdGlkOiBhbnk7XHJcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgb3B0cz86IGFueSkge1xyXG4gICAgdGhpcy5mbHVzaEludGVydmFsID0gb3B0cy5mbHVzaEludGVydmFsIHx8IERFRkFVTFRfRkxVU0hfSU5URVJWQUw7XHJcbiAgICB0aGlzLnNlc3Npb25zID0ge307IC8vIHNpZCAtPiBtc2cgcXVldWVcclxuICAgIHRoaXMudGlkID0gbnVsbDtcclxuICB9XHJcbiAgc3RhcnQoY2I/OiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy50aWQgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzLmZsdXNoKCksIHRoaXMuZmx1c2hJbnRlcnZhbCk7XHJcbiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge1xyXG4gICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiEpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdG9wKGZvcmNlOiBib29sZWFuLCBjYj86IEZ1bmN0aW9uKSB7XHJcbiAgICBpZiAodGhpcy50aWQpIHtcclxuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnRpZCk7XHJcbiAgICAgIHRoaXMudGlkID0gPGFueT5udWxsO1xyXG4gICAgfVxyXG4gICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtcclxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2NoZWR1bGUoXHJcbiAgICByZXFJZDogbnVtYmVyLFxyXG4gICAgcm91dGU6IHN0cmluZyxcclxuICAgIG1zZzogYW55LFxyXG4gICAgcmVjdnM6IG51bWJlcltdLFxyXG4gICAgb3B0czogYW55LFxyXG4gICAgY2I/OiBGdW5jdGlvblxyXG4gICkge1xyXG4gICAgb3B0cyA9IG9wdHMgfHwge307XHJcbiAgICBpZiAob3B0cy50eXBlID09PSBcImJyb2FkY2FzdFwiKSB7XHJcbiAgICAgIHRoaXMuZG9Ccm9hZGNhc3QobXNnLCBvcHRzLnVzZXJPcHRpb25zKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZG9CYXRjaFB1c2gobXNnLCByZWN2cyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XHJcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBkb0Jyb2FkY2FzdChtc2c6IGFueSwgb3B0czogYW55KSB7XHJcbiAgICBsZXQgY2hhbm5lbFNlcnZpY2UgPSB0aGlzLmFwcC5nZXQoXCJjaGFubmVsU2VydmljZVwiKTtcclxuICAgIGxldCBzZXNzaW9uU2VydmljZSA9IHRoaXMuYXBwLmdldChcInNlc3Npb25TZXJ2aWNlXCIpO1xyXG5cclxuICAgIGlmIChvcHRzLmJpbmRlZCkge1xyXG4gICAgICBzZXNzaW9uU2VydmljZS5mb3JFYWNoQmluZGVkU2Vzc2lvbigoc2Vzc2lvbjogU2Vzc2lvbikgPT4ge1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgIGNoYW5uZWxTZXJ2aWNlLmJyb2FkY2FzdEZpbHRlciAmJlxyXG4gICAgICAgICAgIWNoYW5uZWxTZXJ2aWNlLmJyb2FkY2FzdEZpbHRlcihzZXNzaW9uLCBtc2csIG9wdHMuZmlsdGVyUGFyYW0pXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmVucXVldWUoc2Vzc2lvbiwgbXNnKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzZXNzaW9uU2VydmljZS5mb3JFYWNoU2Vzc2lvbigoc2Vzc2lvbjogU2Vzc2lvbikgPT4ge1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgIGNoYW5uZWxTZXJ2aWNlLmJyb2FkY2FzdEZpbHRlciAmJlxyXG4gICAgICAgICAgIWNoYW5uZWxTZXJ2aWNlLmJyb2FkY2FzdEZpbHRlcihzZXNzaW9uLCBtc2csIG9wdHMuZmlsdGVyUGFyYW0pXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmVucXVldWUoc2Vzc2lvbiwgbXNnKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZG9CYXRjaFB1c2gobXNnOiBhbnksIHJlY3ZzOiBudW1iZXJbXSkge1xyXG4gICAgbGV0IHNlc3Npb25TZXJ2aWNlID0gdGhpcy5hcHAuZ2V0KFwic2Vzc2lvblNlcnZpY2VcIik7XHJcbiAgICBsZXQgc2Vzc2lvbjtcclxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gcmVjdnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgIHNlc3Npb24gPSBzZXNzaW9uU2VydmljZS5nZXQocmVjdnNbaV0pO1xyXG4gICAgICBpZiAoc2Vzc2lvbikge1xyXG4gICAgICAgIHRoaXMuZW5xdWV1ZShzZXNzaW9uLCBtc2cpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZW5xdWV1ZShzZXNzaW9uOiBTZXNzaW9uLCBtc2c6IGFueSkge1xyXG4gICAgbGV0IHF1ZXVlID0gdGhpcy5zZXNzaW9uc1tzZXNzaW9uLmlkXTtcclxuICAgIGlmICghcXVldWUpIHtcclxuICAgICAgcXVldWUgPSB0aGlzLnNlc3Npb25zW3Nlc3Npb24uaWRdID0gW107XHJcbiAgICAgIHNlc3Npb24ub25jZShcImNsb3NlZFwiLCAoKSA9PiB0aGlzLm9uQ2xvc2Uoc2Vzc2lvbikpO1xyXG4gICAgfVxyXG5cclxuICAgIHF1ZXVlLnB1c2gobXNnKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBvbkNsb3NlKHNlc3Npb246IFNlc3Npb24pIHtcclxuICAgIGRlbGV0ZSB0aGlzLnNlc3Npb25zW3Nlc3Npb24uaWRdO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGZsdXNoKCkge1xyXG4gICAgbGV0IHNlc3Npb25TZXJ2aWNlID0gdGhpcy5hcHAuZ2V0KFwic2Vzc2lvblNlcnZpY2VcIik7XHJcbiAgICBsZXQgcXVldWUsIHNlc3Npb247XHJcbiAgICBmb3IgKGxldCBzaWQgaW4gdGhpcy5zZXNzaW9ucykge1xyXG4gICAgICBzZXNzaW9uID0gc2Vzc2lvblNlcnZpY2UuZ2V0KDxhbnk+c2lkKTtcclxuICAgICAgaWYgKCFzZXNzaW9uKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHF1ZXVlID0gdGhpcy5zZXNzaW9uc1tzaWRdO1xyXG4gICAgICBpZiAoIXF1ZXVlIHx8IHF1ZXVlLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBzZXNzaW9uLnNlbmRCYXRjaChxdWV1ZSk7XHJcbiAgICAgIHRoaXMuc2Vzc2lvbnNbc2lkXSA9IFtdO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=