"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils = require("../util/utils");
const DEFAULT_FLUSH_INTERVAL = 20;
exports.default = (app, opts) => {
    return new BufferPushScheduler(app, opts);
};
class BufferPushScheduler {
    constructor(app, opts) {
        this.app = app;
        this.flushInterval = opts.flushInterval || DEFAULT_FLUSH_INTERVAL;
        this.sessions = {}; // sid -> msg queue
        this.tid = null;
    }
    start(cb) {
        this.tid = setInterval(() => this.flush(), this.flushInterval);
        process.nextTick(function () {
            utils.invokeCallback(cb);
        });
    }
    stop(force, cb) {
        if (this.tid) {
            clearInterval(this.tid);
            this.tid = null;
        }
        process.nextTick(function () {
            utils.invokeCallback(cb);
        });
    }
    schedule(reqId, route, msg, recvs, opts, cb) {
        opts = opts || {};
        if (opts.type === "broadcast") {
            this.doBroadcast(msg, opts.userOptions);
        }
        else {
            this.doBatchPush(msg, recvs);
        }
        process.nextTick(() => {
            utils.invokeCallback(cb);
        });
    }
    doBroadcast(msg, opts) {
        let channelService = this.app.get("channelService");
        let sessionService = this.app.get("sessionService");
        if (opts.binded) {
            sessionService.forEachBindedSession((session) => {
                if (channelService.broadcastFilter &&
                    !channelService.broadcastFilter(session, msg, opts.filterParam)) {
                    return;
                }
                this.enqueue(session, msg);
            });
        }
        else {
            sessionService.forEachSession((session) => {
                if (channelService.broadcastFilter &&
                    !channelService.broadcastFilter(session, msg, opts.filterParam)) {
                    return;
                }
                this.enqueue(session, msg);
            });
        }
    }
    doBatchPush(msg, recvs) {
        let sessionService = this.app.get("sessionService");
        let session;
        for (let i = 0, l = recvs.length; i < l; i++) {
            session = sessionService.get(recvs[i]);
            if (session) {
                this.enqueue(session, msg);
            }
        }
    }
    enqueue(session, msg) {
        let queue = this.sessions[session.id];
        if (!queue) {
            queue = this.sessions[session.id] = [];
            session.once("closed", () => this.onClose(session));
        }
        queue.push(msg);
    }
    onClose(session) {
        delete this.sessions[session.id];
    }
    flush() {
        let sessionService = this.app.get("sessionService");
        let queue, session;
        for (let sid in this.sessions) {
            session = sessionService.get(sid);
            if (!session) {
                continue;
            }
            queue = this.sessions[sid];
            if (!queue || queue.length === 0) {
                continue;
            }
            session.sendBatch(queue);
            this.sessions[sid] = [];
        }
    }
}
exports.BufferPushScheduler = BufferPushScheduler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVmZmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYnVmZmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsdUNBQXdDO0FBRXhDLE1BQU0sc0JBQXNCLEdBQUcsRUFBRSxDQUFDO0FBRWxDLGtCQUFlLENBQUMsR0FBZ0IsRUFBRSxJQUFVLEVBQUUsRUFBRTtJQUM5QyxNQUFNLENBQUMsSUFBSSxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDNUMsQ0FBQyxDQUFDO0FBRUY7SUFJRSxZQUFxQixHQUFnQixFQUFFLElBQVU7UUFBNUIsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUNuQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLElBQUksc0JBQXNCLENBQUM7UUFDbEUsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUMsQ0FBQyxtQkFBbUI7UUFDdkMsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUM7SUFDbEIsQ0FBQztJQUNELEtBQUssQ0FBQyxFQUFhO1FBQ2pCLElBQUksQ0FBQyxHQUFHLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDL0QsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUNmLEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRyxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxDQUFDLEtBQWMsRUFBRSxFQUFhO1FBQ2hDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2IsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN4QixJQUFJLENBQUMsR0FBRyxHQUFRLElBQUksQ0FBQztRQUN2QixDQUFDO1FBQ0QsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUNmLEtBQUssQ0FBQyxjQUFj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LENBQUM7UUFDMUIsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXRIRCxrREFzSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCIuLi9cIjtcbmltcG9ydCB1dGlscyA9IHJlcXVpcmUoXCIuLi91dGlsL3V0aWxzXCIpO1xuaW1wb3J0IHsgU2Vzc2lvbiB9IGZyb20gXCIuLi9jb21tb24vc2VydmljZS9zZXNzaW9uU2VydmljZVwiO1xuY29uc3QgREVGQVVMVF9GTFVTSF9JTlRFUlZBTCA9IDIwO1xuXG5leHBvcnQgZGVmYXVsdCAoYXBwOiBBcHBsaWNhdGlvbiwgb3B0cz86IGFueSkgPT4ge1xuICByZXR1cm4gbmV3IEJ1ZmZlclB1c2hTY2hlZHVsZXIoYXBwLCBvcHRzKTtcbn07XG5cbmV4cG9ydCBjbGFzcyBCdWZmZXJQdXNoU2NoZWR1bGVyIHtcbiAgcHJpdmF0ZSBmbHVzaEludGVydmFsOiBudW1iZXI7XG4gIHByaXZhdGUgc2Vzc2lvbnM6IHsgW2lkeDogbnVtYmVyXTogYW55IH07XG4gIHByaXZhdGUgdGlkOiBhbnk7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGFwcDogQXBwbGljYXRpb24sIG9wdHM/OiBhbnkpIHtcbiAgICB0aGlzLmZsdXNoSW50ZXJ2YWwgPSBvcHRzLmZsdXNoSW50ZXJ2YWwgfHwgREVGQVVMVF9GTFVTSF9JTlRFUlZBTDtcbiAgICB0aGlzLnNlc3Npb25zID0ge307IC8vIHNpZCAtPiBtc2cgcXVldWVcbiAgICB0aGlzLnRpZCA9IG51bGw7XG4gIH1cbiAgc3RhcnQoY2I/OiBGdW5jdGlvbikge1xuICAgIHRoaXMudGlkID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5mbHVzaCgpLCB0aGlzLmZsdXNoSW50ZXJ2YWwpO1xuICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7XG4gICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiEpO1xuICAgIH0pO1xuICB9XG5cbiAgc3RvcChmb3JjZTogYm9vbGVhbiwgY2I/OiBGdW5jdGlvbikge1xuICAgIGlmICh0aGlzLnRpZCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnRpZCk7XG4gICAgICB0aGlzLnRpZCA9IDxhbnk+bnVsbDtcbiAgICB9XG4gICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XG4gICAgfSk7XG4gIH1cblxuICBzY2hlZHVsZShcbiAgICByZXFJZDogbnVtYmVyLFxuICAgIHJvdXRlOiBzdHJpbmcsXG4gICAgbXNnOiBhbnksXG4gICAgcmVjdnM6IG51bWJlcltdLFxuICAgIG9wdHM6IGFueSxcbiAgICBjYj86IEZ1bmN0aW9uXG4gICkge1xuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xuICAgIGlmIChvcHRzLnR5cGUgPT09IFwiYnJvYWRjYXN0XCIpIHtcbiAgICAgIHRoaXMuZG9Ccm9hZGNhc3QobXNnLCBvcHRzLnVzZXJPcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kb0JhdGNoUHVzaChtc2csIHJlY3ZzKTtcbiAgICB9XG5cbiAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XG4gICAgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZG9Ccm9hZGNhc3QobXNnOiBhbnksIG9wdHM6IGFueSkge1xuICAgIGxldCBjaGFubmVsU2VydmljZSA9IHRoaXMuYXBwLmdldChcImNoYW5uZWxTZXJ2aWNlXCIpO1xuICAgIGxldCBzZXNzaW9uU2VydmljZSA9IHRoaXMuYXBwLmdldChcInNlc3Npb25TZXJ2aWNlXCIpO1xuXG4gICAgaWYgKG9wdHMuYmluZGVkKSB7XG4gICAgICBzZXNzaW9uU2VydmljZS5mb3JFYWNoQmluZGVkU2Vzc2lvbigoc2Vzc2lvbjogU2Vzc2lvbikgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgY2hhbm5lbFNlcnZpY2UuYnJvYWRjYXN0RmlsdGVyICYmXG4gICAgICAgICAgIWNoYW5uZWxTZXJ2aWNlLmJyb2FkY2FzdEZpbHRlcihzZXNzaW9uLCBtc2csIG9wdHMuZmlsdGVyUGFyYW0pXG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZW5xdWV1ZShzZXNzaW9uLCBtc2cpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNlc3Npb25TZXJ2aWNlLmZvckVhY2hTZXNzaW9uKChzZXNzaW9uOiBTZXNzaW9uKSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBjaGFubmVsU2VydmljZS5icm9hZGNhc3RGaWx0ZXIgJiZcbiAgICAgICAgICAhY2hhbm5lbFNlcnZpY2UuYnJvYWRjYXN0RmlsdGVyKHNlc3Npb24sIG1zZywgb3B0cy5maWx0ZXJQYXJhbSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5lbnF1ZXVlKHNlc3Npb24sIG1zZyk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgZG9CYXRjaFB1c2gobXNnOiBhbnksIHJlY3ZzOiBudW1iZXJbXSkge1xuICAgIGxldCBzZXNzaW9uU2VydmljZSA9IHRoaXMuYXBwLmdldChcInNlc3Npb25TZXJ2aWNlXCIpO1xuICAgIGxldCBzZXNzaW9uO1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gcmVjdnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICBzZXNzaW9uID0gc2Vzc2lvblNlcnZpY2UuZ2V0KHJlY3ZzW2ldKTtcbiAgICAgIGlmIChzZXNzaW9uKSB7XG4gICAgICAgIHRoaXMuZW5xdWV1ZShzZXNzaW9uLCBtc2cpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBlbnF1ZXVlKHNlc3Npb246IFNlc3Npb24sIG1zZzogYW55KSB7XG4gICAgbGV0IHF1ZXVlID0gdGhpcy5zZXNzaW9uc1tzZXNzaW9uLmlkXTtcbiAgICBpZiAoIXF1ZXVlKSB7XG4gICAgICBxdWV1ZSA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbi5pZF0gPSBbXTtcbiAgICAgIHNlc3Npb24ub25jZShcImNsb3NlZFwiLCAoKSA9PiB0aGlzLm9uQ2xvc2Uoc2Vzc2lvbikpO1xuICAgIH1cblxuICAgIHF1ZXVlLnB1c2gobXNnKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBvbkNsb3NlKHNlc3Npb246IFNlc3Npb24pIHtcbiAgICBkZWxldGUgdGhpcy5zZXNzaW9uc1tzZXNzaW9uLmlkXTtcbiAgfVxuXG4gIHByb3RlY3RlZCBmbHVzaCgpIHtcbiAgICBsZXQgc2Vzc2lvblNlcnZpY2UgPSB0aGlzLmFwcC5nZXQoXCJzZXNzaW9uU2VydmljZVwiKTtcbiAgICBsZXQgcXVldWUsIHNlc3Npb247XG4gICAgZm9yIChsZXQgc2lkIGluIHRoaXMuc2Vzc2lvbnMpIHtcbiAgICAgIHNlc3Npb24gPSBzZXNzaW9uU2VydmljZS5nZXQoPGFueT5zaWQpO1xuICAgICAgaWYgKCFzZXNzaW9uKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBxdWV1ZSA9IHRoaXMuc2Vzc2lvbnNbc2lkXTtcbiAgICAgIGlmICghcXVldWUgfHwgcXVldWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBzZXNzaW9uLnNlbmRCYXRjaChxdWV1ZSk7XG4gICAgICB0aGlzLnNlc3Npb25zW3NpZF0gPSBbXTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==