"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const fs = require("fs");
const RemoteServer = require("pomelo-rpc").server;
class RemoteComponent {
    constructor(app, opts) {
        this.app = app;
        this.opts = opts;
        this.name = "__remote__";
        this.app = app;
        this.opts = opts;
    }
    start(cb) {
        this.opts.port = this.app.curServer.port;
        this.remote = genRemote(this.app, this.opts);
        this.remote.start();
        process.nextTick(cb);
    }
    stop(force, cb) {
        this.remote.stop(force);
        process.nextTick(cb);
    }
}
exports.RemoteComponent = RemoteComponent;
function getRemotePaths(app) {
    let paths = [];
    let role;
    // master server should not come here
    if (app.isFrontend()) {
        role = "frontend";
    }
    else {
        role = "backend";
    }
    let sysPath = index_1.pathUtil.getSysRemotePath(role), serverType = app.serverType;
    if (fs.existsSync(sysPath)) {
        paths.push(index_1.pathUtil.remotePathRecord("sys", serverType, sysPath));
    }
    let userPath = index_1.pathUtil.getUserRemotePath(app.base, serverType);
    if (fs.existsSync(userPath)) {
        paths.push(index_1.pathUtil.remotePathRecord("user", serverType, userPath));
    }
    return paths;
}
function genRemote(app, opts) {
    opts.paths = getRemotePaths(app);
    opts.context = app;
    if (!!opts.rpcServer) {
        return opts.rpcServer.create(opts);
    }
    else {
        return RemoteServer.create(opts);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3RlU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlbW90ZVNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBK0Q7QUFDL0QseUJBQTBCO0FBQzFCLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFFbEQ7SUFHRSxZQUFxQixHQUFnQixFQUFVLElBQVM7UUFBbkMsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUFVLFNBQUksR0FBSixJQUFJLENBQUs7UUFGL0MsU0FBSSxHQUFHLFlBQVksQ0FBQztRQUczQixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFDRCxLQUFLLENBQUMsRUFBWTtRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7UUFDekMsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxJQUFJLENBQUMsS0FBYyxFQUFFLEVBQVk7UUFDL0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2QixDQUFDO0NBQ0Y7QUFsQkQsMENBa0JDO0FBRUQsd0JBQXdCLEdBQWdCO0lBQ3RDLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUVmLElBQUksSUFBSSxDQUFDO0lBQ1QscUNBQXFDO0lBQ3JDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckIsSUFBSSxHQUFHLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixJQUFJLEdBQUcsU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRCxJQUFJLE9BQU8sR0FBRyxnQkFBUSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUMzQyxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQztJQUM5QixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1QixLQUFLLENBQUMsSUFBSSxDQUFDLGdCQUFRLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRSxPQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFDRCxJQUFJLFFBQVEsR0FBRyxnQkFBUSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDaEUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0IsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBUSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUyxDQUFDLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQztBQUNmLENBQUM7QUFFRCxtQkFBbUIsR0FBZ0IsRUFBRSxJQUFVO0lBQzdDLElBQUksQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pDLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO0lBQ25CLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEFwcGxpY2F0aW9uLCBwYXRoVXRpbCB9IGZyb20gXCIuLi8uLi9pbmRleFwiO1xuaW1wb3J0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuY29uc3QgUmVtb3RlU2VydmVyID0gcmVxdWlyZShcInBvbWVsby1ycGNcIikuc2VydmVyO1xuXG5leHBvcnQgY2xhc3MgUmVtb3RlQ29tcG9uZW50IGltcGxlbWVudHMgQ29tcG9uZW50IHtcbiAgcmVhZG9ubHkgbmFtZSA9IFwiX19yZW1vdGVfX1wiO1xuICBwcml2YXRlIHJlbW90ZTogYW55OyAvL1RPRE9cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgcHJpdmF0ZSBvcHRzOiBhbnkpIHtcbiAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xuICB9XG4gIHN0YXJ0KGNiOiBGdW5jdGlvbikge1xuICAgIHRoaXMub3B0cy5wb3J0ID0gdGhpcy5hcHAuY3VyU2VydmVyLnBvcnQ7XG4gICAgdGhpcy5yZW1vdGUgPSBnZW5SZW1vdGUodGhpcy5hcHAsIHRoaXMub3B0cyk7XG4gICAgdGhpcy5yZW1vdGUuc3RhcnQoKTtcbiAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcbiAgfVxuXG4gIHN0b3AoZm9yY2U6IGJvb2xlYW4sIGNiOiBGdW5jdGlvbikge1xuICAgIHRoaXMucmVtb3RlLnN0b3AoZm9yY2UpO1xuICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFJlbW90ZVBhdGhzKGFwcDogQXBwbGljYXRpb24pIHtcbiAgbGV0IHBhdGhzID0gW107XG5cbiAgbGV0IHJvbGU7XG4gIC8vIG1hc3RlciBzZXJ2ZXIgc2hvdWxkIG5vdCBjb21lIGhlcmVcbiAgaWYgKGFwcC5pc0Zyb250ZW5kKCkpIHtcbiAgICByb2xlID0gXCJmcm9udGVuZFwiO1xuICB9IGVsc2Uge1xuICAgIHJvbGUgPSBcImJhY2tlbmRcIjtcbiAgfVxuXG4gIGxldCBzeXNQYXRoID0gcGF0aFV0aWwuZ2V0U3lzUmVtb3RlUGF0aChyb2xlKSxcbiAgICBzZXJ2ZXJUeXBlID0gYXBwLnNlcnZlclR5cGU7XG4gIGlmIChmcy5leGlzdHNTeW5jKHN5c1BhdGghKSkge1xuICAgIHBhdGhzLnB1c2gocGF0aFV0aWwucmVtb3RlUGF0aFJlY29yZChcInN5c1wiLCBzZXJ2ZXJUeXBlLCBzeXNQYXRoISkpO1xuICB9XG4gIGxldCB1c2VyUGF0aCA9IHBhdGhVdGlsLmdldFVzZXJSZW1vdGVQYXRoKGFwcC5iYXNlLCBzZXJ2ZXJUeXBlKTtcbiAgaWYgKGZzLmV4aXN0c1N5bmModXNlclBhdGghKSkge1xuICAgIHBhdGhzLnB1c2gocGF0aFV0aWwucmVtb3RlUGF0aFJlY29yZChcInVzZXJcIiwgc2VydmVyVHlwZSwgdXNlclBhdGghKSk7XG4gIH1cblxuICByZXR1cm4gcGF0aHM7XG59XG5cbmZ1bmN0aW9uIGdlblJlbW90ZShhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XG4gIG9wdHMucGF0aHMgPSBnZXRSZW1vdGVQYXRocyhhcHApO1xuICBvcHRzLmNvbnRleHQgPSBhcHA7XG4gIGlmICghIW9wdHMucnBjU2VydmVyKSB7XG4gICAgcmV0dXJuIG9wdHMucnBjU2VydmVyLmNyZWF0ZShvcHRzKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gUmVtb3RlU2VydmVyLmNyZWF0ZShvcHRzKTtcbiAgfVxufVxuIl19