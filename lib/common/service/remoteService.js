"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const fs = require("fs");
const RemoteServer = require("pomelo-rpc").server;
class RemoteComponent {
    constructor(app, opts) {
        this.app = app;
        this.opts = opts;
        this.name = "__remote__";
        this.app = app;
        this.opts = opts;
    }
    start(cb) {
        this.opts.port = this.app.curServer.port;
        this.remote = genRemote(this.app, this.opts);
        this.remote.start();
        process.nextTick(cb);
    }
    stop(force, cb) {
        this.remote.stop(force);
        process.nextTick(cb);
    }
}
exports.RemoteComponent = RemoteComponent;
function getRemotePaths(app) {
    let paths = [];
    let role;
    // master server should not come here
    if (app.isFrontend()) {
        role = "frontend";
    }
    else {
        role = "backend";
    }
    let sysPath = index_1.pathUtil.getSysRemotePath(role), serverType = app.serverType;
    if (fs.existsSync(sysPath)) {
        paths.push(index_1.pathUtil.remotePathRecord("sys", serverType, sysPath));
    }
    let userPath = index_1.pathUtil.getUserRemotePath(app.base, serverType);
    if (fs.existsSync(userPath)) {
        paths.push(index_1.pathUtil.remotePathRecord("user", serverType, userPath));
    }
    return paths;
}
function genRemote(app, opts) {
    opts.paths = getRemotePaths(app);
    opts.context = app;
    if (!!opts.rpcServer) {
        return opts.rpcServer.create(opts);
    }
    else {
        return RemoteServer.create(opts);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3RlU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlbW90ZVNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBK0Q7QUFDL0QseUJBQTBCO0FBQzFCLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFFbEQ7SUFHRSxZQUFxQixHQUFnQixFQUFVLElBQVM7UUFBbkMsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUFVLFNBQUksR0FBSixJQUFJLENBQUs7UUFGL0MsU0FBSSxHQUFHLFlBQVksQ0FBQztRQUczQixJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFDRCxLQUFLLENBQUMsRUFBWTtRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7UUFDekMsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxJQUFJLENBQUMsS0FBYyxFQUFFLEVBQVk7UUFDL0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEIsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2QixDQUFDO0NBQ0Y7QUFsQkQsMENBa0JDO0FBRUQsd0JBQXdCLEdBQWdCO0lBQ3RDLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUVmLElBQUksSUFBSSxDQUFDO0lBQ1QscUNBQXFDO0lBQ3JDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckIsSUFBSSxHQUFHLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixJQUFJLEdBQUcsU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRCxJQUFJLE9BQU8sR0FBRyxnQkFBUSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUMzQyxVQUFVLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQztJQUM5QixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1QixLQUFLLENBQUMsSUFBSSxDQUFDLGdCQUFRLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRSxPQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFDRCxJQUFJLFFBQVEsR0FBRyxnQkFBUSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDaEUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0IsS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBUSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUyxDQUFDLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQztBQUNmLENBQUM7QUFFRCxtQkFBbUIsR0FBZ0IsRUFBRSxJQUFVO0lBQzdDLElBQUksQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pDLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO0lBQ25CLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEFwcGxpY2F0aW9uLCBwYXRoVXRpbCB9IGZyb20gXCIuLi8uLi9pbmRleFwiO1xyXG5pbXBvcnQgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmNvbnN0IFJlbW90ZVNlcnZlciA9IHJlcXVpcmUoXCJwb21lbG8tcnBjXCIpLnNlcnZlcjtcclxuXHJcbmV4cG9ydCBjbGFzcyBSZW1vdGVDb21wb25lbnQgaW1wbGVtZW50cyBDb21wb25lbnQge1xyXG4gIHJlYWRvbmx5IG5hbWUgPSBcIl9fcmVtb3RlX19cIjtcclxuICBwcml2YXRlIHJlbW90ZTogYW55OyAvL1RPRE9cclxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uLCBwcml2YXRlIG9wdHM6IGFueSkge1xyXG4gICAgdGhpcy5hcHAgPSBhcHA7XHJcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xyXG4gIH1cclxuICBzdGFydChjYjogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMub3B0cy5wb3J0ID0gdGhpcy5hcHAuY3VyU2VydmVyLnBvcnQ7XHJcbiAgICB0aGlzLnJlbW90ZSA9IGdlblJlbW90ZSh0aGlzLmFwcCwgdGhpcy5vcHRzKTtcclxuICAgIHRoaXMucmVtb3RlLnN0YXJ0KCk7XHJcbiAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcclxuICB9XHJcblxyXG4gIHN0b3AoZm9yY2U6IGJvb2xlYW4sIGNiOiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5yZW1vdGUuc3RvcChmb3JjZSk7XHJcbiAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFJlbW90ZVBhdGhzKGFwcDogQXBwbGljYXRpb24pIHtcclxuICBsZXQgcGF0aHMgPSBbXTtcclxuXHJcbiAgbGV0IHJvbGU7XHJcbiAgLy8gbWFzdGVyIHNlcnZlciBzaG91bGQgbm90IGNvbWUgaGVyZVxyXG4gIGlmIChhcHAuaXNGcm9udGVuZCgpKSB7XHJcbiAgICByb2xlID0gXCJmcm9udGVuZFwiO1xyXG4gIH0gZWxzZSB7XHJcbiAgICByb2xlID0gXCJiYWNrZW5kXCI7XHJcbiAgfVxyXG5cclxuICBsZXQgc3lzUGF0aCA9IHBhdGhVdGlsLmdldFN5c1JlbW90ZVBhdGgocm9sZSksXHJcbiAgICBzZXJ2ZXJUeXBlID0gYXBwLnNlcnZlclR5cGU7XHJcbiAgaWYgKGZzLmV4aXN0c1N5bmMoc3lzUGF0aCEpKSB7XHJcbiAgICBwYXRocy5wdXNoKHBhdGhVdGlsLnJlbW90ZVBhdGhSZWNvcmQoXCJzeXNcIiwgc2VydmVyVHlwZSwgc3lzUGF0aCEpKTtcclxuICB9XHJcbiAgbGV0IHVzZXJQYXRoID0gcGF0aFV0aWwuZ2V0VXNlclJlbW90ZVBhdGgoYXBwLmJhc2UsIHNlcnZlclR5cGUpO1xyXG4gIGlmIChmcy5leGlzdHNTeW5jKHVzZXJQYXRoISkpIHtcclxuICAgIHBhdGhzLnB1c2gocGF0aFV0aWwucmVtb3RlUGF0aFJlY29yZChcInVzZXJcIiwgc2VydmVyVHlwZSwgdXNlclBhdGghKSk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcGF0aHM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdlblJlbW90ZShhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XHJcbiAgb3B0cy5wYXRocyA9IGdldFJlbW90ZVBhdGhzKGFwcCk7XHJcbiAgb3B0cy5jb250ZXh0ID0gYXBwO1xyXG4gIGlmICghIW9wdHMucnBjU2VydmVyKSB7XHJcbiAgICByZXR1cm4gb3B0cy5ycGNTZXJ2ZXIuY3JlYXRlKG9wdHMpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gUmVtb3RlU2VydmVyLmNyZWF0ZShvcHRzKTtcclxuICB9XHJcbn1cclxuIl19