"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
class ChannelRemote {
    constructor(app) {
        this.app = app;
    }
    pushMessage(route, msg, uids, opts, cb) {
        if (!msg) {
            logger.error("Can not send empty message! route : %j, compressed msg : %j", route, msg);
            index_1.utils.invokeCallback(cb, new Error("can not send empty message."));
            return;
        }
        let connector = this.app.components.__connector__;
        let sessionService = this.app.get("sessionService");
        let fails = [];
        let sids = [];
        for (let i = 0, l = uids.length; i < l; i++) {
            let sessions = sessionService.getByUid(uids[i]);
            if (!sessions) {
                fails.push(uids[i]);
            }
            else {
                for (let j = 0, k = sessions.length; j < k; j++) {
                    sids.push(sessions[j].id);
                }
            }
        }
        logger.debug("[%s] pushMessage uids: %j, msg: %j, sids: %j", this.app.serverId, uids, msg, sids);
        connector.send(null, route, msg, sids, opts, (err) => {
            index_1.utils.invokeCallback(cb, err, fails);
        });
    }
    broadcast(route, msg, opts, cb) {
        let connector = this.app.components.__connector__;
        connector.send(null, route, msg, null, opts, cb);
    }
}
exports.ChannelRemote = ChannelRemote;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbm5lbFJlbW90ZVNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjaGFubmVsUmVtb3RlU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUFpRDtBQUNqRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUV4RTtJQUNFLFlBQXFCLEdBQWdCO1FBQWhCLFFBQUcsR0FBSCxHQUFHLENBQWE7SUFBRyxDQUFDO0lBRXpDLFdBQVcsQ0FBQyxLQUFZLEVBQUUsR0FBTyxFQUFFLElBQWEsRUFBRSxJQUFRLEVBQUUsRUFBVztRQUNyRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDVCxNQUFNLENBQUMsS0FBSyxDQUNWLDZEQUE2RCxFQUM3RCxLQUFLLEVBQ0wsR0FBRyxDQUNKLENBQUM7WUFDRixhQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsRUFBRSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDLENBQUM7WUFDbkUsTUFBTSxDQUFDO1FBQ1QsQ0FBQztRQUVELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztRQUVsRCxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3BELElBQUksS0FBSyxHQUFZLEVBQUUsQ0FBQztRQUN4QixJQUFJLElBQUksR0FBWSxFQUFFLENBQUM7UUFDdkIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUM1QyxJQUFJLFFBQVEsR0FBRyxjQUFjLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hELEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDZCxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUNoRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDNUIsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO1FBQ0QsTUFBTSxDQUFDLEtBQUssQ0FDViw4Q0FBOEMsRUFDOUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQ2pCLElBQUksRUFDSixHQUFHLEVBQ0gsSUFBSSxDQUNMLENBQUM7UUFDRixTQUFTLENBQUMsSUFBSSxDQUFDLElBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFPLEVBQUMsRUFBRTtZQUN2RCxhQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsU0FBUyxDQUFDLEtBQVksRUFBRSxHQUFPLEVBQUUsSUFBUSxFQUFFLEVBQVc7UUFDcEQsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDO1FBRWxELFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsSUFBSyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNyRCxDQUFDO0NBQ0Y7QUE5Q0Qsc0NBOENDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwbGljYXRpb24sIHV0aWxzIH0gZnJvbSBcIi4uLy4uL2luZGV4XCI7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcclxuXHJcbmV4cG9ydCBjbGFzcyBDaGFubmVsUmVtb3RlIHtcclxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uKSB7fVxyXG5cclxuICBwdXNoTWVzc2FnZShyb3V0ZTpzdHJpbmcsIG1zZzphbnksIHVpZHM6c3RyaW5nW10sIG9wdHM6YW55LCBjYjpGdW5jdGlvbikge1xyXG4gICAgaWYgKCFtc2cpIHtcclxuICAgICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAgIFwiQ2FuIG5vdCBzZW5kIGVtcHR5IG1lc3NhZ2UhIHJvdXRlIDogJWosIGNvbXByZXNzZWQgbXNnIDogJWpcIixcclxuICAgICAgICByb3V0ZSxcclxuICAgICAgICBtc2dcclxuICAgICAgKTtcclxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIG5ldyBFcnJvcihcImNhbiBub3Qgc2VuZCBlbXB0eSBtZXNzYWdlLlwiKSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgY29ubmVjdG9yID0gdGhpcy5hcHAuY29tcG9uZW50cy5fX2Nvbm5lY3Rvcl9fO1xyXG5cclxuICAgIGxldCBzZXNzaW9uU2VydmljZSA9IHRoaXMuYXBwLmdldChcInNlc3Npb25TZXJ2aWNlXCIpO1xyXG4gICAgbGV0IGZhaWxzOnN0cmluZ1tdID0gW107XHJcbiAgICBsZXQgc2lkczpudW1iZXJbXSA9IFtdO1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSB1aWRzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICBsZXQgc2Vzc2lvbnMgPSBzZXNzaW9uU2VydmljZS5nZXRCeVVpZCh1aWRzW2ldKTtcclxuICAgICAgaWYgKCFzZXNzaW9ucykge1xyXG4gICAgICAgIGZhaWxzLnB1c2godWlkc1tpXSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZm9yIChsZXQgaiA9IDAsIGsgPSBzZXNzaW9ucy5sZW5ndGg7IGogPCBrOyBqKyspIHtcclxuICAgICAgICAgIHNpZHMucHVzaChzZXNzaW9uc1tqXS5pZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBsb2dnZXIuZGVidWcoXHJcbiAgICAgIFwiWyVzXSBwdXNoTWVzc2FnZSB1aWRzOiAlaiwgbXNnOiAlaiwgc2lkczogJWpcIixcclxuICAgICAgdGhpcy5hcHAuc2VydmVySWQsXHJcbiAgICAgIHVpZHMsXHJcbiAgICAgIG1zZyxcclxuICAgICAgc2lkc1xyXG4gICAgKTtcclxuICAgIGNvbm5lY3Rvci5zZW5kKG51bGwhLCByb3V0ZSwgbXNnLCBzaWRzLCBvcHRzLCAoZXJyOmFueSk9PiB7XHJcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiLCBlcnIsIGZhaWxzKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYnJvYWRjYXN0KHJvdXRlOnN0cmluZywgbXNnOmFueSwgb3B0czphbnksIGNiOkZ1bmN0aW9uKSB7XHJcbiAgICBsZXQgY29ubmVjdG9yID0gdGhpcy5hcHAuY29tcG9uZW50cy5fX2Nvbm5lY3Rvcl9fO1xyXG5cclxuICAgIGNvbm5lY3Rvci5zZW5kKG51bGwhLCByb3V0ZSwgbXNnLCBudWxsISwgb3B0cywgY2IpO1xyXG4gIH1cclxufVxyXG4iXX0=