"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const events_1 = require("events");
const index_1 = require("../../index");
const dns_1 = require("dns");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const FRONTEND_SESSION_FIELDS = ["id", "frontendId", "uid", "sessionService"];
const EXPORTED_SESSION_FIELDS = ["id", "frontendId", "uid", "settings"];
var State;
(function (State) {
    State[State["ST_INITED"] = 0] = "ST_INITED";
    State[State["ST_CLOSED"] = 1] = "ST_CLOSED";
})(State || (State = {}));
class Session extends events_1.EventEmitter {
    constructor(id, frontendId, _socket, _sessionService) {
        super();
        this.id = id;
        this.frontendId = frontendId;
        this._socket = _socket;
        this._sessionService = _sessionService;
        this._state = State.ST_INITED;
        this._settings = {};
    }
    get uid() {
        return this._uid;
    }
    set uid(val) {
        this._uid = val;
    }
    get socket() {
        return this._socket;
    }
    get sessionService() {
        return this._sessionService;
    }
    set sessionService(val) {
        this._sessionService = val;
    }
    get settings() {
        return this._settings;
    }
    toFrontendSession() {
        return new FrontendSession(this);
    }
    bind(uid) {
        this._uid = uid;
        this.emit("bind", uid);
    }
    unbind(uid) {
        delete this._uid;
        this.emit("unbind", uid);
    }
    set(key, val) {
        if (util_1.isObject(key)) {
            for (let i in key) {
                this._settings[i] = key[i];
            }
        }
        else {
            this._settings[key] = val;
        }
    }
    get(key) {
        return this._settings[key];
    }
    send(msg) {
        this._socket.send(msg);
    }
    sendBatch(msgs) {
        this._socket.sendBatch(msgs);
    }
    closed(reason) {
        logger.debug("session on [%s] is closed with session id: %s", this.frontendId, this.id);
        if (this._state === State.ST_CLOSED) {
            return;
        }
        this._state = State.ST_CLOSED;
        this._sessionService.remove(this.id);
        this.emit("closed", this.toFrontendSession(), reason);
        this._socket.emit("closing", reason);
        process.nextTick(() => {
            this._socket.disconnect();
        });
    }
}
exports.Session = Session;
class FrontendSession extends Session {
    constructor(_session) {
        super(_session.id, _session.frontendId, _session.socket, _session.sessionService);
        this._session = _session;
        clone(_session, this, FRONTEND_SESSION_FIELDS);
        this._settings = dclone(_session.settings);
    }
    bind(uid, cb) {
        this._sessionService.bind(this.id, uid, (err) => {
            if (!err) {
                this._uid = uid;
            }
            index_1.utils.invokeCallback(cb, err);
        });
    }
    unbind(uid, cb) {
        this._sessionService.unbind(this.id, uid, (err) => {
            if (!err) {
                delete this._uid;
            }
            index_1.utils.invokeCallback(cb, err);
        });
    }
    push(key, cb) {
        this._sessionService.import(this.id, key, this.get(key), cb);
    }
    pushAll(cb) {
        this._sessionService.importAll(this.id, this._settings, cb);
    }
    on(event, listener) {
        events_1.EventEmitter.prototype.on.call(this, event, listener);
        this._session.on(event, listener);
        return this;
    }
    export() {
        let res = {};
        clone(this, res, EXPORTED_SESSION_FIELDS);
        return res;
    }
}
exports.FrontendSession = FrontendSession;
class SessionService {
    constructor(opts) {
        this._singleSession = false;
        opts = opts || {};
        this._singleSession = opts.singleSession;
        this._sessions = {}; // sid -> session
        this._uidMap = {}; // uid -> sessions
    }
    get singleSession() {
        return this._singleSession;
    }
    get sessions() {
        return this._sessions;
    }
    get uidMap() {
        return this._uidMap;
    }
    create(sid, frontendId, socket) {
        let session = new Session(sid, frontendId, socket, this);
        this._sessions[session.id] = session;
        return session;
    }
    bind(sid, uid, cb) {
        const session = this._sessions[sid];
        if (!session) {
            process.nextTick(() => {
                cb(new Error("session does not exist, sid: " + sid));
            });
            return;
        }
        if (session.uid) {
            if (session.uid === uid) {
                // already bound with the same uid
                cb();
                return;
            }
            // already bound with other uid
            process.nextTick(() => {
                cb(new Error("session has already bind with " + session.uid));
            });
            return;
        }
        let sessions = this.uidMap[uid];
        if (this.singleSession && !!sessions) {
            process.nextTick(() => {
                cb(new Error("singleSession is enabled, and session has already bind with uid: " +
                    uid));
            });
            return;
        }
        if (!sessions) {
            sessions = this._uidMap[uid] = [];
        }
        for (let i = 0, l = sessions.length; i < l; i++) {
            // session has binded with the uid
            if (sessions[i].id === session.id) {
                process.nextTick(cb);
                return;
            }
        }
        sessions.push(session);
        session.bind(uid);
        if (cb) {
            process.nextTick(cb);
        }
    }
    unbind(sid, uid, cb) {
        const session = this.sessions[sid];
        if (!session) {
            process.nextTick(() => {
                cb(new Error("session does not exist, sid: " + sid));
            });
            return;
        }
        if (!session.uid || session.uid !== uid) {
            process.nextTick(() => {
                cb(new Error("session has not bind with " + session.uid));
            });
            return;
        }
        let sessions = this._uidMap[uid];
        let sess;
        if (sessions) {
            for (let i = 0, l = sessions.length; i < l; i++) {
                sess = sessions[i];
                if (sess.id === sid) {
                    sessions.splice(i, 1);
                    break;
                }
            }
            if (sessions.length === 0) {
                delete this._uidMap[uid];
            }
        }
        session.unbind(uid);
        if (cb) {
            process.nextTick(cb);
        }
    }
    get(sid) {
        return this._sessions[sid];
    }
    getByUid(uid) {
        return this._uidMap[uid];
    }
    remove(sid) {
        const session = this._sessions[sid];
        if (session) {
            let uid = session.uid;
            delete this._sessions[session.id];
            let sessions = this._uidMap[uid];
            if (!sessions) {
                return;
            }
            for (let i = 0, l = sessions.length; i < l; i++) {
                if (sessions[i].id === sid) {
                    sessions.splice(i, 1);
                    if (sessions.length === 0) {
                        delete this._uidMap[uid];
                    }
                    break;
                }
            }
        }
    }
    import(sid, key, value, cb) {
        const session = this.sessions[sid];
        if (!session) {
            index_1.utils.invokeCallback(cb, new Error("session does not exist, sid: " + sid));
            return;
        }
        session.set(key, value);
        index_1.utils.invokeCallback(cb);
    }
    importAll(sid, settings, cb) {
        let session = this.sessions[sid];
        if (!session) {
            index_1.utils.invokeCallback(cb, new Error("session does not exist, sid: " + sid));
            return;
        }
        for (let f in settings) {
            session.set(f, settings[f]);
        }
        index_1.utils.invokeCallback(cb);
    }
    kick(uid, reason, cb) {
        if (typeof reason === "function") {
            cb = reason;
            reason = "kick";
        }
        let sessions = this.getByUid(uid);
        if (sessions) {
            // notify client
            let sids = [];
            sessions.forEach(session => {
                sids.push(session.id);
            });
            sids.forEach(sid => {
                this._sessions[sid].closed(reason);
            });
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb);
            });
        }
        else {
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb);
            });
        }
    }
    kickBySessionId(sid, reason, cb) {
        if (typeof reason === "function") {
            cb = reason;
            reason = "kick";
        }
        let session = this.get(sid);
        if (session) {
            // notify client
            session.closed(reason);
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb);
            });
        }
        else {
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb);
            });
        }
    }
    getClientAddressBySessionId(sid) {
        let session = this.get(sid);
        if (session) {
            let socket = session.socket;
            return socket.remoteAddress;
        }
        else {
            return null;
        }
    }
    sendMessage(sid, msg) {
        let session = this.get(sid);
        if (!session) {
            logger.debug("Fail to send message for non-existing session, sid: " +
                sid +
                " msg: " +
                msg);
            return false;
        }
        session.send(msg);
        return true;
    }
    sendMessageByUid(uid, msg) {
        let sessions = this.getByUid(uid);
        if (!sessions) {
            logger.debug("fail to send message by uid for non-existing session. uid: %j", uid);
            return false;
        }
        for (let i = 0, l = sessions.length; i < l; i++) {
            sessions[i].send(msg);
        }
        return true;
    }
    forEachSession(cb) {
        for (let sid in this.sessions) {
            cb(this.sessions[sid]);
        }
    }
    forEachBindedSession(cb) {
        for (let uid in this.uidMap) {
            let sessions = this.uidMap[uid];
            for (let i = 0, l = sessions.length; i < l; i++) {
                cb(sessions[i]);
            }
        }
    }
    getSessionCount() {
        return index_1.utils.size(this.sessions);
    }
}
exports.SessionService = SessionService;
class SessionComponent {
    constructor(app, opts) {
        this.app = app;
        this.name = "__session__";
        opts = opts || {};
        this.service = new SessionService(opts);
    }
    create(sid, frontendId, socket) {
        return this.service.create(sid, frontendId, socket);
    }
    bind(sid, uid, cb) {
        this.service.bind(sid, uid, cb);
    }
    unbind(sid, uid, cb) {
        this.service.unbind(sid, uid, cb);
    }
    get(sid) {
        return this.service.get(sid);
    }
    getByUid(uid) {
        return this.service.getByUid(uid);
    }
    remove(sid) {
        this.service.remove(sid);
    }
    import(sid, key, value, cb) {
        this.service.import(sid, key, value, cb);
    }
    importAll(sid, settings, cb) {
        this.service.importAll(sid, settings, cb);
    }
    kick(uid, reason, cb) {
        this.service.kick(uid, dns_1.resolveNaptr, cb);
    }
    kickBySessionId(sid, reason, cb) {
        this.service.kickBySessionId(sid, reason, cb);
    }
    getClientAddressBySessionId(sid) {
        return this.service.getClientAddressBySessionId(sid);
    }
    sendMessage(sid, msg) {
        return this.service.sendMessage(sid, msg);
    }
    sendMessageByUid(uid, msg) {
        return this.service.sendMessageByUid(uid, msg);
    }
    forEachSession(cb) {
        this.service.forEachSession(cb);
    }
    forEachBindedSession(cb) {
        this.service.forEachBindedSession(cb);
    }
    getSessionCount() {
        return this.service.getSessionCount();
    }
}
exports.SessionComponent = SessionComponent;
function clone(src, dest, includes) {
    let f;
    for (let i = 0, l = includes.length; i < l; i++) {
        f = includes[i];
        dest[f] = src[f];
    }
}
function dclone(src) {
    let res = {};
    for (let f in src) {
        res[f] = src[f];
    }
    return res;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvblNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXNzaW9uU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUFnQztBQUNoQyxtQ0FBc0M7QUFDdEMsdUNBQStFO0FBQy9FLDZCQUFtQztBQUVuQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUt4RSxNQUFNLHVCQUF1QixHQUFHLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztBQUM5RSxNQUFNLHVCQUF1QixHQUFHLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFeEUsSUFBSyxLQUdKO0FBSEQsV0FBSyxLQUFLO0lBQ1IsMkNBQWEsQ0FBQTtJQUNiLDJDQUFhLENBQUE7QUFDZixDQUFDLEVBSEksS0FBSyxLQUFMLEtBQUssUUFHVDtBQUVELGFBQXFCLFNBQVEscUJBQVk7SUFLdkMsWUFDa0IsRUFBVSxFQUNWLFVBQWtCLEVBQ3hCLE9BQWdCLEVBQ2hCLGVBQStCO1FBRXpDLEtBQUssRUFBRSxDQUFDO1FBTFEsT0FBRSxHQUFGLEVBQUUsQ0FBUTtRQUNWLGVBQVUsR0FBVixVQUFVLENBQVE7UUFDeEIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUNoQixvQkFBZSxHQUFmLGVBQWUsQ0FBZ0I7UUFHekMsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQzlCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFDRCxJQUFJLEdBQUc7UUFDTCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDO0lBQ0QsSUFBSSxHQUFHLENBQUMsR0FBVztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcs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QUcsR0FBRyxFQUFFLENBQUM7SUFDYixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1osR0FBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc09iamVjdCB9IGZyb20gXCJ1dGlsXCI7XHJcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcclxuaW1wb3J0IHsgU2V0dGluZ3MsIElTb2NrZXQsIHV0aWxzLCBDb21wb25lbnQsIEFwcGxpY2F0aW9uIH0gZnJvbSBcIi4uLy4uL2luZGV4XCI7XHJcbmltcG9ydCB7IHJlc29sdmVOYXB0ciB9IGZyb20gXCJkbnNcIjtcclxuXHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcclxuXHJcbmV4cG9ydCB0eXBlIFNpZFNlc3Npb25NYXAgPSB7IFtpZHg6IHN0cmluZ106IFNlc3Npb24gfTtcclxuZXhwb3J0IHR5cGUgVWlkU2Vzc2lvbnNNYXAgPSB7IFtpZHg6IHN0cmluZ106IFNlc3Npb25bXSB9O1xyXG5cclxuY29uc3QgRlJPTlRFTkRfU0VTU0lPTl9GSUVMRFMgPSBbXCJpZFwiLCBcImZyb250ZW5kSWRcIiwgXCJ1aWRcIiwgXCJzZXNzaW9uU2VydmljZVwiXTtcclxuY29uc3QgRVhQT1JURURfU0VTU0lPTl9GSUVMRFMgPSBbXCJpZFwiLCBcImZyb250ZW5kSWRcIiwgXCJ1aWRcIiwgXCJzZXR0aW5nc1wiXTtcclxuXHJcbmVudW0gU3RhdGUge1xyXG4gIFNUX0lOSVRFRCA9IDAsXHJcbiAgU1RfQ0xPU0VEID0gMVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU2Vzc2lvbiBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgX190aW1lb3V0X18/OiBudW1iZXI7XHJcbiAgcHJvdGVjdGVkIF9zdGF0ZTogU3RhdGU7XHJcbiAgcHJvdGVjdGVkIF9zZXR0aW5nczogU2V0dGluZ3M7XHJcbiAgcHJvdGVjdGVkIF91aWQ6IHN0cmluZztcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHB1YmxpYyByZWFkb25seSBpZDogbnVtYmVyLFxyXG4gICAgcHVibGljIHJlYWRvbmx5IGZyb250ZW5kSWQ6IHN0cmluZyxcclxuICAgIHByb3RlY3RlZCBfc29ja2V0OiBJU29ja2V0LFxyXG4gICAgcHJvdGVjdGVkIF9zZXNzaW9uU2VydmljZTogU2Vzc2lvblNlcnZpY2VcclxuICApIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICB0aGlzLl9zdGF0ZSA9IFN0YXRlLlNUX0lOSVRFRDtcclxuICAgIHRoaXMuX3NldHRpbmdzID0ge307XHJcbiAgfVxyXG4gIGdldCB1aWQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fdWlkO1xyXG4gIH1cclxuICBzZXQgdWlkKHZhbDogc3RyaW5nKSB7XHJcbiAgICB0aGlzLl91aWQgPSB2YWw7XHJcbiAgfVxyXG5cclxuICBnZXQgc29ja2V0KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX3NvY2tldDtcclxuICB9XHJcbiAgZ2V0IHNlc3Npb25TZXJ2aWNlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX3Nlc3Npb25TZXJ2aWNlO1xyXG4gIH1cclxuICBzZXQgc2Vzc2lvblNlcnZpY2UodmFsOiBTZXNzaW9uU2VydmljZSkge1xyXG4gICAgdGhpcy5fc2Vzc2lvblNlcnZpY2UgPSB2YWw7XHJcbiAgfVxyXG4gIGdldCBzZXR0aW5ncygpOiBSZWFkb25seTxTZXR0aW5ncz4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3NldHRpbmdzO1xyXG4gIH1cclxuXHJcbiAgdG9Gcm9udGVuZFNlc3Npb24oKSB7XHJcbiAgICByZXR1cm4gbmV3IEZyb250ZW5kU2Vzc2lvbih0aGlzKTtcclxuICB9XHJcblxyXG4gIGJpbmQodWlkOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuX3VpZCA9IHVpZDtcclxuICAgIHRoaXMuZW1pdChcImJpbmRcIiwgdWlkKTtcclxuICB9XHJcblxyXG4gIHVuYmluZCh1aWQ6IHN0cmluZykge1xyXG4gICAgZGVsZXRlIHRoaXMuX3VpZDtcclxuICAgIHRoaXMuZW1pdChcInVuYmluZFwiLCB1aWQpO1xyXG4gIH1cclxuXHJcbiAgc2V0KGtleTogYW55LCB2YWw/OiBhbnkpIHtcclxuICAgIGlmIChpc09iamVjdChrZXkpKSB7XHJcbiAgICAgIGZvciAobGV0IGkgaW4ga2V5KSB7XHJcbiAgICAgICAgdGhpcy5fc2V0dGluZ3NbaV0gPSBrZXlbaV07XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuX3NldHRpbmdzW2tleV0gPSB2YWw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXQoa2V5OiBhbnkpIHtcclxuICAgIHJldHVybiB0aGlzLl9zZXR0aW5nc1trZXldO1xyXG4gIH1cclxuXHJcbiAgc2VuZChtc2c6IGFueSkge1xyXG4gICAgdGhpcy5fc29ja2V0LnNlbmQobXNnKTtcclxuICB9XHJcblxyXG4gIHNlbmRCYXRjaChtc2dzOiBBcnJheUxpa2U8YW55Pikge1xyXG4gICAgdGhpcy5fc29ja2V0LnNlbmRCYXRjaChtc2dzKTtcclxuICB9XHJcblxyXG4gIGNsb3NlZChyZWFzb246IGFueSkge1xyXG4gICAgbG9nZ2VyLmRlYnVnKFxyXG4gICAgICBcInNlc3Npb24gb24gWyVzXSBpcyBjbG9zZWQgd2l0aCBzZXNzaW9uIGlkOiAlc1wiLFxyXG4gICAgICB0aGlzLmZyb250ZW5kSWQsXHJcbiAgICAgIHRoaXMuaWRcclxuICAgICk7XHJcbiAgICBpZiAodGhpcy5fc3RhdGUgPT09IFN0YXRlLlNUX0NMT1NFRCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLl9zdGF0ZSA9IFN0YXRlLlNUX0NMT1NFRDtcclxuICAgIHRoaXMuX3Nlc3Npb25TZXJ2aWNlLnJlbW92ZSh0aGlzLmlkKTtcclxuICAgIHRoaXMuZW1pdChcImNsb3NlZFwiLCB0aGlzLnRvRnJvbnRlbmRTZXNzaW9uKCksIHJlYXNvbik7XHJcbiAgICB0aGlzLl9zb2NrZXQuZW1pdChcImNsb3NpbmdcIiwgcmVhc29uKTtcclxuXHJcbiAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcclxuICAgICAgdGhpcy5fc29ja2V0LmRpc2Nvbm5lY3QoKTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEZyb250ZW5kU2Vzc2lvbiBleHRlbmRzIFNlc3Npb24ge1xyXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBfc2Vzc2lvbjogU2Vzc2lvbikge1xyXG4gICAgc3VwZXIoXHJcbiAgICAgIF9zZXNzaW9uLmlkLFxyXG4gICAgICBfc2Vzc2lvbi5mcm9udGVuZElkLFxyXG4gICAgICBfc2Vzc2lvbi5zb2NrZXQsXHJcbiAgICAgIF9zZXNzaW9uLnNlc3Npb25TZXJ2aWNlXHJcbiAgICApO1xyXG4gICAgY2xvbmUoX3Nlc3Npb24sIHRoaXMsIEZST05URU5EX1NFU1NJT05fRklFTERTKTtcclxuICAgIHRoaXMuX3NldHRpbmdzID0gZGNsb25lKF9zZXNzaW9uLnNldHRpbmdzKTtcclxuICB9XHJcblxyXG4gIGJpbmQodWlkOiBzdHJpbmcsIGNiPzogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuX3Nlc3Npb25TZXJ2aWNlLmJpbmQodGhpcy5pZCwgdWlkLCAoZXJyOiBhbnkpID0+IHtcclxuICAgICAgaWYgKCFlcnIpIHtcclxuICAgICAgICB0aGlzLl91aWQgPSB1aWQ7XHJcbiAgICAgIH1cclxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhLCBlcnIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICB1bmJpbmQodWlkOiBzdHJpbmcsIGNiPzogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuX3Nlc3Npb25TZXJ2aWNlLnVuYmluZCh0aGlzLmlkLCB1aWQsIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoIWVycikge1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLl91aWQ7XHJcbiAgICAgIH1cclxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhLCBlcnIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdXNoKGtleTogYW55LCBjYj86IEZ1bmN0aW9uKSB7XHJcbiAgICB0aGlzLl9zZXNzaW9uU2VydmljZS5pbXBvcnQodGhpcy5pZCwga2V5LCB0aGlzLmdldChrZXkpLCBjYik7XHJcbiAgfVxyXG5cclxuICBwdXNoQWxsKGNiPzogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuX3Nlc3Npb25TZXJ2aWNlLmltcG9ydEFsbCh0aGlzLmlkLCB0aGlzLl9zZXR0aW5ncywgY2IpO1xyXG4gIH1cclxuXHJcbiAgb24oZXZlbnQ6IHN0cmluZyB8IHN5bWJvbCwgbGlzdGVuZXI6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkge1xyXG4gICAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbi5jYWxsKHRoaXMsIGV2ZW50LCBsaXN0ZW5lcik7XHJcbiAgICB0aGlzLl9zZXNzaW9uLm9uKGV2ZW50LCBsaXN0ZW5lcik7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIGV4cG9ydCgpIHtcclxuICAgIGxldCByZXM6IHtcclxuICAgICAgaWQ6IG51bWJlcjtcclxuICAgICAgZnJvbnRlbmRJZDogc3RyaW5nO1xyXG4gICAgICB1aWQ6IHN0cmluZztcclxuICAgICAgc2V0dGluZ3M6IFNldHRpbmdzO1xyXG4gICAgfSA9IDxhbnk+e307XHJcbiAgICBjbG9uZSh0aGlzLCByZXMsIEVYUE9SVEVEX1NFU1NJT05fRklFTERTKTtcclxuICAgIHJldHVybiByZXM7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU2Vzc2lvblNlcnZpY2Uge1xyXG4gIHByaXZhdGUgX3NpbmdsZVNlc3Npb24gPSBmYWxzZTtcclxuICBwcml2YXRlIF9zZXNzaW9uczogU2lkU2Vzc2lvbk1hcDtcclxuICBwcml2YXRlIF91aWRNYXA6IFVpZFNlc3Npb25zTWFwO1xyXG4gIGdldCBzaW5nbGVTZXNzaW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX3NpbmdsZVNlc3Npb247XHJcbiAgfVxyXG4gIGNvbnN0cnVjdG9yKG9wdHM/OiBhbnkpIHtcclxuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xyXG4gICAgdGhpcy5fc2luZ2xlU2Vzc2lvbiA9IG9wdHMuc2luZ2xlU2Vzc2lvbjtcclxuICAgIHRoaXMuX3Nlc3Npb25zID0ge307IC8vIHNpZCAtPiBzZXNzaW9uXHJcbiAgICB0aGlzLl91aWRNYXAgPSB7fTsgLy8gdWlkIC0+IHNlc3Npb25zXHJcbiAgfVxyXG5cclxuICBnZXQgc2Vzc2lvbnMoKTogUmVhZG9ubHk8U2lkU2Vzc2lvbk1hcD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3Nlc3Npb25zO1xyXG4gIH1cclxuICBnZXQgdWlkTWFwKCk6IFJlYWRvbmx5PFVpZFNlc3Npb25zTWFwPiB7XHJcbiAgICByZXR1cm4gdGhpcy5fdWlkTWFwO1xyXG4gIH1cclxuXHJcbiAgY3JlYXRlKHNpZDogbnVtYmVyLCBmcm9udGVuZElkOiBzdHJpbmcsIHNvY2tldDogSVNvY2tldCk6IFNlc3Npb24ge1xyXG4gICAgbGV0IHNlc3Npb24gPSBuZXcgU2Vzc2lvbihzaWQsIGZyb250ZW5kSWQsIHNvY2tldCwgdGhpcyk7XHJcbiAgICB0aGlzLl9zZXNzaW9uc1tzZXNzaW9uLmlkXSA9IHNlc3Npb247XHJcbiAgICByZXR1cm4gc2Vzc2lvbjtcclxuICB9XHJcblxyXG4gIGJpbmQoc2lkOiBudW1iZXIsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLl9zZXNzaW9uc1tzaWRdO1xyXG5cclxuICAgIGlmICghc2Vzc2lvbikge1xyXG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcclxuICAgICAgICBjYihuZXcgRXJyb3IoXCJzZXNzaW9uIGRvZXMgbm90IGV4aXN0LCBzaWQ6IFwiICsgc2lkKSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHNlc3Npb24udWlkKSB7XHJcbiAgICAgIGlmIChzZXNzaW9uLnVpZCA9PT0gdWlkKSB7XHJcbiAgICAgICAgLy8gYWxyZWFkeSBib3VuZCB3aXRoIHRoZSBzYW1lIHVpZFxyXG4gICAgICAgIGNiKCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBhbHJlYWR5IGJvdW5kIHdpdGggb3RoZXIgdWlkXHJcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xyXG4gICAgICAgIGNiKG5ldyBFcnJvcihcInNlc3Npb24gaGFzIGFscmVhZHkgYmluZCB3aXRoIFwiICsgc2Vzc2lvbi51aWQpKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2Vzc2lvbnMgPSB0aGlzLnVpZE1hcFt1aWRdO1xyXG5cclxuICAgIGlmICh0aGlzLnNpbmdsZVNlc3Npb24gJiYgISFzZXNzaW9ucykge1xyXG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcclxuICAgICAgICBjYihcclxuICAgICAgICAgIG5ldyBFcnJvcihcclxuICAgICAgICAgICAgXCJzaW5nbGVTZXNzaW9uIGlzIGVuYWJsZWQsIGFuZCBzZXNzaW9uIGhhcyBhbHJlYWR5IGJpbmQgd2l0aCB1aWQ6IFwiICtcclxuICAgICAgICAgICAgICB1aWRcclxuICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghc2Vzc2lvbnMpIHtcclxuICAgICAgc2Vzc2lvbnMgPSB0aGlzLl91aWRNYXBbdWlkXSA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gc2Vzc2lvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgIC8vIHNlc3Npb24gaGFzIGJpbmRlZCB3aXRoIHRoZSB1aWRcclxuICAgICAgaWYgKHNlc3Npb25zW2ldLmlkID09PSBzZXNzaW9uLmlkKSB7XHJcbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYik7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBzZXNzaW9ucy5wdXNoKHNlc3Npb24pO1xyXG5cclxuICAgIHNlc3Npb24uYmluZCh1aWQpO1xyXG5cclxuICAgIGlmIChjYikge1xyXG4gICAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVuYmluZChzaWQ6IG51bWJlciwgdWlkOiBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xyXG4gICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2lkXTtcclxuXHJcbiAgICBpZiAoIXNlc3Npb24pIHtcclxuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XHJcbiAgICAgICAgY2IobmV3IEVycm9yKFwic2Vzc2lvbiBkb2VzIG5vdCBleGlzdCwgc2lkOiBcIiArIHNpZCkpO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghc2Vzc2lvbi51aWQgfHwgc2Vzc2lvbi51aWQgIT09IHVpZCkge1xyXG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcclxuICAgICAgICBjYihuZXcgRXJyb3IoXCJzZXNzaW9uIGhhcyBub3QgYmluZCB3aXRoIFwiICsgc2Vzc2lvbi51aWQpKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2Vzc2lvbnMgPSB0aGlzLl91aWRNYXBbdWlkXTtcclxuICAgIGxldCBzZXNzOiBTZXNzaW9uO1xyXG4gICAgaWYgKHNlc3Npb25zKSB7XHJcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gc2Vzc2lvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgc2VzcyA9IHNlc3Npb25zW2ldO1xyXG4gICAgICAgIGlmIChzZXNzLmlkID09PSBzaWQpIHtcclxuICAgICAgICAgIHNlc3Npb25zLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHNlc3Npb25zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIGRlbGV0ZSB0aGlzLl91aWRNYXBbdWlkXTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgc2Vzc2lvbi51bmJpbmQodWlkKTtcclxuXHJcbiAgICBpZiAoY2IpIHtcclxuICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnZXQoc2lkOiBudW1iZXIpIHtcclxuICAgIHJldHVybiB0aGlzLl9zZXNzaW9uc1tzaWRdO1xyXG4gIH1cclxuXHJcbiAgZ2V0QnlVaWQodWlkOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB0aGlzLl91aWRNYXBbdWlkXTtcclxuICB9XHJcblxyXG4gIHJlbW92ZShzaWQ6IG51bWJlcikge1xyXG4gICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuX3Nlc3Npb25zW3NpZF07XHJcbiAgICBpZiAoc2Vzc2lvbikge1xyXG4gICAgICBsZXQgdWlkID0gc2Vzc2lvbi51aWQ7XHJcbiAgICAgIGRlbGV0ZSB0aGlzLl9zZXNzaW9uc1tzZXNzaW9uLmlkXTtcclxuXHJcbiAgICAgIGxldCBzZXNzaW9ucyA9IHRoaXMuX3VpZE1hcFt1aWRdO1xyXG4gICAgICBpZiAoIXNlc3Npb25zKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHNlc3Npb25zLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgIGlmIChzZXNzaW9uc1tpXS5pZCA9PT0gc2lkKSB7XHJcbiAgICAgICAgICBzZXNzaW9ucy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICBpZiAoc2Vzc2lvbnMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl91aWRNYXBbdWlkXTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaW1wb3J0KHNpZDogbnVtYmVyLCBrZXk6IGFueSwgdmFsdWU6IGFueSwgY2I/OiBGdW5jdGlvbikge1xyXG4gICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2lkXTtcclxuICAgIGlmICghc2Vzc2lvbikge1xyXG4gICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhcclxuICAgICAgICBjYiEsXHJcbiAgICAgICAgbmV3IEVycm9yKFwic2Vzc2lvbiBkb2VzIG5vdCBleGlzdCwgc2lkOiBcIiArIHNpZClcclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgc2Vzc2lvbi5zZXQoa2V5LCB2YWx1ZSk7XHJcbiAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiEpO1xyXG4gIH1cclxuXHJcbiAgaW1wb3J0QWxsKHNpZDogbnVtYmVyLCBzZXR0aW5nczogU2V0dGluZ3MsIGNiPzogRnVuY3Rpb24pIHtcclxuICAgIGxldCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tzaWRdO1xyXG4gICAgaWYgKCFzZXNzaW9uKSB7XHJcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKFxyXG4gICAgICAgIGNiISxcclxuICAgICAgICBuZXcgRXJyb3IoXCJzZXNzaW9uIGRvZXMgbm90IGV4aXN0LCBzaWQ6IFwiICsgc2lkKVxyXG4gICAgICApO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChsZXQgZiBpbiBzZXR0aW5ncykge1xyXG4gICAgICBzZXNzaW9uLnNldChmLCBzZXR0aW5nc1tmXSk7XHJcbiAgICB9XHJcbiAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiEpO1xyXG4gIH1cclxuXHJcbiAga2ljayh1aWQ6IHN0cmluZywgcmVhc29uOiBhbnksIGNiPzogRnVuY3Rpb24pIHtcclxuICAgIGlmICh0eXBlb2YgcmVhc29uID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgY2IgPSByZWFzb247XHJcbiAgICAgIHJlYXNvbiA9IFwia2lja1wiO1xyXG4gICAgfVxyXG4gICAgbGV0IHNlc3Npb25zID0gdGhpcy5nZXRCeVVpZCh1aWQpO1xyXG5cclxuICAgIGlmIChzZXNzaW9ucykge1xyXG4gICAgICAvLyBub3RpZnkgY2xpZW50XHJcbiAgICAgIGxldCBzaWRzOiBudW1iZXJbXSA9IFtdO1xyXG4gICAgICBzZXNzaW9ucy5mb3JFYWNoKHNlc3Npb24gPT4ge1xyXG4gICAgICAgIHNpZHMucHVzaChzZXNzaW9uLmlkKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBzaWRzLmZvckVhY2goc2lkID0+IHtcclxuICAgICAgICB0aGlzLl9zZXNzaW9uc1tzaWRdLmNsb3NlZChyZWFzb24pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xyXG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XHJcbiAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBraWNrQnlTZXNzaW9uSWQoc2lkOiBudW1iZXIsIHJlYXNvbjogYW55LCBjYj86IEZ1bmN0aW9uKSB7XHJcbiAgICBpZiAodHlwZW9mIHJlYXNvbiA9PT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgIGNiID0gcmVhc29uO1xyXG4gICAgICByZWFzb24gPSBcImtpY2tcIjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2Vzc2lvbiA9IHRoaXMuZ2V0KHNpZCk7XHJcblxyXG4gICAgaWYgKHNlc3Npb24pIHtcclxuICAgICAgLy8gbm90aWZ5IGNsaWVudFxyXG4gICAgICBzZXNzaW9uLmNsb3NlZChyZWFzb24pO1xyXG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcclxuICAgICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiEpO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xyXG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0Q2xpZW50QWRkcmVzc0J5U2Vzc2lvbklkKHNpZDogbnVtYmVyKSB7XHJcbiAgICBsZXQgc2Vzc2lvbiA9IHRoaXMuZ2V0KHNpZCk7XHJcbiAgICBpZiAoc2Vzc2lvbikge1xyXG4gICAgICBsZXQgc29ja2V0ID0gc2Vzc2lvbi5zb2NrZXQ7XHJcbiAgICAgIHJldHVybiBzb2NrZXQucmVtb3RlQWRkcmVzcztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2VuZE1lc3NhZ2Uoc2lkOiBudW1iZXIsIG1zZzogYW55KSB7XHJcbiAgICBsZXQgc2Vzc2lvbiA9IHRoaXMuZ2V0KHNpZCk7XHJcblxyXG4gICAgaWYgKCFzZXNzaW9uKSB7XHJcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcclxuICAgICAgICBcIkZhaWwgdG8gc2VuZCBtZXNzYWdlIGZvciBub24tZXhpc3Rpbmcgc2Vzc2lvbiwgc2lkOiBcIiArXHJcbiAgICAgICAgICBzaWQgK1xyXG4gICAgICAgICAgXCIgbXNnOiBcIiArXHJcbiAgICAgICAgICBtc2dcclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHNlc3Npb24uc2VuZChtc2cpO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBzZW5kTWVzc2FnZUJ5VWlkKHVpZDogc3RyaW5nLCBtc2c6IGFueSkge1xyXG4gICAgbGV0IHNlc3Npb25zID0gdGhpcy5nZXRCeVVpZCh1aWQpO1xyXG5cclxuICAgIGlmICghc2Vzc2lvbnMpIHtcclxuICAgICAgbG9nZ2VyLmRlYnVnKFxyXG4gICAgICAgIFwiZmFpbCB0byBzZW5kIG1lc3NhZ2UgYnkgdWlkIGZvciBub24tZXhpc3Rpbmcgc2Vzc2lvbi4gdWlkOiAlalwiLFxyXG4gICAgICAgIHVpZFxyXG4gICAgICApO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBzZXNzaW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgc2Vzc2lvbnNbaV0uc2VuZChtc2cpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgZm9yRWFjaFNlc3Npb24oY2I6IEZ1bmN0aW9uKSB7XHJcbiAgICBmb3IgKGxldCBzaWQgaW4gdGhpcy5zZXNzaW9ucykge1xyXG4gICAgICBjYih0aGlzLnNlc3Npb25zW3NpZF0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZm9yRWFjaEJpbmRlZFNlc3Npb24oY2I6IEZ1bmN0aW9uKSB7XHJcbiAgICBmb3IgKGxldCB1aWQgaW4gdGhpcy51aWRNYXApIHtcclxuICAgICAgbGV0IHNlc3Npb25zID0gdGhpcy51aWRNYXBbdWlkXTtcclxuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBzZXNzaW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcclxuICAgICAgICBjYihzZXNzaW9uc1tpXSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldFNlc3Npb25Db3VudCgpIHtcclxuICAgIHJldHVybiB1dGlscy5zaXplKHRoaXMuc2Vzc2lvbnMpO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFNlc3Npb25Db21wb25lbnQgaW1wbGVtZW50cyBDb21wb25lbnQge1xyXG4gIHJlYWRvbmx5IG5hbWUgPSBcIl9fc2Vzc2lvbl9fXCI7XHJcbiAgcHJpdmF0ZSBzZXJ2aWNlOiBTZXNzaW9uU2VydmljZTtcclxuICBjb25zdHJ1Y3RvcihyZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XHJcbiAgICBvcHRzID0gb3B0cyB8fCB7fTtcclxuICAgIHRoaXMuc2VydmljZSA9IG5ldyBTZXNzaW9uU2VydmljZShvcHRzKTtcclxuICB9XHJcblxyXG4gIGNyZWF0ZShzaWQ6IG51bWJlciwgZnJvbnRlbmRJZDogc3RyaW5nLCBzb2NrZXQ6IElTb2NrZXQpOiBTZXNzaW9uIHtcclxuICAgIHJldHVybiB0aGlzLnNlcnZpY2UuY3JlYXRlKHNpZCwgZnJvbnRlbmRJZCwgc29ja2V0KTtcclxuICB9XHJcblxyXG4gIGJpbmQoc2lkOiBudW1iZXIsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuc2VydmljZS5iaW5kKHNpZCwgdWlkLCBjYik7XHJcbiAgfVxyXG5cclxuICB1bmJpbmQoc2lkOiBudW1iZXIsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuc2VydmljZS51bmJpbmQoc2lkLCB1aWQsIGNiKTtcclxuICB9XHJcblxyXG4gIGdldChzaWQ6IG51bWJlcikge1xyXG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5nZXQoc2lkKTtcclxuICB9XHJcblxyXG4gIGdldEJ5VWlkKHVpZDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLmdldEJ5VWlkKHVpZCk7XHJcbiAgfVxyXG5cclxuICByZW1vdmUoc2lkOiBudW1iZXIpIHtcclxuICAgIHRoaXMuc2VydmljZS5yZW1vdmUoc2lkKTtcclxuICB9XHJcblxyXG4gIGltcG9ydChzaWQ6IG51bWJlciwga2V5OiBhbnksIHZhbHVlOiBhbnksIGNiPzogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuc2VydmljZS5pbXBvcnQoc2lkLCBrZXksIHZhbHVlLCBjYik7XHJcbiAgfVxyXG5cclxuICBpbXBvcnRBbGwoc2lkOiBudW1iZXIsIHNldHRpbmdzOiBTZXR0aW5ncywgY2I/OiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5zZXJ2aWNlLmltcG9ydEFsbChzaWQsIHNldHRpbmdzLCBjYik7XHJcbiAgfVxyXG5cclxuICBraWNrKHVpZDogc3RyaW5nLCByZWFzb246IGFueSwgY2I/OiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5zZXJ2aWNlLmtpY2sodWlkLCByZXNvbHZlTmFwdHIsIGNiKTtcclxuICB9XHJcblxyXG4gIGtpY2tCeVNlc3Npb25JZChzaWQ6IG51bWJlciwgcmVhc29uOiBhbnksIGNiPzogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuc2VydmljZS5raWNrQnlTZXNzaW9uSWQoc2lkLCByZWFzb24sIGNiKTtcclxuICB9XHJcblxyXG4gIGdldENsaWVudEFkZHJlc3NCeVNlc3Npb25JZChzaWQ6IG51bWJlcikge1xyXG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5nZXRDbGllbnRBZGRyZXNzQnlTZXNzaW9uSWQoc2lkKTtcclxuICB9XHJcblxyXG4gIHNlbmRNZXNzYWdlKHNpZDogbnVtYmVyLCBtc2c6IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5zZW5kTWVzc2FnZShzaWQsIG1zZyk7XHJcbiAgfVxyXG5cclxuICBzZW5kTWVzc2FnZUJ5VWlkKHVpZDogc3RyaW5nLCBtc2c6IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5zZW5kTWVzc2FnZUJ5VWlkKHVpZCwgbXNnKTtcclxuICB9XHJcblxyXG4gIGZvckVhY2hTZXNzaW9uKGNiOiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5zZXJ2aWNlLmZvckVhY2hTZXNzaW9uKGNiKTtcclxuICB9XHJcblxyXG4gIGZvckVhY2hCaW5kZWRTZXNzaW9uKGNiOiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5zZXJ2aWNlLmZvckVhY2hCaW5kZWRTZXNzaW9uKGNiKTtcclxuICB9XHJcblxyXG4gIGdldFNlc3Npb25Db3VudCgpIHtcclxuICAgIHJldHVybiB0aGlzLnNlcnZpY2UuZ2V0U2Vzc2lvbkNvdW50KCk7XHJcbiAgfVxyXG59XHJcbmZ1bmN0aW9uIGNsb25lKHNyYzogYW55LCBkZXN0OiBhbnksIGluY2x1ZGVzOiBzdHJpbmdbXSkge1xyXG4gIGxldCBmO1xyXG4gIGZvciAobGV0IGkgPSAwLCBsID0gaW5jbHVkZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICBmID0gaW5jbHVkZXNbaV07XHJcbiAgICBkZXN0W2ZdID0gc3JjW2ZdO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZGNsb25lKHNyYzogYW55KTogYW55IHtcclxuICBsZXQgcmVzID0ge307XHJcbiAgZm9yIChsZXQgZiBpbiBzcmMpIHtcclxuICAgICg8YW55PnJlcylbZl0gPSBzcmNbZl07XHJcbiAgfVxyXG4gIHJldHVybiByZXM7XHJcbn1cclxuIl19