"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const events_1 = require("events");
const index_1 = require("../../index");
const dns_1 = require("dns");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const FRONTEND_SESSION_FIELDS = ["id", "frontendId", "uid", "sessionService"];
const EXPORTED_SESSION_FIELDS = ["id", "frontendId", "uid", "settings"];
var State;
(function (State) {
    State[State["ST_INITED"] = 0] = "ST_INITED";
    State[State["ST_CLOSED"] = 1] = "ST_CLOSED";
})(State || (State = {}));
class Session extends events_1.EventEmitter {
    constructor(id, frontendId, _socket, _sessionService) {
        super();
        this.id = id;
        this.frontendId = frontendId;
        this._socket = _socket;
        this._sessionService = _sessionService;
        this._state = State.ST_INITED;
        this._settings = {};
    }
    get uid() {
        return this._uid;
    }
    set uid(val) {
        this._uid = val;
    }
    get socket() {
        return this._socket;
    }
    get sessionService() {
        return this._sessionService;
    }
    set sessionService(val) {
        this._sessionService = val;
    }
    get settings() {
        return this._settings;
    }
    toFrontendSession() {
        return new FrontendSession(this);
    }
    bind(uid) {
        this._uid = uid;
        this.emit("bind", uid);
    }
    unbind(uid) {
        delete this._uid;
        this.emit("unbind", uid);
    }
    set(key, val) {
        if (util_1.isObject(key)) {
            for (let i in key) {
                this._settings[i] = key[i];
            }
        }
        else {
            this._settings[key] = val;
        }
    }
    get(key) {
        return this._settings[key];
    }
    send(msg) {
        this._socket.send(msg);
    }
    sendBatch(msgs) {
        this._socket.sendBatch(msgs);
    }
    closed(reason) {
        logger.debug("session on [%s] is closed with session id: %s", this.frontendId, this.id);
        if (this._state === State.ST_CLOSED) {
            return;
        }
        this._state = State.ST_CLOSED;
        this._sessionService.remove(this.id);
        this.emit("closed", this.toFrontendSession(), reason);
        this._socket.emit("closing", reason);
        process.nextTick(() => {
            this._socket.disconnect();
        });
    }
}
exports.Session = Session;
class FrontendSession extends Session {
    constructor(_session) {
        super(_session.id, _session.frontendId, _session.socket, _session.sessionService);
        this._session = _session;
        clone(_session, this, FRONTEND_SESSION_FIELDS);
        this._settings = dclone(_session.settings);
    }
    bind(uid, cb) {
        this._sessionService.bind(this.id, uid, (err) => {
            if (!err) {
                this._uid = uid;
            }
            index_1.utils.invokeCallback(cb, err);
        });
    }
    unbind(uid, cb) {
        this._sessionService.unbind(this.id, uid, (err) => {
            if (!err) {
                delete this._uid;
            }
            index_1.utils.invokeCallback(cb, err);
        });
    }
    push(key, cb) {
        this._sessionService.import(this.id, key, this.get(key), cb);
    }
    pushAll(cb) {
        this._sessionService.importAll(this.id, this._settings, cb);
    }
    on(event, listener) {
        events_1.EventEmitter.prototype.on.call(this, event, listener);
        this._session.on(event, listener);
        return this;
    }
    export() {
        let res = {};
        clone(this, res, EXPORTED_SESSION_FIELDS);
        return res;
    }
}
exports.FrontendSession = FrontendSession;
class SessionService {
    constructor(opts) {
        this._singleSession = false;
        opts = opts || {};
        this._singleSession = opts.singleSession;
        this._sessions = {}; // sid -> session
        this._uidMap = {}; // uid -> sessions
    }
    get singleSession() {
        return this._singleSession;
    }
    get sessions() {
        return this._sessions;
    }
    get uidMap() {
        return this._uidMap;
    }
    create(sid, frontendId, socket) {
        let session = new Session(sid, frontendId, socket, this);
        this._sessions[session.id] = session;
        return session;
    }
    bind(sid, uid, cb) {
        const session = this._sessions[sid];
        if (!session) {
            process.nextTick(() => {
                cb(new Error("session does not exist, sid: " + sid));
            });
            return;
        }
        if (session.uid) {
            if (session.uid === uid) {
                // already bound with the same uid
                cb();
                return;
            }
            // already bound with other uid
            process.nextTick(() => {
                cb(new Error("session has already bind with " + session.uid));
            });
            return;
        }
        let sessions = this.uidMap[uid];
        if (this.singleSession && !!sessions) {
            process.nextTick(() => {
                cb(new Error("singleSession is enabled, and session has already bind with uid: " +
                    uid));
            });
            return;
        }
        if (!sessions) {
            sessions = this._uidMap[uid] = [];
        }
        for (let i = 0, l = sessions.length; i < l; i++) {
            // session has binded with the uid
            if (sessions[i].id === session.id) {
                process.nextTick(cb);
                return;
            }
        }
        sessions.push(session);
        session.bind(uid);
        if (cb) {
            process.nextTick(cb);
        }
    }
    unbind(sid, uid, cb) {
        const session = this.sessions[sid];
        if (!session) {
            process.nextTick(() => {
                cb(new Error("session does not exist, sid: " + sid));
            });
            return;
        }
        if (!session.uid || session.uid !== uid) {
            process.nextTick(() => {
                cb(new Error("session has not bind with " + session.uid));
            });
            return;
        }
        let sessions = this._uidMap[uid];
        let sess;
        if (sessions) {
            for (let i = 0, l = sessions.length; i < l; i++) {
                sess = sessions[i];
                if (sess.id === sid) {
                    sessions.splice(i, 1);
                    break;
                }
            }
            if (sessions.length === 0) {
                delete this._uidMap[uid];
            }
        }
        session.unbind(uid);
        if (cb) {
            process.nextTick(cb);
        }
    }
    get(sid) {
        return this._sessions[sid];
    }
    getByUid(uid) {
        return this._uidMap[uid];
    }
    remove(sid) {
        const session = this._sessions[sid];
        if (session) {
            let uid = session.uid;
            delete this._sessions[session.id];
            let sessions = this._uidMap[uid];
            if (!sessions) {
                return;
            }
            for (let i = 0, l = sessions.length; i < l; i++) {
                if (sessions[i].id === sid) {
                    sessions.splice(i, 1);
                    if (sessions.length === 0) {
                        delete this._uidMap[uid];
                    }
                    break;
                }
            }
        }
    }
    import(sid, key, value, cb) {
        const session = this.sessions[sid];
        if (!session) {
            index_1.utils.invokeCallback(cb, new Error("session does not exist, sid: " + sid));
            return;
        }
        session.set(key, value);
        index_1.utils.invokeCallback(cb);
    }
    importAll(sid, settings, cb) {
        let session = this.sessions[sid];
        if (!session) {
            index_1.utils.invokeCallback(cb, new Error("session does not exist, sid: " + sid));
            return;
        }
        for (let f in settings) {
            session.set(f, settings[f]);
        }
        index_1.utils.invokeCallback(cb);
    }
    kick(uid, reason, cb) {
        if (typeof reason === "function") {
            cb = reason;
            reason = "kick";
        }
        let sessions = this.getByUid(uid);
        if (sessions) {
            // notify client
            let sids = [];
            sessions.forEach(session => {
                sids.push(session.id);
            });
            sids.forEach(sid => {
                this._sessions[sid].closed(reason);
            });
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb);
            });
        }
        else {
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb);
            });
        }
    }
    kickBySessionId(sid, reason, cb) {
        if (typeof reason === "function") {
            cb = reason;
            reason = "kick";
        }
        let session = this.get(sid);
        if (session) {
            // notify client
            session.closed(reason);
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb);
            });
        }
        else {
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb);
            });
        }
    }
    getClientAddressBySessionId(sid) {
        let session = this.get(sid);
        if (session) {
            let socket = session.socket;
            return socket.remoteAddress;
        }
        else {
            return null;
        }
    }
    sendMessage(sid, msg) {
        let session = this.get(sid);
        if (!session) {
            logger.debug("Fail to send message for non-existing session, sid: " +
                sid +
                " msg: " +
                msg);
            return false;
        }
        session.send(msg);
        return true;
    }
    sendMessageByUid(uid, msg) {
        let sessions = this.getByUid(uid);
        if (!sessions) {
            logger.debug("fail to send message by uid for non-existing session. uid: %j", uid);
            return false;
        }
        for (let i = 0, l = sessions.length; i < l; i++) {
            sessions[i].send(msg);
        }
        return true;
    }
    forEachSession(cb) {
        for (let sid in this.sessions) {
            cb(this.sessions[sid]);
        }
    }
    forEachBindedSession(cb) {
        for (let uid in this.uidMap) {
            let sessions = this.uidMap[uid];
            for (let i = 0, l = sessions.length; i < l; i++) {
                cb(sessions[i]);
            }
        }
    }
    getSessionCount() {
        return index_1.utils.size(this.sessions);
    }
}
exports.SessionService = SessionService;
class SessionComponent {
    constructor(app, opts) {
        this.app = app;
        this.name = "__session__";
        opts = opts || {};
        this.service = new SessionService(opts);
    }
    create(sid, frontendId, socket) {
        return this.service.create(sid, frontendId, socket);
    }
    bind(sid, uid, cb) {
        this.service.bind(sid, uid, cb);
    }
    unbind(sid, uid, cb) {
        this.service.unbind(sid, uid, cb);
    }
    get(sid) {
        return this.service.get(sid);
    }
    getByUid(uid) {
        return this.service.getByUid(uid);
    }
    remove(sid) {
        this.service.remove(sid);
    }
    import(sid, key, value, cb) {
        this.service.import(sid, key, value, cb);
    }
    importAll(sid, settings, cb) {
        this.service.importAll(sid, settings, cb);
    }
    kick(uid, reason, cb) {
        this.service.kick(uid, dns_1.resolveNaptr, cb);
    }
    kickBySessionId(sid, reason, cb) {
        this.service.kickBySessionId(sid, reason, cb);
    }
    getClientAddressBySessionId(sid) {
        return this.service.getClientAddressBySessionId(sid);
    }
    sendMessage(sid, msg) {
        return this.service.sendMessage(sid, msg);
    }
    sendMessageByUid(uid, msg) {
        return this.service.sendMessageByUid(uid, msg);
    }
    forEachSession(cb) {
        this.service.forEachSession(cb);
    }
    forEachBindedSession(cb) {
        this.service.forEachBindedSession(cb);
    }
    getSessionCount() {
        return this.service.getSessionCount();
    }
}
exports.SessionComponent = SessionComponent;
function clone(src, dest, includes) {
    let f;
    for (let i = 0, l = includes.length; i < l; i++) {
        f = includes[i];
        dest[f] = src[f];
    }
}
function dclone(src) {
    let res = {};
    for (let f in src) {
        res[f] = src[f];
    }
    return res;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvblNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXNzaW9uU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUFnQztBQUNoQyxtQ0FBc0M7QUFDdEMsdUNBQStFO0FBQy9FLDZCQUFtQztBQUVuQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUt4RSxNQUFNLHVCQUF1QixHQUFHLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztBQUM5RSxNQUFNLHVCQUF1QixHQUFHLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFeEUsSUFBSyxLQUdKO0FBSEQsV0FBSyxLQUFLO0lBQ1IsMkNBQWEsQ0FBQTtJQUNiLDJDQUFhLENBQUE7QUFDZixDQUFDLEVBSEksS0FBSyxLQUFMLEtBQUssUUFHVDtBQUVELGFBQXFCLFNBQVEscUJBQVk7SUFLdkMsWUFDa0IsRUFBVSxFQUNWLFVBQWtCLEVBQ3hCLE9BQWdCLEVBQ2hCLGVBQStCO1FBRXpDLEtBQUssRUFBRSxDQUFDO1FBTFEsT0FBRSxHQUFGLEVBQUUsQ0FBUTtRQUNWLGVBQVUsR0FBVixVQUFVLENBQVE7UUFDeEIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUNoQixvQkFBZSxHQUFmLGVBQWUsQ0FBZ0I7UUFHekMsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQzlCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFDRCxJQUFJLEdBQUc7UUFDTCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDO0lBQ0QsSUFBSSxHQUFHLENBQUMsR0FBVztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcs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QUcsR0FBRyxFQUFFLENBQUM7SUFDYixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1osR0FBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc09iamVjdCB9IGZyb20gXCJ1dGlsXCI7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQgeyBTZXR0aW5ncywgSVNvY2tldCwgdXRpbHMsIENvbXBvbmVudCwgQXBwbGljYXRpb24gfSBmcm9tIFwiLi4vLi4vaW5kZXhcIjtcbmltcG9ydCB7IHJlc29sdmVOYXB0ciB9IGZyb20gXCJkbnNcIjtcblxuY29uc3QgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwicG9tZWxvXCIsIF9fZmlsZW5hbWUpO1xuXG5leHBvcnQgdHlwZSBTaWRTZXNzaW9uTWFwID0geyBbaWR4OiBzdHJpbmddOiBTZXNzaW9uIH07XG5leHBvcnQgdHlwZSBVaWRTZXNzaW9uc01hcCA9IHsgW2lkeDogc3RyaW5nXTogU2Vzc2lvbltdIH07XG5cbmNvbnN0IEZST05URU5EX1NFU1NJT05fRklFTERTID0gW1wiaWRcIiwgXCJmcm9udGVuZElkXCIsIFwidWlkXCIsIFwic2Vzc2lvblNlcnZpY2VcIl07XG5jb25zdCBFWFBPUlRFRF9TRVNTSU9OX0ZJRUxEUyA9IFtcImlkXCIsIFwiZnJvbnRlbmRJZFwiLCBcInVpZFwiLCBcInNldHRpbmdzXCJdO1xuXG5lbnVtIFN0YXRlIHtcbiAgU1RfSU5JVEVEID0gMCxcbiAgU1RfQ0xPU0VEID0gMVxufVxuXG5leHBvcnQgY2xhc3MgU2Vzc2lvbiBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIF9fdGltZW91dF9fPzogbnVtYmVyO1xuICBwcm90ZWN0ZWQgX3N0YXRlOiBTdGF0ZTtcbiAgcHJvdGVjdGVkIF9zZXR0aW5nczogU2V0dGluZ3M7XG4gIHByb3RlY3RlZCBfdWlkOiBzdHJpbmc7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFkb25seSBpZDogbnVtYmVyLFxuICAgIHB1YmxpYyByZWFkb25seSBmcm9udGVuZElkOiBzdHJpbmcsXG4gICAgcHJvdGVjdGVkIF9zb2NrZXQ6IElTb2NrZXQsXG4gICAgcHJvdGVjdGVkIF9zZXNzaW9uU2VydmljZTogU2Vzc2lvblNlcnZpY2VcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zdGF0ZSA9IFN0YXRlLlNUX0lOSVRFRDtcbiAgICB0aGlzLl9zZXR0aW5ncyA9IHt9O1xuICB9XG4gIGdldCB1aWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3VpZDtcbiAgfVxuICBzZXQgdWlkKHZhbDogc3RyaW5nKSB7XG4gICAgdGhpcy5fdWlkID0gdmFsO1xuICB9XG5cbiAgZ2V0IHNvY2tldCgpIHtcbiAgICByZXR1cm4gdGhpcy5fc29ja2V0O1xuICB9XG4gIGdldCBzZXNzaW9uU2VydmljZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fc2Vzc2lvblNlcnZpY2U7XG4gIH1cbiAgc2V0IHNlc3Npb25TZXJ2aWNlKHZhbDogU2Vzc2lvblNlcnZpY2UpIHtcbiAgICB0aGlzLl9zZXNzaW9uU2VydmljZSA9IHZhbDtcbiAgfVxuICBnZXQgc2V0dGluZ3MoKTogUmVhZG9ubHk8U2V0dGluZ3M+IHtcbiAgICByZXR1cm4gdGhpcy5fc2V0dGluZ3M7XG4gIH1cblxuICB0b0Zyb250ZW5kU2Vzc2lvbigpIHtcbiAgICByZXR1cm4gbmV3IEZyb250ZW5kU2Vzc2lvbih0aGlzKTtcbiAgfVxuXG4gIGJpbmQodWlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLl91aWQgPSB1aWQ7XG4gICAgdGhpcy5lbWl0KFwiYmluZFwiLCB1aWQpO1xuICB9XG5cbiAgdW5iaW5kKHVpZDogc3RyaW5nKSB7XG4gICAgZGVsZXRlIHRoaXMuX3VpZDtcbiAgICB0aGlzLmVtaXQoXCJ1bmJpbmRcIiwgdWlkKTtcbiAgfVxuXG4gIHNldChrZXk6IGFueSwgdmFsPzogYW55KSB7XG4gICAgaWYgKGlzT2JqZWN0KGtleSkpIHtcbiAgICAgIGZvciAobGV0IGkgaW4ga2V5KSB7XG4gICAgICAgIHRoaXMuX3NldHRpbmdzW2ldID0ga2V5W2ldO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9zZXR0aW5nc1trZXldID0gdmFsO1xuICAgIH1cbiAgfVxuXG4gIGdldChrZXk6IGFueSkge1xuICAgIHJldHVybiB0aGlzLl9zZXR0aW5nc1trZXldO1xuICB9XG5cbiAgc2VuZChtc2c6IGFueSkge1xuICAgIHRoaXMuX3NvY2tldC5zZW5kKG1zZyk7XG4gIH1cblxuICBzZW5kQmF0Y2gobXNnczogQXJyYXlMaWtlPGFueT4pIHtcbiAgICB0aGlzLl9zb2NrZXQuc2VuZEJhdGNoKG1zZ3MpO1xuICB9XG5cbiAgY2xvc2VkKHJlYXNvbjogYW55KSB7XG4gICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgXCJzZXNzaW9uIG9uIFslc10gaXMgY2xvc2VkIHdpdGggc2Vzc2lvbiBpZDogJXNcIixcbiAgICAgIHRoaXMuZnJvbnRlbmRJZCxcbiAgICAgIHRoaXMuaWRcbiAgICApO1xuICAgIGlmICh0aGlzLl9zdGF0ZSA9PT0gU3RhdGUuU1RfQ0xPU0VEKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX3N0YXRlID0gU3RhdGUuU1RfQ0xPU0VEO1xuICAgIHRoaXMuX3Nlc3Npb25TZXJ2aWNlLnJlbW92ZSh0aGlzLmlkKTtcbiAgICB0aGlzLmVtaXQoXCJjbG9zZWRcIiwgdGhpcy50b0Zyb250ZW5kU2Vzc2lvbigpLCByZWFzb24pO1xuICAgIHRoaXMuX3NvY2tldC5lbWl0KFwiY2xvc2luZ1wiLCByZWFzb24pO1xuXG4gICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICB0aGlzLl9zb2NrZXQuZGlzY29ubmVjdCgpO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBGcm9udGVuZFNlc3Npb24gZXh0ZW5kcyBTZXNzaW9uIHtcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIF9zZXNzaW9uOiBTZXNzaW9uKSB7XG4gICAgc3VwZXIoXG4gICAgICBfc2Vzc2lvbi5pZCxcbiAgICAgIF9zZXNzaW9uLmZyb250ZW5kSWQsXG4gICAgICBfc2Vzc2lvbi5zb2NrZXQsXG4gICAgICBfc2Vzc2lvbi5zZXNzaW9uU2VydmljZVxuICAgICk7XG4gICAgY2xvbmUoX3Nlc3Npb24sIHRoaXMsIEZST05URU5EX1NFU1NJT05fRklFTERTKTtcbiAgICB0aGlzLl9zZXR0aW5ncyA9IGRjbG9uZShfc2Vzc2lvbi5zZXR0aW5ncyk7XG4gIH1cblxuICBiaW5kKHVpZDogc3RyaW5nLCBjYj86IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5fc2Vzc2lvblNlcnZpY2UuYmluZCh0aGlzLmlkLCB1aWQsIChlcnI6IGFueSkgPT4ge1xuICAgICAgaWYgKCFlcnIpIHtcbiAgICAgICAgdGhpcy5fdWlkID0gdWlkO1xuICAgICAgfVxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhLCBlcnIpO1xuICAgIH0pO1xuICB9XG5cbiAgdW5iaW5kKHVpZDogc3RyaW5nLCBjYj86IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5fc2Vzc2lvblNlcnZpY2UudW5iaW5kKHRoaXMuaWQsIHVpZCwgKGVycjogYW55KSA9PiB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICBkZWxldGUgdGhpcy5fdWlkO1xuICAgICAgfVxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhLCBlcnIpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVzaChrZXk6IGFueSwgY2I/OiBGdW5jdGlvbikge1xuICAgIHRoaXMuX3Nlc3Npb25TZXJ2aWNlLmltcG9ydCh0aGlzLmlkLCBrZXksIHRoaXMuZ2V0KGtleSksIGNiKTtcbiAgfVxuXG4gIHB1c2hBbGwoY2I/OiBGdW5jdGlvbikge1xuICAgIHRoaXMuX3Nlc3Npb25TZXJ2aWNlLmltcG9ydEFsbCh0aGlzLmlkLCB0aGlzLl9zZXR0aW5ncywgY2IpO1xuICB9XG5cbiAgb24oZXZlbnQ6IHN0cmluZyB8IHN5bWJvbCwgbGlzdGVuZXI6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCkge1xuICAgIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub24uY2FsbCh0aGlzLCBldmVudCwgbGlzdGVuZXIpO1xuICAgIHRoaXMuX3Nlc3Npb24ub24oZXZlbnQsIGxpc3RlbmVyKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGV4cG9ydCgpIHtcbiAgICBsZXQgcmVzOiB7XG4gICAgICBpZDogbnVtYmVyO1xuICAgICAgZnJvbnRlbmRJZDogc3RyaW5nO1xuICAgICAgdWlkOiBzdHJpbmc7XG4gICAgICBzZXR0aW5nczogU2V0dGluZ3M7XG4gICAgfSA9IDxhbnk+e307XG4gICAgY2xvbmUodGhpcywgcmVzLCBFWFBPUlRFRF9TRVNTSU9OX0ZJRUxEUyk7XG4gICAgcmV0dXJuIHJlcztcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgU2Vzc2lvblNlcnZpY2Uge1xuICBwcml2YXRlIF9zaW5nbGVTZXNzaW9uID0gZmFsc2U7XG4gIHByaXZhdGUgX3Nlc3Npb25zOiBTaWRTZXNzaW9uTWFwO1xuICBwcml2YXRlIF91aWRNYXA6IFVpZFNlc3Npb25zTWFwO1xuICBnZXQgc2luZ2xlU2Vzc2lvbigpIHtcbiAgICByZXR1cm4gdGhpcy5fc2luZ2xlU2Vzc2lvbjtcbiAgfVxuICBjb25zdHJ1Y3RvcihvcHRzPzogYW55KSB7XG4gICAgb3B0cyA9IG9wdHMgfHwge307XG4gICAgdGhpcy5fc2luZ2xlU2Vzc2lvbiA9IG9wdHMuc2luZ2xlU2Vzc2lvbjtcbiAgICB0aGlzLl9zZXNzaW9ucyA9IHt9OyAvLyBzaWQgLT4gc2Vzc2lvblxuICAgIHRoaXMuX3VpZE1hcCA9IHt9OyAvLyB1aWQgLT4gc2Vzc2lvbnNcbiAgfVxuXG4gIGdldCBzZXNzaW9ucygpOiBSZWFkb25seTxTaWRTZXNzaW9uTWFwPiB7XG4gICAgcmV0dXJuIHRoaXMuX3Nlc3Npb25zO1xuICB9XG4gIGdldCB1aWRNYXAoKTogUmVhZG9ubHk8VWlkU2Vzc2lvbnNNYXA+IHtcbiAgICByZXR1cm4gdGhpcy5fdWlkTWFwO1xuICB9XG5cbiAgY3JlYXRlKHNpZDogbnVtYmVyLCBmcm9udGVuZElkOiBzdHJpbmcsIHNvY2tldDogSVNvY2tldCk6IFNlc3Npb24ge1xuICAgIGxldCBzZXNzaW9uID0gbmV3IFNlc3Npb24oc2lkLCBmcm9udGVuZElkLCBzb2NrZXQsIHRoaXMpO1xuICAgIHRoaXMuX3Nlc3Npb25zW3Nlc3Npb24uaWRdID0gc2Vzc2lvbjtcbiAgICByZXR1cm4gc2Vzc2lvbjtcbiAgfVxuXG4gIGJpbmQoc2lkOiBudW1iZXIsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcbiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5fc2Vzc2lvbnNbc2lkXTtcblxuICAgIGlmICghc2Vzc2lvbikge1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIGNiKG5ldyBFcnJvcihcInNlc3Npb24gZG9lcyBub3QgZXhpc3QsIHNpZDogXCIgKyBzaWQpKTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChzZXNzaW9uLnVpZCkge1xuICAgICAgaWYgKHNlc3Npb24udWlkID09PSB1aWQpIHtcbiAgICAgICAgLy8gYWxyZWFkeSBib3VuZCB3aXRoIHRoZSBzYW1lIHVpZFxuICAgICAgICBjYigpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIGFscmVhZHkgYm91bmQgd2l0aCBvdGhlciB1aWRcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICBjYihuZXcgRXJyb3IoXCJzZXNzaW9uIGhhcyBhbHJlYWR5IGJpbmQgd2l0aCBcIiArIHNlc3Npb24udWlkKSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgc2Vzc2lvbnMgPSB0aGlzLnVpZE1hcFt1aWRdO1xuXG4gICAgaWYgKHRoaXMuc2luZ2xlU2Vzc2lvbiAmJiAhIXNlc3Npb25zKSB7XG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgY2IoXG4gICAgICAgICAgbmV3IEVycm9yKFxuICAgICAgICAgICAgXCJzaW5nbGVTZXNzaW9uIGlzIGVuYWJsZWQsIGFuZCBzZXNzaW9uIGhhcyBhbHJlYWR5IGJpbmQgd2l0aCB1aWQ6IFwiICtcbiAgICAgICAgICAgICAgdWlkXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFzZXNzaW9ucykge1xuICAgICAgc2Vzc2lvbnMgPSB0aGlzLl91aWRNYXBbdWlkXSA9IFtdO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gc2Vzc2lvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAvLyBzZXNzaW9uIGhhcyBiaW5kZWQgd2l0aCB0aGUgdWlkXG4gICAgICBpZiAoc2Vzc2lvbnNbaV0uaWQgPT09IHNlc3Npb24uaWQpIHtcbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgc2Vzc2lvbnMucHVzaChzZXNzaW9uKTtcblxuICAgIHNlc3Npb24uYmluZCh1aWQpO1xuXG4gICAgaWYgKGNiKSB7XG4gICAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTtcbiAgICB9XG4gIH1cblxuICB1bmJpbmQoc2lkOiBudW1iZXIsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcbiAgICBjb25zdCBzZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tzaWRdO1xuXG4gICAgaWYgKCFzZXNzaW9uKSB7XG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgY2IobmV3IEVycm9yKFwic2Vzc2lvbiBkb2VzIG5vdCBleGlzdCwgc2lkOiBcIiArIHNpZCkpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFzZXNzaW9uLnVpZCB8fCBzZXNzaW9uLnVpZCAhPT0gdWlkKSB7XG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgY2IobmV3IEVycm9yKFwic2Vzc2lvbiBoYXMgbm90IGJpbmQgd2l0aCBcIiArIHNlc3Npb24udWlkKSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgc2Vzc2lvbnMgPSB0aGlzLl91aWRNYXBbdWlkXTtcbiAgICBsZXQgc2VzczogU2Vzc2lvbjtcbiAgICBpZiAoc2Vzc2lvbnMpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gc2Vzc2lvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgIHNlc3MgPSBzZXNzaW9uc1tpXTtcbiAgICAgICAgaWYgKHNlc3MuaWQgPT09IHNpZCkge1xuICAgICAgICAgIHNlc3Npb25zLnNwbGljZShpLCAxKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoc2Vzc2lvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl91aWRNYXBbdWlkXTtcbiAgICAgIH1cbiAgICB9XG4gICAgc2Vzc2lvbi51bmJpbmQodWlkKTtcblxuICAgIGlmIChjYikge1xuICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYik7XG4gICAgfVxuICB9XG5cbiAgZ2V0KHNpZDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuX3Nlc3Npb25zW3NpZF07XG4gIH1cblxuICBnZXRCeVVpZCh1aWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLl91aWRNYXBbdWlkXTtcbiAgfVxuXG4gIHJlbW92ZShzaWQ6IG51bWJlcikge1xuICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLl9zZXNzaW9uc1tzaWRdO1xuICAgIGlmIChzZXNzaW9uKSB7XG4gICAgICBsZXQgdWlkID0gc2Vzc2lvbi51aWQ7XG4gICAgICBkZWxldGUgdGhpcy5fc2Vzc2lvbnNbc2Vzc2lvbi5pZF07XG5cbiAgICAgIGxldCBzZXNzaW9ucyA9IHRoaXMuX3VpZE1hcFt1aWRdO1xuICAgICAgaWYgKCFzZXNzaW9ucykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gc2Vzc2lvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgIGlmIChzZXNzaW9uc1tpXS5pZCA9PT0gc2lkKSB7XG4gICAgICAgICAgc2Vzc2lvbnMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgIGlmIChzZXNzaW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl91aWRNYXBbdWlkXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpbXBvcnQoc2lkOiBudW1iZXIsIGtleTogYW55LCB2YWx1ZTogYW55LCBjYj86IEZ1bmN0aW9uKSB7XG4gICAgY29uc3Qgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2lkXTtcbiAgICBpZiAoIXNlc3Npb24pIHtcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKFxuICAgICAgICBjYiEsXG4gICAgICAgIG5ldyBFcnJvcihcInNlc3Npb24gZG9lcyBub3QgZXhpc3QsIHNpZDogXCIgKyBzaWQpXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzZXNzaW9uLnNldChrZXksIHZhbHVlKTtcbiAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiEpO1xuICB9XG5cbiAgaW1wb3J0QWxsKHNpZDogbnVtYmVyLCBzZXR0aW5nczogU2V0dGluZ3MsIGNiPzogRnVuY3Rpb24pIHtcbiAgICBsZXQgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2lkXTtcbiAgICBpZiAoIXNlc3Npb24pIHtcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKFxuICAgICAgICBjYiEsXG4gICAgICAgIG5ldyBFcnJvcihcInNlc3Npb24gZG9lcyBub3QgZXhpc3QsIHNpZDogXCIgKyBzaWQpXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAobGV0IGYgaW4gc2V0dGluZ3MpIHtcbiAgICAgIHNlc3Npb24uc2V0KGYsIHNldHRpbmdzW2ZdKTtcbiAgICB9XG4gICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhKTtcbiAgfVxuXG4gIGtpY2sodWlkOiBzdHJpbmcsIHJlYXNvbjogYW55LCBjYj86IEZ1bmN0aW9uKSB7XG4gICAgaWYgKHR5cGVvZiByZWFzb24gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY2IgPSByZWFzb247XG4gICAgICByZWFzb24gPSBcImtpY2tcIjtcbiAgICB9XG4gICAgbGV0IHNlc3Npb25zID0gdGhpcy5nZXRCeVVpZCh1aWQpO1xuXG4gICAgaWYgKHNlc3Npb25zKSB7XG4gICAgICAvLyBub3RpZnkgY2xpZW50XG4gICAgICBsZXQgc2lkczogbnVtYmVyW10gPSBbXTtcbiAgICAgIHNlc3Npb25zLmZvckVhY2goc2Vzc2lvbiA9PiB7XG4gICAgICAgIHNpZHMucHVzaChzZXNzaW9uLmlkKTtcbiAgICAgIH0pO1xuXG4gICAgICBzaWRzLmZvckVhY2goc2lkID0+IHtcbiAgICAgICAgdGhpcy5fc2Vzc2lvbnNbc2lkXS5jbG9zZWQocmVhc29uKTtcbiAgICAgIH0pO1xuXG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IhKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGtpY2tCeVNlc3Npb25JZChzaWQ6IG51bWJlciwgcmVhc29uOiBhbnksIGNiPzogRnVuY3Rpb24pIHtcbiAgICBpZiAodHlwZW9mIHJlYXNvbiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjYiA9IHJlYXNvbjtcbiAgICAgIHJlYXNvbiA9IFwia2lja1wiO1xuICAgIH1cblxuICAgIGxldCBzZXNzaW9uID0gdGhpcy5nZXQoc2lkKTtcblxuICAgIGlmIChzZXNzaW9uKSB7XG4gICAgICAvLyBub3RpZnkgY2xpZW50XG4gICAgICBzZXNzaW9uLmNsb3NlZChyZWFzb24pO1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBnZXRDbGllbnRBZGRyZXNzQnlTZXNzaW9uSWQoc2lkOiBudW1iZXIpIHtcbiAgICBsZXQgc2Vzc2lvbiA9IHRoaXMuZ2V0KHNpZCk7XG4gICAgaWYgKHNlc3Npb24pIHtcbiAgICAgIGxldCBzb2NrZXQgPSBzZXNzaW9uLnNvY2tldDtcbiAgICAgIHJldHVybiBzb2NrZXQucmVtb3RlQWRkcmVzcztcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgc2VuZE1lc3NhZ2Uoc2lkOiBudW1iZXIsIG1zZzogYW55KSB7XG4gICAgbGV0IHNlc3Npb24gPSB0aGlzLmdldChzaWQpO1xuXG4gICAgaWYgKCFzZXNzaW9uKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgIFwiRmFpbCB0byBzZW5kIG1lc3NhZ2UgZm9yIG5vbi1leGlzdGluZyBzZXNzaW9uLCBzaWQ6IFwiICtcbiAgICAgICAgICBzaWQgK1xuICAgICAgICAgIFwiIG1zZzogXCIgK1xuICAgICAgICAgIG1zZ1xuICAgICAgKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBzZXNzaW9uLnNlbmQobXNnKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHNlbmRNZXNzYWdlQnlVaWQodWlkOiBzdHJpbmcsIG1zZzogYW55KSB7XG4gICAgbGV0IHNlc3Npb25zID0gdGhpcy5nZXRCeVVpZCh1aWQpO1xuXG4gICAgaWYgKCFzZXNzaW9ucykge1xuICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICBcImZhaWwgdG8gc2VuZCBtZXNzYWdlIGJ5IHVpZCBmb3Igbm9uLWV4aXN0aW5nIHNlc3Npb24uIHVpZDogJWpcIixcbiAgICAgICAgdWlkXG4gICAgICApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gc2Vzc2lvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICBzZXNzaW9uc1tpXS5zZW5kKG1zZyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBmb3JFYWNoU2Vzc2lvbihjYjogRnVuY3Rpb24pIHtcbiAgICBmb3IgKGxldCBzaWQgaW4gdGhpcy5zZXNzaW9ucykge1xuICAgICAgY2IodGhpcy5zZXNzaW9uc1tzaWRdKTtcbiAgICB9XG4gIH1cblxuICBmb3JFYWNoQmluZGVkU2Vzc2lvbihjYjogRnVuY3Rpb24pIHtcbiAgICBmb3IgKGxldCB1aWQgaW4gdGhpcy51aWRNYXApIHtcbiAgICAgIGxldCBzZXNzaW9ucyA9IHRoaXMudWlkTWFwW3VpZF07XG4gICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHNlc3Npb25zLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgICBjYihzZXNzaW9uc1tpXSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0U2Vzc2lvbkNvdW50KCkge1xuICAgIHJldHVybiB1dGlscy5zaXplKHRoaXMuc2Vzc2lvbnMpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTZXNzaW9uQ29tcG9uZW50IGltcGxlbWVudHMgQ29tcG9uZW50IHtcbiAgcmVhZG9ubHkgbmFtZSA9IFwiX19zZXNzaW9uX19cIjtcbiAgcHJpdmF0ZSBzZXJ2aWNlOiBTZXNzaW9uU2VydmljZTtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgb3B0cz86IGFueSkge1xuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xuICAgIHRoaXMuc2VydmljZSA9IG5ldyBTZXNzaW9uU2VydmljZShvcHRzKTtcbiAgfVxuXG4gIGNyZWF0ZShzaWQ6IG51bWJlciwgZnJvbnRlbmRJZDogc3RyaW5nLCBzb2NrZXQ6IElTb2NrZXQpOiBTZXNzaW9uIHtcbiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLmNyZWF0ZShzaWQsIGZyb250ZW5kSWQsIHNvY2tldCk7XG4gIH1cblxuICBiaW5kKHNpZDogbnVtYmVyLCB1aWQ6IHN0cmluZywgY2I6IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5zZXJ2aWNlLmJpbmQoc2lkLCB1aWQsIGNiKTtcbiAgfVxuXG4gIHVuYmluZChzaWQ6IG51bWJlciwgdWlkOiBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xuICAgIHRoaXMuc2VydmljZS51bmJpbmQoc2lkLCB1aWQsIGNiKTtcbiAgfVxuXG4gIGdldChzaWQ6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLnNlcnZpY2UuZ2V0KHNpZCk7XG4gIH1cblxuICBnZXRCeVVpZCh1aWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnNlcnZpY2UuZ2V0QnlVaWQodWlkKTtcbiAgfVxuXG4gIHJlbW92ZShzaWQ6IG51bWJlcikge1xuICAgIHRoaXMuc2VydmljZS5yZW1vdmUoc2lkKTtcbiAgfVxuXG4gIGltcG9ydChzaWQ6IG51bWJlciwga2V5OiBhbnksIHZhbHVlOiBhbnksIGNiPzogRnVuY3Rpb24pIHtcbiAgICB0aGlzLnNlcnZpY2UuaW1wb3J0KHNpZCwga2V5LCB2YWx1ZSwgY2IpO1xuICB9XG5cbiAgaW1wb3J0QWxsKHNpZDogbnVtYmVyLCBzZXR0aW5nczogU2V0dGluZ3MsIGNiPzogRnVuY3Rpb24pIHtcbiAgICB0aGlzLnNlcnZpY2UuaW1wb3J0QWxsKHNpZCwgc2V0dGluZ3MsIGNiKTtcbiAgfVxuXG4gIGtpY2sodWlkOiBzdHJpbmcsIHJlYXNvbjogYW55LCBjYj86IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5zZXJ2aWNlLmtpY2sodWlkLCByZXNvbHZlTmFwdHIsIGNiKTtcbiAgfVxuXG4gIGtpY2tCeVNlc3Npb25JZChzaWQ6IG51bWJlciwgcmVhc29uOiBhbnksIGNiPzogRnVuY3Rpb24pIHtcbiAgICB0aGlzLnNlcnZpY2Uua2lja0J5U2Vzc2lvbklkKHNpZCwgcmVhc29uLCBjYik7XG4gIH1cblxuICBnZXRDbGllbnRBZGRyZXNzQnlTZXNzaW9uSWQoc2lkOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLmdldENsaWVudEFkZHJlc3NCeVNlc3Npb25JZChzaWQpO1xuICB9XG5cbiAgc2VuZE1lc3NhZ2Uoc2lkOiBudW1iZXIsIG1zZzogYW55KSB7XG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5zZW5kTWVzc2FnZShzaWQsIG1zZyk7XG4gIH1cblxuICBzZW5kTWVzc2FnZUJ5VWlkKHVpZDogc3RyaW5nLCBtc2c6IGFueSkge1xuICAgIHJldHVybiB0aGlzLnNlcnZpY2Uuc2VuZE1lc3NhZ2VCeVVpZCh1aWQsIG1zZyk7XG4gIH1cblxuICBmb3JFYWNoU2Vzc2lvbihjYjogRnVuY3Rpb24pIHtcbiAgICB0aGlzLnNlcnZpY2UuZm9yRWFjaFNlc3Npb24oY2IpO1xuICB9XG5cbiAgZm9yRWFjaEJpbmRlZFNlc3Npb24oY2I6IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5zZXJ2aWNlLmZvckVhY2hCaW5kZWRTZXNzaW9uKGNiKTtcbiAgfVxuXG4gIGdldFNlc3Npb25Db3VudCgpIHtcbiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLmdldFNlc3Npb25Db3VudCgpO1xuICB9XG59XG5mdW5jdGlvbiBjbG9uZShzcmM6IGFueSwgZGVzdDogYW55LCBpbmNsdWRlczogc3RyaW5nW10pIHtcbiAgbGV0IGY7XG4gIGZvciAobGV0IGkgPSAwLCBsID0gaW5jbHVkZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgZiA9IGluY2x1ZGVzW2ldO1xuICAgIGRlc3RbZl0gPSBzcmNbZl07XG4gIH1cbn1cblxuZnVuY3Rpb24gZGNsb25lKHNyYzogYW55KTogYW55IHtcbiAgbGV0IHJlcyA9IHt9O1xuICBmb3IgKGxldCBmIGluIHNyYykge1xuICAgICg8YW55PnJlcylbZl0gPSBzcmNbZl07XG4gIH1cbiAgcmV0dXJuIHJlcztcbn1cbiJdfQ==