"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils = require("../../util/utils");
const EXPORTED_FIELDS = ["id", "frontendId", "uid", "settings"];
class BackendSessionService {
    constructor(app) {
        this.app = app;
        this.name = "__backendSession__";
    }
    create(opts) {
        if (!opts) {
            throw new Error("opts should not be empty.");
        }
        return new BackendSession(opts, this);
    }
    get(frontendId, sid, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "getBackendSessionBySid";
        let args = [sid];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, BackendSessionCB.bind(null, this, cb));
    }
    getByUid(frontendId, uid, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "getBackendSessionBySid";
        let args = [uid];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, BackendSessionCB.bind(null, this, cb));
    }
    kickBySid(frontendId, sid, reason, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "kickBySid";
        let args = [sid];
        if (typeof reason === "function") {
            cb = reason;
        }
        else {
            args.push(reason);
        }
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    kickByUid(frontendId, uid, reason, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "kickByUid";
        let args = [uid];
        if (typeof reason === "function") {
            cb = reason;
        }
        else {
            args.push(reason);
        }
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    bind(frontendId, sid, uid, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "bind";
        let args = [sid, uid];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    unbind(frontendId, sid, uid, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "unbind";
        let args = [sid, uid];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    push(frontendId, sid, key, value, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "push";
        let args = [sid, key, value];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    pushAll(frontendId, sid, settings, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "pushAll";
        let args = [sid, settings];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
}
exports.BackendSessionService = BackendSessionService;
function rpcInvoke(app, serverId, namespace, service, method, args, cb) {
    app.rpcInvoke(serverId, { namespace: namespace, service: service, method: method, args: args }, cb);
}
class BackendSession {
    constructor(opts, __sessionService__) {
        this.__sessionService__ = __sessionService__;
        for (let f in opts) {
            this[f] = opts[f];
        }
    }
    bind(uid, cb) {
        this.__sessionService__.bind(this.frontendId, this.id, uid, (err) => {
            if (!err) {
                this.uid = uid;
            }
            utils.invokeCallback(cb, err);
        });
    }
    unbind(uid, cb) {
        this.__sessionService__.unbind(this.frontendId, this.id, uid, (err) => {
            if (!err) {
                delete this.uid;
            }
            utils.invokeCallback(cb, err);
        });
    }
    set(key, value) {
        this.settings[key] = value;
    }
    get(key) {
        return this.settings[key];
    }
    push(key, cb) {
        this.__sessionService__.push(this.frontendId, this.id, key, this.get(key), cb);
    }
    pushAll(cb) {
        this.__sessionService__.pushAll(this.frontendId, this.id, this.settings, cb);
    }
    export() {
        let res = {};
        for (let field of EXPORTED_FIELDS) {
            res[field] = this[field];
        }
        return res;
    }
}
exports.BackendSession = BackendSession;
function BackendSessionCB(service, cb, err, sinfo) {
    if (err) {
        utils.invokeCallback(cb, err);
        return;
    }
    if (!sinfo) {
        utils.invokeCallback(cb);
        return;
    }
    let sessions = [];
    if (Array.isArray(sinfo)) {
        // #getByUid
        for (let i = 0, k = sinfo.length; i < k; i++) {
            sessions.push(service.create(sinfo[i]));
        }
    }
    else {
        // #get
        sessions = service.create(sinfo);
    }
    utils.invokeCallback(cb, null, sessions);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZFNlc3Npb25TZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFja2VuZFNlc3Npb25TZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMENBQTJDO0FBRzNDLE1BQU0sZUFBZSxHQUFHLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFaEU7SUFFRSxZQUE0QixHQUFnQjtRQUFoQixRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQzFDLElBQUksQ0FBQyxJQUFJLEdBQUcsb0JBQW9CLENBQUM7SUFDbkMsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUF3QjtRQUM3QixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDVixNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7UUFDL0MsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELEdBQUcsQ0FBQyxVQUFrQixFQUFFLEdBQVcsRUFBRSxFQUFZO1FBQy9DLElBQUksU0FBUyxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLE9BQU8sR0FBRyxlQUFlLENBQUM7UUFDOUIsSUFBSSxNQUFNLEdBQUcsd0JBQXdCLENBQUM7UUFDdEMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQixTQUFTLENBQ1AsSUFBSSxDQUFDLEdBQUcsRUFDUixVQUFVLEVBQ1YsU0FBUyxFQUNULE9BQU8sRUFDUCxNQUFNLEVBQ04sSUFBSSxFQUNKLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUN0QyxDQUFDO0lBQ0osQ0FBQztJQUVELFFBQVEsQ0FBQyxVQUFrQixFQUFFLEdBQVcsRUFBRSxFQUFZO1FBQ3BELElBQUksU0FBUyxHQUFHLEtBQUssQ0FB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QUksUUFBUSxHQUEyQyxFQUFFLENBQUM7SUFDMUQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsWUFBWTtRQUNaLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDNUMsUUFBa0MsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7SUFDSCxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixPQUFPO1FBQ1AsUUFBUSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUNELEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztBQUMzQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2V0dGluZ3MgfSBmcm9tIFwiLi4vLi5cIjtcbmltcG9ydCB1dGlscyA9IHJlcXVpcmUoXCIuLi8uLi91dGlsL3V0aWxzXCIpO1xuaW1wb3J0IHsgQXBwbGljYXRpb24sIENvbXBvbmVudCB9IGZyb20gXCIuLi8uLi9hcHBsaWNhdGlvblwiO1xuXG5jb25zdCBFWFBPUlRFRF9GSUVMRFMgPSBbXCJpZFwiLCBcImZyb250ZW5kSWRcIiwgXCJ1aWRcIiwgXCJzZXR0aW5nc1wiXTtcblxuZXhwb3J0IGNsYXNzIEJhY2tlbmRTZXNzaW9uU2VydmljZSBpbXBsZW1lbnRzIENvbXBvbmVudCB7XG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgY29uc3RydWN0b3IocHVibGljIHJlYWRvbmx5IGFwcDogQXBwbGljYXRpb24pIHtcbiAgICB0aGlzLm5hbWUgPSBcIl9fYmFja2VuZFNlc3Npb25fX1wiO1xuICB9XG5cbiAgY3JlYXRlKG9wdHM6IEJhY2tlbmRTZXNzaW9uT3B0cykge1xuICAgIGlmICghb3B0cykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwib3B0cyBzaG91bGQgbm90IGJlIGVtcHR5LlwiKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBCYWNrZW5kU2Vzc2lvbihvcHRzLCB0aGlzKTtcbiAgfVxuXG4gIGdldChmcm9udGVuZElkOiBzdHJpbmcsIHNpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xuICAgIGxldCBtZXRob2QgPSBcImdldEJhY2tlbmRTZXNzaW9uQnlTaWRcIjtcbiAgICBsZXQgYXJncyA9IFtzaWRdO1xuICAgIHJwY0ludm9rZShcbiAgICAgIHRoaXMuYXBwLFxuICAgICAgZnJvbnRlbmRJZCxcbiAgICAgIG5hbWVzcGFjZSxcbiAgICAgIHNlcnZpY2UsXG4gICAgICBtZXRob2QsXG4gICAgICBhcmdzLFxuICAgICAgQmFja2VuZFNlc3Npb25DQi5iaW5kKG51bGwsIHRoaXMsIGNiKVxuICAgICk7XG4gIH1cblxuICBnZXRCeVVpZChmcm9udGVuZElkOiBzdHJpbmcsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xuICAgIGxldCBtZXRob2QgPSBcImdldEJhY2tlbmRTZXNzaW9uQnlTaWRcIjtcbiAgICBsZXQgYXJncyA9IFt1aWRdO1xuXG4gICAgcnBjSW52b2tlKFxuICAgICAgdGhpcy5hcHAsXG4gICAgICBmcm9udGVuZElkLFxuICAgICAgbmFtZXNwYWNlLFxuICAgICAgc2VydmljZSxcbiAgICAgIG1ldGhvZCxcbiAgICAgIGFyZ3MsXG4gICAgICBCYWNrZW5kU2Vzc2lvbkNCLmJpbmQobnVsbCwgdGhpcywgY2IpXG4gICAgKTtcbiAgfVxuXG4gIGtpY2tCeVNpZChmcm9udGVuZElkOiBzdHJpbmcsIHNpZDogc3RyaW5nLCByZWFzb246IGFueSwgY2I6IEZ1bmN0aW9uKSB7XG4gICAgbGV0IG5hbWVzcGFjZSA9IFwic3lzXCI7XG4gICAgbGV0IHNlcnZpY2UgPSBcInNlc3Npb25SZW1vdGVcIjtcbiAgICBsZXQgbWV0aG9kID0gXCJraWNrQnlTaWRcIjtcbiAgICBsZXQgYXJncyA9IFtzaWRdO1xuICAgIGlmICh0eXBlb2YgcmVhc29uID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNiID0gcmVhc29uO1xuICAgIH0gZWxzZSB7XG4gICAgICBhcmdzLnB1c2gocmVhc29uKTtcbiAgICB9XG4gICAgcnBjSW52b2tlKHRoaXMuYXBwLCBmcm9udGVuZElkLCBuYW1lc3BhY2UsIHNlcnZpY2UsIG1ldGhvZCwgYXJncywgY2IpO1xuICB9XG5cbiAga2lja0J5VWlkKGZyb250ZW5kSWQ6IHN0cmluZywgdWlkOiBzdHJpbmcsIHJlYXNvbjogYW55LCBjYjogRnVuY3Rpb24pIHtcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xuICAgIGxldCBtZXRob2QgPSBcImtpY2tCeVVpZFwiO1xuICAgIGxldCBhcmdzID0gW3VpZF07XG4gICAgaWYgKHR5cGVvZiByZWFzb24gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY2IgPSByZWFzb247XG4gICAgfSBlbHNlIHtcbiAgICAgIGFyZ3MucHVzaChyZWFzb24pO1xuICAgIH1cbiAgICBycGNJbnZva2UodGhpcy5hcHAsIGZyb250ZW5kSWQsIG5hbWVzcGFjZSwgc2VydmljZSwgbWV0aG9kLCBhcmdzLCBjYik7XG4gIH1cblxuICBiaW5kKGZyb250ZW5kSWQ6IHN0cmluZywgc2lkOiBudW1iZXIsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xuICAgIGxldCBtZXRob2QgPSBcImJpbmRcIjtcbiAgICBsZXQgYXJncyA9IFtzaWQsIHVpZF07XG4gICAgcnBjSW52b2tlKHRoaXMuYXBwLCBmcm9udGVuZElkLCBuYW1lc3BhY2UsIHNlcnZpY2UsIG1ldGhvZCwgYXJncywgY2IpO1xuICB9XG5cbiAgdW5iaW5kKGZyb250ZW5kSWQ6IHN0cmluZywgc2lkOiBudW1iZXIsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xuICAgIGxldCBtZXRob2QgPSBcInVuYmluZFwiO1xuICAgIGxldCBhcmdzID0gW3NpZCwgdWlkXTtcbiAgICBycGNJbnZva2UodGhpcy5hcHAsIGZyb250ZW5kSWQsIG5hbWVzcGFjZSwgc2VydmljZSwgbWV0aG9kLCBhcmdzLCBjYik7XG4gIH1cblxuICBwdXNoKFxuICAgIGZyb250ZW5kSWQ6IHN0cmluZyxcbiAgICBzaWQ6IG51bWJlcixcbiAgICBrZXk6IHN0cmluZyxcbiAgICB2YWx1ZTogb2JqZWN0LFxuICAgIGNiOiBGdW5jdGlvblxuICApIHtcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xuICAgIGxldCBtZXRob2QgPSBcInB1c2hcIjtcbiAgICBsZXQgYXJncyA9IFtzaWQsIGtleSwgdmFsdWVdO1xuICAgIHJwY0ludm9rZSh0aGlzLmFwcCwgZnJvbnRlbmRJZCwgbmFtZXNwYWNlLCBzZXJ2aWNlLCBtZXRob2QsIGFyZ3MsIGNiKTtcbiAgfVxuXG4gIHB1c2hBbGwoZnJvbnRlbmRJZDogc3RyaW5nLCBzaWQ6IG51bWJlciwgc2V0dGluZ3M6IFNldHRpbmdzLCBjYjogRnVuY3Rpb24pIHtcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xuICAgIGxldCBtZXRob2QgPSBcInB1c2hBbGxcIjtcbiAgICBsZXQgYXJncyA9IFtzaWQsIHNldHRpbmdzXTtcbiAgICBycGNJbnZva2UodGhpcy5hcHAsIGZyb250ZW5kSWQsIG5hbWVzcGFjZSwgc2VydmljZSwgbWV0aG9kLCBhcmdzLCBjYik7XG4gIH1cbn1cblxuZnVuY3Rpb24gcnBjSW52b2tlKFxuICBhcHA6IEFwcGxpY2F0aW9uLFxuICBzZXJ2ZXJJZDogc3RyaW5nLFxuICBuYW1lc3BhY2U6IHN0cmluZyxcbiAgc2VydmljZTogc3RyaW5nLFxuICBtZXRob2Q6IHN0cmluZyxcbiAgYXJnczogQXJyYXk8YW55PixcbiAgY2I6IEZ1bmN0aW9uXG4pIHtcbiAgYXBwLnJwY0ludm9rZShcbiAgICBzZXJ2ZXJJZCxcbiAgICB7IG5hbWVzcGFjZTogbmFtZXNwYWNlLCBzZXJ2aWNlOiBzZXJ2aWNlLCBtZXRob2Q6IG1ldGhvZCwgYXJnczogYXJncyB9LFxuICAgIGNiXG4gICk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFja2VuZFNlc3Npb25PcHRzIHtcbiAgaWQ6IG51bWJlcjtcbiAgZnJvbnRlbmRJZDogc3RyaW5nO1xuICB1aWQ6IHN0cmluZztcbiAgc2V0dGluZ3M/OiB7IFtpZHg6IHN0cmluZ106IGFueSB9O1xufVxuXG5leHBvcnQgY2xhc3MgQmFja2VuZFNlc3Npb24ge1xuICBfX3RpbWVvdXRfXz86bnVtYmVyO1xuICB1aWQ6IHN0cmluZztcbiAgcmVhZG9ubHkgaWQ6IG51bWJlcjtcbiAgcmVhZG9ubHkgZnJvbnRlbmRJZDogc3RyaW5nO1xuICByZWFkb25seSBzZXR0aW5ncz86IFNldHRpbmdzO1xuICBjb25zdHJ1Y3RvcihcbiAgICBvcHRzOiBCYWNrZW5kU2Vzc2lvbk9wdHMsXG4gICAgcHVibGljIHJlYWRvbmx5IF9fc2Vzc2lvblNlcnZpY2VfXzogQmFja2VuZFNlc3Npb25TZXJ2aWNlXG4gICkge1xuICAgIGZvciAobGV0IGYgaW4gb3B0cykge1xuICAgICAgKHRoaXMgYXMgYW55KVtmXSA9IChvcHRzIGFzIGFueSlbZl07XG4gICAgfVxuICB9XG5cbiAgYmluZCh1aWQ6IHN0cmluZyB8IHN0cmluZywgY2I6IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5fX3Nlc3Npb25TZXJ2aWNlX18uYmluZCh0aGlzLmZyb250ZW5kSWQsIHRoaXMuaWQsIHVpZCwgKGVycjogYW55KSA9PiB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICB0aGlzLnVpZCA9IHVpZDtcbiAgICAgIH1cbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiLCBlcnIpO1xuICAgIH0pO1xuICB9XG4gIHVuYmluZCh1aWQ6IHN0cmluZywgY2I6IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5fX3Nlc3Npb25TZXJ2aWNlX18udW5iaW5kKFxuICAgICAgdGhpcy5mcm9udGVuZElkLFxuICAgICAgdGhpcy5pZCxcbiAgICAgIHVpZCxcbiAgICAgIChlcnI6IGFueSkgPT4ge1xuICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgIGRlbGV0ZSB0aGlzLnVpZDtcbiAgICAgICAgfVxuICAgICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiwgZXJyKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG4gIHNldChrZXk6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICAgIHRoaXMuc2V0dGluZ3MhW2tleV0gPSB2YWx1ZTtcbiAgfVxuICBnZXQoa2V5OiBzdHJpbmcpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLnNldHRpbmdzIVtrZXldO1xuICB9XG4gIHB1c2goa2V5OiBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xuICAgIHRoaXMuX19zZXNzaW9uU2VydmljZV9fLnB1c2goXG4gICAgICB0aGlzLmZyb250ZW5kSWQsXG4gICAgICB0aGlzLmlkLFxuICAgICAga2V5LFxuICAgICAgdGhpcy5nZXQoa2V5KSxcbiAgICAgIGNiXG4gICAgKTtcbiAgfVxuICBwdXNoQWxsKGNiOiBGdW5jdGlvbikge1xuICAgIHRoaXMuX19zZXNzaW9uU2VydmljZV9fLnB1c2hBbGwoXG4gICAgICB0aGlzLmZyb250ZW5kSWQsXG4gICAgICB0aGlzLmlkLFxuICAgICAgdGhpcy5zZXR0aW5ncyEsXG4gICAgICBjYlxuICAgICk7XG4gIH1cbiAgZXhwb3J0KCk6IHtcbiAgICBpZDogbnVtYmVyO1xuICAgIGZyb250ZW5kSWQ6IHN0cmluZztcbiAgICB1aWQ6IHN0cmluZztcbiAgICBzZXR0aW5nczogU2V0dGluZ3M7XG4gIH0ge1xuICAgIGxldCByZXMgPSB7fTtcblxuICAgIGZvciAobGV0IGZpZWxkIG9mIEVYUE9SVEVEX0ZJRUxEUykge1xuICAgICAgKDxhbnk+cmVzKVtmaWVsZF0gPSAoPGFueT50aGlzKVtmaWVsZF07XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcyBhcyBhbnk7XG4gIH1cbn1cblxuZnVuY3Rpb24gQmFja2VuZFNlc3Npb25DQihcbiAgc2VydmljZTogQmFja2VuZFNlc3Npb25TZXJ2aWNlLFxuICBjYjogRnVuY3Rpb24sXG4gIGVycjogYW55LFxuICBzaW5mbzogQmFja2VuZFNlc3Npb25PcHRzW11cbikge1xuICBpZiAoZXJyKSB7XG4gICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIGVycik7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKCFzaW5mbykge1xuICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiKTtcbiAgICByZXR1cm47XG4gIH1cbiAgbGV0IHNlc3Npb25zOiBBcnJheTxCYWNrZW5kU2Vzc2lvbj4gfCBCYWNrZW5kU2Vzc2lvbiA9IFtdO1xuICBpZiAoQXJyYXkuaXNBcnJheShzaW5mbykpIHtcbiAgICAvLyAjZ2V0QnlVaWRcbiAgICBmb3IgKGxldCBpID0gMCwgayA9IHNpbmZvLmxlbmd0aDsgaSA8IGs7IGkrKykge1xuICAgICAgKHNlc3Npb25zIGFzIEFycmF5PEJhY2tlbmRTZXNzaW9uPikucHVzaChzZXJ2aWNlLmNyZWF0ZShzaW5mb1tpXSkpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICAvLyAjZ2V0XG4gICAgc2Vzc2lvbnMgPSBzZXJ2aWNlLmNyZWF0ZShzaW5mbyk7XG4gIH1cbiAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIG51bGwsIHNlc3Npb25zKTtcbn1cbiJdfQ==