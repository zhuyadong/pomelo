"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils = require("../../util/utils");
const EXPORTED_FIELDS = ["id", "frontendId", "uid", "settings"];
class BackendSessionService {
    constructor(app) {
        this.app = app;
        this.name = "__backendSession__";
    }
    create(opts) {
        if (!opts) {
            throw new Error("opts should not be empty.");
        }
        return new BackendSession(opts, this);
    }
    get(frontendId, sid, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "getBackendSessionBySid";
        let args = [sid];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, BackendSessionCB.bind(null, this, cb));
    }
    getByUid(frontendId, uid, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "getBackendSessionBySid";
        let args = [uid];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, BackendSessionCB.bind(null, this, cb));
    }
    kickBySid(frontendId, sid, reason, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "kickBySid";
        let args = [sid];
        if (typeof reason === "function") {
            cb = reason;
        }
        else {
            args.push(reason);
        }
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    kickByUid(frontendId, uid, reason, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "kickByUid";
        let args = [uid];
        if (typeof reason === "function") {
            cb = reason;
        }
        else {
            args.push(reason);
        }
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    bind(frontendId, sid, uid, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "bind";
        let args = [sid, uid];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    unbind(frontendId, sid, uid, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "unbind";
        let args = [sid, uid];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    push(frontendId, sid, key, value, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "push";
        let args = [sid, key, value];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
    pushAll(frontendId, sid, settings, cb) {
        let namespace = "sys";
        let service = "sessionRemote";
        let method = "pushAll";
        let args = [sid, settings];
        rpcInvoke(this.app, frontendId, namespace, service, method, args, cb);
    }
}
exports.BackendSessionService = BackendSessionService;
function rpcInvoke(app, serverId, namespace, service, method, args, cb) {
    app.rpcInvoke(serverId, { namespace: namespace, service: service, method: method, args: args }, cb);
}
class BackendSession {
    constructor(opts, __sessionService__) {
        this.__sessionService__ = __sessionService__;
        for (let f in opts) {
            this[f] = opts[f];
        }
    }
    bind(uid, cb) {
        this.__sessionService__.bind(this.frontendId, this.id, uid, (err) => {
            if (!err) {
                this.uid = uid;
            }
            utils.invokeCallback(cb, err);
        });
    }
    unbind(uid, cb) {
        this.__sessionService__.unbind(this.frontendId, this.id, uid, (err) => {
            if (!err) {
                delete this.uid;
            }
            utils.invokeCallback(cb, err);
        });
    }
    set(key, value) {
        this.settings[key] = value;
    }
    get(key) {
        return this.settings[key];
    }
    push(key, cb) {
        this.__sessionService__.push(this.frontendId, this.id, key, this.get(key), cb);
    }
    pushAll(cb) {
        this.__sessionService__.pushAll(this.frontendId, this.id, this.settings, cb);
    }
    export() {
        let res = {};
        for (let field of EXPORTED_FIELDS) {
            res[field] = this[field];
        }
        return res;
    }
}
exports.BackendSession = BackendSession;
function BackendSessionCB(service, cb, err, sinfo) {
    if (err) {
        utils.invokeCallback(cb, err);
        return;
    }
    if (!sinfo) {
        utils.invokeCallback(cb);
        return;
    }
    let sessions = [];
    if (Array.isArray(sinfo)) {
        // #getByUid
        for (let i = 0, k = sinfo.length; i < k; i++) {
            sessions.push(service.create(sinfo[i]));
        }
    }
    else {
        // #get
        sessions = service.create(sinfo);
    }
    utils.invokeCallback(cb, null, sessions);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZFNlc3Npb25TZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFja2VuZFNlc3Npb25TZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsMENBQTJDO0FBRzNDLE1BQU0sZUFBZSxHQUFHLENBQUMsSUFBSSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFFaEU7SUFFRSxZQUE0QixHQUFnQjtRQUFoQixRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQzFDLElBQUksQ0FBQyxJQUFJLEdBQUcsb0JBQW9CLENBQUM7SUFDbkMsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUF3QjtRQUM3QixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDVixNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7UUFDL0MsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELEdBQUcsQ0FBQyxVQUFrQixFQUFFLEdBQVcsRUFBRSxFQUFZO1FBQy9DLElBQUksU0FBUyxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLE9BQU8sR0FBRyxlQUFlLENBQUM7UUFDOUIsSUFBSSxNQUFNLEdBQUcsd0JBQXdCLENBQUM7UUFDdEMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQixTQUFTLENBQ1AsSUFBSSxDQUFDLEdBQUcsRUFDUixVQUFVLEVBQ1YsU0FBUyxFQUNULE9BQU8sRUFDUCxNQUFNLEVBQ04sSUFBSSxFQUNKLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUN0QyxDQUFDO0lBQ0osQ0FBQztJQUVELFFBQVEsQ0FBQyxVQUFrQixFQUFFLEdBQVcsRUFBRSxFQUFZO1FBQ3BELElBQUksU0FBUyxHQUFHLEtBQUssQ0FB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QUksUUFBUSxHQUEyQyxFQUFFLENBQUM7SUFDMUQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsWUFBWTtRQUNaLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDNUMsUUFBa0MsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLENBQUM7SUFDSCxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixPQUFPO1FBQ1AsUUFBUSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUNELEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztBQUMzQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2V0dGluZ3MgfSBmcm9tIFwiLi4vLi5cIjtcclxuaW1wb3J0IHV0aWxzID0gcmVxdWlyZShcIi4uLy4uL3V0aWwvdXRpbHNcIik7XHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBDb21wb25lbnQgfSBmcm9tIFwiLi4vLi4vYXBwbGljYXRpb25cIjtcclxuXHJcbmNvbnN0IEVYUE9SVEVEX0ZJRUxEUyA9IFtcImlkXCIsIFwiZnJvbnRlbmRJZFwiLCBcInVpZFwiLCBcInNldHRpbmdzXCJdO1xyXG5cclxuZXhwb3J0IGNsYXNzIEJhY2tlbmRTZXNzaW9uU2VydmljZSBpbXBsZW1lbnRzIENvbXBvbmVudCB7XHJcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uKSB7XHJcbiAgICB0aGlzLm5hbWUgPSBcIl9fYmFja2VuZFNlc3Npb25fX1wiO1xyXG4gIH1cclxuXHJcbiAgY3JlYXRlKG9wdHM6IEJhY2tlbmRTZXNzaW9uT3B0cykge1xyXG4gICAgaWYgKCFvcHRzKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIm9wdHMgc2hvdWxkIG5vdCBiZSBlbXB0eS5cIik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3IEJhY2tlbmRTZXNzaW9uKG9wdHMsIHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgZ2V0KGZyb250ZW5kSWQ6IHN0cmluZywgc2lkOiBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xyXG4gICAgbGV0IG5hbWVzcGFjZSA9IFwic3lzXCI7XHJcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xyXG4gICAgbGV0IG1ldGhvZCA9IFwiZ2V0QmFja2VuZFNlc3Npb25CeVNpZFwiO1xyXG4gICAgbGV0IGFyZ3MgPSBbc2lkXTtcclxuICAgIHJwY0ludm9rZShcclxuICAgICAgdGhpcy5hcHAsXHJcbiAgICAgIGZyb250ZW5kSWQsXHJcbiAgICAgIG5hbWVzcGFjZSxcclxuICAgICAgc2VydmljZSxcclxuICAgICAgbWV0aG9kLFxyXG4gICAgICBhcmdzLFxyXG4gICAgICBCYWNrZW5kU2Vzc2lvbkNCLmJpbmQobnVsbCwgdGhpcywgY2IpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0QnlVaWQoZnJvbnRlbmRJZDogc3RyaW5nLCB1aWQ6IHN0cmluZywgY2I6IEZ1bmN0aW9uKSB7XHJcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcclxuICAgIGxldCBzZXJ2aWNlID0gXCJzZXNzaW9uUmVtb3RlXCI7XHJcbiAgICBsZXQgbWV0aG9kID0gXCJnZXRCYWNrZW5kU2Vzc2lvbkJ5U2lkXCI7XHJcbiAgICBsZXQgYXJncyA9IFt1aWRdO1xyXG5cclxuICAgIHJwY0ludm9rZShcclxuICAgICAgdGhpcy5hcHAsXHJcbiAgICAgIGZyb250ZW5kSWQsXHJcbiAgICAgIG5hbWVzcGFjZSxcclxuICAgICAgc2VydmljZSxcclxuICAgICAgbWV0aG9kLFxyXG4gICAgICBhcmdzLFxyXG4gICAgICBCYWNrZW5kU2Vzc2lvbkNCLmJpbmQobnVsbCwgdGhpcywgY2IpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAga2lja0J5U2lkKGZyb250ZW5kSWQ6IHN0cmluZywgc2lkOiBzdHJpbmcsIHJlYXNvbjogYW55LCBjYjogRnVuY3Rpb24pIHtcclxuICAgIGxldCBuYW1lc3BhY2UgPSBcInN5c1wiO1xyXG4gICAgbGV0IHNlcnZpY2UgPSBcInNlc3Npb25SZW1vdGVcIjtcclxuICAgIGxldCBtZXRob2QgPSBcImtpY2tCeVNpZFwiO1xyXG4gICAgbGV0IGFyZ3MgPSBbc2lkXTtcclxuICAgIGlmICh0eXBlb2YgcmVhc29uID09PSBcImZ1bmN0aW9uXCIpIHtcclxuICAgICAgY2IgPSByZWFzb247XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBhcmdzLnB1c2gocmVhc29uKTtcclxuICAgIH1cclxuICAgIHJwY0ludm9rZSh0aGlzLmFwcCwgZnJvbnRlbmRJZCwgbmFtZXNwYWNlLCBzZXJ2aWNlLCBtZXRob2QsIGFyZ3MsIGNiKTtcclxuICB9XHJcblxyXG4gIGtpY2tCeVVpZChmcm9udGVuZElkOiBzdHJpbmcsIHVpZDogc3RyaW5nLCByZWFzb246IGFueSwgY2I6IEZ1bmN0aW9uKSB7XHJcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcclxuICAgIGxldCBzZXJ2aWNlID0gXCJzZXNzaW9uUmVtb3RlXCI7XHJcbiAgICBsZXQgbWV0aG9kID0gXCJraWNrQnlVaWRcIjtcclxuICAgIGxldCBhcmdzID0gW3VpZF07XHJcbiAgICBpZiAodHlwZW9mIHJlYXNvbiA9PT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgIGNiID0gcmVhc29uO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgYXJncy5wdXNoKHJlYXNvbik7XHJcbiAgICB9XHJcbiAgICBycGNJbnZva2UodGhpcy5hcHAsIGZyb250ZW5kSWQsIG5hbWVzcGFjZSwgc2VydmljZSwgbWV0aG9kLCBhcmdzLCBjYik7XHJcbiAgfVxyXG5cclxuICBiaW5kKGZyb250ZW5kSWQ6IHN0cmluZywgc2lkOiBudW1iZXIsIHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIGxldCBuYW1lc3BhY2UgPSBcInN5c1wiO1xyXG4gICAgbGV0IHNlcnZpY2UgPSBcInNlc3Npb25SZW1vdGVcIjtcclxuICAgIGxldCBtZXRob2QgPSBcImJpbmRcIjtcclxuICAgIGxldCBhcmdzID0gW3NpZCwgdWlkXTtcclxuICAgIHJwY0ludm9rZSh0aGlzLmFwcCwgZnJvbnRlbmRJZCwgbmFtZXNwYWNlLCBzZXJ2aWNlLCBtZXRob2QsIGFyZ3MsIGNiKTtcclxuICB9XHJcblxyXG4gIHVuYmluZChmcm9udGVuZElkOiBzdHJpbmcsIHNpZDogbnVtYmVyLCB1aWQ6IHN0cmluZywgY2I6IEZ1bmN0aW9uKSB7XHJcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcclxuICAgIGxldCBzZXJ2aWNlID0gXCJzZXNzaW9uUmVtb3RlXCI7XHJcbiAgICBsZXQgbWV0aG9kID0gXCJ1bmJpbmRcIjtcclxuICAgIGxldCBhcmdzID0gW3NpZCwgdWlkXTtcclxuICAgIHJwY0ludm9rZSh0aGlzLmFwcCwgZnJvbnRlbmRJZCwgbmFtZXNwYWNlLCBzZXJ2aWNlLCBtZXRob2QsIGFyZ3MsIGNiKTtcclxuICB9XHJcblxyXG4gIHB1c2goXHJcbiAgICBmcm9udGVuZElkOiBzdHJpbmcsXHJcbiAgICBzaWQ6IG51bWJlcixcclxuICAgIGtleTogc3RyaW5nLFxyXG4gICAgdmFsdWU6IG9iamVjdCxcclxuICAgIGNiOiBGdW5jdGlvblxyXG4gICkge1xyXG4gICAgbGV0IG5hbWVzcGFjZSA9IFwic3lzXCI7XHJcbiAgICBsZXQgc2VydmljZSA9IFwic2Vzc2lvblJlbW90ZVwiO1xyXG4gICAgbGV0IG1ldGhvZCA9IFwicHVzaFwiO1xyXG4gICAgbGV0IGFyZ3MgPSBbc2lkLCBrZXksIHZhbHVlXTtcclxuICAgIHJwY0ludm9rZSh0aGlzLmFwcCwgZnJvbnRlbmRJZCwgbmFtZXNwYWNlLCBzZXJ2aWNlLCBtZXRob2QsIGFyZ3MsIGNiKTtcclxuICB9XHJcblxyXG4gIHB1c2hBbGwoZnJvbnRlbmRJZDogc3RyaW5nLCBzaWQ6IG51bWJlciwgc2V0dGluZ3M6IFNldHRpbmdzLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIGxldCBuYW1lc3BhY2UgPSBcInN5c1wiO1xyXG4gICAgbGV0IHNlcnZpY2UgPSBcInNlc3Npb25SZW1vdGVcIjtcclxuICAgIGxldCBtZXRob2QgPSBcInB1c2hBbGxcIjtcclxuICAgIGxldCBhcmdzID0gW3NpZCwgc2V0dGluZ3NdO1xyXG4gICAgcnBjSW52b2tlKHRoaXMuYXBwLCBmcm9udGVuZElkLCBuYW1lc3BhY2UsIHNlcnZpY2UsIG1ldGhvZCwgYXJncywgY2IpO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcnBjSW52b2tlKFxyXG4gIGFwcDogQXBwbGljYXRpb24sXHJcbiAgc2VydmVySWQ6IHN0cmluZyxcclxuICBuYW1lc3BhY2U6IHN0cmluZyxcclxuICBzZXJ2aWNlOiBzdHJpbmcsXHJcbiAgbWV0aG9kOiBzdHJpbmcsXHJcbiAgYXJnczogQXJyYXk8YW55PixcclxuICBjYjogRnVuY3Rpb25cclxuKSB7XHJcbiAgYXBwLnJwY0ludm9rZShcclxuICAgIHNlcnZlcklkLFxyXG4gICAgeyBuYW1lc3BhY2U6IG5hbWVzcGFjZSwgc2VydmljZTogc2VydmljZSwgbWV0aG9kOiBtZXRob2QsIGFyZ3M6IGFyZ3MgfSxcclxuICAgIGNiXHJcbiAgKTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBCYWNrZW5kU2Vzc2lvbk9wdHMge1xyXG4gIGlkOiBudW1iZXI7XHJcbiAgZnJvbnRlbmRJZDogc3RyaW5nO1xyXG4gIHVpZDogc3RyaW5nO1xyXG4gIHNldHRpbmdzPzogeyBbaWR4OiBzdHJpbmddOiBhbnkgfTtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEJhY2tlbmRTZXNzaW9uIHtcclxuICBfX3RpbWVvdXRfXz86bnVtYmVyO1xyXG4gIHVpZDogc3RyaW5nO1xyXG4gIHJlYWRvbmx5IGlkOiBudW1iZXI7XHJcbiAgcmVhZG9ubHkgZnJvbnRlbmRJZDogc3RyaW5nO1xyXG4gIHJlYWRvbmx5IHNldHRpbmdzPzogU2V0dGluZ3M7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBvcHRzOiBCYWNrZW5kU2Vzc2lvbk9wdHMsXHJcbiAgICBwdWJsaWMgcmVhZG9ubHkgX19zZXNzaW9uU2VydmljZV9fOiBCYWNrZW5kU2Vzc2lvblNlcnZpY2VcclxuICApIHtcclxuICAgIGZvciAobGV0IGYgaW4gb3B0cykge1xyXG4gICAgICAodGhpcyBhcyBhbnkpW2ZdID0gKG9wdHMgYXMgYW55KVtmXTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGJpbmQodWlkOiBzdHJpbmcgfCBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5fX3Nlc3Npb25TZXJ2aWNlX18uYmluZCh0aGlzLmZyb250ZW5kSWQsIHRoaXMuaWQsIHVpZCwgKGVycjogYW55KSA9PiB7XHJcbiAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgdGhpcy51aWQgPSB1aWQ7XHJcbiAgICAgIH1cclxuICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIGVycik7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgdW5iaW5kKHVpZDogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuX19zZXNzaW9uU2VydmljZV9fLnVuYmluZChcclxuICAgICAgdGhpcy5mcm9udGVuZElkLFxyXG4gICAgICB0aGlzLmlkLFxyXG4gICAgICB1aWQsXHJcbiAgICAgIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICghZXJyKSB7XHJcbiAgICAgICAgICBkZWxldGUgdGhpcy51aWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiLCBlcnIpO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgIHRoaXMuc2V0dGluZ3MhW2tleV0gPSB2YWx1ZTtcclxuICB9XHJcbiAgZ2V0KGtleTogc3RyaW5nKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLnNldHRpbmdzIVtrZXldO1xyXG4gIH1cclxuICBwdXNoKGtleTogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuX19zZXNzaW9uU2VydmljZV9fLnB1c2goXHJcbiAgICAgIHRoaXMuZnJvbnRlbmRJZCxcclxuICAgICAgdGhpcy5pZCxcclxuICAgICAga2V5LFxyXG4gICAgICB0aGlzLmdldChrZXkpLFxyXG4gICAgICBjYlxyXG4gICAgKTtcclxuICB9XHJcbiAgcHVzaEFsbChjYjogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuX19zZXNzaW9uU2VydmljZV9fLnB1c2hBbGwoXHJcbiAgICAgIHRoaXMuZnJvbnRlbmRJZCxcclxuICAgICAgdGhpcy5pZCxcclxuICAgICAgdGhpcy5zZXR0aW5ncyEsXHJcbiAgICAgIGNiXHJcbiAgICApO1xyXG4gIH1cclxuICBleHBvcnQoKToge1xyXG4gICAgaWQ6IG51bWJlcjtcclxuICAgIGZyb250ZW5kSWQ6IHN0cmluZztcclxuICAgIHVpZDogc3RyaW5nO1xyXG4gICAgc2V0dGluZ3M6IFNldHRpbmdzO1xyXG4gIH0ge1xyXG4gICAgbGV0IHJlcyA9IHt9O1xyXG5cclxuICAgIGZvciAobGV0IGZpZWxkIG9mIEVYUE9SVEVEX0ZJRUxEUykge1xyXG4gICAgICAoPGFueT5yZXMpW2ZpZWxkXSA9ICg8YW55PnRoaXMpW2ZpZWxkXTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzIGFzIGFueTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIEJhY2tlbmRTZXNzaW9uQ0IoXHJcbiAgc2VydmljZTogQmFja2VuZFNlc3Npb25TZXJ2aWNlLFxyXG4gIGNiOiBGdW5jdGlvbixcclxuICBlcnI6IGFueSxcclxuICBzaW5mbzogQmFja2VuZFNlc3Npb25PcHRzW11cclxuKSB7XHJcbiAgaWYgKGVycikge1xyXG4gICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIGVycik7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBpZiAoIXNpbmZvKSB7XHJcbiAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYik7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIGxldCBzZXNzaW9uczogQXJyYXk8QmFja2VuZFNlc3Npb24+IHwgQmFja2VuZFNlc3Npb24gPSBbXTtcclxuICBpZiAoQXJyYXkuaXNBcnJheShzaW5mbykpIHtcclxuICAgIC8vICNnZXRCeVVpZFxyXG4gICAgZm9yIChsZXQgaSA9IDAsIGsgPSBzaW5mby5sZW5ndGg7IGkgPCBrOyBpKyspIHtcclxuICAgICAgKHNlc3Npb25zIGFzIEFycmF5PEJhY2tlbmRTZXNzaW9uPikucHVzaChzZXJ2aWNlLmNyZWF0ZShzaW5mb1tpXSkpO1xyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICAvLyAjZ2V0XHJcbiAgICBzZXNzaW9ucyA9IHNlcnZpY2UuY3JlYXRlKHNpbmZvKTtcclxuICB9XHJcbiAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIG51bGwsIHNlc3Npb25zKTtcclxufVxyXG4iXX0=