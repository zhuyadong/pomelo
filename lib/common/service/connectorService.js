"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const rsa = require("node-bignumber");
class ConnectorComponent {
    constructor(app, opts) {
        this.app = app;
        this.name = "__connector__";
        opts = opts || {};
        this.connector = getConnector(app, opts);
        this.encode = opts.encode;
        this.decode = opts.decode;
        this.useCrypto = opts.useCrypto;
        this.useHostFilter = opts.useHostFilter;
        this.useAsyncCoder = opts.useAsyncCoder;
        this.blacklistFun = opts.blacklistFun;
        this.keys = {};
        this.blacklist = [];
        if (opts.useDict) {
            app.load(index_1.pomelo.dictionary, app.get("dictionaryConfig"));
        }
        if (opts.useProtobuf) {
            app.load(index_1.pomelo.protobuf, app.get("protobufConfig"));
        }
        // component dependencies
        this.server = null;
        this.session = null;
        this.connection = null;
    }
    start(cb) {
        this.server = this.app.components.__server__;
        this.session = this.app.components.__session__;
        this.connection = this.app.components.__connection__;
        // check component dependencies
        if (!this.server) {
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb, new Error("fail to start connector component for no server component loaded"));
            });
            return;
        }
        if (!this.session) {
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb, new Error("fail to start connector component for no session component loaded"));
            });
            return;
        }
        process.nextTick(cb);
    }
    afterStart(cb) {
        this.connector.start(cb);
        this.connector.on("connection", this.hostFilter.bind(this, bindEvents));
    }
    stop(force, cb) {
        if (this.connector) {
            this.connector.stop(force, cb);
            this.connector = null;
            return;
        }
        else {
            process.nextTick(cb);
        }
    }
    send(reqId, route, msg, recvs, opts, cb) {
        logger.debug("[%s] send message reqId: %s, route: %s, msg: %j, receivers: %j, opts: %j", this.app.serverId, reqId, route, msg, recvs, opts);
        if (this.useAsyncCoder) {
            return this.sendAsync(reqId, route, msg, recvs, opts, cb);
        }
        let emsg = msg;
        if (this.encode) {
            // use costumized encode
            emsg = this.encode.call(this, reqId, route, msg);
        }
        else if (this.connector.encode) {
            // use connector default encode
            emsg = this.connector.encode(reqId, route, msg);
        }
        this.doSend(reqId, route, emsg, recvs, opts, cb);
    }
    sendAsync(reqId, route, msg, recvs, opts, cb) {
        let emsg = msg;
        if (this.encode) {
            // use costumized encode
            this.encode(reqId, route, msg, (err, encodeMsg) => {
                if (err) {
                    return cb(err);
                }
                emsg = encodeMsg;
                this.doSend(reqId, route, emsg, recvs, opts, cb);
            });
        }
        else if (this.connector.encode) {
            // use connector default encode
            this.connector.encode(reqId, route, msg, (err, encodeMsg) => {
                if (err) {
                    return cb(err);
                }
                emsg = encodeMsg;
                this.doSend(reqId, route, emsg, recvs, opts, cb);
            });
        }
    }
    doSend(reqId, route, emsg, recvs, opts, cb) {
        if (!emsg) {
            process.nextTick(() => {
                return (cb &&
                    cb(new Error("fail to send message for encode result is empty.")));
            });
        }
        this.app.components.__pushScheduler__.schedule(reqId, route, emsg, recvs, opts, cb);
    }
    setPubKey(id, key) {
        let pubKey = new rsa.Key();
        pubKey.n = new rsa.BigInteger(key.rsa_n, 16);
        pubKey.e = key.rsa_e;
        this.keys[id] = pubKey;
    }
    getPubKey(id) {
        return this.keys[id];
    }
    hostFilter(cb, socket) {
        if (!this.useHostFilter) {
            return cb(this, socket);
        }
        let ip = socket.remoteAddress.ip;
        let check = (list) => {
            for (let address in list) {
                let exp = new RegExp(list[address]);
                if (exp.test(ip)) {
                    socket.disconnect();
                    return true;
                }
            }
            return false;
        };
        // dynamical check
        if (this.blacklist.length !== 0 && !!check(this.blacklist)) {
            return;
        }
        // static check
        if (!!this.blacklistFun && typeof this.blacklistFun === "function") {
            this.blacklistFun((err, list) => {
                if (!!err) {
                    logger.error("connector blacklist error: %j", err.stack);
                    index_1.utils.invokeCallback(cb, this, socket);
                    return;
                }
                if (!Array.isArray(list)) {
                    logger.error("connector blacklist is not array: %j", list);
                    index_1.utils.invokeCallback(cb, this, socket);
                    return;
                }
                if (!!check(list)) {
                    return;
                }
                else {
                    index_1.utils.invokeCallback(cb, this, socket);
                    return;
                }
            });
        }
        else {
            index_1.utils.invokeCallback(cb, this, socket);
        }
    }
}
exports.ConnectorComponent = ConnectorComponent;
//FIXME:这里的代码好像根本没有用，没有一个decode函数支持cb的
function handleMessageAsync(self, msg, session, socket) {
    if (self.decode) {
        self.decode(msg, session, (err, dmsg) => {
            if (err) {
                logger.error("fail to decode message from client %s .", err.stack);
                return;
            }
            doHandleMessage(self, dmsg, session);
        });
    }
    else if (self.connector.decode) {
        self.connector.decode(msg, socket, (err, dmsg) => {
            if (err) {
                logger.error("fail to decode message from client %s .", err.stack);
                return;
            }
            doHandleMessage(self, dmsg, session);
        });
    }
}
function doHandleMessage(self, dmsg, session) {
    if (!dmsg) {
        // discard invalid message
        return;
    }
    // use rsa crypto
    if (self.useCrypto) {
        let verified = verifyMessage(self, session, dmsg);
        if (!verified) {
            logger.error("fail to verify the data received from client.");
            return;
        }
    }
    handleMessage(self, session, dmsg);
}
function getSession(self, socket) {
    let app = self.app, sid = socket.id;
    let session = self.session.get(sid);
    if (session) {
        return session;
    }
    session = self.session.create(sid, app.serverId, socket);
    logger.debug("[%s] getSession session is created with session id: %s", app.serverId, sid);
    // bind events for session
    socket.on("disconnect", session.closed.bind(session));
    socket.on("error", session.closed.bind(session));
    session.on("closed", onSessionClose.bind(null, app));
    session.on("bind", (uid) => {
        logger.debug("session on [%s] bind with uid: %s", self.app.serverId, uid);
        // update connection statistics if necessary
        if (self.connection) {
            self.connection.addLoginedUser(uid, {
                loginTime: Date.now(),
                uid: uid,
                address: socket.remoteAddress.ip + ":" + socket.remoteAddress.port
            });
        }
        self.app.event.emit(index_1.events.BIND_SESSION, session);
    });
    session.on("unbind", (uid) => {
        if (self.connection) {
            self.connection.removeLoginedUser(uid);
        }
        self.app.event.emit(index_1.events.UNBIND_SESSION, session);
    });
    return session;
}
function getConnector(app, opts) {
    let connector = opts.connector;
    if (!connector) {
        return getDefaultConnector(app, opts);
    }
    if (typeof connector !== "function") {
        return connector;
    }
    let curServer = app.curServer;
    return new connector(curServer.clientPort, curServer.host, opts);
}
function getDefaultConnector(app, opts) {
    let DefaultConnector = require("../connectors/sioconnector");
    let curServer = app.curServer;
    return new DefaultConnector(curServer.clientPort, curServer.host, opts);
}
function onSessionClose(app, session, reason) {
    index_1.taskManager.closeQueue(session.id, true);
    app.event.emit(index_1.events.CLOSE_SESSION, session);
}
function checkServerType(route) {
    if (!route) {
        return null;
    }
    let idx = route.indexOf(".");
    if (idx < 0) {
        return null;
    }
    return route.substring(0, idx);
}
function bindEvents(self, socket) {
    let curServer = self.app.curServer;
    let maxConnections = curServer["max-connections"];
    if (self.connection && maxConnections) {
        self.connection.increaseConnectionCount();
        let statisticInfo = self.connection.getStatisticsInfo();
        if (statisticInfo.totalConnCount > maxConnections) {
            logger.warn("the server %s has reached the max connections %s", curServer.id, maxConnections);
            socket.disconnect();
            return;
        }
    }
    //create session for connection
    let session = getSession(self, socket);
    let closed = false;
    socket.on("disconnect", () => {
        if (closed) {
            return;
        }
        closed = true;
        if (self.connection) {
            self.connection.decreaseConnectionCount(session.uid);
        }
    });
    socket.on("error", () => {
        if (closed) {
            return;
        }
        closed = true;
        if (self.connection) {
            self.connection.decreaseConnectionCount(session.uid);
        }
    });
    // new message
    socket.on("message", msg => {
        let dmsg = msg;
        if (self.useAsyncCoder) {
            return handleMessageAsync(self, msg, session, socket);
        }
        if (self.decode) {
            dmsg = self.decode(msg, session);
        }
        else if (self.connector.decode) {
            dmsg = self.connector.decode(msg, socket);
        }
        if (!dmsg) {
            // discard invalid message
            return;
        }
        // use rsa crypto
        if (self.useCrypto) {
            let verified = verifyMessage(self, session, dmsg);
            if (!verified) {
                logger.error("fail to verify the data received from client.");
                return;
            }
        }
        handleMessage(self, session, dmsg);
    }); //on message end
}
function handleMessage(self, session, msg) {
    logger.debug("[%s] handleMessage session id: %s, msg: %j", self.app.serverId, session.id, msg);
    let type = checkServerType(msg.route);
    if (!type) {
        logger.error("invalid route string. route : %j", msg.route);
        return;
    }
    self.server.globalHandle(msg, session.toFrontendSession(), (err, resp, opts) => {
        if (resp && !msg.id) {
            logger.warn("try to response to a notify: %j", msg.route);
            return;
        }
        if (!msg.id && !resp)
            return;
        if (!resp)
            resp = {};
        if (!!err && !resp.code) {
            resp.code = 500;
        }
        opts = {
            type: "response",
            userOptions: opts || {}
        };
        // for compatiablity
        opts.isResponse = true;
        self.send(msg.id, msg.route, resp, [session.id], opts, () => { });
    });
}
function verifyMessage(self, session, msg) {
    let sig = msg.body.__crypto__;
    if (!sig) {
        logger.error("receive data from client has no signature [%s]", self.app.serverId);
        return false;
    }
    let pubKey;
    if (!session) {
        logger.error("could not find session.");
        return false;
    }
    if (!session.get("pubKey")) {
        pubKey = self.getPubKey(session.id.toString());
        if (!!pubKey) {
            delete self.keys[session.id];
            session.set("pubKey", pubKey);
        }
        else {
            logger.error("could not get public key, session id is %s", session.id);
            return false;
        }
    }
    else {
        pubKey = session.get("pubKey");
    }
    if (!pubKey.n || !pubKey.e) {
        logger.error("could not verify message without public key [%s]", self.app.serverId);
        return false;
    }
    delete msg.body.__crypto__;
    let message = JSON.stringify(msg.body);
    if (index_1.utils.hasChineseChar(message))
        message = index_1.utils.unicodeToUtf8(message);
    return pubKey.verifyString(message, sig);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdG9yU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbm5lY3RvclNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FpQnFCO0FBRXJCLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ3hFLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBY3RDO0lBY0UsWUFBcUIsR0FBZ0IsRUFBRSxJQUE2QjtRQUEvQyxRQUFHLEdBQUgsR0FBRyxDQUFhO1FBYjVCLFNBQUksR0FBVyxlQUFlLENBQUM7UUFjdEMsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxZQUFZLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU8sQ0FBQztRQUMzQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFPLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBVSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWMsQ0FBQztRQUN6QyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFjLENBQUM7UUFDekMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBYSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFFcEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDakIsR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFNLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxHQUFH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QUMsQ0FBQztZQUN2RSxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2YsQ0FBQztJQUNILENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLENBQUMsS0FBSyxDQUNWLGtEQUFrRCxFQUNsRCxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FDbEIsQ0FBQztRQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUUzQixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2QyxFQUFFLENBQUMsQ0FBQyxhQUFLLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQUMsT0FBTyxHQUFHLGFBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFMUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzNDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbm5lY3RvcixcclxuICBDb25uZWN0b3JFbmNvZGVGdW5jLFxyXG4gIENvbm5lY3RvckRlY29kZUZ1bmMsXHJcbiAgQmxhY2tsaXN0RnVuYyxcclxuICBDb21wb25lbnQsXHJcbiAgU2VydmVyQ29tcG9uZW50LFxyXG4gIFNlc3Npb25Db21wb25lbnQsXHJcbiAgQ29ubmVjdGlvbkNvbXBvbmVudCxcclxuICBCbGFja2xpc3QsXHJcbiAgQXBwbGljYXRpb24sXHJcbiAgcG9tZWxvLFxyXG4gIHV0aWxzLFxyXG4gIElTb2NrZXQsXHJcbiAgU2Vzc2lvbixcclxuICBldmVudHMsXHJcbiAgdGFza01hbmFnZXJcclxufSBmcm9tIFwiLi4vLi4vaW5kZXhcIjtcclxuXHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcclxuY29uc3QgcnNhID0gcmVxdWlyZShcIm5vZGUtYmlnbnVtYmVyXCIpO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0b3JDb21wb25lbnRPcHRzIHtcclxuICBjb25uZWN0b3I/OiBDb25uZWN0b3I7XHJcbiAgZW5jb2RlPzogQ29ubmVjdG9yRW5jb2RlRnVuYztcclxuICBkZWNvZGU/OiBDb25uZWN0b3JEZWNvZGVGdW5jO1xyXG4gIHVzZURpY3Q/OiBib29sZWFuO1xyXG4gIHVzZVByb3RvYnVmPzogYm9vbGVhbjtcclxuICB1c2VDcnlwdG8/OiBib29sZWFuO1xyXG4gIHVzZUhvc3RGaWx0ZXI/OiBib29sZWFuO1xyXG4gIHVzZUFzeW5jQ29kZXI/OiBib29sZWFuO1xyXG4gIGJsYWNrbGlzdEZ1bj86IEJsYWNrbGlzdEZ1bmM7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBDb25uZWN0b3JDb21wb25lbnQgaW1wbGVtZW50cyBDb21wb25lbnQge1xyXG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZyA9IFwiX19jb25uZWN0b3JfX1wiO1xyXG4gIHJlYWRvbmx5IGNvbm5lY3RvcjogQ29ubmVjdG9yO1xyXG4gIHJlYWRvbmx5IGVuY29kZTogQ29ubmVjdG9yRW5jb2RlRnVuYztcclxuICByZWFkb25seSBkZWNvZGU6IENvbm5lY3RvckRlY29kZUZ1bmM7XHJcbiAgcmVhZG9ubHkgdXNlQ3J5cHRvOiBib29sZWFuO1xyXG4gIHJlYWRvbmx5IHVzZUhvc3RGaWx0ZXI6IGJvb2xlYW47XHJcbiAgcmVhZG9ubHkgdXNlQXN5bmNDb2RlcjogYm9vbGVhbjtcclxuICByZWFkb25seSBzZXJ2ZXI6IFNlcnZlckNvbXBvbmVudDtcclxuICByZWFkb25seSBzZXNzaW9uOiBTZXNzaW9uQ29tcG9uZW50O1xyXG4gIHJlYWRvbmx5IGNvbm5lY3Rpb246IENvbm5lY3Rpb25Db21wb25lbnQ7XHJcbiAgcHJpdmF0ZSBibGFja2xpc3RGdW46IEJsYWNrbGlzdEZ1bmM7XHJcbiAgcmVhZG9ubHkga2V5czogeyBbaWR4OiBzdHJpbmddOiBhbnkgfTtcclxuICBwcml2YXRlIGJsYWNrbGlzdDogQmxhY2tsaXN0O1xyXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGFwcDogQXBwbGljYXRpb24sIG9wdHM/OiBDb25uZWN0b3JDb21wb25lbnRPcHRzKSB7XHJcbiAgICBvcHRzID0gb3B0cyB8fCB7fTtcclxuICAgIHRoaXMuY29ubmVjdG9yID0gZ2V0Q29ubmVjdG9yKGFwcCwgb3B0cyk7XHJcbiAgICB0aGlzLmVuY29kZSA9IG9wdHMuZW5jb2RlITtcclxuICAgIHRoaXMuZGVjb2RlID0gb3B0cy5kZWNvZGUhO1xyXG4gICAgdGhpcy51c2VDcnlwdG8gPSBvcHRzLnVzZUNyeXB0byE7XHJcbiAgICB0aGlzLnVzZUhvc3RGaWx0ZXIgPSBvcHRzLnVzZUhvc3RGaWx0ZXIhO1xyXG4gICAgdGhpcy51c2VBc3luY0NvZGVyID0gb3B0cy51c2VBc3luY0NvZGVyITtcclxuICAgIHRoaXMuYmxhY2tsaXN0RnVuID0gb3B0cy5ibGFja2xpc3RGdW4hO1xyXG4gICAgdGhpcy5rZXlzID0ge307XHJcbiAgICB0aGlzLmJsYWNrbGlzdCA9IFtdO1xyXG5cclxuICAgIGlmIChvcHRzLnVzZURpY3QpIHtcclxuICAgICAgYXBwLmxvYWQocG9tZWxvLmRpY3Rpb25hcnksIGFwcC5nZXQoXCJkaWN0aW9uYXJ5Q29uZmlnXCIpKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAob3B0cy51c2VQcm90b2J1Zikge1xyXG4gICAgICBhcHAubG9hZChwb21lbG8ucHJvdG9idWYsIGFwcC5nZXQoXCJwcm90b2J1ZkNvbmZpZ1wiKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gY29tcG9uZW50IGRlcGVuZGVuY2llc1xyXG4gICAgdGhpcy5zZXJ2ZXIgPSA8YW55Pm51bGw7XHJcbiAgICB0aGlzLnNlc3Npb24gPSA8YW55Pm51bGw7XHJcbiAgICB0aGlzLmNvbm5lY3Rpb24gPSA8YW55Pm51bGw7XHJcbiAgfVxyXG4gIHN0YXJ0KGNiPzogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMuc2VydmVyISA9IHRoaXMuYXBwLmNvbXBvbmVudHMuX19zZXJ2ZXJfXztcclxuICAgIHRoaXMuc2Vzc2lvbiEgPSB0aGlzLmFwcC5jb21wb25lbnRzLl9fc2Vzc2lvbl9fO1xyXG4gICAgdGhpcy5jb25uZWN0aW9uISA9IHRoaXMuYXBwLmNvbXBvbmVudHMuX19jb25uZWN0aW9uX187XHJcblxyXG4gICAgLy8gY2hlY2sgY29tcG9uZW50IGRlcGVuZGVuY2llc1xyXG4gICAgaWYgKCF0aGlzLnNlcnZlcikge1xyXG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcclxuICAgICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhcclxuICAgICAgICAgIGNiISxcclxuICAgICAgICAgIG5ldyBFcnJvcihcclxuICAgICAgICAgICAgXCJmYWlsIHRvIHN0YXJ0IGNvbm5lY3RvciBjb21wb25lbnQgZm9yIG5vIHNlcnZlciBjb21wb25lbnQgbG9hZGVkXCJcclxuICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdGhpcy5zZXNzaW9uKSB7XHJcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xyXG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKFxyXG4gICAgICAgICAgY2IhLFxyXG4gICAgICAgICAgbmV3IEVycm9yKFxyXG4gICAgICAgICAgICBcImZhaWwgdG8gc3RhcnQgY29ubmVjdG9yIGNvbXBvbmVudCBmb3Igbm8gc2Vzc2lvbiBjb21wb25lbnQgbG9hZGVkXCJcclxuICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHByb2Nlc3MubmV4dFRpY2soY2IhKTtcclxuICB9XHJcblxyXG4gIGFmdGVyU3RhcnQoY2I/OiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5jb25uZWN0b3Iuc3RhcnQoY2IhKTtcclxuICAgIHRoaXMuY29ubmVjdG9yLm9uKFwiY29ubmVjdGlvblwiLCB0aGlzLmhvc3RGaWx0ZXIuYmluZCh0aGlzLCBiaW5kRXZlbnRzKSk7XHJcbiAgfVxyXG5cclxuICBzdG9wKGZvcmNlOiBib29sZWFuLCBjYjogRnVuY3Rpb24pIHtcclxuICAgIGlmICh0aGlzLmNvbm5lY3Rvcikge1xyXG4gICAgICB0aGlzLmNvbm5lY3Rvci5zdG9wKGZvcmNlLCBjYik7XHJcbiAgICAgICg8YW55PnRoaXMuY29ubmVjdG9yKSA9IG51bGw7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2VuZChcclxuICAgIHJlcUlkOiBudW1iZXIsXHJcbiAgICByb3V0ZTogc3RyaW5nLFxyXG4gICAgbXNnOiBhbnksXHJcbiAgICByZWN2czogbnVtYmVyW10sXHJcbiAgICBvcHRzOiBhbnksXHJcbiAgICBjYjogRnVuY3Rpb25cclxuICApIHtcclxuICAgIGxvZ2dlci5kZWJ1ZyhcclxuICAgICAgXCJbJXNdIHNlbmQgbWVzc2FnZSByZXFJZDogJXMsIHJvdXRlOiAlcywgbXNnOiAlaiwgcmVjZWl2ZXJzOiAlaiwgb3B0czogJWpcIixcclxuICAgICAgdGhpcy5hcHAuc2VydmVySWQsXHJcbiAgICAgIHJlcUlkLFxyXG4gICAgICByb3V0ZSxcclxuICAgICAgbXNnLFxyXG4gICAgICByZWN2cyxcclxuICAgICAgb3B0c1xyXG4gICAgKTtcclxuICAgIGlmICh0aGlzLnVzZUFzeW5jQ29kZXIpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc2VuZEFzeW5jKHJlcUlkLCByb3V0ZSwgbXNnLCByZWN2cywgb3B0cywgY2IpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBlbXNnID0gbXNnO1xyXG4gICAgaWYgKHRoaXMuZW5jb2RlKSB7XHJcbiAgICAgIC8vIHVzZSBjb3N0dW1pemVkIGVuY29kZVxyXG4gICAgICBlbXNnID0gdGhpcy5lbmNvZGUuY2FsbCh0aGlzLCByZXFJZCwgcm91dGUsIG1zZyk7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuY29ubmVjdG9yLmVuY29kZSkge1xyXG4gICAgICAvLyB1c2UgY29ubmVjdG9yIGRlZmF1bHQgZW5jb2RlXHJcbiAgICAgIGVtc2cgPSB0aGlzLmNvbm5lY3Rvci5lbmNvZGUocmVxSWQsIHJvdXRlLCBtc2cpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZG9TZW5kKHJlcUlkLCByb3V0ZSwgZW1zZywgcmVjdnMsIG9wdHMsIGNiKTtcclxuICB9XHJcblxyXG4gIHNlbmRBc3luYyhcclxuICAgIHJlcUlkOiBudW1iZXIsXHJcbiAgICByb3V0ZTogc3RyaW5nLFxyXG4gICAgbXNnOiBhbnksXHJcbiAgICByZWN2czogbnVtYmVyW10sXHJcbiAgICBvcHRzOiBhbnksXHJcbiAgICBjYjogRnVuY3Rpb25cclxuICApIHtcclxuICAgIGxldCBlbXNnID0gbXNnO1xyXG5cclxuICAgIGlmICh0aGlzLmVuY29kZSkge1xyXG4gICAgICAvLyB1c2UgY29zdHVtaXplZCBlbmNvZGVcclxuICAgICAgdGhpcy5lbmNvZGUocmVxSWQsIHJvdXRlLCBtc2csIChlcnI6IGFueSwgZW5jb2RlTXNnOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICByZXR1cm4gY2IoZXJyKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGVtc2cgPSBlbmNvZGVNc2c7XHJcbiAgICAgICAgdGhpcy5kb1NlbmQocmVxSWQsIHJvdXRlLCBlbXNnLCByZWN2cywgb3B0cywgY2IpO1xyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5jb25uZWN0b3IuZW5jb2RlKSB7XHJcbiAgICAgIC8vIHVzZSBjb25uZWN0b3IgZGVmYXVsdCBlbmNvZGVcclxuICAgICAgdGhpcy5jb25uZWN0b3IuZW5jb2RlKHJlcUlkLCByb3V0ZSwgbXNnLCAoZXJyOiBhbnksIGVuY29kZU1zZzogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgcmV0dXJuIGNiKGVycik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBlbXNnID0gZW5jb2RlTXNnO1xyXG4gICAgICAgIHRoaXMuZG9TZW5kKHJlcUlkLCByb3V0ZSwgZW1zZywgcmVjdnMsIG9wdHMsIGNiKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkb1NlbmQoXHJcbiAgICByZXFJZDogbnVtYmVyLFxyXG4gICAgcm91dGU6IHN0cmluZyxcclxuICAgIGVtc2c6IGFueSxcclxuICAgIHJlY3ZzOiBudW1iZXJbXSxcclxuICAgIG9wdHM6IGFueSxcclxuICAgIGNiOiBGdW5jdGlvblxyXG4gICkge1xyXG4gICAgaWYgKCFlbXNnKSB7XHJcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICBjYiAmJlxyXG4gICAgICAgICAgY2IobmV3IEVycm9yKFwiZmFpbCB0byBzZW5kIG1lc3NhZ2UgZm9yIGVuY29kZSByZXN1bHQgaXMgZW1wdHkuXCIpKVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYXBwLmNvbXBvbmVudHMuX19wdXNoU2NoZWR1bGVyX18uc2NoZWR1bGUoXHJcbiAgICAgIHJlcUlkLFxyXG4gICAgICByb3V0ZSxcclxuICAgICAgZW1zZyxcclxuICAgICAgcmVjdnMsXHJcbiAgICAgIG9wdHMsXHJcbiAgICAgIGNiXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc2V0UHViS2V5KGlkOiBudW1iZXIsIGtleTogYW55KSB7XHJcbiAgICBsZXQgcHViS2V5ID0gbmV3IHJzYS5LZXkoKTtcclxuICAgIHB1YktleS5uID0gbmV3IHJzYS5CaWdJbnRlZ2VyKGtleS5yc2FfbiwgMTYpO1xyXG4gICAgcHViS2V5LmUgPSBrZXkucnNhX2U7XHJcbiAgICB0aGlzLmtleXNbaWRdID0gcHViS2V5O1xyXG4gIH1cclxuXHJcbiAgZ2V0UHViS2V5KGlkOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB0aGlzLmtleXNbaWRdO1xyXG4gIH1cclxuXHJcbiAgaG9zdEZpbHRlcihjYjogRnVuY3Rpb24sIHNvY2tldDogSVNvY2tldCkge1xyXG4gICAgaWYgKCF0aGlzLnVzZUhvc3RGaWx0ZXIpIHtcclxuICAgICAgcmV0dXJuIGNiKHRoaXMsIHNvY2tldCk7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGlwID0gc29ja2V0LnJlbW90ZUFkZHJlc3MuaXA7XHJcbiAgICBsZXQgY2hlY2sgPSAobGlzdDogKHN0cmluZyB8IFJlZ0V4cClbXSkgPT4ge1xyXG4gICAgICBmb3IgKGxldCBhZGRyZXNzIGluIGxpc3QpIHtcclxuICAgICAgICBsZXQgZXhwID0gbmV3IFJlZ0V4cChsaXN0W2FkZHJlc3NdKTtcclxuICAgICAgICBpZiAoZXhwLnRlc3QoaXApKSB7XHJcbiAgICAgICAgICBzb2NrZXQuZGlzY29ubmVjdCgpO1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH07XHJcbiAgICAvLyBkeW5hbWljYWwgY2hlY2tcclxuICAgIGlmICh0aGlzLmJsYWNrbGlzdC5sZW5ndGggIT09IDAgJiYgISFjaGVjayh0aGlzLmJsYWNrbGlzdCkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8gc3RhdGljIGNoZWNrXHJcbiAgICBpZiAoISF0aGlzLmJsYWNrbGlzdEZ1biAmJiB0eXBlb2YgdGhpcy5ibGFja2xpc3RGdW4gPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICB0aGlzLmJsYWNrbGlzdEZ1bigoZXJyLCBsaXN0KSA9PiB7XHJcbiAgICAgICAgaWYgKCEhZXJyKSB7XHJcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJjb25uZWN0b3IgYmxhY2tsaXN0IGVycm9yOiAlalwiLCBlcnIuc3RhY2spO1xyXG4gICAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIHRoaXMsIHNvY2tldCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShsaXN0KSkge1xyXG4gICAgICAgICAgbG9nZ2VyLmVycm9yKFwiY29ubmVjdG9yIGJsYWNrbGlzdCBpcyBub3QgYXJyYXk6ICVqXCIsIGxpc3QpO1xyXG4gICAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIHRoaXMsIHNvY2tldCk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghIWNoZWNrKGxpc3QpKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiLCB0aGlzLCBzb2NrZXQpO1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhjYiwgdGhpcywgc29ja2V0KTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbi8vRklYTUU66L+Z6YeM55qE5Luj56CB5aW95YOP5qC55pys5rKh5pyJ55So77yM5rKh5pyJ5LiA5LiqZGVjb2Rl5Ye95pWw5pSv5oyBY2LnmoRcclxuZnVuY3Rpb24gaGFuZGxlTWVzc2FnZUFzeW5jKFxyXG4gIHNlbGY6IENvbm5lY3RvckNvbXBvbmVudCxcclxuICBtc2c6IGFueSxcclxuICBzZXNzaW9uOiBTZXNzaW9uLFxyXG4gIHNvY2tldDogSVNvY2tldFxyXG4pIHtcclxuICBpZiAoc2VsZi5kZWNvZGUpIHtcclxuICAgIHNlbGYuZGVjb2RlKG1zZywgc2Vzc2lvbiwgKGVycjogYW55LCBkbXNnOiBhbnkpID0+IHtcclxuICAgICAgaWYgKGVycikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihcImZhaWwgdG8gZGVjb2RlIG1lc3NhZ2UgZnJvbSBjbGllbnQgJXMgLlwiLCBlcnIuc3RhY2spO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgZG9IYW5kbGVNZXNzYWdlKHNlbGYsIGRtc2csIHNlc3Npb24pO1xyXG4gICAgfSk7XHJcbiAgfSBlbHNlIGlmIChzZWxmLmNvbm5lY3Rvci5kZWNvZGUpIHtcclxuICAgIHNlbGYuY29ubmVjdG9yLmRlY29kZShtc2csIDxhbnk+c29ja2V0LCAoZXJyOiBhbnksIGRtc2c6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgbG9nZ2VyLmVycm9yKFwiZmFpbCB0byBkZWNvZGUgbWVzc2FnZSBmcm9tIGNsaWVudCAlcyAuXCIsIGVyci5zdGFjayk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBkb0hhbmRsZU1lc3NhZ2Uoc2VsZiwgZG1zZywgc2Vzc2lvbik7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRvSGFuZGxlTWVzc2FnZShcclxuICBzZWxmOiBDb25uZWN0b3JDb21wb25lbnQsXHJcbiAgZG1zZzogYW55LFxyXG4gIHNlc3Npb246IFNlc3Npb25cclxuKSB7XHJcbiAgaWYgKCFkbXNnKSB7XHJcbiAgICAvLyBkaXNjYXJkIGludmFsaWQgbWVzc2FnZVxyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgLy8gdXNlIHJzYSBjcnlwdG9cclxuICBpZiAoc2VsZi51c2VDcnlwdG8pIHtcclxuICAgIGxldCB2ZXJpZmllZCA9IHZlcmlmeU1lc3NhZ2Uoc2VsZiwgc2Vzc2lvbiwgZG1zZyk7XHJcbiAgICBpZiAoIXZlcmlmaWVkKSB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihcImZhaWwgdG8gdmVyaWZ5IHRoZSBkYXRhIHJlY2VpdmVkIGZyb20gY2xpZW50LlwiKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaGFuZGxlTWVzc2FnZShzZWxmLCBzZXNzaW9uLCBkbXNnKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0U2Vzc2lvbihzZWxmOiBDb25uZWN0b3JDb21wb25lbnQsIHNvY2tldDogSVNvY2tldCkge1xyXG4gIGxldCBhcHAgPSBzZWxmLmFwcCxcclxuICAgIHNpZCA9IHNvY2tldC5pZDtcclxuICBsZXQgc2Vzc2lvbiA9IHNlbGYuc2Vzc2lvbi5nZXQoc2lkKTtcclxuICBpZiAoc2Vzc2lvbikge1xyXG4gICAgcmV0dXJuIHNlc3Npb247XHJcbiAgfVxyXG5cclxuICBzZXNzaW9uID0gc2VsZi5zZXNzaW9uLmNyZWF0ZShzaWQsIGFwcC5zZXJ2ZXJJZCwgc29ja2V0KTtcclxuICBsb2dnZXIuZGVidWcoXHJcbiAgICBcIlslc10gZ2V0U2Vzc2lvbiBzZXNzaW9uIGlzIGNyZWF0ZWQgd2l0aCBzZXNzaW9uIGlkOiAlc1wiLFxyXG4gICAgYXBwLnNlcnZlcklkLFxyXG4gICAgc2lkXHJcbiAgKTtcclxuXHJcbiAgLy8gYmluZCBldmVudHMgZm9yIHNlc3Npb25cclxuICBzb2NrZXQub24oXCJkaXNjb25uZWN0XCIsIHNlc3Npb24uY2xvc2VkLmJpbmQoc2Vzc2lvbikpO1xyXG4gIHNvY2tldC5vbihcImVycm9yXCIsIHNlc3Npb24uY2xvc2VkLmJpbmQoc2Vzc2lvbikpO1xyXG4gIHNlc3Npb24ub24oXCJjbG9zZWRcIiwgb25TZXNzaW9uQ2xvc2UuYmluZChudWxsLCBhcHApKTtcclxuICBzZXNzaW9uLm9uKFwiYmluZFwiLCAodWlkOiBzdHJpbmcpID0+IHtcclxuICAgIGxvZ2dlci5kZWJ1ZyhcInNlc3Npb24gb24gWyVzXSBiaW5kIHdpdGggdWlkOiAlc1wiLCBzZWxmLmFwcC5zZXJ2ZXJJZCwgdWlkKTtcclxuICAgIC8vIHVwZGF0ZSBjb25uZWN0aW9uIHN0YXRpc3RpY3MgaWYgbmVjZXNzYXJ5XHJcbiAgICBpZiAoc2VsZi5jb25uZWN0aW9uKSB7XHJcbiAgICAgIHNlbGYuY29ubmVjdGlvbi5hZGRMb2dpbmVkVXNlcih1aWQsIHtcclxuICAgICAgICBsb2dpblRpbWU6IERhdGUubm93KCksXHJcbiAgICAgICAgdWlkOiB1aWQsXHJcbiAgICAgICAgYWRkcmVzczogc29ja2V0LnJlbW90ZUFkZHJlc3MuaXAgKyBcIjpcIiArIHNvY2tldC5yZW1vdGVBZGRyZXNzLnBvcnRcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBzZWxmLmFwcC5ldmVudC5lbWl0KGV2ZW50cy5CSU5EX1NFU1NJT04sIHNlc3Npb24pO1xyXG4gIH0pO1xyXG5cclxuICBzZXNzaW9uLm9uKFwidW5iaW5kXCIsICh1aWQ6IHN0cmluZykgPT4ge1xyXG4gICAgaWYgKHNlbGYuY29ubmVjdGlvbikge1xyXG4gICAgICBzZWxmLmNvbm5lY3Rpb24ucmVtb3ZlTG9naW5lZFVzZXIodWlkKTtcclxuICAgIH1cclxuICAgIHNlbGYuYXBwLmV2ZW50LmVtaXQoZXZlbnRzLlVOQklORF9TRVNTSU9OLCBzZXNzaW9uKTtcclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHNlc3Npb247XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldENvbm5lY3RvcihhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XHJcbiAgbGV0IGNvbm5lY3RvciA9IG9wdHMuY29ubmVjdG9yO1xyXG4gIGlmICghY29ubmVjdG9yKSB7XHJcbiAgICByZXR1cm4gZ2V0RGVmYXVsdENvbm5lY3RvcihhcHAsIG9wdHMpO1xyXG4gIH1cclxuXHJcbiAgaWYgKHR5cGVvZiBjb25uZWN0b3IgIT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgcmV0dXJuIGNvbm5lY3RvcjtcclxuICB9XHJcblxyXG4gIGxldCBjdXJTZXJ2ZXIgPSBhcHAuY3VyU2VydmVyO1xyXG4gIHJldHVybiBuZXcgY29ubmVjdG9yKGN1clNlcnZlci5jbGllbnRQb3J0LCBjdXJTZXJ2ZXIuaG9zdCwgb3B0cyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldERlZmF1bHRDb25uZWN0b3IoYXBwOiBBcHBsaWNhdGlvbiwgb3B0cz86IGFueSkge1xyXG4gIGxldCBEZWZhdWx0Q29ubmVjdG9yID0gcmVxdWlyZShcIi4uL2Nvbm5lY3RvcnMvc2lvY29ubmVjdG9yXCIpO1xyXG4gIGxldCBjdXJTZXJ2ZXIgPSBhcHAuY3VyU2VydmVyO1xyXG4gIHJldHVybiBuZXcgRGVmYXVsdENvbm5lY3RvcihjdXJTZXJ2ZXIuY2xpZW50UG9ydCwgY3VyU2VydmVyLmhvc3QsIG9wdHMpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBvblNlc3Npb25DbG9zZShhcHA6IEFwcGxpY2F0aW9uLCBzZXNzaW9uOiBTZXNzaW9uLCByZWFzb246IGFueSkge1xyXG4gIHRhc2tNYW5hZ2VyLmNsb3NlUXVldWUoc2Vzc2lvbi5pZCwgdHJ1ZSk7XHJcbiAgYXBwLmV2ZW50LmVtaXQoZXZlbnRzLkNMT1NFX1NFU1NJT04sIHNlc3Npb24pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjaGVja1NlcnZlclR5cGUocm91dGU6IHN0cmluZykge1xyXG4gIGlmICghcm91dGUpIHtcclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICBsZXQgaWR4ID0gcm91dGUuaW5kZXhPZihcIi5cIik7XHJcbiAgaWYgKGlkeCA8IDApIHtcclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICByZXR1cm4gcm91dGUuc3Vic3RyaW5nKDAsIGlkeCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJpbmRFdmVudHMoc2VsZjogQ29ubmVjdG9yQ29tcG9uZW50LCBzb2NrZXQ6IElTb2NrZXQpIHtcclxuICBsZXQgY3VyU2VydmVyID0gc2VsZi5hcHAuY3VyU2VydmVyO1xyXG4gIGxldCBtYXhDb25uZWN0aW9ucyA9IGN1clNlcnZlcltcIm1heC1jb25uZWN0aW9uc1wiXTtcclxuICBpZiAoc2VsZi5jb25uZWN0aW9uICYmIG1heENvbm5lY3Rpb25zKSB7XHJcbiAgICBzZWxmLmNvbm5lY3Rpb24uaW5jcmVhc2VDb25uZWN0aW9uQ291bnQoKTtcclxuICAgIGxldCBzdGF0aXN0aWNJbmZvID0gc2VsZi5jb25uZWN0aW9uLmdldFN0YXRpc3RpY3NJbmZvKCk7XHJcbiAgICBpZiAoc3RhdGlzdGljSW5mby50b3RhbENvbm5Db3VudCA+IG1heENvbm5lY3Rpb25zKSB7XHJcbiAgICAgIGxvZ2dlci53YXJuKFxyXG4gICAgICAgIFwidGhlIHNlcnZlciAlcyBoYXMgcmVhY2hlZCB0aGUgbWF4IGNvbm5lY3Rpb25zICVzXCIsXHJcbiAgICAgICAgY3VyU2VydmVyLmlkLFxyXG4gICAgICAgIG1heENvbm5lY3Rpb25zXHJcbiAgICAgICk7XHJcbiAgICAgIHNvY2tldC5kaXNjb25uZWN0KCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vY3JlYXRlIHNlc3Npb24gZm9yIGNvbm5lY3Rpb25cclxuICBsZXQgc2Vzc2lvbiA9IGdldFNlc3Npb24oc2VsZiwgc29ja2V0KTtcclxuICBsZXQgY2xvc2VkID0gZmFsc2U7XHJcblxyXG4gIHNvY2tldC5vbihcImRpc2Nvbm5lY3RcIiwgKCkgPT4ge1xyXG4gICAgaWYgKGNsb3NlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjbG9zZWQgPSB0cnVlO1xyXG4gICAgaWYgKHNlbGYuY29ubmVjdGlvbikge1xyXG4gICAgICBzZWxmLmNvbm5lY3Rpb24uZGVjcmVhc2VDb25uZWN0aW9uQ291bnQoc2Vzc2lvbi51aWQpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBzb2NrZXQub24oXCJlcnJvclwiLCAoKSA9PiB7XHJcbiAgICBpZiAoY2xvc2VkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNsb3NlZCA9IHRydWU7XHJcbiAgICBpZiAoc2VsZi5jb25uZWN0aW9uKSB7XHJcbiAgICAgIHNlbGYuY29ubmVjdGlvbi5kZWNyZWFzZUNvbm5lY3Rpb25Db3VudChzZXNzaW9uLnVpZCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIC8vIG5ldyBtZXNzYWdlXHJcbiAgc29ja2V0Lm9uKFwibWVzc2FnZVwiLCBtc2cgPT4ge1xyXG4gICAgbGV0IGRtc2cgPSBtc2c7XHJcbiAgICBpZiAoc2VsZi51c2VBc3luY0NvZGVyKSB7XHJcbiAgICAgIHJldHVybiBoYW5kbGVNZXNzYWdlQXN5bmMoc2VsZiwgbXNnLCBzZXNzaW9uLCBzb2NrZXQpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChzZWxmLmRlY29kZSkge1xyXG4gICAgICBkbXNnID0gc2VsZi5kZWNvZGUobXNnLCBzZXNzaW9uKTtcclxuICAgIH0gZWxzZSBpZiAoc2VsZi5jb25uZWN0b3IuZGVjb2RlKSB7XHJcbiAgICAgIGRtc2cgPSBzZWxmLmNvbm5lY3Rvci5kZWNvZGUobXNnLCA8YW55PnNvY2tldCk7XHJcbiAgICB9XHJcbiAgICBpZiAoIWRtc2cpIHtcclxuICAgICAgLy8gZGlzY2FyZCBpbnZhbGlkIG1lc3NhZ2VcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHVzZSByc2EgY3J5cHRvXHJcbiAgICBpZiAoc2VsZi51c2VDcnlwdG8pIHtcclxuICAgICAgbGV0IHZlcmlmaWVkID0gdmVyaWZ5TWVzc2FnZShzZWxmLCBzZXNzaW9uLCBkbXNnKTtcclxuICAgICAgaWYgKCF2ZXJpZmllZCkge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihcImZhaWwgdG8gdmVyaWZ5IHRoZSBkYXRhIHJlY2VpdmVkIGZyb20gY2xpZW50LlwiKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBoYW5kbGVNZXNzYWdlKHNlbGYsIHNlc3Npb24sIGRtc2cpO1xyXG4gIH0pOyAvL29uIG1lc3NhZ2UgZW5kXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZU1lc3NhZ2Uoc2VsZjogQ29ubmVjdG9yQ29tcG9uZW50LCBzZXNzaW9uOiBTZXNzaW9uLCBtc2c6IGFueSkge1xyXG4gIGxvZ2dlci5kZWJ1ZyhcclxuICAgIFwiWyVzXSBoYW5kbGVNZXNzYWdlIHNlc3Npb24gaWQ6ICVzLCBtc2c6ICVqXCIsXHJcbiAgICBzZWxmLmFwcC5zZXJ2ZXJJZCxcclxuICAgIHNlc3Npb24uaWQsXHJcbiAgICBtc2dcclxuICApO1xyXG4gIGxldCB0eXBlID0gY2hlY2tTZXJ2ZXJUeXBlKG1zZy5yb3V0ZSk7XHJcbiAgaWYgKCF0eXBlKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoXCJpbnZhbGlkIHJvdXRlIHN0cmluZy4gcm91dGUgOiAlalwiLCBtc2cucm91dGUpO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuICBzZWxmLnNlcnZlci5nbG9iYWxIYW5kbGUoXHJcbiAgICBtc2csXHJcbiAgICBzZXNzaW9uLnRvRnJvbnRlbmRTZXNzaW9uKCksXHJcbiAgICAoZXJyOiBhbnksIHJlc3A6IGFueSwgb3B0czogYW55KSA9PiB7XHJcbiAgICAgIGlmIChyZXNwICYmICFtc2cuaWQpIHtcclxuICAgICAgICBsb2dnZXIud2FybihcInRyeSB0byByZXNwb25zZSB0byBhIG5vdGlmeTogJWpcIiwgbXNnLnJvdXRlKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCFtc2cuaWQgJiYgIXJlc3ApIHJldHVybjtcclxuICAgICAgaWYgKCFyZXNwKSByZXNwID0ge307XHJcbiAgICAgIGlmICghIWVyciAmJiAhcmVzcC5jb2RlKSB7XHJcbiAgICAgICAgcmVzcC5jb2RlID0gNTAwO1xyXG4gICAgICB9XHJcbiAgICAgIG9wdHMgPSB7XHJcbiAgICAgICAgdHlwZTogXCJyZXNwb25zZVwiLFxyXG4gICAgICAgIHVzZXJPcHRpb25zOiBvcHRzIHx8IHt9XHJcbiAgICAgIH07XHJcbiAgICAgIC8vIGZvciBjb21wYXRpYWJsaXR5XHJcbiAgICAgIG9wdHMuaXNSZXNwb25zZSA9IHRydWU7XHJcblxyXG4gICAgICBzZWxmLnNlbmQobXNnLmlkLCBtc2cucm91dGUsIHJlc3AsIFtzZXNzaW9uLmlkXSwgb3B0cywgKCkgPT4ge30pO1xyXG4gICAgfVxyXG4gICk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHZlcmlmeU1lc3NhZ2Uoc2VsZjogQ29ubmVjdG9yQ29tcG9uZW50LCBzZXNzaW9uOiBTZXNzaW9uLCBtc2c6IGFueSkge1xyXG4gIGxldCBzaWcgPSBtc2cuYm9keS5fX2NyeXB0b19fO1xyXG4gIGlmICghc2lnKSB7XHJcbiAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgIFwicmVjZWl2ZSBkYXRhIGZyb20gY2xpZW50IGhhcyBubyBzaWduYXR1cmUgWyVzXVwiLFxyXG4gICAgICBzZWxmLmFwcC5zZXJ2ZXJJZFxyXG4gICAgKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGxldCBwdWJLZXk7XHJcblxyXG4gIGlmICghc2Vzc2lvbikge1xyXG4gICAgbG9nZ2VyLmVycm9yKFwiY291bGQgbm90IGZpbmQgc2Vzc2lvbi5cIik7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBpZiAoIXNlc3Npb24uZ2V0KFwicHViS2V5XCIpKSB7XHJcbiAgICBwdWJLZXkgPSBzZWxmLmdldFB1YktleShzZXNzaW9uLmlkLnRvU3RyaW5nKCkpO1xyXG4gICAgaWYgKCEhcHViS2V5KSB7XHJcbiAgICAgIGRlbGV0ZSBzZWxmLmtleXNbc2Vzc2lvbi5pZF07XHJcbiAgICAgIHNlc3Npb24uc2V0KFwicHViS2V5XCIsIHB1YktleSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoXCJjb3VsZCBub3QgZ2V0IHB1YmxpYyBrZXksIHNlc3Npb24gaWQgaXMgJXNcIiwgc2Vzc2lvbi5pZCk7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgcHViS2V5ID0gc2Vzc2lvbi5nZXQoXCJwdWJLZXlcIik7XHJcbiAgfVxyXG5cclxuICBpZiAoIXB1YktleS5uIHx8ICFwdWJLZXkuZSkge1xyXG4gICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICBcImNvdWxkIG5vdCB2ZXJpZnkgbWVzc2FnZSB3aXRob3V0IHB1YmxpYyBrZXkgWyVzXVwiLFxyXG4gICAgICBzZWxmLmFwcC5zZXJ2ZXJJZFxyXG4gICAgKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGRlbGV0ZSBtc2cuYm9keS5fX2NyeXB0b19fO1xyXG5cclxuICBsZXQgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KG1zZy5ib2R5KTtcclxuICBpZiAodXRpbHMuaGFzQ2hpbmVzZUNoYXIobWVzc2FnZSkpIG1lc3NhZ2UgPSB1dGlscy51bmljb2RlVG9VdGY4KG1lc3NhZ2UpO1xyXG5cclxuICByZXR1cm4gcHViS2V5LnZlcmlmeVN0cmluZyhtZXNzYWdlLCBzaWcpO1xyXG59XHJcbiJdfQ==