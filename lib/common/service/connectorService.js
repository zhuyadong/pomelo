"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const rsa = require("node-bignumber");
class ConnectorComponent {
    constructor(app, opts) {
        this.app = app;
        this.name = "__connector__";
        opts = opts || {};
        this.connector = getConnector(app, opts);
        this.encode = opts.encode;
        this.decode = opts.decode;
        this.useCrypto = opts.useCrypto;
        this.useHostFilter = opts.useHostFilter;
        this.useAsyncCoder = opts.useAsyncCoder;
        this.blacklistFun = opts.blacklistFun;
        this.keys = {};
        this.blacklist = [];
        if (opts.useDict) {
            app.load(index_1.pomelo.dictionary, app.get("dictionaryConfig"));
        }
        if (opts.useProtobuf) {
            app.load(index_1.pomelo.protobuf, app.get("protobufConfig"));
        }
        // component dependencies
        this.server = null;
        this.session = null;
        this.connection = null;
    }
    start(cb) {
        this.server = this.app.components.__server__;
        this.session = this.app.components.__session__;
        this.connection = this.app.components.__connection__;
        // check component dependencies
        if (!this.server) {
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb, new Error("fail to start connector component for no server component loaded"));
            });
            return;
        }
        if (!this.session) {
            process.nextTick(() => {
                index_1.utils.invokeCallback(cb, new Error("fail to start connector component for no session component loaded"));
            });
            return;
        }
        process.nextTick(cb);
    }
    afterStart(cb) {
        this.connector.start(cb);
        this.connector.on("connection", this.hostFilter.bind(this, bindEvents));
    }
    stop(force, cb) {
        if (this.connector) {
            this.connector.stop(force, cb);
            this.connector = null;
            return;
        }
        else {
            process.nextTick(cb);
        }
    }
    send(reqId, route, msg, recvs, opts, cb) {
        logger.debug("[%s] send message reqId: %s, route: %s, msg: %j, receivers: %j, opts: %j", this.app.serverId, reqId, route, msg, recvs, opts);
        if (this.useAsyncCoder) {
            return this.sendAsync(reqId, route, msg, recvs, opts, cb);
        }
        let emsg = msg;
        if (this.encode) {
            // use costumized encode
            emsg = this.encode.call(this, reqId, route, msg);
        }
        else if (this.connector.encode) {
            // use connector default encode
            emsg = this.connector.encode(reqId, route, msg);
        }
        this.doSend(reqId, route, emsg, recvs, opts, cb);
    }
    sendAsync(reqId, route, msg, recvs, opts, cb) {
        let emsg = msg;
        if (this.encode) {
            // use costumized encode
            this.encode(reqId, route, msg, (err, encodeMsg) => {
                if (err) {
                    return cb(err);
                }
                emsg = encodeMsg;
                this.doSend(reqId, route, emsg, recvs, opts, cb);
            });
        }
        else if (this.connector.encode) {
            // use connector default encode
            this.connector.encode(reqId, route, msg, (err, encodeMsg) => {
                if (err) {
                    return cb(err);
                }
                emsg = encodeMsg;
                this.doSend(reqId, route, emsg, recvs, opts, cb);
            });
        }
    }
    doSend(reqId, route, emsg, recvs, opts, cb) {
        if (!emsg) {
            process.nextTick(() => {
                return (cb &&
                    cb(new Error("fail to send message for encode result is empty.")));
            });
        }
        this.app.components.__pushScheduler__.schedule(reqId, route, emsg, recvs, opts, cb);
    }
    setPubKey(id, key) {
        let pubKey = new rsa.Key();
        pubKey.n = new rsa.BigInteger(key.rsa_n, 16);
        pubKey.e = key.rsa_e;
        this.keys[id] = pubKey;
    }
    getPubKey(id) {
        return this.keys[id];
    }
    hostFilter(cb, socket) {
        if (!this.useHostFilter) {
            return cb(this, socket);
        }
        let ip = socket.remoteAddress.ip;
        let check = (list) => {
            for (let address in list) {
                let exp = new RegExp(list[address]);
                if (exp.test(ip)) {
                    socket.disconnect();
                    return true;
                }
            }
            return false;
        };
        // dynamical check
        if (this.blacklist.length !== 0 && !!check(this.blacklist)) {
            return;
        }
        // static check
        if (!!this.blacklistFun && typeof this.blacklistFun === "function") {
            this.blacklistFun((err, list) => {
                if (!!err) {
                    logger.error("connector blacklist error: %j", err.stack);
                    index_1.utils.invokeCallback(cb, this, socket);
                    return;
                }
                if (!Array.isArray(list)) {
                    logger.error("connector blacklist is not array: %j", list);
                    index_1.utils.invokeCallback(cb, this, socket);
                    return;
                }
                if (!!check(list)) {
                    return;
                }
                else {
                    index_1.utils.invokeCallback(cb, this, socket);
                    return;
                }
            });
        }
        else {
            index_1.utils.invokeCallback(cb, this, socket);
        }
    }
}
exports.ConnectorComponent = ConnectorComponent;
//FIXME:这里的代码好像根本没有用，没有一个decode函数支持cb的
function handleMessageAsync(self, msg, session, socket) {
    if (self.decode) {
        self.decode(msg, session, (err, dmsg) => {
            if (err) {
                logger.error("fail to decode message from client %s .", err.stack);
                return;
            }
            doHandleMessage(self, dmsg, session);
        });
    }
    else if (self.connector.decode) {
        self.connector.decode(msg, socket, (err, dmsg) => {
            if (err) {
                logger.error("fail to decode message from client %s .", err.stack);
                return;
            }
            doHandleMessage(self, dmsg, session);
        });
    }
}
function doHandleMessage(self, dmsg, session) {
    if (!dmsg) {
        // discard invalid message
        return;
    }
    // use rsa crypto
    if (self.useCrypto) {
        let verified = verifyMessage(self, session, dmsg);
        if (!verified) {
            logger.error("fail to verify the data received from client.");
            return;
        }
    }
    handleMessage(self, session, dmsg);
}
function getSession(self, socket) {
    let app = self.app, sid = socket.id;
    let session = self.session.get(sid);
    if (session) {
        return session;
    }
    session = self.session.create(sid, app.serverId, socket);
    logger.debug("[%s] getSession session is created with session id: %s", app.serverId, sid);
    // bind events for session
    socket.on("disconnect", session.closed.bind(session));
    socket.on("error", session.closed.bind(session));
    session.on("closed", onSessionClose.bind(null, app));
    session.on("bind", (uid) => {
        logger.debug("session on [%s] bind with uid: %s", self.app.serverId, uid);
        // update connection statistics if necessary
        if (self.connection) {
            self.connection.addLoginedUser(uid, {
                loginTime: Date.now(),
                uid: uid,
                address: socket.remoteAddress.ip + ":" + socket.remoteAddress.port
            });
        }
        self.app.event.emit(index_1.events.BIND_SESSION, session);
    });
    session.on("unbind", (uid) => {
        if (self.connection) {
            self.connection.removeLoginedUser(uid);
        }
        self.app.event.emit(index_1.events.UNBIND_SESSION, session);
    });
    return session;
}
function getConnector(app, opts) {
    let connector = opts.connector;
    if (!connector) {
        return getDefaultConnector(app, opts);
    }
    if (typeof connector !== "function") {
        return connector;
    }
    let curServer = app.curServer;
    return new connector(curServer.clientPort, curServer.host, opts);
}
function getDefaultConnector(app, opts) {
    let DefaultConnector = require("../connectors/sioconnector");
    let curServer = app.curServer;
    return new DefaultConnector(curServer.clientPort, curServer.host, opts);
}
function onSessionClose(app, session, reason) {
    index_1.taskManager.closeQueue(session.id, true);
    app.event.emit(index_1.events.CLOSE_SESSION, session);
}
function checkServerType(route) {
    if (!route) {
        return null;
    }
    let idx = route.indexOf(".");
    if (idx < 0) {
        return null;
    }
    return route.substring(0, idx);
}
function bindEvents(self, socket) {
    let curServer = self.app.curServer;
    let maxConnections = curServer["max-connections"];
    if (self.connection && maxConnections) {
        self.connection.increaseConnectionCount();
        let statisticInfo = self.connection.getStatisticsInfo();
        if (statisticInfo.totalConnCount > maxConnections) {
            logger.warn("the server %s has reached the max connections %s", curServer.id, maxConnections);
            socket.disconnect();
            return;
        }
    }
    //create session for connection
    let session = getSession(self, socket);
    let closed = false;
    socket.on("disconnect", () => {
        if (closed) {
            return;
        }
        closed = true;
        if (self.connection) {
            self.connection.decreaseConnectionCount(session.uid);
        }
    });
    socket.on("error", () => {
        if (closed) {
            return;
        }
        closed = true;
        if (self.connection) {
            self.connection.decreaseConnectionCount(session.uid);
        }
    });
    // new message
    socket.on("message", msg => {
        let dmsg = msg;
        if (self.useAsyncCoder) {
            return handleMessageAsync(self, msg, session, socket);
        }
        if (self.decode) {
            dmsg = self.decode(msg, session);
        }
        else if (self.connector.decode) {
            dmsg = self.connector.decode(msg, socket);
        }
        if (!dmsg) {
            // discard invalid message
            return;
        }
        // use rsa crypto
        if (self.useCrypto) {
            let verified = verifyMessage(self, session, dmsg);
            if (!verified) {
                logger.error("fail to verify the data received from client.");
                return;
            }
        }
        handleMessage(self, session, dmsg);
    }); //on message end
}
function handleMessage(self, session, msg) {
    logger.debug("[%s] handleMessage session id: %s, msg: %j", self.app.serverId, session.id, msg);
    let type = checkServerType(msg.route);
    if (!type) {
        logger.error("invalid route string. route : %j", msg.route);
        return;
    }
    self.server.globalHandle(msg, session.toFrontendSession(), (err, resp, opts) => {
        if (resp && !msg.id) {
            logger.warn("try to response to a notify: %j", msg.route);
            return;
        }
        if (!msg.id && !resp)
            return;
        if (!resp)
            resp = {};
        if (!!err && !resp.code) {
            resp.code = 500;
        }
        opts = {
            type: "response",
            userOptions: opts || {}
        };
        // for compatiablity
        opts.isResponse = true;
        self.send(msg.id, msg.route, resp, [session.id], opts, () => { });
    });
}
function verifyMessage(self, session, msg) {
    let sig = msg.body.__crypto__;
    if (!sig) {
        logger.error("receive data from client has no signature [%s]", self.app.serverId);
        return false;
    }
    let pubKey;
    if (!session) {
        logger.error("could not find session.");
        return false;
    }
    if (!session.get("pubKey")) {
        pubKey = self.getPubKey(session.id.toString());
        if (!!pubKey) {
            delete self.keys[session.id];
            session.set("pubKey", pubKey);
        }
        else {
            logger.error("could not get public key, session id is %s", session.id);
            return false;
        }
    }
    else {
        pubKey = session.get("pubKey");
    }
    if (!pubKey.n || !pubKey.e) {
        logger.error("could not verify message without public key [%s]", self.app.serverId);
        return false;
    }
    delete msg.body.__crypto__;
    let message = JSON.stringify(msg.body);
    if (index_1.utils.hasChineseChar(message))
        message = index_1.utils.unicodeToUtf8(message);
    return pubKey.verifyString(message, sig);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdG9yU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbm5lY3RvclNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FpQnFCO0FBRXJCLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ3hFLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBY3RDO0lBY0UsWUFBcUIsR0FBZ0IsRUFBRSxJQUE2QjtRQUEvQyxRQUFHLEdBQUgsR0FBRyxDQUFhO1FBYjVCLFNBQUksR0FBVyxlQUFlLENBQUM7UUFjdEMsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxZQUFZLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU8sQ0FBQztRQUMzQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFPLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBVSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWMsQ0FBQztRQUN6QyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFjLENBQUM7UUFDekMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBYSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFFcEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDakIsR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFNLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxHQUFH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QUMsQ0FBQztZQUN2RSxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2YsQ0FBQztJQUNILENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLENBQUMsS0FBSyxDQUNWLGtEQUFrRCxFQUNsRCxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FDbEIsQ0FBQztRQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUUzQixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2QyxFQUFFLENBQUMsQ0FBQyxhQUFLLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQUMsT0FBTyxHQUFHLGFBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFMUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzNDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb25uZWN0b3IsXG4gIENvbm5lY3RvckVuY29kZUZ1bmMsXG4gIENvbm5lY3RvckRlY29kZUZ1bmMsXG4gIEJsYWNrbGlzdEZ1bmMsXG4gIENvbXBvbmVudCxcbiAgU2VydmVyQ29tcG9uZW50LFxuICBTZXNzaW9uQ29tcG9uZW50LFxuICBDb25uZWN0aW9uQ29tcG9uZW50LFxuICBCbGFja2xpc3QsXG4gIEFwcGxpY2F0aW9uLFxuICBwb21lbG8sXG4gIHV0aWxzLFxuICBJU29ja2V0LFxuICBTZXNzaW9uLFxuICBldmVudHMsXG4gIHRhc2tNYW5hZ2VyXG59IGZyb20gXCIuLi8uLi9pbmRleFwiO1xuXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XG5jb25zdCByc2EgPSByZXF1aXJlKFwibm9kZS1iaWdudW1iZXJcIik7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdG9yQ29tcG9uZW50T3B0cyB7XG4gIGNvbm5lY3Rvcj86IENvbm5lY3RvcjtcbiAgZW5jb2RlPzogQ29ubmVjdG9yRW5jb2RlRnVuYztcbiAgZGVjb2RlPzogQ29ubmVjdG9yRGVjb2RlRnVuYztcbiAgdXNlRGljdD86IGJvb2xlYW47XG4gIHVzZVByb3RvYnVmPzogYm9vbGVhbjtcbiAgdXNlQ3J5cHRvPzogYm9vbGVhbjtcbiAgdXNlSG9zdEZpbHRlcj86IGJvb2xlYW47XG4gIHVzZUFzeW5jQ29kZXI/OiBib29sZWFuO1xuICBibGFja2xpc3RGdW4/OiBCbGFja2xpc3RGdW5jO1xufVxuXG5leHBvcnQgY2xhc3MgQ29ubmVjdG9yQ29tcG9uZW50IGltcGxlbWVudHMgQ29tcG9uZW50IHtcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nID0gXCJfX2Nvbm5lY3Rvcl9fXCI7XG4gIHJlYWRvbmx5IGNvbm5lY3RvcjogQ29ubmVjdG9yO1xuICByZWFkb25seSBlbmNvZGU6IENvbm5lY3RvckVuY29kZUZ1bmM7XG4gIHJlYWRvbmx5IGRlY29kZTogQ29ubmVjdG9yRGVjb2RlRnVuYztcbiAgcmVhZG9ubHkgdXNlQ3J5cHRvOiBib29sZWFuO1xuICByZWFkb25seSB1c2VIb3N0RmlsdGVyOiBib29sZWFuO1xuICByZWFkb25seSB1c2VBc3luY0NvZGVyOiBib29sZWFuO1xuICByZWFkb25seSBzZXJ2ZXI6IFNlcnZlckNvbXBvbmVudDtcbiAgcmVhZG9ubHkgc2Vzc2lvbjogU2Vzc2lvbkNvbXBvbmVudDtcbiAgcmVhZG9ubHkgY29ubmVjdGlvbjogQ29ubmVjdGlvbkNvbXBvbmVudDtcbiAgcHJpdmF0ZSBibGFja2xpc3RGdW46IEJsYWNrbGlzdEZ1bmM7XG4gIHJlYWRvbmx5IGtleXM6IHsgW2lkeDogc3RyaW5nXTogYW55IH07XG4gIHByaXZhdGUgYmxhY2tsaXN0OiBCbGFja2xpc3Q7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGFwcDogQXBwbGljYXRpb24sIG9wdHM/OiBDb25uZWN0b3JDb21wb25lbnRPcHRzKSB7XG4gICAgb3B0cyA9IG9wdHMgfHwge307XG4gICAgdGhpcy5jb25uZWN0b3IgPSBnZXRDb25uZWN0b3IoYXBwLCBvcHRzKTtcbiAgICB0aGlzLmVuY29kZSA9IG9wdHMuZW5jb2RlITtcbiAgICB0aGlzLmRlY29kZSA9IG9wdHMuZGVjb2RlITtcbiAgICB0aGlzLnVzZUNyeXB0byA9IG9wdHMudXNlQ3J5cHRvITtcbiAgICB0aGlzLnVzZUhvc3RGaWx0ZXIgPSBvcHRzLnVzZUhvc3RGaWx0ZXIhO1xuICAgIHRoaXMudXNlQXN5bmNDb2RlciA9IG9wdHMudXNlQXN5bmNDb2RlciE7XG4gICAgdGhpcy5ibGFja2xpc3RGdW4gPSBvcHRzLmJsYWNrbGlzdEZ1biE7XG4gICAgdGhpcy5rZXlzID0ge307XG4gICAgdGhpcy5ibGFja2xpc3QgPSBbXTtcblxuICAgIGlmIChvcHRzLnVzZURpY3QpIHtcbiAgICAgIGFwcC5sb2FkKHBvbWVsby5kaWN0aW9uYXJ5LCBhcHAuZ2V0KFwiZGljdGlvbmFyeUNvbmZpZ1wiKSk7XG4gICAgfVxuXG4gICAgaWYgKG9wdHMudXNlUHJvdG9idWYpIHtcbiAgICAgIGFwcC5sb2FkKHBvbWVsby5wcm90b2J1ZiwgYXBwLmdldChcInByb3RvYnVmQ29uZmlnXCIpKTtcbiAgICB9XG5cbiAgICAvLyBjb21wb25lbnQgZGVwZW5kZW5jaWVzXG4gICAgdGhpcy5zZXJ2ZXIgPSA8YW55Pm51bGw7XG4gICAgdGhpcy5zZXNzaW9uID0gPGFueT5udWxsO1xuICAgIHRoaXMuY29ubmVjdGlvbiA9IDxhbnk+bnVsbDtcbiAgfVxuICBzdGFydChjYj86IEZ1bmN0aW9uKSB7XG4gICAgdGhpcy5zZXJ2ZXIhID0gdGhpcy5hcHAuY29tcG9uZW50cy5fX3NlcnZlcl9fO1xuICAgIHRoaXMuc2Vzc2lvbiEgPSB0aGlzLmFwcC5jb21wb25lbnRzLl9fc2Vzc2lvbl9fO1xuICAgIHRoaXMuY29ubmVjdGlvbiEgPSB0aGlzLmFwcC5jb21wb25lbnRzLl9fY29ubmVjdGlvbl9fO1xuXG4gICAgLy8gY2hlY2sgY29tcG9uZW50IGRlcGVuZGVuY2llc1xuICAgIGlmICghdGhpcy5zZXJ2ZXIpIHtcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICB1dGlscy5pbnZva2VDYWxsYmFjayhcbiAgICAgICAgICBjYiEsXG4gICAgICAgICAgbmV3IEVycm9yKFxuICAgICAgICAgICAgXCJmYWlsIHRvIHN0YXJ0IGNvbm5lY3RvciBjb21wb25lbnQgZm9yIG5vIHNlcnZlciBjb21wb25lbnQgbG9hZGVkXCJcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuc2Vzc2lvbikge1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKFxuICAgICAgICAgIGNiISxcbiAgICAgICAgICBuZXcgRXJyb3IoXG4gICAgICAgICAgICBcImZhaWwgdG8gc3RhcnQgY29ubmVjdG9yIGNvbXBvbmVudCBmb3Igbm8gc2Vzc2lvbiBjb21wb25lbnQgbG9hZGVkXCJcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBwcm9jZXNzLm5leHRUaWNrKGNiISk7XG4gIH1cblxuICBhZnRlclN0YXJ0KGNiPzogRnVuY3Rpb24pIHtcbiAgICB0aGlzLmNvbm5lY3Rvci5zdGFydChjYiEpO1xuICAgIHRoaXMuY29ubmVjdG9yLm9uKFwiY29ubmVjdGlvblwiLCB0aGlzLmhvc3RGaWx0ZXIuYmluZCh0aGlzLCBiaW5kRXZlbnRzKSk7XG4gIH1cblxuICBzdG9wKGZvcmNlOiBib29sZWFuLCBjYjogRnVuY3Rpb24pIHtcbiAgICBpZiAodGhpcy5jb25uZWN0b3IpIHtcbiAgICAgIHRoaXMuY29ubmVjdG9yLnN0b3AoZm9yY2UsIGNiKTtcbiAgICAgICg8YW55PnRoaXMuY29ubmVjdG9yKSA9IG51bGw7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIHtcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xuICAgIH1cbiAgfVxuXG4gIHNlbmQoXG4gICAgcmVxSWQ6IG51bWJlcixcbiAgICByb3V0ZTogc3RyaW5nLFxuICAgIG1zZzogYW55LFxuICAgIHJlY3ZzOiBudW1iZXJbXSxcbiAgICBvcHRzOiBhbnksXG4gICAgY2I6IEZ1bmN0aW9uXG4gICkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgIFwiWyVzXSBzZW5kIG1lc3NhZ2UgcmVxSWQ6ICVzLCByb3V0ZTogJXMsIG1zZzogJWosIHJlY2VpdmVyczogJWosIG9wdHM6ICVqXCIsXG4gICAgICB0aGlzLmFwcC5zZXJ2ZXJJZCxcbiAgICAgIHJlcUlkLFxuICAgICAgcm91dGUsXG4gICAgICBtc2csXG4gICAgICByZWN2cyxcbiAgICAgIG9wdHNcbiAgICApO1xuICAgIGlmICh0aGlzLnVzZUFzeW5jQ29kZXIpIHtcbiAgICAgIHJldHVybiB0aGlzLnNlbmRBc3luYyhyZXFJZCwgcm91dGUsIG1zZywgcmVjdnMsIG9wdHMsIGNiKTtcbiAgICB9XG5cbiAgICBsZXQgZW1zZyA9IG1zZztcbiAgICBpZiAodGhpcy5lbmNvZGUpIHtcbiAgICAgIC8vIHVzZSBjb3N0dW1pemVkIGVuY29kZVxuICAgICAgZW1zZyA9IHRoaXMuZW5jb2RlLmNhbGwodGhpcywgcmVxSWQsIHJvdXRlLCBtc2cpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jb25uZWN0b3IuZW5jb2RlKSB7XG4gICAgICAvLyB1c2UgY29ubmVjdG9yIGRlZmF1bHQgZW5jb2RlXG4gICAgICBlbXNnID0gdGhpcy5jb25uZWN0b3IuZW5jb2RlKHJlcUlkLCByb3V0ZSwgbXNnKTtcbiAgICB9XG5cbiAgICB0aGlzLmRvU2VuZChyZXFJZCwgcm91dGUsIGVtc2csIHJlY3ZzLCBvcHRzLCBjYik7XG4gIH1cblxuICBzZW5kQXN5bmMoXG4gICAgcmVxSWQ6IG51bWJlcixcbiAgICByb3V0ZTogc3RyaW5nLFxuICAgIG1zZzogYW55LFxuICAgIHJlY3ZzOiBudW1iZXJbXSxcbiAgICBvcHRzOiBhbnksXG4gICAgY2I6IEZ1bmN0aW9uXG4gICkge1xuICAgIGxldCBlbXNnID0gbXNnO1xuXG4gICAgaWYgKHRoaXMuZW5jb2RlKSB7XG4gICAgICAvLyB1c2UgY29zdHVtaXplZCBlbmNvZGVcbiAgICAgIHRoaXMuZW5jb2RlKHJlcUlkLCByb3V0ZSwgbXNnLCAoZXJyOiBhbnksIGVuY29kZU1zZzogYW55KSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGVtc2cgPSBlbmNvZGVNc2c7XG4gICAgICAgIHRoaXMuZG9TZW5kKHJlcUlkLCByb3V0ZSwgZW1zZywgcmVjdnMsIG9wdHMsIGNiKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jb25uZWN0b3IuZW5jb2RlKSB7XG4gICAgICAvLyB1c2UgY29ubmVjdG9yIGRlZmF1bHQgZW5jb2RlXG4gICAgICB0aGlzLmNvbm5lY3Rvci5lbmNvZGUocmVxSWQsIHJvdXRlLCBtc2csIChlcnI6IGFueSwgZW5jb2RlTXNnOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgICB9XG5cbiAgICAgICAgZW1zZyA9IGVuY29kZU1zZztcbiAgICAgICAgdGhpcy5kb1NlbmQocmVxSWQsIHJvdXRlLCBlbXNnLCByZWN2cywgb3B0cywgY2IpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZG9TZW5kKFxuICAgIHJlcUlkOiBudW1iZXIsXG4gICAgcm91dGU6IHN0cmluZyxcbiAgICBlbXNnOiBhbnksXG4gICAgcmVjdnM6IG51bWJlcltdLFxuICAgIG9wdHM6IGFueSxcbiAgICBjYjogRnVuY3Rpb25cbiAgKSB7XG4gICAgaWYgKCFlbXNnKSB7XG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICBjYiAmJlxuICAgICAgICAgIGNiKG5ldyBFcnJvcihcImZhaWwgdG8gc2VuZCBtZXNzYWdlIGZvciBlbmNvZGUgcmVzdWx0IGlzIGVtcHR5LlwiKSlcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHRoaXMuYXBwLmNvbXBvbmVudHMuX19wdXNoU2NoZWR1bGVyX18uc2NoZWR1bGUoXG4gICAgICByZXFJZCxcbiAgICAgIHJvdXRlLFxuICAgICAgZW1zZyxcbiAgICAgIHJlY3ZzLFxuICAgICAgb3B0cyxcbiAgICAgIGNiXG4gICAgKTtcbiAgfVxuXG4gIHNldFB1YktleShpZDogbnVtYmVyLCBrZXk6IGFueSkge1xuICAgIGxldCBwdWJLZXkgPSBuZXcgcnNhLktleSgpO1xuICAgIHB1YktleS5uID0gbmV3IHJzYS5CaWdJbnRlZ2VyKGtleS5yc2FfbiwgMTYpO1xuICAgIHB1YktleS5lID0ga2V5LnJzYV9lO1xuICAgIHRoaXMua2V5c1tpZF0gPSBwdWJLZXk7XG4gIH1cblxuICBnZXRQdWJLZXkoaWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmtleXNbaWRdO1xuICB9XG5cbiAgaG9zdEZpbHRlcihjYjogRnVuY3Rpb24sIHNvY2tldDogSVNvY2tldCkge1xuICAgIGlmICghdGhpcy51c2VIb3N0RmlsdGVyKSB7XG4gICAgICByZXR1cm4gY2IodGhpcywgc29ja2V0KTtcbiAgICB9XG5cbiAgICBsZXQgaXAgPSBzb2NrZXQucmVtb3RlQWRkcmVzcy5pcDtcbiAgICBsZXQgY2hlY2sgPSAobGlzdDogKHN0cmluZyB8IFJlZ0V4cClbXSkgPT4ge1xuICAgICAgZm9yIChsZXQgYWRkcmVzcyBpbiBsaXN0KSB7XG4gICAgICAgIGxldCBleHAgPSBuZXcgUmVnRXhwKGxpc3RbYWRkcmVzc10pO1xuICAgICAgICBpZiAoZXhwLnRlc3QoaXApKSB7XG4gICAgICAgICAgc29ja2V0LmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG4gICAgLy8gZHluYW1pY2FsIGNoZWNrXG4gICAgaWYgKHRoaXMuYmxhY2tsaXN0Lmxlbmd0aCAhPT0gMCAmJiAhIWNoZWNrKHRoaXMuYmxhY2tsaXN0KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyBzdGF0aWMgY2hlY2tcbiAgICBpZiAoISF0aGlzLmJsYWNrbGlzdEZ1biAmJiB0eXBlb2YgdGhpcy5ibGFja2xpc3RGdW4gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgdGhpcy5ibGFja2xpc3RGdW4oKGVyciwgbGlzdCkgPT4ge1xuICAgICAgICBpZiAoISFlcnIpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJjb25uZWN0b3IgYmxhY2tsaXN0IGVycm9yOiAlalwiLCBlcnIuc3RhY2spO1xuICAgICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiLCB0aGlzLCBzb2NrZXQpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobGlzdCkpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoXCJjb25uZWN0b3IgYmxhY2tsaXN0IGlzIG5vdCBhcnJheTogJWpcIiwgbGlzdCk7XG4gICAgICAgICAgdXRpbHMuaW52b2tlQ2FsbGJhY2soY2IsIHRoaXMsIHNvY2tldCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICghIWNoZWNrKGxpc3QpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiLCB0aGlzLCBzb2NrZXQpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHV0aWxzLmludm9rZUNhbGxiYWNrKGNiLCB0aGlzLCBzb2NrZXQpO1xuICAgIH1cbiAgfVxufVxuXG4vL0ZJWE1FOui/memHjOeahOS7o+eggeWlveWDj+agueacrOayoeacieeUqO+8jOayoeacieS4gOS4qmRlY29kZeWHveaVsOaUr+aMgWNi55qEXG5mdW5jdGlvbiBoYW5kbGVNZXNzYWdlQXN5bmMoXG4gIHNlbGY6IENvbm5lY3RvckNvbXBvbmVudCxcbiAgbXNnOiBhbnksXG4gIHNlc3Npb246IFNlc3Npb24sXG4gIHNvY2tldDogSVNvY2tldFxuKSB7XG4gIGlmIChzZWxmLmRlY29kZSkge1xuICAgIHNlbGYuZGVjb2RlKG1zZywgc2Vzc2lvbiwgKGVycjogYW55LCBkbXNnOiBhbnkpID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFwiZmFpbCB0byBkZWNvZGUgbWVzc2FnZSBmcm9tIGNsaWVudCAlcyAuXCIsIGVyci5zdGFjayk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgZG9IYW5kbGVNZXNzYWdlKHNlbGYsIGRtc2csIHNlc3Npb24pO1xuICAgIH0pO1xuICB9IGVsc2UgaWYgKHNlbGYuY29ubmVjdG9yLmRlY29kZSkge1xuICAgIHNlbGYuY29ubmVjdG9yLmRlY29kZShtc2csIDxhbnk+c29ja2V0LCAoZXJyOiBhbnksIGRtc2c6IGFueSkgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoXCJmYWlsIHRvIGRlY29kZSBtZXNzYWdlIGZyb20gY2xpZW50ICVzIC5cIiwgZXJyLnN0YWNrKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBkb0hhbmRsZU1lc3NhZ2Uoc2VsZiwgZG1zZywgc2Vzc2lvbik7XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZG9IYW5kbGVNZXNzYWdlKFxuICBzZWxmOiBDb25uZWN0b3JDb21wb25lbnQsXG4gIGRtc2c6IGFueSxcbiAgc2Vzc2lvbjogU2Vzc2lvblxuKSB7XG4gIGlmICghZG1zZykge1xuICAgIC8vIGRpc2NhcmQgaW52YWxpZCBtZXNzYWdlXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gdXNlIHJzYSBjcnlwdG9cbiAgaWYgKHNlbGYudXNlQ3J5cHRvKSB7XG4gICAgbGV0IHZlcmlmaWVkID0gdmVyaWZ5TWVzc2FnZShzZWxmLCBzZXNzaW9uLCBkbXNnKTtcbiAgICBpZiAoIXZlcmlmaWVkKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXCJmYWlsIHRvIHZlcmlmeSB0aGUgZGF0YSByZWNlaXZlZCBmcm9tIGNsaWVudC5cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlTWVzc2FnZShzZWxmLCBzZXNzaW9uLCBkbXNnKTtcbn1cblxuZnVuY3Rpb24gZ2V0U2Vzc2lvbihzZWxmOiBDb25uZWN0b3JDb21wb25lbnQsIHNvY2tldDogSVNvY2tldCkge1xuICBsZXQgYXBwID0gc2VsZi5hcHAsXG4gICAgc2lkID0gc29ja2V0LmlkO1xuICBsZXQgc2Vzc2lvbiA9IHNlbGYuc2Vzc2lvbi5nZXQoc2lkKTtcbiAgaWYgKHNlc3Npb24pIHtcbiAgICByZXR1cm4gc2Vzc2lvbjtcbiAgfVxuXG4gIHNlc3Npb24gPSBzZWxmLnNlc3Npb24uY3JlYXRlKHNpZCwgYXBwLnNlcnZlcklkLCBzb2NrZXQpO1xuICBsb2dnZXIuZGVidWcoXG4gICAgXCJbJXNdIGdldFNlc3Npb24gc2Vzc2lvbiBpcyBjcmVhdGVkIHdpdGggc2Vzc2lvbiBpZDogJXNcIixcbiAgICBhcHAuc2VydmVySWQsXG4gICAgc2lkXG4gICk7XG5cbiAgLy8gYmluZCBldmVudHMgZm9yIHNlc3Npb25cbiAgc29ja2V0Lm9uKFwiZGlzY29ubmVjdFwiLCBzZXNzaW9uLmNsb3NlZC5iaW5kKHNlc3Npb24pKTtcbiAgc29ja2V0Lm9uKFwiZXJyb3JcIiwgc2Vzc2lvbi5jbG9zZWQuYmluZChzZXNzaW9uKSk7XG4gIHNlc3Npb24ub24oXCJjbG9zZWRcIiwgb25TZXNzaW9uQ2xvc2UuYmluZChudWxsLCBhcHApKTtcbiAgc2Vzc2lvbi5vbihcImJpbmRcIiwgKHVpZDogc3RyaW5nKSA9PiB7XG4gICAgbG9nZ2VyLmRlYnVnKFwic2Vzc2lvbiBvbiBbJXNdIGJpbmQgd2l0aCB1aWQ6ICVzXCIsIHNlbGYuYXBwLnNlcnZlcklkLCB1aWQpO1xuICAgIC8vIHVwZGF0ZSBjb25uZWN0aW9uIHN0YXRpc3RpY3MgaWYgbmVjZXNzYXJ5XG4gICAgaWYgKHNlbGYuY29ubmVjdGlvbikge1xuICAgICAgc2VsZi5jb25uZWN0aW9uLmFkZExvZ2luZWRVc2VyKHVpZCwge1xuICAgICAgICBsb2dpblRpbWU6IERhdGUubm93KCksXG4gICAgICAgIHVpZDogdWlkLFxuICAgICAgICBhZGRyZXNzOiBzb2NrZXQucmVtb3RlQWRkcmVzcy5pcCArIFwiOlwiICsgc29ja2V0LnJlbW90ZUFkZHJlc3MucG9ydFxuICAgICAgfSk7XG4gICAgfVxuICAgIHNlbGYuYXBwLmV2ZW50LmVtaXQoZXZlbnRzLkJJTkRfU0VTU0lPTiwgc2Vzc2lvbik7XG4gIH0pO1xuXG4gIHNlc3Npb24ub24oXCJ1bmJpbmRcIiwgKHVpZDogc3RyaW5nKSA9PiB7XG4gICAgaWYgKHNlbGYuY29ubmVjdGlvbikge1xuICAgICAgc2VsZi5jb25uZWN0aW9uLnJlbW92ZUxvZ2luZWRVc2VyKHVpZCk7XG4gICAgfVxuICAgIHNlbGYuYXBwLmV2ZW50LmVtaXQoZXZlbnRzLlVOQklORF9TRVNTSU9OLCBzZXNzaW9uKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHNlc3Npb247XG59XG5cbmZ1bmN0aW9uIGdldENvbm5lY3RvcihhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XG4gIGxldCBjb25uZWN0b3IgPSBvcHRzLmNvbm5lY3RvcjtcbiAgaWYgKCFjb25uZWN0b3IpIHtcbiAgICByZXR1cm4gZ2V0RGVmYXVsdENvbm5lY3RvcihhcHAsIG9wdHMpO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBjb25uZWN0b3IgIT09IFwiZnVuY3Rpb25cIikge1xuICAgIHJldHVybiBjb25uZWN0b3I7XG4gIH1cblxuICBsZXQgY3VyU2VydmVyID0gYXBwLmN1clNlcnZlcjtcbiAgcmV0dXJuIG5ldyBjb25uZWN0b3IoY3VyU2VydmVyLmNsaWVudFBvcnQsIGN1clNlcnZlci5ob3N0LCBvcHRzKTtcbn1cblxuZnVuY3Rpb24gZ2V0RGVmYXVsdENvbm5lY3RvcihhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XG4gIGxldCBEZWZhdWx0Q29ubmVjdG9yID0gcmVxdWlyZShcIi4uL2Nvbm5lY3RvcnMvc2lvY29ubmVjdG9yXCIpO1xuICBsZXQgY3VyU2VydmVyID0gYXBwLmN1clNlcnZlcjtcbiAgcmV0dXJuIG5ldyBEZWZhdWx0Q29ubmVjdG9yKGN1clNlcnZlci5jbGllbnRQb3J0LCBjdXJTZXJ2ZXIuaG9zdCwgb3B0cyk7XG59XG5cbmZ1bmN0aW9uIG9uU2Vzc2lvbkNsb3NlKGFwcDogQXBwbGljYXRpb24sIHNlc3Npb246IFNlc3Npb24sIHJlYXNvbjogYW55KSB7XG4gIHRhc2tNYW5hZ2VyLmNsb3NlUXVldWUoc2Vzc2lvbi5pZCwgdHJ1ZSk7XG4gIGFwcC5ldmVudC5lbWl0KGV2ZW50cy5DTE9TRV9TRVNTSU9OLCBzZXNzaW9uKTtcbn1cblxuZnVuY3Rpb24gY2hlY2tTZXJ2ZXJUeXBlKHJvdXRlOiBzdHJpbmcpIHtcbiAgaWYgKCFyb3V0ZSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGxldCBpZHggPSByb3V0ZS5pbmRleE9mKFwiLlwiKTtcbiAgaWYgKGlkeCA8IDApIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gcm91dGUuc3Vic3RyaW5nKDAsIGlkeCk7XG59XG5cbmZ1bmN0aW9uIGJpbmRFdmVudHMoc2VsZjogQ29ubmVjdG9yQ29tcG9uZW50LCBzb2NrZXQ6IElTb2NrZXQpIHtcbiAgbGV0IGN1clNlcnZlciA9IHNlbGYuYXBwLmN1clNlcnZlcjtcbiAgbGV0IG1heENvbm5lY3Rpb25zID0gY3VyU2VydmVyW1wibWF4LWNvbm5lY3Rpb25zXCJdO1xuICBpZiAoc2VsZi5jb25uZWN0aW9uICYmIG1heENvbm5lY3Rpb25zKSB7XG4gICAgc2VsZi5jb25uZWN0aW9uLmluY3JlYXNlQ29ubmVjdGlvbkNvdW50KCk7XG4gICAgbGV0IHN0YXRpc3RpY0luZm8gPSBzZWxmLmNvbm5lY3Rpb24uZ2V0U3RhdGlzdGljc0luZm8oKTtcbiAgICBpZiAoc3RhdGlzdGljSW5mby50b3RhbENvbm5Db3VudCA+IG1heENvbm5lY3Rpb25zKSB7XG4gICAgICBsb2dnZXIud2FybihcbiAgICAgICAgXCJ0aGUgc2VydmVyICVzIGhhcyByZWFjaGVkIHRoZSBtYXggY29ubmVjdGlvbnMgJXNcIixcbiAgICAgICAgY3VyU2VydmVyLmlkLFxuICAgICAgICBtYXhDb25uZWN0aW9uc1xuICAgICAgKTtcbiAgICAgIHNvY2tldC5kaXNjb25uZWN0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG5cbiAgLy9jcmVhdGUgc2Vzc2lvbiBmb3IgY29ubmVjdGlvblxuICBsZXQgc2Vzc2lvbiA9IGdldFNlc3Npb24oc2VsZiwgc29ja2V0KTtcbiAgbGV0IGNsb3NlZCA9IGZhbHNlO1xuXG4gIHNvY2tldC5vbihcImRpc2Nvbm5lY3RcIiwgKCkgPT4ge1xuICAgIGlmIChjbG9zZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY2xvc2VkID0gdHJ1ZTtcbiAgICBpZiAoc2VsZi5jb25uZWN0aW9uKSB7XG4gICAgICBzZWxmLmNvbm5lY3Rpb24uZGVjcmVhc2VDb25uZWN0aW9uQ291bnQoc2Vzc2lvbi51aWQpO1xuICAgIH1cbiAgfSk7XG5cbiAgc29ja2V0Lm9uKFwiZXJyb3JcIiwgKCkgPT4ge1xuICAgIGlmIChjbG9zZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY2xvc2VkID0gdHJ1ZTtcbiAgICBpZiAoc2VsZi5jb25uZWN0aW9uKSB7XG4gICAgICBzZWxmLmNvbm5lY3Rpb24uZGVjcmVhc2VDb25uZWN0aW9uQ291bnQoc2Vzc2lvbi51aWQpO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gbmV3IG1lc3NhZ2VcbiAgc29ja2V0Lm9uKFwibWVzc2FnZVwiLCBtc2cgPT4ge1xuICAgIGxldCBkbXNnID0gbXNnO1xuICAgIGlmIChzZWxmLnVzZUFzeW5jQ29kZXIpIHtcbiAgICAgIHJldHVybiBoYW5kbGVNZXNzYWdlQXN5bmMoc2VsZiwgbXNnLCBzZXNzaW9uLCBzb2NrZXQpO1xuICAgIH1cblxuICAgIGlmIChzZWxmLmRlY29kZSkge1xuICAgICAgZG1zZyA9IHNlbGYuZGVjb2RlKG1zZywgc2Vzc2lvbik7XG4gICAgfSBlbHNlIGlmIChzZWxmLmNvbm5lY3Rvci5kZWNvZGUpIHtcbiAgICAgIGRtc2cgPSBzZWxmLmNvbm5lY3Rvci5kZWNvZGUobXNnLCA8YW55PnNvY2tldCk7XG4gICAgfVxuICAgIGlmICghZG1zZykge1xuICAgICAgLy8gZGlzY2FyZCBpbnZhbGlkIG1lc3NhZ2VcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB1c2UgcnNhIGNyeXB0b1xuICAgIGlmIChzZWxmLnVzZUNyeXB0bykge1xuICAgICAgbGV0IHZlcmlmaWVkID0gdmVyaWZ5TWVzc2FnZShzZWxmLCBzZXNzaW9uLCBkbXNnKTtcbiAgICAgIGlmICghdmVyaWZpZWQpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFwiZmFpbCB0byB2ZXJpZnkgdGhlIGRhdGEgcmVjZWl2ZWQgZnJvbSBjbGllbnQuXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuXG4gICAgaGFuZGxlTWVzc2FnZShzZWxmLCBzZXNzaW9uLCBkbXNnKTtcbiAgfSk7IC8vb24gbWVzc2FnZSBlbmRcbn1cblxuZnVuY3Rpb24gaGFuZGxlTWVzc2FnZShzZWxmOiBDb25uZWN0b3JDb21wb25lbnQsIHNlc3Npb246IFNlc3Npb24sIG1zZzogYW55KSB7XG4gIGxvZ2dlci5kZWJ1ZyhcbiAgICBcIlslc10gaGFuZGxlTWVzc2FnZSBzZXNzaW9uIGlkOiAlcywgbXNnOiAlalwiLFxuICAgIHNlbGYuYXBwLnNlcnZlcklkLFxuICAgIHNlc3Npb24uaWQsXG4gICAgbXNnXG4gICk7XG4gIGxldCB0eXBlID0gY2hlY2tTZXJ2ZXJUeXBlKG1zZy5yb3V0ZSk7XG4gIGlmICghdHlwZSkge1xuICAgIGxvZ2dlci5lcnJvcihcImludmFsaWQgcm91dGUgc3RyaW5nLiByb3V0ZSA6ICVqXCIsIG1zZy5yb3V0ZSk7XG4gICAgcmV0dXJuO1xuICB9XG4gIHNlbGYuc2VydmVyLmdsb2JhbEhhbmRsZShcbiAgICBtc2csXG4gICAgc2Vzc2lvbi50b0Zyb250ZW5kU2Vzc2lvbigpLFxuICAgIChlcnI6IGFueSwgcmVzcDogYW55LCBvcHRzOiBhbnkpID0+IHtcbiAgICAgIGlmIChyZXNwICYmICFtc2cuaWQpIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oXCJ0cnkgdG8gcmVzcG9uc2UgdG8gYSBub3RpZnk6ICVqXCIsIG1zZy5yb3V0ZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICghbXNnLmlkICYmICFyZXNwKSByZXR1cm47XG4gICAgICBpZiAoIXJlc3ApIHJlc3AgPSB7fTtcbiAgICAgIGlmICghIWVyciAmJiAhcmVzcC5jb2RlKSB7XG4gICAgICAgIHJlc3AuY29kZSA9IDUwMDtcbiAgICAgIH1cbiAgICAgIG9wdHMgPSB7XG4gICAgICAgIHR5cGU6IFwicmVzcG9uc2VcIixcbiAgICAgICAgdXNlck9wdGlvbnM6IG9wdHMgfHwge31cbiAgICAgIH07XG4gICAgICAvLyBmb3IgY29tcGF0aWFibGl0eVxuICAgICAgb3B0cy5pc1Jlc3BvbnNlID0gdHJ1ZTtcblxuICAgICAgc2VsZi5zZW5kKG1zZy5pZCwgbXNnLnJvdXRlLCByZXNwLCBbc2Vzc2lvbi5pZF0sIG9wdHMsICgpID0+IHt9KTtcbiAgICB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIHZlcmlmeU1lc3NhZ2Uoc2VsZjogQ29ubmVjdG9yQ29tcG9uZW50LCBzZXNzaW9uOiBTZXNzaW9uLCBtc2c6IGFueSkge1xuICBsZXQgc2lnID0gbXNnLmJvZHkuX19jcnlwdG9fXztcbiAgaWYgKCFzaWcpIHtcbiAgICBsb2dnZXIuZXJyb3IoXG4gICAgICBcInJlY2VpdmUgZGF0YSBmcm9tIGNsaWVudCBoYXMgbm8gc2lnbmF0dXJlIFslc11cIixcbiAgICAgIHNlbGYuYXBwLnNlcnZlcklkXG4gICAgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsZXQgcHViS2V5O1xuXG4gIGlmICghc2Vzc2lvbikge1xuICAgIGxvZ2dlci5lcnJvcihcImNvdWxkIG5vdCBmaW5kIHNlc3Npb24uXCIpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGlmICghc2Vzc2lvbi5nZXQoXCJwdWJLZXlcIikpIHtcbiAgICBwdWJLZXkgPSBzZWxmLmdldFB1YktleShzZXNzaW9uLmlkLnRvU3RyaW5nKCkpO1xuICAgIGlmICghIXB1YktleSkge1xuICAgICAgZGVsZXRlIHNlbGYua2V5c1tzZXNzaW9uLmlkXTtcbiAgICAgIHNlc3Npb24uc2V0KFwicHViS2V5XCIsIHB1YktleSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcImNvdWxkIG5vdCBnZXQgcHVibGljIGtleSwgc2Vzc2lvbiBpZCBpcyAlc1wiLCBzZXNzaW9uLmlkKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcHViS2V5ID0gc2Vzc2lvbi5nZXQoXCJwdWJLZXlcIik7XG4gIH1cblxuICBpZiAoIXB1YktleS5uIHx8ICFwdWJLZXkuZSkge1xuICAgIGxvZ2dlci5lcnJvcihcbiAgICAgIFwiY291bGQgbm90IHZlcmlmeSBtZXNzYWdlIHdpdGhvdXQgcHVibGljIGtleSBbJXNdXCIsXG4gICAgICBzZWxmLmFwcC5zZXJ2ZXJJZFxuICAgICk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgZGVsZXRlIG1zZy5ib2R5Ll9fY3J5cHRvX187XG5cbiAgbGV0IG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShtc2cuYm9keSk7XG4gIGlmICh1dGlscy5oYXNDaGluZXNlQ2hhcihtZXNzYWdlKSkgbWVzc2FnZSA9IHV0aWxzLnVuaWNvZGVUb1V0ZjgobWVzc2FnZSk7XG5cbiAgcmV0dXJuIHB1YktleS52ZXJpZnlTdHJpbmcobWVzc2FnZSwgc2lnKTtcbn1cbiJdfQ==