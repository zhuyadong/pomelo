"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const utils = require("../../util/utils");
const Loader = require("pomelo-loader");
const pathUtil = require("../../util/pathUtil");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const forwardLogger = require("pomelo-logger").getLogger("forward-log", __filename);
class HandlerService {
    constructor(app, opts) {
        this.app = app;
        this.handlersMap = {};
        if (!!opts.reloadHandlers) {
            watchHandlers(app, this.handlersMap);
        }
        this.enableForwardLog = opts.enableForwardLog || false;
        this.name = "handler";
    }
    handle(routeRecord, msg, session, cb) {
        // the request should be processed by current server
        let handler = this.getHandler(routeRecord);
        if (!handler) {
            logger.error("[handleManager]: fail to find handler for %j", msg.__route__);
            utils.invokeCallback(cb, new Error("fail to find handler for " + msg.__route__));
            return;
        }
        let start = Date.now();
        let self = this;
        let callback = (err, resp, opts) => {
            if (self.enableForwardLog) {
                let log = {
                    route: msg.__route__,
                    args: msg,
                    time: utils.format(new Date(start)),
                    timeUsed: Date.now() - start
                };
                forwardLogger.info(JSON.stringify(log));
            }
            // resp = getResp(arguments);
            utils.invokeCallback(cb, err, resp, opts);
        };
        let method = routeRecord.method;
        if (!Array.isArray(msg)) {
            handler[method](msg, session, callback);
        }
        else {
            msg.push(session);
            msg.push(callback);
            handler[method].apply(handler, msg);
        }
        return;
    }
    getHandler(routeRecord) {
        let serverType = routeRecord.serverType;
        if (!this.handlersMap[serverType]) {
            loadHandlers(this.app, serverType, this.handlersMap);
        }
        let handlers = this.handlersMap[serverType] || {};
        let handler = handlers[routeRecord.handler];
        if (!handler) {
            logger.warn("could not find handler for routeRecord: %j", routeRecord);
            return null;
        }
        if (typeof handler[routeRecord.method] !== "function") {
            logger.warn("could not find the method %s in handler: %s", routeRecord.method, routeRecord.handler);
            return null;
        }
        return handler;
    }
}
exports.HandlerService = HandlerService;
function loadHandlers(app, serverType, handlersMap) {
    let p = pathUtil.getHandlerPath(app.base, serverType);
    if (p) {
        handlersMap[serverType] = Loader.load(p, app);
    }
}
function watchHandlers(app, handlersMap) {
    let p = pathUtil.getHandlerPath(app.base, app.serverType);
    if (!!p) {
        fs.watch(p, (event, name) => {
            if (event === "change") {
                handlersMap[app.serverType] = Loader.load(p, app);
            }
        });
    }
}
function getResp(args) {
    let len = args.length;
    if (len == 1) {
        return [];
    }
    if (len == 2) {
        return [args[1]];
    }
    if (len == 3) {
        return [args[1], args[2]];
    }
    if (len == 4) {
        return [args[1], args[2], args[3]];
    }
    let r = new Array(len);
    for (let i = 1; i < len; i++) {
        r[i] = args[i];
    }
    return r;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlclNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoYW5kbGVyU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUEwQjtBQUMxQiwwQ0FBMkM7QUFDM0MsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3hDLGdEQUFpRDtBQUlqRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUN4RSxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUN2RCxhQUFhLEVBQ2IsVUFBVSxDQUNWLENBQUM7QUFZRjtJQUlDLFlBQTRCLEdBQWdCLEVBQUUsSUFBVTtRQUE1QixRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQzNDLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUMzQixhQUFhLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0QyxDQUFDO1FBRUQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxLQUFLLENBQUM7UUFFdkQsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUM7SUFDdkIsQ0FBQztJQUVELE1BQU0sQ0FDTCxXQUF3QixFQUN4QixHQUFRLEVBQ1IsT0FBdUMsRUFDdkMsRUFBYTtRQUViLG9EQUFvRDtRQUNwRCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzNDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNkLE1BQU0sQ0FBQyxLQUFLLENBQ1gsOENBQThDLEVBQzlDLEdBQUcsQ0FBQyxT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QUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2QsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNkLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELElBQUksQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoQixDQUFDO0lBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNWLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgPSByZXF1aXJlKFwiZnNcIik7XG5pbXBvcnQgdXRpbHMgPSByZXF1aXJlKFwiLi4vLi4vdXRpbC91dGlsc1wiKTtcbmNvbnN0IExvYWRlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9hZGVyXCIpO1xuaW1wb3J0IHBhdGhVdGlsID0gcmVxdWlyZShcIi4uLy4uL3V0aWwvcGF0aFV0aWxcIik7XG5pbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCIuLi8uLi9hcHBsaWNhdGlvblwiO1xuaW1wb3J0IHsgU2Vzc2lvbiwgRnJvbnRlbmRTZXNzaW9uIH0gZnJvbSBcIi4vc2Vzc2lvblNlcnZpY2VcIjtcbmltcG9ydCB7IEJhY2tlbmRTZXNzaW9uIH0gZnJvbSBcIi4vYmFja2VuZFNlc3Npb25TZXJ2aWNlXCI7XG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XG5jb25zdCBmb3J3YXJkTG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFxuXHRcImZvcndhcmQtbG9nXCIsXG5cdF9fZmlsZW5hbWVcbik7XG5cbmV4cG9ydCB0eXBlIEhhbmRsZXIgPSB7IFtpZHg6IHN0cmluZ106IEZ1bmN0aW9uIH07XG5leHBvcnQgdHlwZSBIYW5kbGVycyA9IHsgW2lkeDogc3RyaW5nXTogSGFuZGxlciB9O1xuZXhwb3J0IHR5cGUgSGFuZGxlcnNNYXAgPSB7IFtpZHg6IHN0cmluZ106IEhhbmRsZXJzIH07XG5leHBvcnQgaW50ZXJmYWNlIFJvdXRlUmVjb3JkIHtcblx0c2VydmVyVHlwZTogc3RyaW5nO1xuXHRyb3V0ZTogc3RyaW5nO1xuXHRoYW5kbGVyOiBzdHJpbmc7XG5cdG1ldGhvZDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgSGFuZGxlclNlcnZpY2Uge1xuXHRyZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cdHByaXZhdGUgaGFuZGxlcnNNYXA6IEhhbmRsZXJzTWFwO1xuXHRwcml2YXRlIGVuYWJsZUZvcndhcmRMb2c6IGJvb2xlYW47XG5cdGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XG5cdFx0dGhpcy5oYW5kbGVyc01hcCA9IHt9O1xuXHRcdGlmICghIW9wdHMucmVsb2FkSGFuZGxlcnMpIHtcblx0XHRcdHdhdGNoSGFuZGxlcnMoYXBwLCB0aGlzLmhhbmRsZXJzTWFwKTtcblx0XHR9XG5cblx0XHR0aGlzLmVuYWJsZUZvcndhcmRMb2cgPSBvcHRzLmVuYWJsZUZvcndhcmRMb2cgfHwgZmFsc2U7XG5cblx0XHR0aGlzLm5hbWUgPSBcImhhbmRsZXJcIjtcblx0fVxuXG5cdGhhbmRsZShcblx0XHRyb3V0ZVJlY29yZDogUm91dGVSZWNvcmQsXG5cdFx0bXNnOiBhbnksXG5cdFx0c2Vzc2lvbjogRnJvbnRlbmRTZXNzaW9ufEJhY2tlbmRTZXNzaW9uLFxuXHRcdGNiPzogRnVuY3Rpb25cblx0KSB7XG5cdFx0Ly8gdGhlIHJlcXVlc3Qgc2hvdWxkIGJlIHByb2Nlc3NlZCBieSBjdXJyZW50IHNlcnZlclxuXHRcdGxldCBoYW5kbGVyID0gdGhpcy5nZXRIYW5kbGVyKHJvdXRlUmVjb3JkKTtcblx0XHRpZiAoIWhhbmRsZXIpIHtcblx0XHRcdGxvZ2dlci5lcnJvcihcblx0XHRcdFx0XCJbaGFuZGxlTWFuYWdlcl06IGZhaWwgdG8gZmluZCBoYW5kbGVyIGZvciAlalwiLFxuXHRcdFx0XHRtc2cuX19yb3V0ZV9fXG5cdFx0XHQpO1xuXHRcdFx0dXRpbHMuaW52b2tlQ2FsbGJhY2soXG5cdFx0XHRcdGNiISxcblx0XHRcdFx0bmV3IEVycm9yKFwiZmFpbCB0byBmaW5kIGhhbmRsZXIgZm9yIFwiICsgbXNnLl9fcm91dGVfXylcblx0XHRcdCk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGxldCBzdGFydCA9IERhdGUubm93KCk7XG5cdFx0bGV0IHNlbGYgPSB0aGlzO1xuXG5cdFx0bGV0IGNhbGxiYWNrID0gKGVycjogYW55LCByZXNwOiBhbnksIG9wdHM6IGFueSkgPT4ge1xuXHRcdFx0aWYgKHNlbGYuZW5hYmxlRm9yd2FyZExvZykge1xuXHRcdFx0XHRsZXQgbG9nID0ge1xuXHRcdFx0XHRcdHJvdXRlOiBtc2cuX19yb3V0ZV9fLFxuXHRcdFx0XHRcdGFyZ3M6IG1zZyxcblx0XHRcdFx0XHR0aW1lOiB1dGlscy5mb3JtYXQobmV3IERhdGUoc3RhcnQpKSxcblx0XHRcdFx0XHR0aW1lVXNlZDogRGF0ZS5ub3coKSAtIHN0YXJ0XG5cdFx0XHRcdH07XG5cdFx0XHRcdGZvcndhcmRMb2dnZXIuaW5mbyhKU09OLnN0cmluZ2lmeShsb2cpKTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gcmVzcCA9IGdldFJlc3AoYXJndW1lbnRzKTtcblx0XHRcdHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISwgZXJyLCByZXNwLCBvcHRzKTtcblx0XHR9O1xuXG5cdFx0bGV0IG1ldGhvZCA9IHJvdXRlUmVjb3JkLm1ldGhvZDtcblxuXHRcdGlmICghQXJyYXkuaXNBcnJheShtc2cpKSB7XG5cdFx0XHRoYW5kbGVyW21ldGhvZF0obXNnLCBzZXNzaW9uLCBjYWxsYmFjayk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG1zZy5wdXNoKHNlc3Npb24pO1xuXHRcdFx0bXNnLnB1c2goY2FsbGJhY2spO1xuXHRcdFx0aGFuZGxlclttZXRob2RdLmFwcGx5KGhhbmRsZXIsIG1zZyk7XG5cdFx0fVxuXHRcdHJldHVybjtcblx0fVxuXG5cdGdldEhhbmRsZXIocm91dGVSZWNvcmQ6IFJvdXRlUmVjb3JkKSB7XG5cdFx0bGV0IHNlcnZlclR5cGUgPSByb3V0ZVJlY29yZC5zZXJ2ZXJUeXBlO1xuXHRcdGlmICghdGhpcy5oYW5kbGVyc01hcFtzZXJ2ZXJUeXBlXSkge1xuXHRcdFx0bG9hZEhhbmRsZXJzKHRoaXMuYXBwLCBzZXJ2ZXJUeXBlLCB0aGlzLmhhbmRsZXJzTWFwKTtcblx0XHR9XG5cdFx0bGV0IGhhbmRsZXJzID0gdGhpcy5oYW5kbGVyc01hcFtzZXJ2ZXJUeXBlXSB8fCB7fTtcblx0XHRsZXQgaGFuZGxlciA9IGhhbmRsZXJzW3JvdXRlUmVjb3JkLmhhbmRsZXJdO1xuXHRcdGlmICghaGFuZGxlcikge1xuXHRcdFx0bG9nZ2VyLndhcm4oXG5cdFx0XHRcdFwiY291bGQgbm90IGZpbmQgaGFuZGxlciBmb3Igcm91dGVSZWNvcmQ6ICVqXCIsXG5cdFx0XHRcdHJvdXRlUmVjb3JkXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXHRcdGlmICh0eXBlb2YgaGFuZGxlcltyb3V0ZVJlY29yZC5tZXRob2RdICE9PSBcImZ1bmN0aW9uXCIpIHtcblx0XHRcdGxvZ2dlci53YXJuKFxuXHRcdFx0XHRcImNvdWxkIG5vdCBmaW5kIHRoZSBtZXRob2QgJXMgaW4gaGFuZGxlcjogJXNcIixcblx0XHRcdFx0cm91dGVSZWNvcmQubWV0aG9kLFxuXHRcdFx0XHRyb3V0ZVJlY29yZC5oYW5kbGVyXG5cdFx0XHQpO1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXHRcdHJldHVybiBoYW5kbGVyO1xuXHR9XG59XG5cbmZ1bmN0aW9uIGxvYWRIYW5kbGVycyhcblx0YXBwOiBBcHBsaWNhdGlvbixcblx0c2VydmVyVHlwZTogc3RyaW5nLFxuXHRoYW5kbGVyc01hcDogSGFuZGxlcnNNYXBcbikge1xuXHRsZXQgcCA9IHBhdGhVdGlsLmdldEhhbmRsZXJQYXRoKGFwcC5iYXNlLCBzZXJ2ZXJUeXBlKTtcblx0aWYgKHApIHtcblx0XHRoYW5kbGVyc01hcFtzZXJ2ZXJUeXBlXSA9IExvYWRlci5sb2FkKHAsIGFwcCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gd2F0Y2hIYW5kbGVycyhhcHA6IEFwcGxpY2F0aW9uLCBoYW5kbGVyc01hcDogSGFuZGxlcnNNYXApIHtcblx0bGV0IHAgPSBwYXRoVXRpbC5nZXRIYW5kbGVyUGF0aChhcHAuYmFzZSwgYXBwLnNlcnZlclR5cGUpO1xuXHRpZiAoISFwKSB7XG5cdFx0ZnMud2F0Y2gocCwgKGV2ZW50LCBuYW1lKSA9PiB7XG5cdFx0XHRpZiAoZXZlbnQgPT09IFwiY2hhbmdlXCIpIHtcblx0XHRcdFx0aGFuZGxlcnNNYXBbYXBwLnNlcnZlclR5cGVdID0gTG9hZGVyLmxvYWQocCwgYXBwKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxufVxuXG5mdW5jdGlvbiBnZXRSZXNwKGFyZ3M6IGFueVtdKSB7XG5cdGxldCBsZW4gPSBhcmdzLmxlbmd0aDtcblx0aWYgKGxlbiA9PSAxKSB7XG5cdFx0cmV0dXJuIFtdO1xuXHR9XG5cblx0aWYgKGxlbiA9PSAyKSB7XG5cdFx0cmV0dXJuIFthcmdzWzFdXTtcblx0fVxuXG5cdGlmIChsZW4gPT0gMykge1xuXHRcdHJldHVybiBbYXJnc1sxXSwgYXJnc1syXV07XG5cdH1cblxuXHRpZiAobGVuID09IDQpIHtcblx0XHRyZXR1cm4gW2FyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM11dO1xuXHR9XG5cblx0bGV0IHIgPSBuZXcgQXJyYXkobGVuKTtcblx0Zm9yIChsZXQgaSA9IDE7IGkgPCBsZW47IGkrKykge1xuXHRcdHJbaV0gPSBhcmdzW2ldO1xuXHR9XG5cblx0cmV0dXJuIHI7XG59XG4iXX0=