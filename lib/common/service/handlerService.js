"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const utils = require("../../util/utils");
const Loader = require("pomelo-loader");
const pathUtil = require("../../util/pathUtil");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const forwardLogger = require("pomelo-logger").getLogger("forward-log", __filename);
class HandlerService {
    constructor(app, opts) {
        this.app = app;
        this.handlersMap = {};
        if (!!opts.reloadHandlers) {
            watchHandlers(app, this.handlersMap);
        }
        this.enableForwardLog = opts.enableForwardLog || false;
        this.name = "handler";
    }
    handle(routeRecord, msg, session, cb) {
        // the request should be processed by current server
        let handler = this.getHandler(routeRecord);
        if (!handler) {
            logger.error("[handleManager]: fail to find handler for %j", msg.__route__);
            utils.invokeCallback(cb, new Error("fail to find handler for " + msg.__route__));
            return;
        }
        let start = Date.now();
        let self = this;
        let callback = (err, resp, opts) => {
            if (self.enableForwardLog) {
                let log = {
                    route: msg.__route__,
                    args: msg,
                    time: utils.format(new Date(start)),
                    timeUsed: Date.now() - start
                };
                forwardLogger.info(JSON.stringify(log));
            }
            // resp = getResp(arguments);
            utils.invokeCallback(cb, err, resp, opts);
        };
        let method = routeRecord.method;
        if (!Array.isArray(msg)) {
            handler[method](msg, session, callback);
        }
        else {
            msg.push(session);
            msg.push(callback);
            handler[method].apply(handler, msg);
        }
        return;
    }
    getHandler(routeRecord) {
        let serverType = routeRecord.serverType;
        if (!this.handlersMap[serverType]) {
            loadHandlers(this.app, serverType, this.handlersMap);
        }
        let handlers = this.handlersMap[serverType] || {};
        let handler = handlers[routeRecord.handler];
        if (!handler) {
            logger.warn("could not find handler for routeRecord: %j", routeRecord);
            return null;
        }
        if (typeof handler[routeRecord.method] !== "function") {
            logger.warn("could not find the method %s in handler: %s", routeRecord.method, routeRecord.handler);
            return null;
        }
        return handler;
    }
}
exports.HandlerService = HandlerService;
function loadHandlers(app, serverType, handlersMap) {
    let p = pathUtil.getHandlerPath(app.base, serverType);
    if (p) {
        handlersMap[serverType] = Loader.load(p, app);
    }
}
function watchHandlers(app, handlersMap) {
    let p = pathUtil.getHandlerPath(app.base, app.serverType);
    if (!!p) {
        fs.watch(p, (event, name) => {
            if (event === "change") {
                handlersMap[app.serverType] = Loader.load(p, app);
            }
        });
    }
}
function getResp(args) {
    let len = args.length;
    if (len == 1) {
        return [];
    }
    if (len == 2) {
        return [args[1]];
    }
    if (len == 3) {
        return [args[1], args[2]];
    }
    if (len == 4) {
        return [args[1], args[2], args[3]];
    }
    let r = new Array(len);
    for (let i = 1; i < len; i++) {
        r[i] = args[i];
    }
    return r;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlclNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoYW5kbGVyU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUEwQjtBQUMxQiwwQ0FBMkM7QUFDM0MsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3hDLGdEQUFpRDtBQUlqRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUN4RSxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUN2RCxhQUFhLEVBQ2IsVUFBVSxDQUNWLENBQUM7QUFZRjtJQUlDLFlBQTRCLEdBQWdCLEVBQUUsSUFBVTtRQUE1QixRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQzNDLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUMzQixhQUFhLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0QyxDQUFDO1FBRUQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxLQUFLLENBQUM7UUFFdkQsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUM7SUFDdkIsQ0FBQztJQUVELE1BQU0sQ0FDTCxXQUF3QixFQUN4QixHQUFRLEVBQ1IsT0FBdUMsRUFDdkMsRUFBYTtRQUViLG9EQUFvRDtRQUNwRCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzNDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNkLE1BQU0sQ0FBQyxLQUFLLENBQ1gsOENBQThDLEVBQzlDLEdBQUcsQ0FBQyxT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QUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUVELEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2QsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFRCxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNkLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELElBQUksQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoQixDQUFDO0lBRUQsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNWLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmltcG9ydCB1dGlscyA9IHJlcXVpcmUoXCIuLi8uLi91dGlsL3V0aWxzXCIpO1xyXG5jb25zdCBMb2FkZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvYWRlclwiKTtcclxuaW1wb3J0IHBhdGhVdGlsID0gcmVxdWlyZShcIi4uLy4uL3V0aWwvcGF0aFV0aWxcIik7XHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uIH0gZnJvbSBcIi4uLy4uL2FwcGxpY2F0aW9uXCI7XHJcbmltcG9ydCB7IFNlc3Npb24sIEZyb250ZW5kU2Vzc2lvbiB9IGZyb20gXCIuL3Nlc3Npb25TZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEJhY2tlbmRTZXNzaW9uIH0gZnJvbSBcIi4vYmFja2VuZFNlc3Npb25TZXJ2aWNlXCI7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcclxuY29uc3QgZm9yd2FyZExvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcclxuXHRcImZvcndhcmQtbG9nXCIsXHJcblx0X19maWxlbmFtZVxyXG4pO1xyXG5cclxuZXhwb3J0IHR5cGUgSGFuZGxlciA9IHsgW2lkeDogc3RyaW5nXTogRnVuY3Rpb24gfTtcclxuZXhwb3J0IHR5cGUgSGFuZGxlcnMgPSB7IFtpZHg6IHN0cmluZ106IEhhbmRsZXIgfTtcclxuZXhwb3J0IHR5cGUgSGFuZGxlcnNNYXAgPSB7IFtpZHg6IHN0cmluZ106IEhhbmRsZXJzIH07XHJcbmV4cG9ydCBpbnRlcmZhY2UgUm91dGVSZWNvcmQge1xyXG5cdHNlcnZlclR5cGU6IHN0cmluZztcclxuXHRyb3V0ZTogc3RyaW5nO1xyXG5cdGhhbmRsZXI6IHN0cmluZztcclxuXHRtZXRob2Q6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEhhbmRsZXJTZXJ2aWNlIHtcclxuXHRyZWFkb25seSBuYW1lOiBzdHJpbmc7XHJcblx0cHJpdmF0ZSBoYW5kbGVyc01hcDogSGFuZGxlcnNNYXA7XHJcblx0cHJpdmF0ZSBlbmFibGVGb3J3YXJkTG9nOiBib29sZWFuO1xyXG5cdGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSBhcHA6IEFwcGxpY2F0aW9uLCBvcHRzPzogYW55KSB7XHJcblx0XHR0aGlzLmhhbmRsZXJzTWFwID0ge307XHJcblx0XHRpZiAoISFvcHRzLnJlbG9hZEhhbmRsZXJzKSB7XHJcblx0XHRcdHdhdGNoSGFuZGxlcnMoYXBwLCB0aGlzLmhhbmRsZXJzTWFwKTtcclxuXHRcdH1cclxuXHJcblx0XHR0aGlzLmVuYWJsZUZvcndhcmRMb2cgPSBvcHRzLmVuYWJsZUZvcndhcmRMb2cgfHwgZmFsc2U7XHJcblxyXG5cdFx0dGhpcy5uYW1lID0gXCJoYW5kbGVyXCI7XHJcblx0fVxyXG5cclxuXHRoYW5kbGUoXHJcblx0XHRyb3V0ZVJlY29yZDogUm91dGVSZWNvcmQsXHJcblx0XHRtc2c6IGFueSxcclxuXHRcdHNlc3Npb246IEZyb250ZW5kU2Vzc2lvbnxCYWNrZW5kU2Vzc2lvbixcclxuXHRcdGNiPzogRnVuY3Rpb25cclxuXHQpIHtcclxuXHRcdC8vIHRoZSByZXF1ZXN0IHNob3VsZCBiZSBwcm9jZXNzZWQgYnkgY3VycmVudCBzZXJ2ZXJcclxuXHRcdGxldCBoYW5kbGVyID0gdGhpcy5nZXRIYW5kbGVyKHJvdXRlUmVjb3JkKTtcclxuXHRcdGlmICghaGFuZGxlcikge1xyXG5cdFx0XHRsb2dnZXIuZXJyb3IoXHJcblx0XHRcdFx0XCJbaGFuZGxlTWFuYWdlcl06IGZhaWwgdG8gZmluZCBoYW5kbGVyIGZvciAlalwiLFxyXG5cdFx0XHRcdG1zZy5fX3JvdXRlX19cclxuXHRcdFx0KTtcclxuXHRcdFx0dXRpbHMuaW52b2tlQ2FsbGJhY2soXHJcblx0XHRcdFx0Y2IhLFxyXG5cdFx0XHRcdG5ldyBFcnJvcihcImZhaWwgdG8gZmluZCBoYW5kbGVyIGZvciBcIiArIG1zZy5fX3JvdXRlX18pXHJcblx0XHRcdCk7XHJcblx0XHRcdHJldHVybjtcclxuXHRcdH1cclxuXHRcdGxldCBzdGFydCA9IERhdGUubm93KCk7XHJcblx0XHRsZXQgc2VsZiA9IHRoaXM7XHJcblxyXG5cdFx0bGV0IGNhbGxiYWNrID0gKGVycjogYW55LCByZXNwOiBhbnksIG9wdHM6IGFueSkgPT4ge1xyXG5cdFx0XHRpZiAoc2VsZi5lbmFibGVGb3J3YXJkTG9nKSB7XHJcblx0XHRcdFx0bGV0IGxvZyA9IHtcclxuXHRcdFx0XHRcdHJvdXRlOiBtc2cuX19yb3V0ZV9fLFxyXG5cdFx0XHRcdFx0YXJnczogbXNnLFxyXG5cdFx0XHRcdFx0dGltZTogdXRpbHMuZm9ybWF0KG5ldyBEYXRlKHN0YXJ0KSksXHJcblx0XHRcdFx0XHR0aW1lVXNlZDogRGF0ZS5ub3coKSAtIHN0YXJ0XHJcblx0XHRcdFx0fTtcclxuXHRcdFx0XHRmb3J3YXJkTG9nZ2VyLmluZm8oSlNPTi5zdHJpbmdpZnkobG9nKSk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdC8vIHJlc3AgPSBnZXRSZXNwKGFyZ3VtZW50cyk7XHJcblx0XHRcdHV0aWxzLmludm9rZUNhbGxiYWNrKGNiISwgZXJyLCByZXNwLCBvcHRzKTtcclxuXHRcdH07XHJcblxyXG5cdFx0bGV0IG1ldGhvZCA9IHJvdXRlUmVjb3JkLm1ldGhvZDtcclxuXHJcblx0XHRpZiAoIUFycmF5LmlzQXJyYXkobXNnKSkge1xyXG5cdFx0XHRoYW5kbGVyW21ldGhvZF0obXNnLCBzZXNzaW9uLCBjYWxsYmFjayk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRtc2cucHVzaChzZXNzaW9uKTtcclxuXHRcdFx0bXNnLnB1c2goY2FsbGJhY2spO1xyXG5cdFx0XHRoYW5kbGVyW21ldGhvZF0uYXBwbHkoaGFuZGxlciwgbXNnKTtcclxuXHRcdH1cclxuXHRcdHJldHVybjtcclxuXHR9XHJcblxyXG5cdGdldEhhbmRsZXIocm91dGVSZWNvcmQ6IFJvdXRlUmVjb3JkKSB7XHJcblx0XHRsZXQgc2VydmVyVHlwZSA9IHJvdXRlUmVjb3JkLnNlcnZlclR5cGU7XHJcblx0XHRpZiAoIXRoaXMuaGFuZGxlcnNNYXBbc2VydmVyVHlwZV0pIHtcclxuXHRcdFx0bG9hZEhhbmRsZXJzKHRoaXMuYXBwLCBzZXJ2ZXJUeXBlLCB0aGlzLmhhbmRsZXJzTWFwKTtcclxuXHRcdH1cclxuXHRcdGxldCBoYW5kbGVycyA9IHRoaXMuaGFuZGxlcnNNYXBbc2VydmVyVHlwZV0gfHwge307XHJcblx0XHRsZXQgaGFuZGxlciA9IGhhbmRsZXJzW3JvdXRlUmVjb3JkLmhhbmRsZXJdO1xyXG5cdFx0aWYgKCFoYW5kbGVyKSB7XHJcblx0XHRcdGxvZ2dlci53YXJuKFxyXG5cdFx0XHRcdFwiY291bGQgbm90IGZpbmQgaGFuZGxlciBmb3Igcm91dGVSZWNvcmQ6ICVqXCIsXHJcblx0XHRcdFx0cm91dGVSZWNvcmRcclxuXHRcdFx0KTtcclxuXHRcdFx0cmV0dXJuIG51bGw7XHJcblx0XHR9XHJcblx0XHRpZiAodHlwZW9mIGhhbmRsZXJbcm91dGVSZWNvcmQubWV0aG9kXSAhPT0gXCJmdW5jdGlvblwiKSB7XHJcblx0XHRcdGxvZ2dlci53YXJuKFxyXG5cdFx0XHRcdFwiY291bGQgbm90IGZpbmQgdGhlIG1ldGhvZCAlcyBpbiBoYW5kbGVyOiAlc1wiLFxyXG5cdFx0XHRcdHJvdXRlUmVjb3JkLm1ldGhvZCxcclxuXHRcdFx0XHRyb3V0ZVJlY29yZC5oYW5kbGVyXHJcblx0XHRcdCk7XHJcblx0XHRcdHJldHVybiBudWxsO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIGhhbmRsZXI7XHJcblx0fVxyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkSGFuZGxlcnMoXHJcblx0YXBwOiBBcHBsaWNhdGlvbixcclxuXHRzZXJ2ZXJUeXBlOiBzdHJpbmcsXHJcblx0aGFuZGxlcnNNYXA6IEhhbmRsZXJzTWFwXHJcbikge1xyXG5cdGxldCBwID0gcGF0aFV0aWwuZ2V0SGFuZGxlclBhdGgoYXBwLmJhc2UsIHNlcnZlclR5cGUpO1xyXG5cdGlmIChwKSB7XHJcblx0XHRoYW5kbGVyc01hcFtzZXJ2ZXJUeXBlXSA9IExvYWRlci5sb2FkKHAsIGFwcCk7XHJcblx0fVxyXG59XHJcblxyXG5mdW5jdGlvbiB3YXRjaEhhbmRsZXJzKGFwcDogQXBwbGljYXRpb24sIGhhbmRsZXJzTWFwOiBIYW5kbGVyc01hcCkge1xyXG5cdGxldCBwID0gcGF0aFV0aWwuZ2V0SGFuZGxlclBhdGgoYXBwLmJhc2UsIGFwcC5zZXJ2ZXJUeXBlKTtcclxuXHRpZiAoISFwKSB7XHJcblx0XHRmcy53YXRjaChwLCAoZXZlbnQsIG5hbWUpID0+IHtcclxuXHRcdFx0aWYgKGV2ZW50ID09PSBcImNoYW5nZVwiKSB7XHJcblx0XHRcdFx0aGFuZGxlcnNNYXBbYXBwLnNlcnZlclR5cGVdID0gTG9hZGVyLmxvYWQocCwgYXBwKTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRSZXNwKGFyZ3M6IGFueVtdKSB7XHJcblx0bGV0IGxlbiA9IGFyZ3MubGVuZ3RoO1xyXG5cdGlmIChsZW4gPT0gMSkge1xyXG5cdFx0cmV0dXJuIFtdO1xyXG5cdH1cclxuXHJcblx0aWYgKGxlbiA9PSAyKSB7XHJcblx0XHRyZXR1cm4gW2FyZ3NbMV1dO1xyXG5cdH1cclxuXHJcblx0aWYgKGxlbiA9PSAzKSB7XHJcblx0XHRyZXR1cm4gW2FyZ3NbMV0sIGFyZ3NbMl1dO1xyXG5cdH1cclxuXHJcblx0aWYgKGxlbiA9PSA0KSB7XHJcblx0XHRyZXR1cm4gW2FyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM11dO1xyXG5cdH1cclxuXHJcblx0bGV0IHIgPSBuZXcgQXJyYXkobGVuKTtcclxuXHRmb3IgKGxldCBpID0gMTsgaSA8IGxlbjsgaSsrKSB7XHJcblx0XHRyW2ldID0gYXJnc1tpXTtcclxuXHR9XHJcblxyXG5cdHJldHVybiByO1xyXG59XHJcbiJdfQ==