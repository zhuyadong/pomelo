"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const path = require("path");
const fs = require("fs");
const crypto = require("crypto");
const protobuf = require("pomelo-protobuf");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
class ProtobufComponent {
    constructor(app, opts) {
        this.app = app;
        this.name = "__protobuf__";
        opts = opts || {};
        this.watchers = {};
        this.serverProtos = {};
        this.clientProtos = {};
        this.version = "";
        let env = app.get(index_1.RESERVED.ENV);
        let originServerPath = path.join(app.base, index_1.FILEPATH.SERVER_PROTOS);
        let presentServerPath = path.join(index_1.FILEPATH.CONFIG_DIR, env, path.basename(index_1.FILEPATH.SERVER_PROTOS));
        let originClientPath = path.join(app.base, index_1.FILEPATH.CLIENT_PROTOS);
        let presentClientPath = path.join(index_1.FILEPATH.CONFIG_DIR, env, path.basename(index_1.FILEPATH.CLIENT_PROTOS));
        this.serverProtosPath =
            opts.serverProtos ||
                (fs.existsSync(originServerPath)
                    ? index_1.FILEPATH.SERVER_PROTOS
                    : presentServerPath);
        this.clientProtosPath =
            opts.clientProtos ||
                (fs.existsSync(originClientPath)
                    ? index_1.FILEPATH.CLIENT_PROTOS
                    : presentClientPath);
        this.setProtos(index_1.RESERVED.SERVER, path.join(app.base, this.serverProtosPath));
        this.setProtos(index_1.RESERVED.CLIENT, path.join(app.base, this.clientProtosPath));
        protobuf.init({
            encoderProtos: this.serverProtos,
            decoderProtos: this.clientProtos
        });
    }
    encode(key, msg) {
        return protobuf.encode(key, msg);
    }
    encode2Bytes(key, msg) {
        return protobuf.encode2Bytes(key, msg);
    }
    decode(key, msg) {
        return protobuf.decode(key, msg);
    }
    getProtos() {
        return {
            server: this.serverProtos,
            client: this.clientProtos,
            version: this.version
        };
    }
    getVersion() {
        return this.version;
    }
    setProtos(type, path) {
        if (!fs.existsSync(path)) {
            return;
        }
        if (type === index_1.RESERVED.SERVER) {
            this.serverProtos = protobuf.parse(require(path));
        }
        if (type === index_1.RESERVED.CLIENT) {
            this.clientProtos = protobuf.parse(require(path));
        }
        let oStr = JSON.stringify(this.clientProtos) + JSON.stringify(this.serverProtos);
        this.version = crypto
            .createHash("md5")
            .update(oStr)
            .digest("base64");
        //Watch file
        let watcher = fs.watch(path, this.onUpdate.bind(this, type, path));
        if (this.watchers[type]) {
            this.watchers[type].close();
        }
        this.watchers[type] = watcher;
    }
    onUpdate(type, path, event) {
        if (event !== "change") {
            return;
        }
        let self = this;
        fs.readFile(path, "utf8", (err, data) => {
            try {
                let os = protobuf.parse(JSON.parse(data));
                if (type === index_1.RESERVED.SERVER) {
                    protobuf.setEncoderProtos(os);
                    self.serverProtos = os;
                }
                else {
                    protobuf.setDecoderProtos(os);
                    self.clientProtos = os;
                }
                let oStr = JSON.stringify(self.clientProtos) + JSON.stringify(self.serverProtos);
                self.version = crypto
                    .createHash("md5")
                    .update(oStr)
                    .digest("base64");
                logger.info("change o file , type : %j, path : %j, version : %j", type, path, self.version);
            }
            catch (e) {
                logger.warn("change o file error! path : %j", path);
                logger.warn(e);
            }
        });
    }
    stop(force, cb) {
        for (let type in this.watchers) {
            this.watchers[type].close();
        }
        this.watchers = {};
        process.nextTick(cb);
    }
}
exports.ProtobufComponent = ProtobufComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9idWZTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJvdG9idWZTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQXlFO0FBRXpFLDZCQUE4QjtBQUM5Qix5QkFBMEI7QUFDMUIsaUNBQWtDO0FBRWxDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRXhFO0lBUUUsWUFBcUIsR0FBZ0IsRUFBRSxJQUFVO1FBQTVCLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFQNUIsU0FBSSxHQUFHLGNBQWMsQ0FBQztRQVE3QixJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUVsQixJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLGdCQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEMsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsZ0JBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNuRSxJQUFJLGlCQUFpQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQy9CLGdCQUFRLENBQUMsVUFBVSxFQUNuQixHQUFHLEVBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBUSxDQUFDLGFBQWEsQ0FBQyxDQUN0QyxDQUFDO1FBQ0YsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJ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QUMsRUFBRSxDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBL0lELDhDQStJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgQXBwbGljYXRpb24sIFJFU0VSVkVELCBGSUxFUEFUSCB9IGZyb20gXCIuLi8uLi9pbmRleFwiO1xyXG5pbXBvcnQgeyBGU1dhdGNoZXIgfSBmcm9tIFwiZnNcIjtcclxuaW1wb3J0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuaW1wb3J0IGZzID0gcmVxdWlyZShcImZzXCIpO1xyXG5pbXBvcnQgY3J5cHRvID0gcmVxdWlyZShcImNyeXB0b1wiKTtcclxuXHJcbmNvbnN0IHByb3RvYnVmID0gcmVxdWlyZShcInBvbWVsby1wcm90b2J1ZlwiKTtcclxuY29uc3QgbG9nZ2VyID0gcmVxdWlyZShcInBvbWVsby1sb2dnZXJcIikuZ2V0TG9nZ2VyKFwicG9tZWxvXCIsIF9fZmlsZW5hbWUpO1xyXG5cclxuZXhwb3J0IGNsYXNzIFByb3RvYnVmQ29tcG9uZW50IGltcGxlbWVudHMgQ29tcG9uZW50IHtcclxuICByZWFkb25seSBuYW1lID0gXCJfX3Byb3RvYnVmX19cIjtcclxuICBwcml2YXRlIHNlcnZlclByb3Rvc1BhdGg6IHN0cmluZztcclxuICBwcml2YXRlIGNsaWVudFByb3Rvc1BhdGg6IHN0cmluZztcclxuICBwcml2YXRlIHNlcnZlclByb3RvczogeyBbaWR4OiBzdHJpbmddOiBhbnkgfTtcclxuICBwcml2YXRlIGNsaWVudFByb3RvczogeyBbaWR4OiBzdHJpbmddOiBhbnkgfTtcclxuICBwcml2YXRlIHZlcnNpb246IHN0cmluZztcclxuICBwcml2YXRlIHdhdGNoZXJzOiB7IFtpZHg6IHN0cmluZ106IEZTV2F0Y2hlciB9O1xyXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IGFwcDogQXBwbGljYXRpb24sIG9wdHM/OiBhbnkpIHtcclxuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xyXG4gICAgdGhpcy53YXRjaGVycyA9IHt9O1xyXG4gICAgdGhpcy5zZXJ2ZXJQcm90b3MgPSB7fTtcclxuICAgIHRoaXMuY2xpZW50UHJvdG9zID0ge307XHJcbiAgICB0aGlzLnZlcnNpb24gPSBcIlwiO1xyXG5cclxuICAgIGxldCBlbnYgPSBhcHAuZ2V0KFJFU0VSVkVELkVOVik7XHJcbiAgICBsZXQgb3JpZ2luU2VydmVyUGF0aCA9IHBhdGguam9pbihhcHAuYmFzZSwgRklMRVBBVEguU0VSVkVSX1BST1RPUyk7XHJcbiAgICBsZXQgcHJlc2VudFNlcnZlclBhdGggPSBwYXRoLmpvaW4oXHJcbiAgICAgIEZJTEVQQVRILkNPTkZJR19ESVIsXHJcbiAgICAgIGVudixcclxuICAgICAgcGF0aC5iYXNlbmFtZShGSUxFUEFUSC5TRVJWRVJfUFJPVE9TKVxyXG4gICAgKTtcclxuICAgIGxldCBvcmlnaW5DbGllbnRQYXRoID0gcGF0aC5qb2luKGFwcC5iYXNlLCBGSUxFUEFUSC5DTElFTlRfUFJPVE9TKTtcclxuICAgIGxldCBwcmVzZW50Q2xpZW50UGF0aCA9IHBhdGguam9pbihcclxuICAgICAgRklMRVBBVEguQ09ORklHX0RJUixcclxuICAgICAgZW52LFxyXG4gICAgICBwYXRoLmJhc2VuYW1lKEZJTEVQQVRILkNMSUVOVF9QUk9UT1MpXHJcbiAgICApO1xyXG5cclxuICAgIHRoaXMuc2VydmVyUHJvdG9zUGF0aCA9XHJcbiAgICAgIG9wdHMuc2VydmVyUHJvdG9zIHx8XHJcbiAgICAgIChmcy5leGlzdHNTeW5jKG9yaWdpblNlcnZlclBhdGgpXHJcbiAgICAgICAgPyBGSUxFUEFUSC5TRVJWRVJfUFJPVE9TXHJcbiAgICAgICAgOiBwcmVzZW50U2VydmVyUGF0aCk7XHJcbiAgICB0aGlzLmNsaWVudFByb3Rvc1BhdGggPVxyXG4gICAgICBvcHRzLmNsaWVudFByb3RvcyB8fFxyXG4gICAgICAoZnMuZXhpc3RzU3luYyhvcmlnaW5DbGllbnRQYXRoKVxyXG4gICAgICAgID8gRklMRVBBVEguQ0xJRU5UX1BST1RPU1xyXG4gICAgICAgIDogcHJlc2VudENsaWVudFBhdGgpO1xyXG5cclxuICAgIHRoaXMuc2V0UHJvdG9zKFJFU0VSVkVELlNFUlZFUiwgcGF0aC5qb2luKGFwcC5iYXNlLCB0aGlzLnNlcnZlclByb3Rvc1BhdGgpKTtcclxuICAgIHRoaXMuc2V0UHJvdG9zKFJFU0VSVkVELkNMSUVOVCwgcGF0aC5qb2luKGFwcC5iYXNlLCB0aGlzLmNsaWVudFByb3Rvc1BhdGgpKTtcclxuXHJcbiAgICBwcm90b2J1Zi5pbml0KHtcclxuICAgICAgZW5jb2RlclByb3RvczogdGhpcy5zZXJ2ZXJQcm90b3MsXHJcbiAgICAgIGRlY29kZXJQcm90b3M6IHRoaXMuY2xpZW50UHJvdG9zXHJcbiAgICB9KTtcclxuICB9XHJcbiAgZW5jb2RlKGtleTogc3RyaW5nLCBtc2c6IGFueSkge1xyXG4gICAgcmV0dXJuIHByb3RvYnVmLmVuY29kZShrZXksIG1zZyk7XHJcbiAgfVxyXG5cclxuICBlbmNvZGUyQnl0ZXMoa2V5OiBzdHJpbmcsIG1zZzogYW55KSB7XHJcbiAgICByZXR1cm4gcHJvdG9idWYuZW5jb2RlMkJ5dGVzKGtleSwgbXNnKTtcclxuICB9XHJcblxyXG4gIGRlY29kZShrZXk6IHN0cmluZywgbXNnOiBhbnkpIHtcclxuICAgIHJldHVybiBwcm90b2J1Zi5kZWNvZGUoa2V5LCBtc2cpO1xyXG4gIH1cclxuXHJcbiAgZ2V0UHJvdG9zKCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgc2VydmVyOiB0aGlzLnNlcnZlclByb3RvcyxcclxuICAgICAgY2xpZW50OiB0aGlzLmNsaWVudFByb3RvcyxcclxuICAgICAgdmVyc2lvbjogdGhpcy52ZXJzaW9uXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgZ2V0VmVyc2lvbigpIHtcclxuICAgIHJldHVybiB0aGlzLnZlcnNpb247XHJcbiAgfVxyXG5cclxuICBzZXRQcm90b3ModHlwZTogc3RyaW5nLCBwYXRoOiBzdHJpbmcpIHtcclxuICAgIGlmICghZnMuZXhpc3RzU3luYyhwYXRoKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHR5cGUgPT09IFJFU0VSVkVELlNFUlZFUikge1xyXG4gICAgICB0aGlzLnNlcnZlclByb3RvcyA9IHByb3RvYnVmLnBhcnNlKHJlcXVpcmUocGF0aCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0eXBlID09PSBSRVNFUlZFRC5DTElFTlQpIHtcclxuICAgICAgdGhpcy5jbGllbnRQcm90b3MgPSBwcm90b2J1Zi5wYXJzZShyZXF1aXJlKHBhdGgpKTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgb1N0ciA9XHJcbiAgICAgIEpTT04uc3RyaW5naWZ5KHRoaXMuY2xpZW50UHJvdG9zKSArIEpTT04uc3RyaW5naWZ5KHRoaXMuc2VydmVyUHJvdG9zKTtcclxuICAgIHRoaXMudmVyc2lvbiA9IGNyeXB0b1xyXG4gICAgICAuY3JlYXRlSGFzaChcIm1kNVwiKVxyXG4gICAgICAudXBkYXRlKG9TdHIpXHJcbiAgICAgIC5kaWdlc3QoXCJiYXNlNjRcIik7XHJcblxyXG4gICAgLy9XYXRjaCBmaWxlXHJcbiAgICBsZXQgd2F0Y2hlciA9IGZzLndhdGNoKHBhdGgsIHRoaXMub25VcGRhdGUuYmluZCh0aGlzLCB0eXBlLCBwYXRoKSk7XHJcbiAgICBpZiAodGhpcy53YXRjaGVyc1t0eXBlXSkge1xyXG4gICAgICB0aGlzLndhdGNoZXJzW3R5cGVdLmNsb3NlKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLndhdGNoZXJzW3R5cGVdID0gd2F0Y2hlcjtcclxuICB9XHJcblxyXG4gIG9uVXBkYXRlKHR5cGU6IHN0cmluZywgcGF0aDogc3RyaW5nLCBldmVudDogc3RyaW5nKSB7XHJcbiAgICBpZiAoZXZlbnQgIT09IFwiY2hhbmdlXCIpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBzZWxmID0gdGhpcztcclxuICAgIGZzLnJlYWRGaWxlKHBhdGgsIFwidXRmOFwiLCAoZXJyLCBkYXRhKSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgbGV0IG9zID0gcHJvdG9idWYucGFyc2UoSlNPTi5wYXJzZShkYXRhKSk7XHJcbiAgICAgICAgaWYgKHR5cGUgPT09IFJFU0VSVkVELlNFUlZFUikge1xyXG4gICAgICAgICAgcHJvdG9idWYuc2V0RW5jb2RlclByb3Rvcyhvcyk7XHJcbiAgICAgICAgICBzZWxmLnNlcnZlclByb3RvcyA9IG9zO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBwcm90b2J1Zi5zZXREZWNvZGVyUHJvdG9zKG9zKTtcclxuICAgICAgICAgIHNlbGYuY2xpZW50UHJvdG9zID0gb3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgb1N0ciA9XHJcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeShzZWxmLmNsaWVudFByb3RvcykgKyBKU09OLnN0cmluZ2lmeShzZWxmLnNlcnZlclByb3Rvcyk7XHJcbiAgICAgICAgc2VsZi52ZXJzaW9uID0gY3J5cHRvXHJcbiAgICAgICAgICAuY3JlYXRlSGFzaChcIm1kNVwiKVxyXG4gICAgICAgICAgLnVwZGF0ZShvU3RyKVxyXG4gICAgICAgICAgLmRpZ2VzdChcImJhc2U2NFwiKTtcclxuICAgICAgICBsb2dnZXIuaW5mbyhcclxuICAgICAgICAgIFwiY2hhbmdlIG8gZmlsZSAsIHR5cGUgOiAlaiwgcGF0aCA6ICVqLCB2ZXJzaW9uIDogJWpcIixcclxuICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICBwYXRoLFxyXG4gICAgICAgICAgc2VsZi52ZXJzaW9uXHJcbiAgICAgICAgKTtcclxuICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGxvZ2dlci53YXJuKFwiY2hhbmdlIG8gZmlsZSBlcnJvciEgcGF0aCA6ICVqXCIsIHBhdGgpO1xyXG4gICAgICAgIGxvZ2dlci53YXJuKGUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHN0b3AoZm9yY2U6IGJvb2xlYW4sIGNiOiBGdW5jdGlvbikge1xyXG4gICAgZm9yIChsZXQgdHlwZSBpbiB0aGlzLndhdGNoZXJzKSB7XHJcbiAgICAgIHRoaXMud2F0Y2hlcnNbdHlwZV0uY2xvc2UoKTtcclxuICAgIH1cclxuICAgIHRoaXMud2F0Y2hlcnMgPSB7fTtcclxuICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xyXG4gIH1cclxufVxyXG4iXX0=