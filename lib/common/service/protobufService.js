"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const path = require("path");
const fs = require("fs");
const crypto = require("crypto");
const protobuf = require("pomelo-protobuf");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
class ProtobufComponent {
    constructor(app, opts) {
        this.app = app;
        this.name = "__protobuf__";
        opts = opts || {};
        this.watchers = {};
        this.serverProtos = {};
        this.clientProtos = {};
        this.version = "";
        let env = app.get(index_1.RESERVED.ENV);
        let originServerPath = path.join(app.base, index_1.FILEPATH.SERVER_PROTOS);
        let presentServerPath = path.join(index_1.FILEPATH.CONFIG_DIR, env, path.basename(index_1.FILEPATH.SERVER_PROTOS));
        let originClientPath = path.join(app.base, index_1.FILEPATH.CLIENT_PROTOS);
        let presentClientPath = path.join(index_1.FILEPATH.CONFIG_DIR, env, path.basename(index_1.FILEPATH.CLIENT_PROTOS));
        this.serverProtosPath =
            opts.serverProtos ||
                (fs.existsSync(originServerPath)
                    ? index_1.FILEPATH.SERVER_PROTOS
                    : presentServerPath);
        this.clientProtosPath =
            opts.clientProtos ||
                (fs.existsSync(originClientPath)
                    ? index_1.FILEPATH.CLIENT_PROTOS
                    : presentClientPath);
        this.setProtos(index_1.RESERVED.SERVER, path.join(app.base, this.serverProtosPath));
        this.setProtos(index_1.RESERVED.CLIENT, path.join(app.base, this.clientProtosPath));
        protobuf.init({
            encoderProtos: this.serverProtos,
            decoderProtos: this.clientProtos
        });
    }
    encode(key, msg) {
        return protobuf.encode(key, msg);
    }
    encode2Bytes(key, msg) {
        return protobuf.encode2Bytes(key, msg);
    }
    decode(key, msg) {
        return protobuf.decode(key, msg);
    }
    getProtos() {
        return {
            server: this.serverProtos,
            client: this.clientProtos,
            version: this.version
        };
    }
    getVersion() {
        return this.version;
    }
    setProtos(type, path) {
        if (!fs.existsSync(path)) {
            return;
        }
        if (type === index_1.RESERVED.SERVER) {
            this.serverProtos = protobuf.parse(require(path));
        }
        if (type === index_1.RESERVED.CLIENT) {
            this.clientProtos = protobuf.parse(require(path));
        }
        let oStr = JSON.stringify(this.clientProtos) + JSON.stringify(this.serverProtos);
        this.version = crypto
            .createHash("md5")
            .update(oStr)
            .digest("base64");
        //Watch file
        let watcher = fs.watch(path, this.onUpdate.bind(this, type, path));
        if (this.watchers[type]) {
            this.watchers[type].close();
        }
        this.watchers[type] = watcher;
    }
    onUpdate(type, path, event) {
        if (event !== "change") {
            return;
        }
        let self = this;
        fs.readFile(path, "utf8", (err, data) => {
            try {
                let os = protobuf.parse(JSON.parse(data));
                if (type === index_1.RESERVED.SERVER) {
                    protobuf.setEncoderProtos(os);
                    self.serverProtos = os;
                }
                else {
                    protobuf.setDecoderProtos(os);
                    self.clientProtos = os;
                }
                let oStr = JSON.stringify(self.clientProtos) + JSON.stringify(self.serverProtos);
                self.version = crypto
                    .createHash("md5")
                    .update(oStr)
                    .digest("base64");
                logger.info("change o file , type : %j, path : %j, version : %j", type, path, self.version);
            }
            catch (e) {
                logger.warn("change o file error! path : %j", path);
                logger.warn(e);
            }
        });
    }
    stop(force, cb) {
        for (let type in this.watchers) {
            this.watchers[type].close();
        }
        this.watchers = {};
        process.nextTick(cb);
    }
}
exports.ProtobufComponent = ProtobufComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9idWZTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJvdG9idWZTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQXlFO0FBRXpFLDZCQUE4QjtBQUM5Qix5QkFBMEI7QUFDMUIsaUNBQWtDO0FBRWxDLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRXhFO0lBUUUsWUFBcUIsR0FBZ0IsRUFBRSxJQUFVO1FBQTVCLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFQNUIsU0FBSSxHQUFHLGNBQWMsQ0FBQztRQVE3QixJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUVsQixJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLGdCQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEMsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsZ0JBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNuRSxJQUFJLGlCQUFpQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQy9CLGdCQUFRLENBQUMsVUFBVSxFQUNuQixHQUFHLEVBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBUSxDQUFDLGFBQWEsQ0FBQyxDQUN0QyxDQUFDO1FBQ0YsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJ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QUMsRUFBRSxDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUNGO0FBL0lELDhDQStJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgQXBwbGljYXRpb24sIFJFU0VSVkVELCBGSUxFUEFUSCB9IGZyb20gXCIuLi8uLi9pbmRleFwiO1xuaW1wb3J0IHsgRlNXYXRjaGVyIH0gZnJvbSBcImZzXCI7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuaW1wb3J0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuaW1wb3J0IGNyeXB0byA9IHJlcXVpcmUoXCJjcnlwdG9cIik7XG5cbmNvbnN0IHByb3RvYnVmID0gcmVxdWlyZShcInBvbWVsby1wcm90b2J1ZlwiKTtcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcblxuZXhwb3J0IGNsYXNzIFByb3RvYnVmQ29tcG9uZW50IGltcGxlbWVudHMgQ29tcG9uZW50IHtcbiAgcmVhZG9ubHkgbmFtZSA9IFwiX19wcm90b2J1Zl9fXCI7XG4gIHByaXZhdGUgc2VydmVyUHJvdG9zUGF0aDogc3RyaW5nO1xuICBwcml2YXRlIGNsaWVudFByb3Rvc1BhdGg6IHN0cmluZztcbiAgcHJpdmF0ZSBzZXJ2ZXJQcm90b3M6IHsgW2lkeDogc3RyaW5nXTogYW55IH07XG4gIHByaXZhdGUgY2xpZW50UHJvdG9zOiB7IFtpZHg6IHN0cmluZ106IGFueSB9O1xuICBwcml2YXRlIHZlcnNpb246IHN0cmluZztcbiAgcHJpdmF0ZSB3YXRjaGVyczogeyBbaWR4OiBzdHJpbmddOiBGU1dhdGNoZXIgfTtcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgb3B0cz86IGFueSkge1xuICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xuICAgIHRoaXMud2F0Y2hlcnMgPSB7fTtcbiAgICB0aGlzLnNlcnZlclByb3RvcyA9IHt9O1xuICAgIHRoaXMuY2xpZW50UHJvdG9zID0ge307XG4gICAgdGhpcy52ZXJzaW9uID0gXCJcIjtcblxuICAgIGxldCBlbnYgPSBhcHAuZ2V0KFJFU0VSVkVELkVOVik7XG4gICAgbGV0IG9yaWdpblNlcnZlclBhdGggPSBwYXRoLmpvaW4oYXBwLmJhc2UsIEZJTEVQQVRILlNFUlZFUl9QUk9UT1MpO1xuICAgIGxldCBwcmVzZW50U2VydmVyUGF0aCA9IHBhdGguam9pbihcbiAgICAgIEZJTEVQQVRILkNPTkZJR19ESVIsXG4gICAgICBlbnYsXG4gICAgICBwYXRoLmJhc2VuYW1lKEZJTEVQQVRILlNFUlZFUl9QUk9UT1MpXG4gICAgKTtcbiAgICBsZXQgb3JpZ2luQ2xpZW50UGF0aCA9IHBhdGguam9pbihhcHAuYmFzZSwgRklMRVBBVEguQ0xJRU5UX1BST1RPUyk7XG4gICAgbGV0IHByZXNlbnRDbGllbnRQYXRoID0gcGF0aC5qb2luKFxuICAgICAgRklMRVBBVEguQ09ORklHX0RJUixcbiAgICAgIGVudixcbiAgICAgIHBhdGguYmFzZW5hbWUoRklMRVBBVEguQ0xJRU5UX1BST1RPUylcbiAgICApO1xuXG4gICAgdGhpcy5zZXJ2ZXJQcm90b3NQYXRoID1cbiAgICAgIG9wdHMuc2VydmVyUHJvdG9zIHx8XG4gICAgICAoZnMuZXhpc3RzU3luYyhvcmlnaW5TZXJ2ZXJQYXRoKVxuICAgICAgICA/IEZJTEVQQVRILlNFUlZFUl9QUk9UT1NcbiAgICAgICAgOiBwcmVzZW50U2VydmVyUGF0aCk7XG4gICAgdGhpcy5jbGllbnRQcm90b3NQYXRoID1cbiAgICAgIG9wdHMuY2xpZW50UHJvdG9zIHx8XG4gICAgICAoZnMuZXhpc3RzU3luYyhvcmlnaW5DbGllbnRQYXRoKVxuICAgICAgICA/IEZJTEVQQVRILkNMSUVOVF9QUk9UT1NcbiAgICAgICAgOiBwcmVzZW50Q2xpZW50UGF0aCk7XG5cbiAgICB0aGlzLnNldFByb3RvcyhSRVNFUlZFRC5TRVJWRVIsIHBhdGguam9pbihhcHAuYmFzZSwgdGhpcy5zZXJ2ZXJQcm90b3NQYXRoKSk7XG4gICAgdGhpcy5zZXRQcm90b3MoUkVTRVJWRUQuQ0xJRU5ULCBwYXRoLmpvaW4oYXBwLmJhc2UsIHRoaXMuY2xpZW50UHJvdG9zUGF0aCkpO1xuXG4gICAgcHJvdG9idWYuaW5pdCh7XG4gICAgICBlbmNvZGVyUHJvdG9zOiB0aGlzLnNlcnZlclByb3RvcyxcbiAgICAgIGRlY29kZXJQcm90b3M6IHRoaXMuY2xpZW50UHJvdG9zXG4gICAgfSk7XG4gIH1cbiAgZW5jb2RlKGtleTogc3RyaW5nLCBtc2c6IGFueSkge1xuICAgIHJldHVybiBwcm90b2J1Zi5lbmNvZGUoa2V5LCBtc2cpO1xuICB9XG5cbiAgZW5jb2RlMkJ5dGVzKGtleTogc3RyaW5nLCBtc2c6IGFueSkge1xuICAgIHJldHVybiBwcm90b2J1Zi5lbmNvZGUyQnl0ZXMoa2V5LCBtc2cpO1xuICB9XG5cbiAgZGVjb2RlKGtleTogc3RyaW5nLCBtc2c6IGFueSkge1xuICAgIHJldHVybiBwcm90b2J1Zi5kZWNvZGUoa2V5LCBtc2cpO1xuICB9XG5cbiAgZ2V0UHJvdG9zKCkge1xuICAgIHJldHVybiB7XG4gICAgICBzZXJ2ZXI6IHRoaXMuc2VydmVyUHJvdG9zLFxuICAgICAgY2xpZW50OiB0aGlzLmNsaWVudFByb3RvcyxcbiAgICAgIHZlcnNpb246IHRoaXMudmVyc2lvblxuICAgIH07XG4gIH1cblxuICBnZXRWZXJzaW9uKCkge1xuICAgIHJldHVybiB0aGlzLnZlcnNpb247XG4gIH1cblxuICBzZXRQcm90b3ModHlwZTogc3RyaW5nLCBwYXRoOiBzdHJpbmcpIHtcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMocGF0aCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodHlwZSA9PT0gUkVTRVJWRUQuU0VSVkVSKSB7XG4gICAgICB0aGlzLnNlcnZlclByb3RvcyA9IHByb3RvYnVmLnBhcnNlKHJlcXVpcmUocGF0aCkpO1xuICAgIH1cblxuICAgIGlmICh0eXBlID09PSBSRVNFUlZFRC5DTElFTlQpIHtcbiAgICAgIHRoaXMuY2xpZW50UHJvdG9zID0gcHJvdG9idWYucGFyc2UocmVxdWlyZShwYXRoKSk7XG4gICAgfVxuXG4gICAgbGV0IG9TdHIgPVxuICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5jbGllbnRQcm90b3MpICsgSlNPTi5zdHJpbmdpZnkodGhpcy5zZXJ2ZXJQcm90b3MpO1xuICAgIHRoaXMudmVyc2lvbiA9IGNyeXB0b1xuICAgICAgLmNyZWF0ZUhhc2goXCJtZDVcIilcbiAgICAgIC51cGRhdGUob1N0cilcbiAgICAgIC5kaWdlc3QoXCJiYXNlNjRcIik7XG5cbiAgICAvL1dhdGNoIGZpbGVcbiAgICBsZXQgd2F0Y2hlciA9IGZzLndhdGNoKHBhdGgsIHRoaXMub25VcGRhdGUuYmluZCh0aGlzLCB0eXBlLCBwYXRoKSk7XG4gICAgaWYgKHRoaXMud2F0Y2hlcnNbdHlwZV0pIHtcbiAgICAgIHRoaXMud2F0Y2hlcnNbdHlwZV0uY2xvc2UoKTtcbiAgICB9XG4gICAgdGhpcy53YXRjaGVyc1t0eXBlXSA9IHdhdGNoZXI7XG4gIH1cblxuICBvblVwZGF0ZSh0eXBlOiBzdHJpbmcsIHBhdGg6IHN0cmluZywgZXZlbnQ6IHN0cmluZykge1xuICAgIGlmIChldmVudCAhPT0gXCJjaGFuZ2VcIikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBzZWxmID0gdGhpcztcbiAgICBmcy5yZWFkRmlsZShwYXRoLCBcInV0ZjhcIiwgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IG9zID0gcHJvdG9idWYucGFyc2UoSlNPTi5wYXJzZShkYXRhKSk7XG4gICAgICAgIGlmICh0eXBlID09PSBSRVNFUlZFRC5TRVJWRVIpIHtcbiAgICAgICAgICBwcm90b2J1Zi5zZXRFbmNvZGVyUHJvdG9zKG9zKTtcbiAgICAgICAgICBzZWxmLnNlcnZlclByb3RvcyA9IG9zO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHByb3RvYnVmLnNldERlY29kZXJQcm90b3Mob3MpO1xuICAgICAgICAgIHNlbGYuY2xpZW50UHJvdG9zID0gb3M7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgb1N0ciA9XG4gICAgICAgICAgSlNPTi5zdHJpbmdpZnkoc2VsZi5jbGllbnRQcm90b3MpICsgSlNPTi5zdHJpbmdpZnkoc2VsZi5zZXJ2ZXJQcm90b3MpO1xuICAgICAgICBzZWxmLnZlcnNpb24gPSBjcnlwdG9cbiAgICAgICAgICAuY3JlYXRlSGFzaChcIm1kNVwiKVxuICAgICAgICAgIC51cGRhdGUob1N0cilcbiAgICAgICAgICAuZGlnZXN0KFwiYmFzZTY0XCIpO1xuICAgICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgICBcImNoYW5nZSBvIGZpbGUgLCB0eXBlIDogJWosIHBhdGggOiAlaiwgdmVyc2lvbiA6ICVqXCIsXG4gICAgICAgICAgdHlwZSxcbiAgICAgICAgICBwYXRoLFxuICAgICAgICAgIHNlbGYudmVyc2lvblxuICAgICAgICApO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2dnZXIud2FybihcImNoYW5nZSBvIGZpbGUgZXJyb3IhIHBhdGggOiAlalwiLCBwYXRoKTtcbiAgICAgICAgbG9nZ2VyLndhcm4oZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzdG9wKGZvcmNlOiBib29sZWFuLCBjYjogRnVuY3Rpb24pIHtcbiAgICBmb3IgKGxldCB0eXBlIGluIHRoaXMud2F0Y2hlcnMpIHtcbiAgICAgIHRoaXMud2F0Y2hlcnNbdHlwZV0uY2xvc2UoKTtcbiAgICB9XG4gICAgdGhpcy53YXRjaGVycyA9IHt9O1xuICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xuICB9XG59XG4iXX0=