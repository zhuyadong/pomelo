"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("../../index");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
const Client = require("pomelo-rpc").client;
class ProxyComponent {
    constructor(app, opts) {
        this.app = app;
        this.name = "__proxy__";
        this.opts = opts;
        this.client = genRpcClient(this.app, opts);
        this.app.event.on(index_1.events.ADD_SERVERS, this.addServers.bind(this));
        this.app.event.on(index_1.events.REMOVE_SERVERS, this.removeServers.bind(this));
        this.app.event.on(index_1.events.REPLACE_SERVERS, this.replaceServers.bind(this));
    }
    start(cb) {
        if (this.opts.enableRpcLog) {
            logger.warn("enableRpcLog is deprecated in 0.8.0, please use app.rpcFilter(pomelo.rpcFilters.rpcLog())");
        }
        let rpcBefores = this.app.get(index_1.KEYWORDS.RPC_BEFORE_FILTER);
        let rpcAfters = this.app.get(index_1.KEYWORDS.RPC_AFTER_FILTER);
        let rpcErrorHandler = this.app.get(index_1.RESERVED.RPC_ERROR_HANDLER);
        if (!!rpcBefores) {
            this.client.before(rpcBefores);
        }
        if (!!rpcAfters) {
            this.client.after(rpcAfters);
        }
        if (!!rpcErrorHandler) {
            this.client.setErrorHandler(rpcErrorHandler);
        }
        process.nextTick(cb);
    }
    afterStart(cb) {
        let self = this;
        this.app.__defineGetter__("rpc", () => {
            return self.client.proxies.user;
        });
        this.app.__defineGetter__("sysrpc", () => {
            return self.client.proxies.sys;
        });
        this.app.set("rpcInvoke", this.client.rpcInvoke.bind(this.client));
        this.client.start(cb);
    }
    addServers(servers) {
        if (!servers || !servers.length) {
            return;
        }
        genProxies(this.client, this.app, servers);
        this.client.addServers(servers);
    }
    removeServers(ids) {
        this.client.removeServers(ids);
    }
    replaceServers(servers) {
        if (!servers || !servers.length) {
            return;
        }
        // update proxies
        this.client.proxies = {};
        genProxies(this.client, this.app, servers);
        this.client.replaceServers(servers);
    }
    rpcInvoke(serverId, msg, cb) {
        this.client.rpcInvoke(serverId, msg, cb);
    }
}
exports.ProxyComponent = ProxyComponent;
function genRpcClient(app, opts) {
    opts.context = app;
    opts.routeContext = app;
    if (!!opts.rpcClient) {
        return opts.rpcClient.create(opts);
    }
    else {
        return Client.create(opts);
    }
}
function genProxies(client, app, sinfos) {
    let item;
    for (let i = 0, l = sinfos.length; i < l; i++) {
        item = sinfos[i];
        if (hasProxy(client, item)) {
            continue;
        }
        client.addProxies(getProxyRecords(app, item));
    }
}
function hasProxy(client, sinfo) {
    let proxy = client.proxies;
    return !!proxy.sys && !!proxy.sys[sinfo.serverType];
}
function getProxyRecords(app, sinfo) {
    let records = [], appBase = app.base, record;
    // sys remote service path record
    if (app.isFrontend(sinfo)) {
        record = index_1.pathUtil.getSysRemotePath("frontend");
    }
    else {
        record = index_1.pathUtil.getSysRemotePath("backend");
    }
    if (record) {
        records.push(index_1.pathUtil.remotePathRecord("sys", sinfo.serverType, record));
    }
    // user remote service path record
    record = index_1.pathUtil.getUserRemotePath(appBase, sinfo.serverType);
    if (record) {
        records.push(index_1.pathUtil.remotePathRecord("user", sinfo.serverType, record));
    }
    return records;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJveHlTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJveHlTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBUXFCO0FBQ3JCLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ3hFLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFFNUM7SUFJRSxZQUFxQixHQUFnQixFQUFFLElBQVM7UUFBM0IsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUg1QixTQUFJLEdBQUcsV0FBVyxDQUFDO1FBSTFCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLGNBQU0sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsY0FBTSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxjQUFNLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUNELEtBQUssQ0FBQyxFQUFZO1FBQ2hCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUMzQixNQUFN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Y2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbXBvbmVudCxcclxuICBBcHBsaWNhdGlvbixcclxuICBldmVudHMsXHJcbiAgS0VZV09SRFMsXHJcbiAgUkVTRVJWRUQsXHJcbiAgU2VydmVySW5mbyxcclxuICBwYXRoVXRpbFxyXG59IGZyb20gXCIuLi8uLi9pbmRleFwiO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XHJcbmNvbnN0IENsaWVudCA9IHJlcXVpcmUoXCJwb21lbG8tcnBjXCIpLmNsaWVudDtcclxuXHJcbmV4cG9ydCBjbGFzcyBQcm94eUNvbXBvbmVudCBpbXBsZW1lbnRzIENvbXBvbmVudCB7XHJcbiAgcmVhZG9ubHkgbmFtZSA9IFwiX19wcm94eV9fXCI7XHJcbiAgcHJpdmF0ZSBvcHRzOiBhbnk7XHJcbiAgcHJpdmF0ZSBjbGllbnQ6IGFueTsgLy9UT0RPXHJcbiAgY29uc3RydWN0b3IocmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgb3B0czogYW55KSB7XHJcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xyXG4gICAgdGhpcy5jbGllbnQgPSBnZW5ScGNDbGllbnQodGhpcy5hcHAsIG9wdHMpO1xyXG4gICAgdGhpcy5hcHAuZXZlbnQub24oZXZlbnRzLkFERF9TRVJWRVJTLCB0aGlzLmFkZFNlcnZlcnMuYmluZCh0aGlzKSk7XHJcbiAgICB0aGlzLmFwcC5ldmVudC5vbihldmVudHMuUkVNT1ZFX1NFUlZFUlMsIHRoaXMucmVtb3ZlU2VydmVycy5iaW5kKHRoaXMpKTtcclxuICAgIHRoaXMuYXBwLmV2ZW50Lm9uKGV2ZW50cy5SRVBMQUNFX1NFUlZFUlMsIHRoaXMucmVwbGFjZVNlcnZlcnMuYmluZCh0aGlzKSk7XHJcbiAgfVxyXG4gIHN0YXJ0KGNiOiBGdW5jdGlvbikge1xyXG4gICAgaWYgKHRoaXMub3B0cy5lbmFibGVScGNMb2cpIHtcclxuICAgICAgbG9nZ2VyLndhcm4oXHJcbiAgICAgICAgXCJlbmFibGVScGNMb2cgaXMgZGVwcmVjYXRlZCBpbiAwLjguMCwgcGxlYXNlIHVzZSBhcHAucnBjRmlsdGVyKHBvbWVsby5ycGNGaWx0ZXJzLnJwY0xvZygpKVwiXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBsZXQgcnBjQmVmb3JlcyA9IHRoaXMuYXBwLmdldChLRVlXT1JEUy5SUENfQkVGT1JFX0ZJTFRFUik7XHJcbiAgICBsZXQgcnBjQWZ0ZXJzID0gdGhpcy5hcHAuZ2V0KEtFWVdPUkRTLlJQQ19BRlRFUl9GSUxURVIpO1xyXG4gICAgbGV0IHJwY0Vycm9ySGFuZGxlciA9IHRoaXMuYXBwLmdldChSRVNFUlZFRC5SUENfRVJST1JfSEFORExFUik7XHJcblxyXG4gICAgaWYgKCEhcnBjQmVmb3Jlcykge1xyXG4gICAgICB0aGlzLmNsaWVudC5iZWZvcmUocnBjQmVmb3Jlcyk7XHJcbiAgICB9XHJcbiAgICBpZiAoISFycGNBZnRlcnMpIHtcclxuICAgICAgdGhpcy5jbGllbnQuYWZ0ZXIocnBjQWZ0ZXJzKTtcclxuICAgIH1cclxuICAgIGlmICghIXJwY0Vycm9ySGFuZGxlcikge1xyXG4gICAgICB0aGlzLmNsaWVudC5zZXRFcnJvckhhbmRsZXIocnBjRXJyb3JIYW5kbGVyKTtcclxuICAgIH1cclxuICAgIHByb2Nlc3MubmV4dFRpY2soY2IpO1xyXG4gIH1cclxuXHJcbiAgYWZ0ZXJTdGFydChjYjogRnVuY3Rpb24pIHtcclxuICAgIGxldCBzZWxmID0gdGhpcztcclxuICAgICg8YW55PnRoaXMuYXBwKS5fX2RlZmluZUdldHRlcl9fKFwicnBjXCIsICgpID0+IHtcclxuICAgICAgcmV0dXJuIHNlbGYuY2xpZW50LnByb3hpZXMudXNlcjtcclxuICAgIH0pO1xyXG4gICAgKDxhbnk+dGhpcy5hcHApLl9fZGVmaW5lR2V0dGVyX18oXCJzeXNycGNcIiwgKCkgPT4ge1xyXG4gICAgICByZXR1cm4gc2VsZi5jbGllbnQucHJveGllcy5zeXM7XHJcbiAgICB9KTtcclxuICAgIHRoaXMuYXBwLnNldChcInJwY0ludm9rZVwiLCB0aGlzLmNsaWVudC5ycGNJbnZva2UuYmluZCh0aGlzLmNsaWVudCkpO1xyXG4gICAgdGhpcy5jbGllbnQuc3RhcnQoY2IpO1xyXG4gIH1cclxuXHJcbiAgYWRkU2VydmVycyhzZXJ2ZXJzOiBTZXJ2ZXJJbmZvW10pIHtcclxuICAgIGlmICghc2VydmVycyB8fCAhc2VydmVycy5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGdlblByb3hpZXModGhpcy5jbGllbnQsIHRoaXMuYXBwLCBzZXJ2ZXJzKTtcclxuICAgIHRoaXMuY2xpZW50LmFkZFNlcnZlcnMoc2VydmVycyk7XHJcbiAgfVxyXG5cclxuICByZW1vdmVTZXJ2ZXJzKGlkczogc3RyaW5nW10pIHtcclxuICAgIHRoaXMuY2xpZW50LnJlbW92ZVNlcnZlcnMoaWRzKTtcclxuICB9XHJcblxyXG4gIHJlcGxhY2VTZXJ2ZXJzKHNlcnZlcnM6IFNlcnZlckluZm9bXSkge1xyXG4gICAgaWYgKCFzZXJ2ZXJzIHx8ICFzZXJ2ZXJzLmxlbmd0aCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gdXBkYXRlIHByb3hpZXNcclxuICAgIHRoaXMuY2xpZW50LnByb3hpZXMgPSB7fTtcclxuICAgIGdlblByb3hpZXModGhpcy5jbGllbnQsIHRoaXMuYXBwLCBzZXJ2ZXJzKTtcclxuXHJcbiAgICB0aGlzLmNsaWVudC5yZXBsYWNlU2VydmVycyhzZXJ2ZXJzKTtcclxuICB9XHJcblxyXG4gIHJwY0ludm9rZShzZXJ2ZXJJZDogc3RyaW5nLCBtc2c6IGFueSwgY2I6IEZ1bmN0aW9uKSB7XHJcbiAgICB0aGlzLmNsaWVudC5ycGNJbnZva2Uoc2VydmVySWQsIG1zZywgY2IpO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2VuUnBjQ2xpZW50KGFwcDogQXBwbGljYXRpb24sIG9wdHM6IGFueSkge1xyXG4gIG9wdHMuY29udGV4dCA9IGFwcDtcclxuICBvcHRzLnJvdXRlQ29udGV4dCA9IGFwcDtcclxuICBpZiAoISFvcHRzLnJwY0NsaWVudCkge1xyXG4gICAgcmV0dXJuIG9wdHMucnBjQ2xpZW50LmNyZWF0ZShvcHRzKTtcclxuICB9IGVsc2Uge1xyXG4gICAgcmV0dXJuIENsaWVudC5jcmVhdGUob3B0cyk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZW5Qcm94aWVzKGNsaWVudDogYW55LCBhcHA6IEFwcGxpY2F0aW9uLCBzaW5mb3M6IFNlcnZlckluZm9bXSkge1xyXG4gIGxldCBpdGVtO1xyXG4gIGZvciAobGV0IGkgPSAwLCBsID0gc2luZm9zLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgaXRlbSA9IHNpbmZvc1tpXTtcclxuICAgIGlmIChoYXNQcm94eShjbGllbnQsIGl0ZW0pKSB7XHJcbiAgICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG4gICAgY2xpZW50LmFkZFByb3hpZXMoZ2V0UHJveHlSZWNvcmRzKGFwcCwgaXRlbSkpO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFzUHJveHkoY2xpZW50OiBhbnksIHNpbmZvOiBTZXJ2ZXJJbmZvKSB7XHJcbiAgbGV0IHByb3h5ID0gY2xpZW50LnByb3hpZXM7XHJcbiAgcmV0dXJuICEhcHJveHkuc3lzICYmICEhcHJveHkuc3lzW3NpbmZvLnNlcnZlclR5cGVdO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQcm94eVJlY29yZHMoYXBwOiBBcHBsaWNhdGlvbiwgc2luZm86IFNlcnZlckluZm8pIHtcclxuICBsZXQgcmVjb3JkcyA9IFtdLFxyXG4gICAgYXBwQmFzZSA9IGFwcC5iYXNlLFxyXG4gICAgcmVjb3JkO1xyXG4gIC8vIHN5cyByZW1vdGUgc2VydmljZSBwYXRoIHJlY29yZFxyXG4gIGlmIChhcHAuaXNGcm9udGVuZChzaW5mbykpIHtcclxuICAgIHJlY29yZCA9IHBhdGhVdGlsLmdldFN5c1JlbW90ZVBhdGgoXCJmcm9udGVuZFwiKTtcclxuICB9IGVsc2Uge1xyXG4gICAgcmVjb3JkID0gcGF0aFV0aWwuZ2V0U3lzUmVtb3RlUGF0aChcImJhY2tlbmRcIik7XHJcbiAgfVxyXG4gIGlmIChyZWNvcmQpIHtcclxuICAgIHJlY29yZHMucHVzaChwYXRoVXRpbC5yZW1vdGVQYXRoUmVjb3JkKFwic3lzXCIsIHNpbmZvLnNlcnZlclR5cGUsIHJlY29yZCkpO1xyXG4gIH1cclxuXHJcbiAgLy8gdXNlciByZW1vdGUgc2VydmljZSBwYXRoIHJlY29yZFxyXG4gIHJlY29yZCA9IHBhdGhVdGlsLmdldFVzZXJSZW1vdGVQYXRoKGFwcEJhc2UsIHNpbmZvLnNlcnZlclR5cGUpO1xyXG4gIGlmIChyZWNvcmQpIHtcclxuICAgIHJlY29yZHMucHVzaChwYXRoVXRpbC5yZW1vdGVQYXRoUmVjb3JkKFwidXNlclwiLCBzaW5mby5zZXJ2ZXJUeXBlLCByZWNvcmQpKTtcclxuICB9XHJcblxyXG4gIHJldHVybiByZWNvcmRzO1xyXG59XHJcbiJdfQ==