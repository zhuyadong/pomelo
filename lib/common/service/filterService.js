"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
class FilterService {
    constructor() {
        this.name = "filter";
        this._befores = [];
        this._afters = [];
    }
    before(filter) {
        this._befores.push(filter);
    }
    after(filter) {
        this._afters.unshift(filter);
    }
    beforeFilter(msg, session, cb) {
        let index = 0;
        let next = (err, resp, opts) => {
            if (err || index >= this._befores.length) {
                cb(err, resp, opts);
                return;
            }
            let handler = this._befores[index++];
            if (typeof handler === "function") {
                handler(msg, session, next);
            }
            else if (typeof handler.before === "function") {
                handler.before(msg, session, next);
            }
            else {
                logger.error("meet invalid before filter, handler or handler.before should be function.");
                next(new Error("invalid before filter."));
            }
        }; //end of next
        next();
    }
    afterFilter(err, msg, session, resp, cb) {
        let index = 0;
        let next = (err) => {
            //if done
            if (index >= this._afters.length) {
                cb(err);
                return;
            }
            let handler = this._afters[index++];
            if (typeof handler === "function") {
                handler(err, msg, session, resp, next);
            }
            else if (typeof handler.after === "function") {
                handler.after(err, msg, session, resp, next);
            }
            else {
                logger.error("meet invalid after filter, handler or handler.after should be function.");
                next(new Error("invalid after filter."));
            }
        }; //end of next
        next(err);
    }
}
exports.FilterService = FilterService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZpbHRlclNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFJQSxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUt4RTtJQUlFO1FBQ0UsSUFBSSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFvQjtRQUN6QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQW1CO1FBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxZQUFZLENBQUMsR0FBUSxFQUFFLE9BQXVDLEVBQUUsRUFBWTtRQUMxRSxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxJQUFJLElBQUksR0FBRyxDQUFDLEdBQVMsRUFBRSxJQUFVLEVBQUUsSUFBVSxFQUFFLEVBQUU7WUFDL0MsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLEtBQUssSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ3pDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNwQixNQUFNLENBQUM7WUFDVCxDQUFDO1lBRUQsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ3JDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sT0FBTyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzlCLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxPQUFPLENBQUMsTUFBTSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hELE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNyQyxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sTUFBTSxDQUFDLEtBQUssQ0FDViwyRUFBMkUsQ0FDNUUsQ0FBQztnQkFDRixJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFDO1lBQzVDLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQyxhQUFhO1FBRWhCLElBQUksRUFBRSxDQUFDO0lBQ1QsQ0FBQztJQUVELFdBQVcsQ0FBQyxHQUFRLEVBQUUsR0FBUSxFQUFFLE9BQXVDLEVBQUUsSUFBUyxFQUFFLEVBQVk7UUFDOUYsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsSUFBSSxJQUFJLEdBQUcsQ0FBQyxHQUFRLEVBQUUsRUFBRTtZQUN0QixTQUFTO1lBQ1QsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDakMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNSLE1BQU0sQ0FBQztZQUNULENBQUM7WUFFRCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDcEMsRUFBRSxDQUFDLENBQUMsT0FBTyxPQUFPLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDbEMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN6QyxDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sT0FBTyxDQUFDLEtBQUssS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUMvQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMvQyxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sTUFBTSxDQUFDLEtBQUssQ0FDVix5RUFBeUUsQ0FDMUUsQ0FBQztnQkFDRixJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxDQUFDO1lBQzNDLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQyxhQUFhO1FBRWhCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNaLENBQUM7Q0FDRjtBQWxFRCxzQ0FrRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTZXNzaW9uLCBGcm9udGVuZFNlc3Npb24gfSBmcm9tIFwiLi9zZXNzaW9uU2VydmljZVwiO1xuaW1wb3J0IHsgRmlsdGVyLCBCZWZvcmVGaWx0ZXJGdW5jLCBBZnRlckZpbHRlckZ1bmMgfSBmcm9tIFwiLi4vLi4vYXBwbGljYXRpb25cIjtcbmltcG9ydCB7IEJhY2tlbmRTZXNzaW9uIH0gZnJvbSAnLi9iYWNrZW5kU2Vzc2lvblNlcnZpY2UnO1xuXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKFwicG9tZWxvLWxvZ2dlclwiKS5nZXRMb2dnZXIoXCJwb21lbG9cIiwgX19maWxlbmFtZSk7XG5cbmV4cG9ydCB0eXBlIEJlZm9yZUhhbmxlciA9IEZpbHRlciB8IEJlZm9yZUZpbHRlckZ1bmM7XG5leHBvcnQgdHlwZSBBZnRlckhhbmxlciA9IEZpbHRlciB8IEFmdGVyRmlsdGVyRnVuYztcblxuZXhwb3J0IGNsYXNzIEZpbHRlclNlcnZpY2Uge1xuICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gIHByaXZhdGUgX2JlZm9yZXM6IEJlZm9yZUhhbmxlcltdO1xuICBwcml2YXRlIF9hZnRlcnM6IEFmdGVySGFubGVyW107XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMubmFtZSA9IFwiZmlsdGVyXCI7XG4gICAgdGhpcy5fYmVmb3JlcyA9IFtdO1xuICAgIHRoaXMuX2FmdGVycyA9IFtdO1xuICB9XG5cbiAgYmVmb3JlKGZpbHRlcjogQmVmb3JlSGFubGVyKSB7XG4gICAgdGhpcy5fYmVmb3Jlcy5wdXNoKGZpbHRlcik7XG4gIH1cblxuICBhZnRlcihmaWx0ZXI6IEFmdGVySGFubGVyKSB7XG4gICAgdGhpcy5fYWZ0ZXJzLnVuc2hpZnQoZmlsdGVyKTtcbiAgfVxuXG4gIGJlZm9yZUZpbHRlcihtc2c6IGFueSwgc2Vzc2lvbjogRnJvbnRlbmRTZXNzaW9ufEJhY2tlbmRTZXNzaW9uLCBjYjogRnVuY3Rpb24pIHtcbiAgICBsZXQgaW5kZXggPSAwO1xuICAgIGxldCBuZXh0ID0gKGVycj86IGFueSwgcmVzcD86IGFueSwgb3B0cz86IGFueSkgPT4ge1xuICAgICAgaWYgKGVyciB8fCBpbmRleCA+PSB0aGlzLl9iZWZvcmVzLmxlbmd0aCkge1xuICAgICAgICBjYihlcnIsIHJlc3AsIG9wdHMpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxldCBoYW5kbGVyID0gdGhpcy5fYmVmb3Jlc1tpbmRleCsrXTtcbiAgICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGhhbmRsZXIobXNnLCBzZXNzaW9uLCBuZXh0KTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGhhbmRsZXIuYmVmb3JlID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgaGFuZGxlci5iZWZvcmUobXNnLCBzZXNzaW9uLCBuZXh0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgICBcIm1lZXQgaW52YWxpZCBiZWZvcmUgZmlsdGVyLCBoYW5kbGVyIG9yIGhhbmRsZXIuYmVmb3JlIHNob3VsZCBiZSBmdW5jdGlvbi5cIlxuICAgICAgICApO1xuICAgICAgICBuZXh0KG5ldyBFcnJvcihcImludmFsaWQgYmVmb3JlIGZpbHRlci5cIikpO1xuICAgICAgfVxuICAgIH07IC8vZW5kIG9mIG5leHRcblxuICAgIG5leHQoKTtcbiAgfVxuXG4gIGFmdGVyRmlsdGVyKGVycjogYW55LCBtc2c6IGFueSwgc2Vzc2lvbjogRnJvbnRlbmRTZXNzaW9ufEJhY2tlbmRTZXNzaW9uLCByZXNwOiBhbnksIGNiOiBGdW5jdGlvbikge1xuICAgIGxldCBpbmRleCA9IDA7XG4gICAgbGV0IG5leHQgPSAoZXJyOiBhbnkpID0+IHtcbiAgICAgIC8vaWYgZG9uZVxuICAgICAgaWYgKGluZGV4ID49IHRoaXMuX2FmdGVycy5sZW5ndGgpIHtcbiAgICAgICAgY2IoZXJyKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBsZXQgaGFuZGxlciA9IHRoaXMuX2FmdGVyc1tpbmRleCsrXTtcbiAgICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGhhbmRsZXIoZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIG5leHQpO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaGFuZGxlci5hZnRlciA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGhhbmRsZXIuYWZ0ZXIoZXJyLCBtc2csIHNlc3Npb24sIHJlc3AsIG5leHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAgIFwibWVldCBpbnZhbGlkIGFmdGVyIGZpbHRlciwgaGFuZGxlciBvciBoYW5kbGVyLmFmdGVyIHNob3VsZCBiZSBmdW5jdGlvbi5cIlxuICAgICAgICApO1xuICAgICAgICBuZXh0KG5ldyBFcnJvcihcImludmFsaWQgYWZ0ZXIgZmlsdGVyLlwiKSk7XG4gICAgICB9XG4gICAgfTsgLy9lbmQgb2YgbmV4dFxuXG4gICAgbmV4dChlcnIpO1xuICB9XG59XG4iXX0=