"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const __1 = require("../..");
const utils_1 = require("../../util/utils");
const countDownLatch_1 = require("../../util/countDownLatch");
const logger = require("pomelo-logger").getLogger("pomelo", __filename);
var State;
(function (State) {
    State[State["ST_INITED"] = 0] = "ST_INITED";
    State[State["ST_DESTROYED"] = 1] = "ST_DESTROYED";
})(State || (State = {}));
class ChannelService {
    constructor(app, opts) {
        this.app = app;
        opts = opts || {};
        this._channels = {};
        this.name = '__channel__';
        this.prefix = opts.prefix;
        this.store = opts.store;
        this.broadcastFilter = opts.broadcastFilter;
        this.channelRemote = new __1.ChannelRemote(app);
    }
    get channels() {
        return this._channels;
    }
    start(cb) {
        restoreChannel(this, cb);
    }
    createChannel(name) {
        if (this._channels[name]) {
            return this._channels[name];
        }
        let c = new Channel(name, this);
        addToStore(this, genKey(this), genKey(this, name));
        this._channels[name] = c;
        return c;
    }
    getChannel(name, create) {
        let channel = this.channels[name];
        if (!channel && !!create) {
            channel = this.channels[name] = new Channel(name, this);
            addToStore(this, genKey(this), genKey(this, name));
        }
        return channel;
    }
    destroyChannel(name) {
        delete this.channels[name];
        removeFromStore(this, genKey(this), genKey(this, name));
        removeAllFromStore(this, genKey(this, name));
    }
    //TODO: 5?
    pushMessageByUids(route, msg, uids, opts, cb) {
        if (typeof route !== "string") {
            cb = opts;
            opts = uids;
            uids = msg;
            msg = route;
            route = msg.route;
        }
        if (!cb && typeof opts === "function") {
            cb = opts;
            opts = {};
        }
        if (!uids || uids.length === 0) {
            utils_1.invokeCallback(cb, new Error("uids should not be empty"));
            return;
        }
        let groups = {}, record;
        for (let i = 0, l = uids.length; i < l; i++) {
            record = uids[i];
            add(record.uid, record.sid, groups);
        }
        sendMessageByGroup(this, route, msg, groups, opts, cb);
    }
    broadcast(stype, route, msg, opts, cb) {
        let app = this.app;
        let namespace = "sys";
        let service = "channelRemote";
        let method = "broadcast";
        let servers = app.getServersByType(stype);
        if (!servers || servers.length === 0) {
            // server list is empty
            utils_1.invokeCallback(cb);
            return;
        }
        let count = servers.length;
        let successFlag = false;
        let latch = countDownLatch_1.createCountDownLatch(count, {}, () => {
            if (!successFlag) {
                utils_1.invokeCallback(cb, new Error("broadcast fails"));
                return;
            }
            utils_1.invokeCallback(cb, null);
        });
        let genCB = (serverId) => {
            return (err) => {
                if (err) {
                    logger.error("[broadcast] fail to push message to serverId: " +
                        serverId +
                        ", err:" +
                        err.stack);
                    latch.done();
                    return;
                }
                successFlag = true;
                latch.done();
            };
        };
        let self = this;
        let sendMessage = (serverId) => {
            return (() => {
                if (serverId === app.serverId) {
                    self.channelRemote[method](route, msg, opts, genCB());
                }
                else {
                    app.rpcInvoke(serverId, {
                        namespace: namespace,
                        service: service,
                        method: method,
                        args: [route, msg, opts]
                    }, genCB(serverId));
                }
            })();
        };
        opts = { type: "broadcast", userOptions: opts || {} };
        // for compatiblity
        opts.isBroadcast = true;
        if (opts.userOptions) {
            opts.binded = opts.userOptions.binded;
            opts.filterParam = opts.userOptions.filterParam;
        }
        for (let i = 0, l = count; i < l; i++) {
            sendMessage(servers[i].id);
        }
    }
}
exports.ChannelService = ChannelService;
class Channel {
    constructor(name, _channelService) {
        this.name = name;
        this._channelService = _channelService;
        this._groups = {};
        this._records = {};
        this._state = State.ST_INITED;
        this._userAmount = 0;
    }
    get userAmount() {
        return this._userAmount;
    }
    get groups() {
        return this._groups;
    }
    get records() {
        return this._records;
    }
    get channelService() {
        return this._channelService;
    }
    add(uid, sid) {
        if (this._state > State.ST_INITED) {
            return false;
        }
        else {
            let res = add(uid, sid, this._groups);
            if (res) {
                this._records[uid] = { sid: sid, uid: uid };
                ++this._userAmount;
            }
            addToStore(this._channelService, genKey(this._channelService, this.name), genValue(sid, uid));
            return res;
        }
    }
    leave(uid, sid) {
        if (!uid || !sid) {
            return false;
        }
        let res = deleteFrom(uid, sid, this.groups[sid]);
        if (res) {
            delete this._records[uid];
            --this._userAmount;
        }
        if (this.userAmount < 0)
            this._userAmount = 0; //robust
        removeFromStore(this._channelService, genKey(this._channelService, this.name), genValue(sid, uid));
        if (this.groups[sid] && this.groups[sid].length === 0) {
            delete this._groups[sid];
        }
        return res;
    }
    getMembers() {
        let res = [], groups = this.groups;
        let group, i, l;
        for (let sid in groups) {
            group = groups[sid];
            for (i = 0, l = group.length; i < l; i++) {
                res.push(group[i]);
            }
        }
        return res;
    }
    getMember(uid) {
        return this._records[uid];
    }
    destroy() {
        this._state = State.ST_DESTROYED;
        this._channelService.destroyChannel(this.name);
    }
    //TODO:4?
    pushMessage(route, msg, opts, cb) {
        if (this._state !== State.ST_INITED) {
            utils_1.invokeCallback(cb, new Error('channel is not running now'));
            return;
        }
        if (typeof route !== 'string') {
            cb = opts;
            opts = msg;
            msg = route;
            route = msg.route;
        }
        if (!cb && typeof opts === 'function') {
            cb = opts;
            opts = {};
        }
        sendMessageByGroup(this._channelService, route, msg, this.groups, opts, cb);
    }
}
exports.Channel = Channel;
function add(uid, sid, groups) {
    if (!sid) {
        logger.warn("ignore uid %j for sid not specified.", uid);
        return false;
    }
    let group = groups[sid];
    if (!group) {
        group = [];
        groups[sid] = group;
    }
    group.push(uid);
    return true;
}
function deleteFrom(uid, sid, group) {
    if (!uid || !sid || !group) {
        return false;
    }
    for (let i = 0, l = group.length; i < l; i++) {
        if (group[i] === uid) {
            group.splice(i, 1);
            return true;
        }
    }
    return false;
}
function sendMessageByGroup(channelService, route, msg, groups, opts, cb) {
    let app = channelService.app;
    let namespace = "sys";
    let service = "channelRemote";
    let method = "pushMessage";
    let count = utils_1.size(groups);
    let successFlag = false;
    let failIds = [];
    logger.debug("[%s] channelService sendMessageByGroup route: %s, msg: %j, groups: %j, opts: %j", app.serverId, route, msg, groups, opts);
    if (count === 0) {
        // group is empty
        utils_1.invokeCallback(cb);
        return;
    }
    let latch = countDownLatch_1.createCountDownLatch(count, {}, () => {
        if (!successFlag) {
            utils_1.invokeCallback(cb, new Error("all uids push message fail"));
            return;
        }
        utils_1.invokeCallback(cb, null, failIds);
    });
    let rpcCB = (serverId) => {
        return (err, fails) => {
            if (err) {
                logger.error("[pushMessage] fail to dispatch msg to serverId: " +
                    serverId +
                    ", err:" +
                    err.stack);
                latch.done();
                return;
            }
            if (fails) {
                failIds = failIds.concat(fails);
            }
            successFlag = true;
            latch.done();
        };
    };
    opts = { type: "push", userOptions: opts || {} };
    // for compatiblity
    opts.isPush = true;
    let sendMessage = (sid) => {
        return (() => {
            if (sid === app.serverId) {
                channelService.channelRemote[method](route, msg, groups[sid], opts, rpcCB(sid));
            }
            else {
                app.rpcInvoke(sid, {
                    namespace: namespace,
                    service: service,
                    method: method,
                    args: [route, msg, groups[sid], opts]
                }, rpcCB(sid));
            }
        })();
    };
    let group;
    for (let sid in groups) {
        group = groups[sid];
        if (group && group.length > 0) {
            sendMessage(sid);
        }
        else {
            // empty group
            process.nextTick(rpcCB(sid));
        }
    }
}
function restoreChannel(self, cb) {
    if (!self.store) {
        utils_1.invokeCallback(cb);
        return;
    }
    else {
        loadAllFromStore(self, genKey(self), (err, list) => {
            if (!!err) {
                utils_1.invokeCallback(cb, err);
                return;
            }
            else {
                if (!list.length || !Array.isArray(list)) {
                    utils_1.invokeCallback(cb);
                    return;
                }
                let load = (key) => {
                    return (() => {
                        loadAllFromStore(self, key, (err, items) => {
                            for (let j = 0; j < items.length; j++) {
                                let array = items[j].split(":");
                                let sid = array[0];
                                let uid = array[1];
                                let channel = self.channels[name];
                                let res = add(uid, sid, channel.groups);
                                if (res) {
                                    channel.records[uid] = { sid: sid, uid: uid };
                                }
                            }
                        });
                    })();
                };
                for (let i = 0; i < list.length; i++) {
                    let name = list[i].slice(genKey(self).length + 1);
                    self.channels[name] = new Channel(name, self);
                    load(list[i]);
                }
                utils_1.invokeCallback(cb);
            }
        });
    }
}
function addToStore(self, key, value) {
    if (!!self.store) {
        self.store.add(key, value, (err) => {
            if (!!err) {
                logger.error("add key: %s value: %s to store, with err: %j", key, value, err.stack);
            }
        });
    }
}
function removeFromStore(self, key, value) {
    if (!!self.store) {
        self.store.remove(key, value, (err) => {
            if (!!err) {
                logger.error("remove key: %s value: %s from store, with err: %j", key, value, err.stack);
            }
        });
    }
}
function loadAllFromStore(self, key, cb) {
    if (!!self.store) {
        self.store.load(key, (err, list) => {
            if (!!err) {
                logger.error("load key: %s from store, with err: %j", key, err.stack);
                utils_1.invokeCallback(cb, err);
            }
            else {
                utils_1.invokeCallback(cb, null, list);
            }
        });
    }
}
function removeAllFromStore(self, key) {
    if (!!self.store) {
        self.store.removeAll(key, (err) => {
            if (!!err) {
                logger.error("remove key: %s all members from store, with err: %j", key, err.stack);
            }
        });
    }
}
function genKey(self, name) {
    if (!!name) {
        return self.prefix + ":" + self.app.serverId + ":" + name;
    }
    else {
        return self.prefix + ":" + self.app.serverId;
    }
}
function genValue(sid, uid) {
    return sid + ":" + uid;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbm5lbFNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjaGFubmVsU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUFpRDtBQUVqRCw0Q0FBd0Q7QUFDeEQsOERBQWlFO0FBR2pFLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRXhFLElBQUssS0FHSjtBQUhELFdBQUssS0FBSztJQUNSLDJDQUFhLENBQUE7SUFDYixpREFBZ0IsQ0FBQTtBQUNsQixDQUFDLEVBSEksS0FBSyxLQUFMLEtBQUssUUFHVDtBQXVCRDtJQVVFLFlBQTRCLEdBQWdCLEVBQUUsSUFBd0I7UUFBMUMsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUMxQyxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsSUFBSSxHQUFHLGFBQWEsQ0FBQztRQUMxQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDMUIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUM1QyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksaUJBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBWEQsSUFBSSxRQUFRO1FBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQztJQVdELEtBQUssQ0FBQyxFQUFhO1FBQ2pCLGNBQWMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELGFBQWEsQ0FBQyxJQUFZO1FBQ3hCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMs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QXFELEVBQ3JELEdBQUcsRUFDSCxHQUFHLENBQUMsS0FBSyxDQUNWLENBQUM7WUFDSixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBQ0gsQ0FBQztBQUVELGdCQUFnQixJQUFvQixFQUFFLElBQWE7SUFDakQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDWCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQztJQUM1RCxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7SUFDL0MsQ0FBQztBQUNILENBQUM7QUFFRCxrQkFBa0IsR0FBVyxFQUFFLEdBQVc7SUFDeEMsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDO0FBQ3pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb25zdGFudHMgfSBmcm9tIFwib3NcIjtcclxuaW1wb3J0IHsgQ29tcG9uZW50LCBDaGFubmVsUmVtb3RlIH0gZnJvbSBcIi4uLy4uXCI7XHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uIH0gZnJvbSBcIi4uLy4uL2FwcGxpY2F0aW9uXCI7XHJcbmltcG9ydCB7IGludm9rZUNhbGxiYWNrLCBzaXplIH0gZnJvbSBcIi4uLy4uL3V0aWwvdXRpbHNcIjtcclxuaW1wb3J0IHsgY3JlYXRlQ291bnREb3duTGF0Y2ggfSBmcm9tIFwiLi4vLi4vdXRpbC9jb3VudERvd25MYXRjaFwiO1xyXG5pbXBvcnQgeyBTZXNzaW9uIH0gZnJvbSBcIi4vc2Vzc2lvblNlcnZpY2VcIjtcclxuXHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoXCJwb21lbG8tbG9nZ2VyXCIpLmdldExvZ2dlcihcInBvbWVsb1wiLCBfX2ZpbGVuYW1lKTtcclxuXHJcbmVudW0gU3RhdGUge1xyXG4gIFNUX0lOSVRFRCA9IDAsXHJcbiAgU1RfREVTVFJPWUVEID0gMVxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBCcm9hZGNhc3RGaWx0ZXIgPSAoXHJcbiAgc2Vzc2lvbjogU2Vzc2lvbixcclxuICBtc2c6IGFueSxcclxuICBvcHRzOiB7IGZpbHRlclBhcmFtOiBhbnkgfVxyXG4pID0+IGJvb2xlYW47XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIENoYW5uZWxTZXJ2aWNlT3B0cyB7XHJcbiAgcHJlZml4OiBzdHJpbmc7XHJcbiAgc3RvcmU6IENoYW5uZWxTdG9yZTtcclxuICBicm9hZGNhc3RGaWx0ZXI6IEJyb2FkY2FzdEZpbHRlcjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDaGFubmVsU3RvcmUge1xyXG4gIGFkZChrZXk6IHN0cmluZywgdmFsdWU6IGFueSwgY2I/OiBGdW5jdGlvbik6IHZvaWQ7XHJcbiAgcmVtb3ZlKGtleTogc3RyaW5nLCB2YWx1ZTogYW55LCBjYj86IEZ1bmN0aW9uKTogdm9pZDtcclxuICBsb2FkKGtleTogc3RyaW5nLCBjYj86IEZ1bmN0aW9uKTogdm9pZDtcclxuICByZW1vdmVBbGwoa2V5OiBzdHJpbmcsIGNiPzogRnVuY3Rpb24pOiB2b2lkO1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBDaGFubmVsTWFwID0geyBbaWR4OiBzdHJpbmddOiBDaGFubmVsIH07XHJcblxyXG5leHBvcnQgY2xhc3MgQ2hhbm5lbFNlcnZpY2UgaW1wbGVtZW50cyBDb21wb25lbnQge1xyXG4gIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcclxuICByZWFkb25seSBwcmVmaXg6IHN0cmluZztcclxuICByZWFkb25seSBzdG9yZTogQ2hhbm5lbFN0b3JlO1xyXG4gIHJlYWRvbmx5IGNoYW5uZWxSZW1vdGU6IENoYW5uZWxSZW1vdGU7XHJcbiAgcmVhZG9ubHkgYnJvYWRjYXN0RmlsdGVyOiBCcm9hZGNhc3RGaWx0ZXI7XHJcbiAgcHJpdmF0ZSBfY2hhbm5lbHM6IENoYW5uZWxNYXA7XHJcbiAgZ2V0IGNoYW5uZWxzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2NoYW5uZWxzO1xyXG4gIH1cclxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgYXBwOiBBcHBsaWNhdGlvbiwgb3B0czogQ2hhbm5lbFNlcnZpY2VPcHRzKSB7XHJcbiAgICBvcHRzID0gb3B0cyB8fCB7fTtcclxuICAgIHRoaXMuX2NoYW5uZWxzID0ge307XHJcbiAgICB0aGlzLm5hbWUgPSAnX19jaGFubmVsX18nO1xyXG4gICAgdGhpcy5wcmVmaXggPSBvcHRzLnByZWZpeDtcclxuICAgIHRoaXMuc3RvcmUgPSBvcHRzLnN0b3JlO1xyXG4gICAgdGhpcy5icm9hZGNhc3RGaWx0ZXIgPSBvcHRzLmJyb2FkY2FzdEZpbHRlcjtcclxuICAgIHRoaXMuY2hhbm5lbFJlbW90ZSA9IG5ldyBDaGFubmVsUmVtb3RlKGFwcCk7XHJcbiAgfVxyXG5cclxuICBzdGFydChjYj86IEZ1bmN0aW9uKSB7XHJcbiAgICByZXN0b3JlQ2hhbm5lbCh0aGlzLCBjYik7XHJcbiAgfVxyXG5cclxuICBjcmVhdGVDaGFubmVsKG5hbWU6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMuX2NoYW5uZWxzW25hbWVdKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLl9jaGFubmVsc1tuYW1lXTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgYyA9IG5ldyBDaGFubmVsKG5hbWUsIHRoaXMpO1xyXG4gICAgYWRkVG9TdG9yZSh0aGlzLCBnZW5LZXkodGhpcyksIGdlbktleSh0aGlzLCBuYW1lKSk7XHJcbiAgICB0aGlzLl9jaGFubmVsc1tuYW1lXSA9IGM7XHJcbiAgICByZXR1cm4gYztcclxuICB9XHJcblxyXG4gIGdldENoYW5uZWwobmFtZTogc3RyaW5nLCBjcmVhdGU/OiBib29sZWFuKSB7XHJcbiAgICBsZXQgY2hhbm5lbCA9IHRoaXMuY2hhbm5lbHNbbmFtZV07XHJcbiAgICBpZiAoIWNoYW5uZWwgJiYgISFjcmVhdGUpIHtcclxuICAgICAgY2hhbm5lbCA9IHRoaXMuY2hhbm5lbHNbbmFtZV0gPSBuZXcgQ2hhbm5lbChuYW1lLCB0aGlzKTtcclxuICAgICAgYWRkVG9TdG9yZSh0aGlzLCBnZW5LZXkodGhpcyksIGdlbktleSh0aGlzLCBuYW1lKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY2hhbm5lbDtcclxuICB9XHJcblxyXG4gIGRlc3Ryb3lDaGFubmVsKG5hbWU6IHN0cmluZykge1xyXG4gICAgZGVsZXRlIHRoaXMuY2hhbm5lbHNbbmFtZV07XHJcbiAgICByZW1vdmVGcm9tU3RvcmUodGhpcywgZ2VuS2V5KHRoaXMpLCBnZW5LZXkodGhpcywgbmFtZSkpO1xyXG4gICAgcmVtb3ZlQWxsRnJvbVN0b3JlKHRoaXMsIGdlbktleSh0aGlzLCBuYW1lKSk7XHJcbiAgfVxyXG5cclxuICAvL1RPRE86IDU/XHJcbiAgcHVzaE1lc3NhZ2VCeVVpZHMoXHJcbiAgICByb3V0ZT86IHN0cmluZyxcclxuICAgIG1zZz86IGFueSxcclxuICAgIHVpZHM/OiBDaGFubmVsTWVtYmVyW10sXHJcbiAgICBvcHRzPzogYW55LFxyXG4gICAgY2I/OiBGdW5jdGlvblxyXG4gICkge1xyXG4gICAgaWYgKHR5cGVvZiByb3V0ZSAhPT0gXCJzdHJpbmdcIikge1xyXG4gICAgICBjYiA9IG9wdHM7XHJcbiAgICAgIG9wdHMgPSB1aWRzO1xyXG4gICAgICB1aWRzID0gbXNnO1xyXG4gICAgICBtc2cgPSByb3V0ZTtcclxuICAgICAgcm91dGUgPSBtc2cucm91dGU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFjYiAmJiB0eXBlb2Ygb3B0cyA9PT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgIGNiID0gb3B0cztcclxuICAgICAgb3B0cyA9IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdWlkcyB8fCB1aWRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICBpbnZva2VDYWxsYmFjayhjYiEsIG5ldyBFcnJvcihcInVpZHMgc2hvdWxkIG5vdCBiZSBlbXB0eVwiKSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBncm91cHMgPSB7fSxcclxuICAgICAgcmVjb3JkO1xyXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSB1aWRzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICByZWNvcmQgPSB1aWRzW2ldO1xyXG4gICAgICBhZGQocmVjb3JkLnVpZCwgcmVjb3JkLnNpZCwgZ3JvdXBzKTtcclxuICAgIH1cclxuXHJcbiAgICBzZW5kTWVzc2FnZUJ5R3JvdXAodGhpcywgcm91dGUhLCBtc2csIGdyb3Vwcywgb3B0cywgY2IpO1xyXG4gIH1cclxuXHJcbiAgYnJvYWRjYXN0KHN0eXBlOiBzdHJpbmcsIHJvdXRlOiBzdHJpbmcsIG1zZzogYW55LCBvcHRzPzogYW55LCBjYj86IEZ1bmN0aW9uKSB7XHJcbiAgICBsZXQgYXBwID0gdGhpcy5hcHA7XHJcbiAgICBsZXQgbmFtZXNwYWNlID0gXCJzeXNcIjtcclxuICAgIGxldCBzZXJ2aWNlID0gXCJjaGFubmVsUmVtb3RlXCI7XHJcbiAgICBsZXQgbWV0aG9kID0gXCJicm9hZGNhc3RcIjtcclxuICAgIGxldCBzZXJ2ZXJzID0gYXBwLmdldFNlcnZlcnNCeVR5cGUoc3R5cGUpO1xyXG5cclxuICAgIGlmICghc2VydmVycyB8fCBzZXJ2ZXJzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAvLyBzZXJ2ZXIgbGlzdCBpcyBlbXB0eVxyXG4gICAgICBpbnZva2VDYWxsYmFjayhjYiEpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGNvdW50ID0gc2VydmVycy5sZW5ndGg7XHJcbiAgICBsZXQgc3VjY2Vzc0ZsYWcgPSBmYWxzZTtcclxuXHJcbiAgICBsZXQgbGF0Y2ggPSBjcmVhdGVDb3VudERvd25MYXRjaChjb3VudCwge30sICgpID0+IHtcclxuICAgICAgaWYgKCFzdWNjZXNzRmxhZykge1xyXG4gICAgICAgIGludm9rZUNhbGxiYWNrKGNiISwgbmV3IEVycm9yKFwiYnJvYWRjYXN0IGZhaWxzXCIpKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgaW52b2tlQ2FsbGJhY2soY2IhLCBudWxsKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGxldCBnZW5DQiA9IChzZXJ2ZXJJZD86IHN0cmluZykgPT4ge1xyXG4gICAgICByZXR1cm4gKGVycjogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgbG9nZ2VyLmVycm9yKFxyXG4gICAgICAgICAgICBcIlticm9hZGNhc3RdIGZhaWwgdG8gcHVzaCBtZXNzYWdlIHRvIHNlcnZlcklkOiBcIiArXHJcbiAgICAgICAgICAgICAgc2VydmVySWQgK1xyXG4gICAgICAgICAgICAgIFwiLCBlcnI6XCIgK1xyXG4gICAgICAgICAgICAgIGVyci5zdGFja1xyXG4gICAgICAgICAgKTtcclxuICAgICAgICAgIGxhdGNoLmRvbmUoKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3VjY2Vzc0ZsYWcgPSB0cnVlO1xyXG4gICAgICAgIGxhdGNoLmRvbmUoKTtcclxuICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgbGV0IHNlbGYgPSB0aGlzO1xyXG4gICAgbGV0IHNlbmRNZXNzYWdlID0gKHNlcnZlcklkOiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuICgoKSA9PiB7XHJcbiAgICAgICAgaWYgKHNlcnZlcklkID09PSBhcHAuc2VydmVySWQpIHtcclxuICAgICAgICAgICg8YW55PnNlbGYpLmNoYW5uZWxSZW1vdGVbbWV0aG9kXShyb3V0ZSwgbXNnLCBvcHRzLCBnZW5DQigpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgYXBwLnJwY0ludm9rZShcclxuICAgICAgICAgICAgc2VydmVySWQsXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZSxcclxuICAgICAgICAgICAgICBzZXJ2aWNlOiBzZXJ2aWNlLFxyXG4gICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLFxyXG4gICAgICAgICAgICAgIGFyZ3M6IFtyb3V0ZSwgbXNnLCBvcHRzXVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBnZW5DQihzZXJ2ZXJJZClcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICBvcHRzID0geyB0eXBlOiBcImJyb2FkY2FzdFwiLCB1c2VyT3B0aW9uczogb3B0cyB8fCB7fSB9O1xyXG5cclxuICAgIC8vIGZvciBjb21wYXRpYmxpdHlcclxuICAgIG9wdHMuaXNCcm9hZGNhc3QgPSB0cnVlO1xyXG4gICAgaWYgKG9wdHMudXNlck9wdGlvbnMpIHtcclxuICAgICAgb3B0cy5iaW5kZWQgPSBvcHRzLnVzZXJPcHRpb25zLmJpbmRlZDtcclxuICAgICAgb3B0cy5maWx0ZXJQYXJhbSA9IG9wdHMudXNlck9wdGlvbnMuZmlsdGVyUGFyYW07XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBjb3VudDsgaSA8IGw7IGkrKykge1xyXG4gICAgICBzZW5kTWVzc2FnZShzZXJ2ZXJzW2ldLmlkKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIENoYW5uZWxHcm91cE1hcCA9IHsgW2lkOiBzdHJpbmddOiBzdHJpbmdbXSB9O1xyXG5leHBvcnQgaW50ZXJmYWNlIENoYW5uZWxNZW1iZXIge1xyXG4gIHNpZDogc3RyaW5nO1xyXG4gIHVpZDogc3RyaW5nO1xyXG59XHJcbmV4cG9ydCB0eXBlIENoYW5uZWxNZW1iZXJNYXAgPSB7IFtpZDogc3RyaW5nXTogQ2hhbm5lbE1lbWJlciB9O1xyXG5cclxuZXhwb3J0IGNsYXNzIENoYW5uZWwge1xyXG4gIHByaXZhdGUgX3N0YXRlOiBTdGF0ZTtcclxuXHJcbiAgcHJpdmF0ZSBfdXNlckFtb3VudDogbnVtYmVyO1xyXG4gIGdldCB1c2VyQW1vdW50KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX3VzZXJBbW91bnQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9ncm91cHM6IENoYW5uZWxHcm91cE1hcDtcclxuICBnZXQgZ3JvdXBzKCk6IFJlYWRvbmx5PENoYW5uZWxHcm91cE1hcD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2dyb3VwcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3JlY29yZHM6IENoYW5uZWxNZW1iZXJNYXA7XHJcbiAgZ2V0IHJlY29yZHMoKTogUmVhZG9ubHk8Q2hhbm5lbE1lbWJlck1hcD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZHM7XHJcbiAgfVxyXG5cclxuICBnZXQgY2hhbm5lbFNlcnZpY2UoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fY2hhbm5lbFNlcnZpY2U7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHB1YmxpYyByZWFkb25seSBuYW1lOiBzdHJpbmcsXHJcbiAgICBwcml2YXRlIF9jaGFubmVsU2VydmljZTogQ2hhbm5lbFNlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMuX2dyb3VwcyA9IHt9O1xyXG4gICAgdGhpcy5fcmVjb3JkcyA9IHt9O1xyXG4gICAgdGhpcy5fc3RhdGUgPSBTdGF0ZS5TVF9JTklURUQ7XHJcbiAgICB0aGlzLl91c2VyQW1vdW50ID0gMDtcclxuICB9XHJcblxyXG4gIGFkZCh1aWQ6IHN0cmluZywgc2lkOiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzLl9zdGF0ZSA+IFN0YXRlLlNUX0lOSVRFRCkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgcmVzID0gYWRkKHVpZCwgc2lkLCB0aGlzLl9ncm91cHMpO1xyXG4gICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgdGhpcy5fcmVjb3Jkc1t1aWRdID0geyBzaWQ6IHNpZCwgdWlkOiB1aWQgfTtcclxuICAgICAgICArK3RoaXMuX3VzZXJBbW91bnQ7XHJcbiAgICAgIH1cclxuICAgICAgYWRkVG9TdG9yZShcclxuICAgICAgICB0aGlzLl9jaGFubmVsU2VydmljZSxcclxuICAgICAgICBnZW5LZXkodGhpcy5fY2hhbm5lbFNlcnZpY2UsIHRoaXMubmFtZSksXHJcbiAgICAgICAgZ2VuVmFsdWUoc2lkLCB1aWQpXHJcbiAgICAgICk7XHJcbiAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBsZWF2ZSh1aWQ6IHN0cmluZywgc2lkOiBzdHJpbmcpIHtcclxuICAgIGlmICghdWlkIHx8ICFzaWQpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgbGV0IHJlcyA9IGRlbGV0ZUZyb20odWlkLCBzaWQsIHRoaXMuZ3JvdXBzW3NpZF0pO1xyXG4gICAgaWYgKHJlcykge1xyXG4gICAgICBkZWxldGUgdGhpcy5fcmVjb3Jkc1t1aWRdO1xyXG4gICAgICAtLXRoaXMuX3VzZXJBbW91bnQ7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy51c2VyQW1vdW50IDwgMCkgdGhpcy5fdXNlckFtb3VudCA9IDA7IC8vcm9idXN0XHJcbiAgICByZW1vdmVGcm9tU3RvcmUoXHJcbiAgICAgIHRoaXMuX2NoYW5uZWxTZXJ2aWNlLFxyXG4gICAgICBnZW5LZXkodGhpcy5fY2hhbm5lbFNlcnZpY2UsIHRoaXMubmFtZSksXHJcbiAgICAgIGdlblZhbHVlKHNpZCwgdWlkKVxyXG4gICAgKTtcclxuICAgIGlmICh0aGlzLmdyb3Vwc1tzaWRdICYmIHRoaXMuZ3JvdXBzW3NpZF0ubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIGRlbGV0ZSB0aGlzLl9ncm91cHNbc2lkXTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXM7XHJcbiAgfVxyXG5cclxuICBnZXRNZW1iZXJzKCkge1xyXG4gICAgbGV0IHJlcyA9IFtdLFxyXG4gICAgICBncm91cHMgPSB0aGlzLmdyb3VwcztcclxuICAgIGxldCBncm91cCwgaSwgbDtcclxuICAgIGZvciAobGV0IHNpZCBpbiBncm91cHMpIHtcclxuICAgICAgZ3JvdXAgPSBncm91cHNbc2lkXTtcclxuICAgICAgZm9yIChpID0gMCwgbCA9IGdyb3VwLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgICAgIHJlcy5wdXNoKGdyb3VwW2ldKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlcztcclxuICB9XHJcblxyXG4gIGdldE1lbWJlcih1aWQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZHNbdWlkXTtcclxuICB9XHJcblxyXG4gIGRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLl9zdGF0ZSA9IFN0YXRlLlNUX0RFU1RST1lFRDtcclxuICAgIHRoaXMuX2NoYW5uZWxTZXJ2aWNlLmRlc3Ryb3lDaGFubmVsKHRoaXMubmFtZSk7XHJcbiAgfVxyXG5cclxuICAvL1RPRE86ND9cclxuICBwdXNoTWVzc2FnZShyb3V0ZT86c3RyaW5nLCBtc2c/OmFueSwgb3B0cz86YW55LCBjYj86RnVuY3Rpb24pIHtcclxuICBpZih0aGlzLl9zdGF0ZSAhPT0gU3RhdGUuU1RfSU5JVEVEKSB7XHJcbiAgICBpbnZva2VDYWxsYmFjayhjYiEsIG5ldyBFcnJvcignY2hhbm5lbCBpcyBub3QgcnVubmluZyBub3cnKSk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBpZih0eXBlb2Ygcm91dGUgIT09ICdzdHJpbmcnKSB7XHJcbiAgICBjYiA9IG9wdHM7XHJcbiAgICBvcHRzID0gbXNnO1xyXG4gICAgbXNnID0gcm91dGU7XHJcbiAgICByb3V0ZSA9IG1zZy5yb3V0ZTtcclxuICB9XHJcblxyXG4gIGlmKCFjYiAmJiB0eXBlb2Ygb3B0cyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgY2IgPSBvcHRzO1xyXG4gICAgb3B0cyA9IHt9O1xyXG4gIH1cclxuXHJcbiAgc2VuZE1lc3NhZ2VCeUdyb3VwKHRoaXMuX2NoYW5uZWxTZXJ2aWNlLCByb3V0ZSEsIG1zZywgdGhpcy5ncm91cHMsIG9wdHMsIGNiKTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFkZCh1aWQ6IHN0cmluZywgc2lkOiBzdHJpbmcsIGdyb3VwczogQ2hhbm5lbEdyb3VwTWFwKSB7XHJcbiAgaWYgKCFzaWQpIHtcclxuICAgIGxvZ2dlci53YXJuKFwiaWdub3JlIHVpZCAlaiBmb3Igc2lkIG5vdCBzcGVjaWZpZWQuXCIsIHVpZCk7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBsZXQgZ3JvdXAgPSBncm91cHNbc2lkXTtcclxuICBpZiAoIWdyb3VwKSB7XHJcbiAgICBncm91cCA9IFtdO1xyXG4gICAgZ3JvdXBzW3NpZF0gPSBncm91cDtcclxuICB9XHJcblxyXG4gIGdyb3VwLnB1c2godWlkKTtcclxuICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gZGVsZXRlRnJvbSh1aWQ6IHN0cmluZywgc2lkOiBzdHJpbmcsIGdyb3VwOiBzdHJpbmdbXSkge1xyXG4gIGlmICghdWlkIHx8ICFzaWQgfHwgIWdyb3VwKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBmb3IgKGxldCBpID0gMCwgbCA9IGdyb3VwLmxlbmd0aDsgaSA8IGw7IGkrKykge1xyXG4gICAgaWYgKGdyb3VwW2ldID09PSB1aWQpIHtcclxuICAgICAgZ3JvdXAuc3BsaWNlKGksIDEpO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2VuZE1lc3NhZ2VCeUdyb3VwKFxyXG4gIGNoYW5uZWxTZXJ2aWNlOiBDaGFubmVsU2VydmljZSxcclxuICByb3V0ZTogc3RyaW5nLFxyXG4gIG1zZzogYW55LFxyXG4gIGdyb3VwczogQ2hhbm5lbEdyb3VwTWFwLFxyXG4gIG9wdHM6IGFueSxcclxuICBjYj86IEZ1bmN0aW9uXHJcbikge1xyXG4gIGxldCBhcHAgPSBjaGFubmVsU2VydmljZS5hcHA7XHJcbiAgbGV0IG5hbWVzcGFjZSA9IFwic3lzXCI7XHJcbiAgbGV0IHNlcnZpY2UgPSBcImNoYW5uZWxSZW1vdGVcIjtcclxuICBsZXQgbWV0aG9kID0gXCJwdXNoTWVzc2FnZVwiO1xyXG4gIGxldCBjb3VudCA9IHNpemUoZ3JvdXBzKTtcclxuICBsZXQgc3VjY2Vzc0ZsYWcgPSBmYWxzZTtcclxuICBsZXQgZmFpbElkczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgbG9nZ2VyLmRlYnVnKFxyXG4gICAgXCJbJXNdIGNoYW5uZWxTZXJ2aWNlIHNlbmRNZXNzYWdlQnlHcm91cCByb3V0ZTogJXMsIG1zZzogJWosIGdyb3VwczogJWosIG9wdHM6ICVqXCIsXHJcbiAgICBhcHAuc2VydmVySWQsXHJcbiAgICByb3V0ZSxcclxuICAgIG1zZyxcclxuICAgIGdyb3VwcyxcclxuICAgIG9wdHNcclxuICApO1xyXG4gIGlmIChjb3VudCA9PT0gMCkge1xyXG4gICAgLy8gZ3JvdXAgaXMgZW1wdHlcclxuICAgIGludm9rZUNhbGxiYWNrKGNiISk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG5cclxuICBsZXQgbGF0Y2ggPSBjcmVhdGVDb3VudERvd25MYXRjaChjb3VudCwge30sICgpID0+IHtcclxuICAgIGlmICghc3VjY2Vzc0ZsYWcpIHtcclxuICAgICAgaW52b2tlQ2FsbGJhY2soY2IhLCBuZXcgRXJyb3IoXCJhbGwgdWlkcyBwdXNoIG1lc3NhZ2UgZmFpbFwiKSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGludm9rZUNhbGxiYWNrKGNiISwgbnVsbCwgZmFpbElkcyk7XHJcbiAgfSk7XHJcblxyXG4gIGxldCBycGNDQiA9IChzZXJ2ZXJJZDogc3RyaW5nKSA9PiB7XHJcbiAgICByZXR1cm4gKGVycjogYW55LCBmYWlsczogYW55KSA9PiB7XHJcbiAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgICBcIltwdXNoTWVzc2FnZV0gZmFpbCB0byBkaXNwYXRjaCBtc2cgdG8gc2VydmVySWQ6IFwiICtcclxuICAgICAgICAgICAgc2VydmVySWQgK1xyXG4gICAgICAgICAgICBcIiwgZXJyOlwiICtcclxuICAgICAgICAgICAgZXJyLnN0YWNrXHJcbiAgICAgICAgKTtcclxuICAgICAgICBsYXRjaC5kb25lKCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChmYWlscykge1xyXG4gICAgICAgIGZhaWxJZHMgPSBmYWlsSWRzLmNvbmNhdChmYWlscyk7XHJcbiAgICAgIH1cclxuICAgICAgc3VjY2Vzc0ZsYWcgPSB0cnVlO1xyXG4gICAgICBsYXRjaC5kb25lKCk7XHJcbiAgICB9O1xyXG4gIH07XHJcblxyXG4gIG9wdHMgPSB7IHR5cGU6IFwicHVzaFwiLCB1c2VyT3B0aW9uczogb3B0cyB8fCB7fSB9O1xyXG4gIC8vIGZvciBjb21wYXRpYmxpdHlcclxuICBvcHRzLmlzUHVzaCA9IHRydWU7XHJcblxyXG4gIGxldCBzZW5kTWVzc2FnZSA9IChzaWQ6IHN0cmluZykgPT4ge1xyXG4gICAgcmV0dXJuICgoKSA9PiB7XHJcbiAgICAgIGlmIChzaWQgPT09IGFwcC5zZXJ2ZXJJZCkge1xyXG4gICAgICAgICg8YW55PmNoYW5uZWxTZXJ2aWNlKS5jaGFubmVsUmVtb3RlW21ldGhvZF0oXHJcbiAgICAgICAgICByb3V0ZSxcclxuICAgICAgICAgIG1zZyxcclxuICAgICAgICAgIGdyb3Vwc1tzaWRdLFxyXG4gICAgICAgICAgb3B0cyxcclxuICAgICAgICAgIHJwY0NCKHNpZClcclxuICAgICAgICApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGFwcC5ycGNJbnZva2UoXHJcbiAgICAgICAgICBzaWQsXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIG5hbWVzcGFjZTogbmFtZXNwYWNlLFxyXG4gICAgICAgICAgICBzZXJ2aWNlOiBzZXJ2aWNlLFxyXG4gICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCxcclxuICAgICAgICAgICAgYXJnczogW3JvdXRlLCBtc2csIGdyb3Vwc1tzaWRdLCBvcHRzXVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIHJwY0NCKHNpZClcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9KSgpO1xyXG4gIH07XHJcblxyXG4gIGxldCBncm91cDtcclxuICBmb3IgKGxldCBzaWQgaW4gZ3JvdXBzKSB7XHJcbiAgICBncm91cCA9IGdyb3Vwc1tzaWRdO1xyXG4gICAgaWYgKGdyb3VwICYmIGdyb3VwLmxlbmd0aCA+IDApIHtcclxuICAgICAgc2VuZE1lc3NhZ2Uoc2lkKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIGVtcHR5IGdyb3VwXHJcbiAgICAgIHByb2Nlc3MubmV4dFRpY2socnBjQ0Ioc2lkKSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXN0b3JlQ2hhbm5lbChzZWxmOiBDaGFubmVsU2VydmljZSwgY2I/OiBGdW5jdGlvbikge1xyXG4gIGlmICghc2VsZi5zdG9yZSkge1xyXG4gICAgaW52b2tlQ2FsbGJhY2soY2IhKTtcclxuICAgIHJldHVybjtcclxuICB9IGVsc2Uge1xyXG4gICAgbG9hZEFsbEZyb21TdG9yZShzZWxmLCBnZW5LZXkoc2VsZiksIChlcnI6IGFueSwgbGlzdDogYW55KSA9PiB7XHJcbiAgICAgIGlmICghIWVycikge1xyXG4gICAgICAgIGludm9rZUNhbGxiYWNrKGNiISwgZXJyKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWYgKCFsaXN0Lmxlbmd0aCB8fCAhQXJyYXkuaXNBcnJheShsaXN0KSkge1xyXG4gICAgICAgICAgaW52b2tlQ2FsbGJhY2soY2IhKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IGxvYWQgPSAoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIHJldHVybiAoKCkgPT4ge1xyXG4gICAgICAgICAgICBsb2FkQWxsRnJvbVN0b3JlKHNlbGYsIGtleSwgKGVycjogYW55LCBpdGVtczogc3RyaW5nW10pID0+IHtcclxuICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGl0ZW1zLmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgYXJyYXkgPSBpdGVtc1tqXS5zcGxpdChcIjpcIik7XHJcbiAgICAgICAgICAgICAgICBsZXQgc2lkID0gYXJyYXlbMF07XHJcbiAgICAgICAgICAgICAgICBsZXQgdWlkID0gYXJyYXlbMV07XHJcbiAgICAgICAgICAgICAgICBsZXQgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbbmFtZV07XHJcbiAgICAgICAgICAgICAgICBsZXQgcmVzID0gYWRkKHVpZCwgc2lkLCBjaGFubmVsLmdyb3Vwcyk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICg8YW55PmNoYW5uZWwpLnJlY29yZHNbdWlkXSA9IHsgc2lkOiBzaWQsIHVpZDogdWlkIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0pKCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICBsZXQgbmFtZSA9IGxpc3RbaV0uc2xpY2UoZ2VuS2V5KHNlbGYpLmxlbmd0aCArIDEpO1xyXG4gICAgICAgICAgc2VsZi5jaGFubmVsc1tuYW1lXSA9IG5ldyBDaGFubmVsKG5hbWUsIHNlbGYpO1xyXG4gICAgICAgICAgbG9hZChsaXN0W2ldKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaW52b2tlQ2FsbGJhY2soY2IhKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBhZGRUb1N0b3JlKHNlbGY6IENoYW5uZWxTZXJ2aWNlLCBrZXk6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gIGlmICghIXNlbGYuc3RvcmUpIHtcclxuICAgIHNlbGYuc3RvcmUuYWRkKGtleSwgdmFsdWUsIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoISFlcnIpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgICBcImFkZCBrZXk6ICVzIHZhbHVlOiAlcyB0byBzdG9yZSwgd2l0aCBlcnI6ICVqXCIsXHJcbiAgICAgICAgICBrZXksXHJcbiAgICAgICAgICB2YWx1ZSxcclxuICAgICAgICAgIGVyci5zdGFja1xyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVtb3ZlRnJvbVN0b3JlKHNlbGY6IENoYW5uZWxTZXJ2aWNlLCBrZXk6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gIGlmICghIXNlbGYuc3RvcmUpIHtcclxuICAgIHNlbGYuc3RvcmUucmVtb3ZlKGtleSwgdmFsdWUsIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoISFlcnIpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgICBcInJlbW92ZSBrZXk6ICVzIHZhbHVlOiAlcyBmcm9tIHN0b3JlLCB3aXRoIGVycjogJWpcIixcclxuICAgICAgICAgIGtleSxcclxuICAgICAgICAgIHZhbHVlLFxyXG4gICAgICAgICAgZXJyLnN0YWNrXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBsb2FkQWxsRnJvbVN0b3JlKHNlbGY6IENoYW5uZWxTZXJ2aWNlLCBrZXk6IHN0cmluZywgY2I/OiBGdW5jdGlvbikge1xyXG4gIGlmICghIXNlbGYuc3RvcmUpIHtcclxuICAgIHNlbGYuc3RvcmUubG9hZChrZXksIChlcnI6IGFueSwgbGlzdDogYW55KSA9PiB7XHJcbiAgICAgIGlmICghIWVycikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihcImxvYWQga2V5OiAlcyBmcm9tIHN0b3JlLCB3aXRoIGVycjogJWpcIiwga2V5LCBlcnIuc3RhY2spO1xyXG4gICAgICAgIGludm9rZUNhbGxiYWNrKGNiISwgZXJyKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpbnZva2VDYWxsYmFjayhjYiEsIG51bGwsIGxpc3QpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlbW92ZUFsbEZyb21TdG9yZShzZWxmOiBDaGFubmVsU2VydmljZSwga2V5OiBzdHJpbmcpIHtcclxuICBpZiAoISFzZWxmLnN0b3JlKSB7XHJcbiAgICBzZWxmLnN0b3JlLnJlbW92ZUFsbChrZXksIChlcnI6IGFueSkgPT4ge1xyXG4gICAgICBpZiAoISFlcnIpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgICBcInJlbW92ZSBrZXk6ICVzIGFsbCBtZW1iZXJzIGZyb20gc3RvcmUsIHdpdGggZXJyOiAlalwiLFxyXG4gICAgICAgICAga2V5LFxyXG4gICAgICAgICAgZXJyLnN0YWNrXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZW5LZXkoc2VsZjogQ2hhbm5lbFNlcnZpY2UsIG5hbWU/OiBzdHJpbmcpIHtcclxuICBpZiAoISFuYW1lKSB7XHJcbiAgICByZXR1cm4gc2VsZi5wcmVmaXggKyBcIjpcIiArIHNlbGYuYXBwLnNlcnZlcklkICsgXCI6XCIgKyBuYW1lO1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gc2VsZi5wcmVmaXggKyBcIjpcIiArIHNlbGYuYXBwLnNlcnZlcklkO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2VuVmFsdWUoc2lkOiBzdHJpbmcsIHVpZDogc3RyaW5nKSB7XHJcbiAgcmV0dXJuIHNpZCArIFwiOlwiICsgdWlkO1xyXG59XHJcbiJdfQ==